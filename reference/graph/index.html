
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A lightweight Python framework for building intelligent agents and multi-agent workflows.">
      
      
      
        <link rel="canonical" href="https://iamsdt.github.io/pyagenity/reference/graph/">
      
      
        <link rel="prev" href="../exceptions/storage_exceptions/">
      
      
        <link rel="next" href="compiled_graph/">
      
      
      <link rel="icon" href="../../None">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.20">
    
    
      
        <title>Graph - PyAgenity</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.e53b48f4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#pyagenity.graph" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="PyAgenity" class="md-header__button md-logo" aria-label="PyAgenity" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PyAgenity
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Graph
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/Iamsdt/PyAgenity" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    Iamsdt/PyAgenity
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  PyAgenity

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../Concept/" class="md-tabs__link">
        
  
  
    
  
  Concept

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../Tutorial/" class="md-tabs__link">
        
  
  
    
  
  Tutorial

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="../" class="md-tabs__link">
        
  
  
    
  
  Reference

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="PyAgenity" class="md-nav__button md-logo" aria-label="PyAgenity" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    PyAgenity
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Iamsdt/PyAgenity" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    Iamsdt/PyAgenity
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PyAgenity
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../Concept/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Concept
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Concept
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Concept/Callbacks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Callbacks: Interception and Flow Control
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Concept/Command/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Commands: Combining State Updates with Control Flow
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Concept/Threadname/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Threadname
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Concept/dependency-injection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Dependency Injection in PyAgenity
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Concept/id_generator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Id generator
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Concept/publisher/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Publisher: Real-time Agent Observability
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Concept/response_converter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Response converter
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../Concept/context/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Context
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_8" id="__nav_2_8_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_8">
            <span class="md-nav__icon md-icon"></span>
            Context
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Concept/context/checkpointer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Checkpointer: The Agent's Session Memory
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Concept/context/message/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Messages: The Lifeblood of Agent Communication
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Concept/context/state/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Agent State: The Mind of Your Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Concept/context/store/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Store: The Agent's Knowledge Memory
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../Concept/graph/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Graph
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_9" id="__nav_2_9_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_9">
            <span class="md-nav__icon md-icon"></span>
            Graph
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Concept/graph/Config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Graph Configuration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Concept/graph/advanced/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Advanced Patterns &amp; Performance
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Concept/graph/control_flow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Control Flow &amp; Edges
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Concept/graph/execution/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Execution &amp; Streaming Runtime
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Concept/graph/human-in-the-loop/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Human-in-the-Loop (HITL) &amp; Interrupts
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Concept/graph/nodes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Nodes &amp; Return Types
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Concept/graph/tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tools &amp; Integrations
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../Tutorial/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Tutorial
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Tutorial
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Tutorial/long_term_memory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Long-Term Memory with Mem0
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Tutorial/plan_act_reflect/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Plan-Act-Reflect Pattern
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Tutorial/qdrant_store/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    QdrantStore Documentation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Tutorial/rag/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RAG (Retrieval-Augmented Generation) with PyAgenity
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../Tutorial/react/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    React
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            React
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Tutorial/react/01-basic-react/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Basic React Patterns
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Tutorial/react/02-dependency-injection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    React Agents with Dependency Injection
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Tutorial/react/03-mcp-integration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    React Agents with Model Context Protocol (MCP)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Tutorial/react/04-streaming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    React Agents with Streaming Responses
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../adapters/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Adapters
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            Adapters
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../adapters/llm/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Llm
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_1_1" id="__nav_4_1_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1_1">
            <span class="md-nav__icon md-icon"></span>
            Llm
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adapters/llm/base_converter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Base converter
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adapters/llm/litellm_converter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Litellm converter
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adapters/llm/model_response_converter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Model response converter
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../adapters/tools/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Tools
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_1_2" id="__nav_4_1_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1_2">
            <span class="md-nav__icon md-icon"></span>
            Tools
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adapters/tools/composio_adapter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Composio adapter
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adapters/tools/langchain_adapter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Langchain adapter
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../checkpointer/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Checkpointer
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            Checkpointer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../checkpointer/base_checkpointer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Base checkpointer
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../checkpointer/in_memory_checkpointer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    In memory checkpointer
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../checkpointer/pg_checkpointer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pg checkpointer
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../exceptions/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Exceptions
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            Exceptions
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../exceptions/graph_error/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Graph error
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../exceptions/node_error/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Node error
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../exceptions/recursion_error/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Recursion error
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../exceptions/storage_exceptions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Storage exceptions
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="./" class="md-nav__link md-nav__link--active">
              
  
  
  <span class="md-ellipsis">
    Graph
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link md-nav__link--active" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            Graph
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="compiled_graph/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Compiled graph
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="edge/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Edge
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="node/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Node
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="state_graph/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    State graph
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="tool_node/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Tool node
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_4_5" id="__nav_4_4_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_4_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4_5">
            <span class="md-nav__icon md-icon"></span>
            Tool node
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="tool_node/base/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Base
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="tool_node/constants/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Constants
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="tool_node/deps/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Deps
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="tool_node/executors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Executors
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="tool_node/schema/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Schema
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="utils/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Utils
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_4_6" id="__nav_4_4_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_4_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4_6">
            <span class="md-nav__icon md-icon"></span>
            Utils
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="utils/handler_mixins/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Handler mixins
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="utils/invoke_handler/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Invoke handler
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="utils/invoke_node_handler/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Invoke node handler
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="utils/stream_handler/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Stream handler
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="utils/stream_node_handler/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Stream node handler
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="utils/stream_utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Stream utils
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="utils/utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Utils
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../prebuilt/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Prebuilt
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_5" id="__nav_4_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_5">
            <span class="md-nav__icon md-icon"></span>
            Prebuilt
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_5_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../prebuilt/agent/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Agent
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_5_1" id="__nav_4_5_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_5_1">
            <span class="md-nav__icon md-icon"></span>
            Agent
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prebuilt/agent/branch_join/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Branch join
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prebuilt/agent/deep_research/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Deep research
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prebuilt/agent/guarded/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Guarded
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prebuilt/agent/map_reduce/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Map reduce
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prebuilt/agent/network/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Network
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prebuilt/agent/plan_act_reflect/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Plan act reflect
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prebuilt/agent/rag/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Rag
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prebuilt/agent/react/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    React
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prebuilt/agent/router/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Router
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prebuilt/agent/sequential/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sequential
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prebuilt/agent/supervisor_team/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Supervisor team
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prebuilt/agent/swarm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Swarm
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../publisher/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Publisher
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_6" id="__nav_4_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_6">
            <span class="md-nav__icon md-icon"></span>
            Publisher
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../publisher/base_publisher/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Base publisher
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../publisher/console_publisher/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Console publisher
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../publisher/events/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Events
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../publisher/kafka_publisher/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Kafka publisher
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../publisher/publish/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Publish
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../publisher/rabbitmq_publisher/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Rabbitmq publisher
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../publisher/redis_publisher/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Redis publisher
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_7" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../state/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    State
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_7" id="__nav_4_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_7">
            <span class="md-nav__icon md-icon"></span>
            State
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../state/agent_state/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Agent state
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../state/base_context/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Base context
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../state/execution_state/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Execution state
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../state/message_context_manager/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Message context manager
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_8" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../store/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Store
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_8" id="__nav_4_8_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_8">
            <span class="md-nav__icon md-icon"></span>
            Store
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../store/base_store/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Base store
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../store/mem0_store/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Mem0 store
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../store/qdrant_store/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Qdrant store
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../store/store_schema/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Store schema
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_8_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../store/embedding/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Embedding
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_8_5" id="__nav_4_8_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_8_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_8_5">
            <span class="md-nav__icon md-icon"></span>
            Embedding
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../store/embedding/base_embedding/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Base embedding
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../store/embedding/openai_embedding/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Openai embedding
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_9" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../utils/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Utils
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_9" id="__nav_4_9_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_9">
            <span class="md-nav__icon md-icon"></span>
            Utils
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/background_task_manager/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Background task manager
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/callable_utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Callable utils
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/callbacks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Callbacks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/command/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Command
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/constants/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Constants
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/converter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Converter
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/id_generator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Id generator
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/logging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Logging
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/message/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Message
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/metrics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Metrics
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/reducers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Reducers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/thread_info/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Thread info
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/thread_name_generator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Thread name generator
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pyagenity.graph" class="md-nav__link">
    <span class="md-ellipsis">
      graph
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pyagenity.graph--architecture-overview" class="md-nav__link">
    <span class="md-ellipsis">
      Architecture Overview:
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pyagenity.graph--core-components" class="md-nav__link">
    <span class="md-ellipsis">
      Core Components:
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pyagenity.graph--key-features" class="md-nav__link">
    <span class="md-ellipsis">
      Key Features:
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pyagenity.graph--usage-example" class="md-nav__link">
    <span class="md-ellipsis">
      Usage Example:
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pyagenity.graph--integration-points" class="md-nav__link">
    <span class="md-ellipsis">
      Integration Points:
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pyagenity.graph-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Attributes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.__all__" class="md-nav__link">
    <span class="md-ellipsis">
      __all__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pyagenity.graph-classes" class="md-nav__link">
    <span class="md-ellipsis">
      Classes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.CompiledGraph" class="md-nav__link">
    <span class="md-ellipsis">
      CompiledGraph
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CompiledGraph">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.CompiledGraph-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.CompiledGraph.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.CompiledGraph.aclose" class="md-nav__link">
    <span class="md-ellipsis">
      aclose
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.CompiledGraph.ainvoke" class="md-nav__link">
    <span class="md-ellipsis">
      ainvoke
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ainvoke">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.CompiledGraph.ainvoke(input_data)" class="md-nav__link">
    <span class="md-ellipsis">
      input_data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.CompiledGraph.ainvoke(config)" class="md-nav__link">
    <span class="md-ellipsis">
      config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.CompiledGraph.ainvoke(response_granularity)" class="md-nav__link">
    <span class="md-ellipsis">
      response_granularity
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.CompiledGraph.astop" class="md-nav__link">
    <span class="md-ellipsis">
      astop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.CompiledGraph.astream" class="md-nav__link">
    <span class="md-ellipsis">
      astream
    </span>
  </a>
  
    <nav class="md-nav" aria-label="astream">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.CompiledGraph.astream(input_data)" class="md-nav__link">
    <span class="md-ellipsis">
      input_data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.CompiledGraph.astream(config)" class="md-nav__link">
    <span class="md-ellipsis">
      config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.CompiledGraph.astream(response_granularity)" class="md-nav__link">
    <span class="md-ellipsis">
      response_granularity
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.CompiledGraph.generate_graph" class="md-nav__link">
    <span class="md-ellipsis">
      generate_graph
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.CompiledGraph.invoke" class="md-nav__link">
    <span class="md-ellipsis">
      invoke
    </span>
  </a>
  
    <nav class="md-nav" aria-label="invoke">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.CompiledGraph.invoke(input_data)" class="md-nav__link">
    <span class="md-ellipsis">
      input_data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.CompiledGraph.invoke(config)" class="md-nav__link">
    <span class="md-ellipsis">
      config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.CompiledGraph.invoke(response_granularity)" class="md-nav__link">
    <span class="md-ellipsis">
      response_granularity
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.CompiledGraph.stop" class="md-nav__link">
    <span class="md-ellipsis">
      stop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.CompiledGraph.stream" class="md-nav__link">
    <span class="md-ellipsis">
      stream
    </span>
  </a>
  
    <nav class="md-nav" aria-label="stream">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.CompiledGraph.stream(input_data)" class="md-nav__link">
    <span class="md-ellipsis">
      input_data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.CompiledGraph.stream(config)" class="md-nav__link">
    <span class="md-ellipsis">
      config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.CompiledGraph.stream(response_granularity)" class="md-nav__link">
    <span class="md-ellipsis">
      response_granularity
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.Edge" class="md-nav__link">
    <span class="md-ellipsis">
      Edge
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Edge">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.Edge-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Attributes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.Edge.condition" class="md-nav__link">
    <span class="md-ellipsis">
      condition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.Edge.condition_result" class="md-nav__link">
    <span class="md-ellipsis">
      condition_result
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.Edge.from_node" class="md-nav__link">
    <span class="md-ellipsis">
      from_node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.Edge.to_node" class="md-nav__link">
    <span class="md-ellipsis">
      to_node
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.Edge-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.Edge.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.Edge.__init__(from_node)" class="md-nav__link">
    <span class="md-ellipsis">
      from_node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.Edge.__init__(to_node)" class="md-nav__link">
    <span class="md-ellipsis">
      to_node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.Edge.__init__(condition)" class="md-nav__link">
    <span class="md-ellipsis">
      condition
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.Node" class="md-nav__link">
    <span class="md-ellipsis">
      Node
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Node">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.Node-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Attributes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.Node.func" class="md-nav__link">
    <span class="md-ellipsis">
      func
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.Node.invoke_handler" class="md-nav__link">
    <span class="md-ellipsis">
      invoke_handler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.Node.name" class="md-nav__link">
    <span class="md-ellipsis">
      name
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.Node.publisher" class="md-nav__link">
    <span class="md-ellipsis">
      publisher
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.Node.stream_handler" class="md-nav__link">
    <span class="md-ellipsis">
      stream_handler
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.Node-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.Node.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.Node.__init__(name)" class="md-nav__link">
    <span class="md-ellipsis">
      name
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.Node.__init__(func)" class="md-nav__link">
    <span class="md-ellipsis">
      func
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.Node.__init__(publisher)" class="md-nav__link">
    <span class="md-ellipsis">
      publisher
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.Node.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
    <nav class="md-nav" aria-label="execute">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.Node.execute(config)" class="md-nav__link">
    <span class="md-ellipsis">
      config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.Node.execute(state)" class="md-nav__link">
    <span class="md-ellipsis">
      state
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.Node.execute(callback_mgr)" class="md-nav__link">
    <span class="md-ellipsis">
      callback_mgr
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.Node.stream" class="md-nav__link">
    <span class="md-ellipsis">
      stream
    </span>
  </a>
  
    <nav class="md-nav" aria-label="stream">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.Node.stream(config)" class="md-nav__link">
    <span class="md-ellipsis">
      config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.Node.stream(state)" class="md-nav__link">
    <span class="md-ellipsis">
      state
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.Node.stream(callback_mgr)" class="md-nav__link">
    <span class="md-ellipsis">
      callback_mgr
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph" class="md-nav__link">
    <span class="md-ellipsis">
      StateGraph
    </span>
  </a>
  
    <nav class="md-nav" aria-label="StateGraph">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Attributes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.edges" class="md-nav__link">
    <span class="md-ellipsis">
      edges
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.entry_point" class="md-nav__link">
    <span class="md-ellipsis">
      entry_point
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.nodes" class="md-nav__link">
    <span class="md-ellipsis">
      nodes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.thread_name_generator" class="md-nav__link">
    <span class="md-ellipsis">
      thread_name_generator
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.__init__(state)" class="md-nav__link">
    <span class="md-ellipsis">
      state
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.__init__(context_manager)" class="md-nav__link">
    <span class="md-ellipsis">
      context_manager
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.__init__(dependency_container)" class="md-nav__link">
    <span class="md-ellipsis">
      dependency_container
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.__init__(publisher)" class="md-nav__link">
    <span class="md-ellipsis">
      publisher
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.__init__--basic-usage-with-default-agentstate" class="md-nav__link">
    <span class="md-ellipsis">
      Basic usage with default AgentState
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.__init__--with-custom-state" class="md-nav__link">
    <span class="md-ellipsis">
      With custom state
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.__init__--or-using-type-hints-for-clarity" class="md-nav__link">
    <span class="md-ellipsis">
      Or using type hints for clarity
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.add_conditional_edges" class="md-nav__link">
    <span class="md-ellipsis">
      add_conditional_edges
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_conditional_edges">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.add_conditional_edges(from_node)" class="md-nav__link">
    <span class="md-ellipsis">
      from_node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.add_conditional_edges(condition)" class="md-nav__link">
    <span class="md-ellipsis">
      condition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.add_conditional_edges(path_map)" class="md-nav__link">
    <span class="md-ellipsis">
      path_map
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.add_edge" class="md-nav__link">
    <span class="md-ellipsis">
      add_edge
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_edge">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.add_edge(from_node)" class="md-nav__link">
    <span class="md-ellipsis">
      from_node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.add_edge(to_node)" class="md-nav__link">
    <span class="md-ellipsis">
      to_node
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.add_node" class="md-nav__link">
    <span class="md-ellipsis">
      add_node
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_node">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.add_node(name_or_func)" class="md-nav__link">
    <span class="md-ellipsis">
      name_or_func
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.add_node(func)" class="md-nav__link">
    <span class="md-ellipsis">
      func
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.add_node--method-1-function-name-inferred" class="md-nav__link">
    <span class="md-ellipsis">
      Method 1: Function name inferred
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.add_node--method-2-explicit-name-and-function" class="md-nav__link">
    <span class="md-ellipsis">
      Method 2: Explicit name and function
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.compile" class="md-nav__link">
    <span class="md-ellipsis">
      compile
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compile">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.compile(checkpointer)" class="md-nav__link">
    <span class="md-ellipsis">
      checkpointer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.compile(store)" class="md-nav__link">
    <span class="md-ellipsis">
      store
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.compile(debug)" class="md-nav__link">
    <span class="md-ellipsis">
      debug
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.compile(interrupt_before)" class="md-nav__link">
    <span class="md-ellipsis">
      interrupt_before
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.compile(interrupt_after)" class="md-nav__link">
    <span class="md-ellipsis">
      interrupt_after
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.compile(callback_manager)" class="md-nav__link">
    <span class="md-ellipsis">
      callback_manager
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.StateGraph.set_entry_point" class="md-nav__link">
    <span class="md-ellipsis">
      set_entry_point
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.ToolNode" class="md-nav__link">
    <span class="md-ellipsis">
      ToolNode
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ToolNode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.ToolNode-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Attributes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.ToolNode.composio_tools" class="md-nav__link">
    <span class="md-ellipsis">
      composio_tools
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.ToolNode.langchain_tools" class="md-nav__link">
    <span class="md-ellipsis">
      langchain_tools
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.ToolNode.mcp_tools" class="md-nav__link">
    <span class="md-ellipsis">
      mcp_tools
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.ToolNode-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.ToolNode.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.ToolNode.__init__(functions)" class="md-nav__link">
    <span class="md-ellipsis">
      functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.ToolNode.__init__(client)" class="md-nav__link">
    <span class="md-ellipsis">
      client
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.ToolNode.__init__(composio_adapter)" class="md-nav__link">
    <span class="md-ellipsis">
      composio_adapter
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.ToolNode.__init__(langchain_adapter)" class="md-nav__link">
    <span class="md-ellipsis">
      langchain_adapter
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.ToolNode.all_tools" class="md-nav__link">
    <span class="md-ellipsis">
      all_tools
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.ToolNode.all_tools_sync" class="md-nav__link">
    <span class="md-ellipsis">
      all_tools_sync
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.ToolNode.get_local_tool" class="md-nav__link">
    <span class="md-ellipsis">
      get_local_tool
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.ToolNode.invoke" class="md-nav__link">
    <span class="md-ellipsis">
      invoke
    </span>
  </a>
  
    <nav class="md-nav" aria-label="invoke">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.ToolNode.invoke(name)" class="md-nav__link">
    <span class="md-ellipsis">
      name
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.ToolNode.invoke(args)" class="md-nav__link">
    <span class="md-ellipsis">
      args
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.ToolNode.invoke(tool_call_id)" class="md-nav__link">
    <span class="md-ellipsis">
      tool_call_id
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.ToolNode.invoke(config)" class="md-nav__link">
    <span class="md-ellipsis">
      config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.ToolNode.invoke(state)" class="md-nav__link">
    <span class="md-ellipsis">
      state
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.ToolNode.invoke(callback_manager)" class="md-nav__link">
    <span class="md-ellipsis">
      callback_manager
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.ToolNode.stream" class="md-nav__link">
    <span class="md-ellipsis">
      stream
    </span>
  </a>
  
    <nav class="md-nav" aria-label="stream">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.ToolNode.stream(name)" class="md-nav__link">
    <span class="md-ellipsis">
      name
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.ToolNode.stream(args)" class="md-nav__link">
    <span class="md-ellipsis">
      args
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.ToolNode.stream(tool_call_id)" class="md-nav__link">
    <span class="md-ellipsis">
      tool_call_id
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.ToolNode.stream(config)" class="md-nav__link">
    <span class="md-ellipsis">
      config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.ToolNode.stream(state)" class="md-nav__link">
    <span class="md-ellipsis">
      state
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.ToolNode.stream(callback_manager)" class="md-nav__link">
    <span class="md-ellipsis">
      callback_manager
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pyagenity.graph-modules" class="md-nav__link">
    <span class="md-ellipsis">
      Modules
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Modules">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.compiled_graph" class="md-nav__link">
    <span class="md-ellipsis">
      compiled_graph
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compiled_graph">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.compiled_graph-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Attributes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.compiled_graph.StateT" class="md-nav__link">
    <span class="md-ellipsis">
      StateT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.compiled_graph.logger" class="md-nav__link">
    <span class="md-ellipsis">
      logger
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.compiled_graph-classes" class="md-nav__link">
    <span class="md-ellipsis">
      Classes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.compiled_graph.CompiledGraph" class="md-nav__link">
    <span class="md-ellipsis">
      CompiledGraph
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CompiledGraph">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.compiled_graph.CompiledGraph-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.edge" class="md-nav__link">
    <span class="md-ellipsis">
      edge
    </span>
  </a>
  
    <nav class="md-nav" aria-label="edge">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.edge-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Attributes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.edge.logger" class="md-nav__link">
    <span class="md-ellipsis">
      logger
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.edge-classes" class="md-nav__link">
    <span class="md-ellipsis">
      Classes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.edge.Edge" class="md-nav__link">
    <span class="md-ellipsis">
      Edge
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Edge">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.edge.Edge-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.edge.Edge-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.node" class="md-nav__link">
    <span class="md-ellipsis">
      node
    </span>
  </a>
  
    <nav class="md-nav" aria-label="node">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.node-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Attributes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.node.logger" class="md-nav__link">
    <span class="md-ellipsis">
      logger
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.node-classes" class="md-nav__link">
    <span class="md-ellipsis">
      Classes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.node.Node" class="md-nav__link">
    <span class="md-ellipsis">
      Node
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Node">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.node.Node-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.node.Node-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.state_graph" class="md-nav__link">
    <span class="md-ellipsis">
      state_graph
    </span>
  </a>
  
    <nav class="md-nav" aria-label="state_graph">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.state_graph-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Attributes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.state_graph.StateT" class="md-nav__link">
    <span class="md-ellipsis">
      StateT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.state_graph.logger" class="md-nav__link">
    <span class="md-ellipsis">
      logger
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.state_graph-classes" class="md-nav__link">
    <span class="md-ellipsis">
      Classes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.state_graph.StateGraph" class="md-nav__link">
    <span class="md-ellipsis">
      StateGraph
    </span>
  </a>
  
    <nav class="md-nav" aria-label="StateGraph">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.state_graph.StateGraph-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.state_graph.StateGraph-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.state_graph.StateGraph.__init__--basic-usage-with-default-agentstate" class="md-nav__link">
    <span class="md-ellipsis">
      Basic usage with default AgentState
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.state_graph.StateGraph.__init__--with-custom-state" class="md-nav__link">
    <span class="md-ellipsis">
      With custom state
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.state_graph.StateGraph.__init__--or-using-type-hints-for-clarity" class="md-nav__link">
    <span class="md-ellipsis">
      Or using type hints for clarity
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.state_graph.StateGraph.add_node--method-1-function-name-inferred" class="md-nav__link">
    <span class="md-ellipsis">
      Method 1: Function name inferred
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.state_graph.StateGraph.add_node--method-2-explicit-name-and-function" class="md-nav__link">
    <span class="md-ellipsis">
      Method 2: Explicit name and function
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.state_graph-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node" class="md-nav__link">
    <span class="md-ellipsis">
      tool_node
    </span>
  </a>
  
    <nav class="md-nav" aria-label="tool_node">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Attributes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node.HAS_FASTMCP" class="md-nav__link">
    <span class="md-ellipsis">
      HAS_FASTMCP
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node.HAS_MCP" class="md-nav__link">
    <span class="md-ellipsis">
      HAS_MCP
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node.__all__" class="md-nav__link">
    <span class="md-ellipsis">
      __all__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node-classes" class="md-nav__link">
    <span class="md-ellipsis">
      Classes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node.ToolNode" class="md-nav__link">
    <span class="md-ellipsis">
      ToolNode
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ToolNode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node.ToolNode-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node.ToolNode-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node-modules" class="md-nav__link">
    <span class="md-ellipsis">
      Modules
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Modules">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node.base" class="md-nav__link">
    <span class="md-ellipsis">
      base
    </span>
  </a>
  
    <nav class="md-nav" aria-label="base">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node.base-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node.base-classes" class="md-nav__link">
    <span class="md-ellipsis">
      Classes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node.base-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node.base-modules" class="md-nav__link">
    <span class="md-ellipsis">
      Modules
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node.constants" class="md-nav__link">
    <span class="md-ellipsis">
      constants
    </span>
  </a>
  
    <nav class="md-nav" aria-label="constants">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node.constants(tool_call_id)" class="md-nav__link">
    <span class="md-ellipsis">
      tool_call_id
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node.constants(state)" class="md-nav__link">
    <span class="md-ellipsis">
      state
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node.constants(config)" class="md-nav__link">
    <span class="md-ellipsis">
      config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node.constants(generated_id)" class="md-nav__link">
    <span class="md-ellipsis">
      generated_id
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node.constants(context_manager)" class="md-nav__link">
    <span class="md-ellipsis">
      context_manager
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node.constants(publisher)" class="md-nav__link">
    <span class="md-ellipsis">
      publisher
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node.constants(checkpointer)" class="md-nav__link">
    <span class="md-ellipsis">
      checkpointer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node.constants(store)" class="md-nav__link">
    <span class="md-ellipsis">
      store
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node.constants-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node.deps" class="md-nav__link">
    <span class="md-ellipsis">
      deps
    </span>
  </a>
  
    <nav class="md-nav" aria-label="deps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node.deps-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node.executors" class="md-nav__link">
    <span class="md-ellipsis">
      executors
    </span>
  </a>
  
    <nav class="md-nav" aria-label="executors">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node.executors-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node.executors-classes" class="md-nav__link">
    <span class="md-ellipsis">
      Classes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node.executors-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node.schema" class="md-nav__link">
    <span class="md-ellipsis">
      schema
    </span>
  </a>
  
    <nav class="md-nav" aria-label="schema">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node.schema-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.tool_node.schema-classes" class="md-nav__link">
    <span class="md-ellipsis">
      Classes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.utils" class="md-nav__link">
    <span class="md-ellipsis">
      utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label="utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.utils-modules" class="md-nav__link">
    <span class="md-ellipsis">
      Modules
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Modules">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.utils.handler_mixins" class="md-nav__link">
    <span class="md-ellipsis">
      handler_mixins
    </span>
  </a>
  
    <nav class="md-nav" aria-label="handler_mixins">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.utils.handler_mixins-classes" class="md-nav__link">
    <span class="md-ellipsis">
      Classes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.utils.invoke_handler" class="md-nav__link">
    <span class="md-ellipsis">
      invoke_handler
    </span>
  </a>
  
    <nav class="md-nav" aria-label="invoke_handler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.utils.invoke_handler-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.utils.invoke_handler-classes" class="md-nav__link">
    <span class="md-ellipsis">
      Classes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.utils.invoke_handler-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.utils.invoke_node_handler" class="md-nav__link">
    <span class="md-ellipsis">
      invoke_node_handler
    </span>
  </a>
  
    <nav class="md-nav" aria-label="invoke_node_handler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.utils.invoke_node_handler-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.utils.invoke_node_handler-classes" class="md-nav__link">
    <span class="md-ellipsis">
      Classes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.utils.invoke_node_handler-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.utils.stream_handler" class="md-nav__link">
    <span class="md-ellipsis">
      stream_handler
    </span>
  </a>
  
    <nav class="md-nav" aria-label="stream_handler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.utils.stream_handler-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.utils.stream_handler-classes" class="md-nav__link">
    <span class="md-ellipsis">
      Classes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.utils.stream_handler-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.utils.stream_node_handler" class="md-nav__link">
    <span class="md-ellipsis">
      stream_node_handler
    </span>
  </a>
  
    <nav class="md-nav" aria-label="stream_node_handler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.utils.stream_node_handler-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.utils.stream_node_handler-classes" class="md-nav__link">
    <span class="md-ellipsis">
      Classes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.utils.stream_node_handler-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.utils.stream_utils" class="md-nav__link">
    <span class="md-ellipsis">
      stream_utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label="stream_utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.utils.stream_utils-classes" class="md-nav__link">
    <span class="md-ellipsis">
      Classes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.utils.stream_utils-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.utils.utils" class="md-nav__link">
    <span class="md-ellipsis">
      utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label="utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.utils.utils-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.utils.utils-classes" class="md-nav__link">
    <span class="md-ellipsis">
      Classes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyagenity.graph.utils.utils-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<div class="doc doc-object doc-module">



<a id="pyagenity.graph"></a>
    <div class="doc doc-contents first">

        <p>PyAgenity Graph Module - Core Workflow Engine.</p>
<p>This module provides the foundational components for building and executing
agent workflows in PyAgenity. It implements a graph-based execution model
similar to LangGraph, where workflows are defined as directed graphs of
interconnected nodes that process state and execute business logic.</p>
<h2 id="pyagenity.graph--architecture-overview">Architecture Overview:<a class="headerlink" href="#pyagenity.graph--architecture-overview" title="Permanent link">&para;</a></h2>
<p>The graph module follows a builder pattern for workflow construction and
provides a compiled execution environment for runtime performance. The core
components work together to enable complex, stateful agent interactions:</p>
<ol>
<li><strong>StateGraph</strong>: The primary builder class for constructing workflows</li>
<li><strong>Node</strong>: Executable units that encapsulate functions or tool operations</li>
<li><strong>Edge</strong>: Connections between nodes that define execution flow</li>
<li><strong>CompiledGraph</strong>: The executable runtime form of a constructed graph</li>
<li><strong>ToolNode</strong>: Specialized node for managing and executing tools</li>
</ol>
<h2 id="pyagenity.graph--core-components">Core Components:<a class="headerlink" href="#pyagenity.graph--core-components" title="Permanent link">&para;</a></h2>


<details class="stategraph" open>
  <summary>StateGraph</summary>
  <p>The main entry point for building workflows. Provides a fluent API for
adding nodes, connecting them with edges, and configuring execution
behavior. Supports both static and conditional routing between nodes.</p>
</details>

<details class="node" open>
  <summary>Node</summary>
  <p>Represents an executable unit within the graph. Wraps functions or
ToolNode instances and handles dependency injection, parameter mapping,
and execution context. Supports both regular and streaming execution modes.</p>
</details>

<details class="edge" open>
  <summary>Edge</summary>
  <p>Defines connections between nodes, supporting both static (always followed)
and conditional (state-dependent) routing. Enables complex branching logic
and decision trees within workflows.</p>
</details>

<details class="compiledgraph" open>
  <summary>CompiledGraph</summary>
  <p>The executable runtime form created by compiling a StateGraph. Provides
synchronous and asynchronous execution methods, state persistence,
event publishing, and comprehensive error handling.</p>
</details>

<details class="toolnode" open>
  <summary>ToolNode</summary>
  <p>A specialized registry and executor for callable functions from various
sources including local functions, MCP tools, Composio integrations,
and LangChain tools. Supports automatic schema generation and unified
tool execution.</p>
</details>        <h2 id="pyagenity.graph--key-features">Key Features:<a class="headerlink" href="#pyagenity.graph--key-features" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>State Management</strong>: Persistent, typed state that flows between nodes</li>
<li><strong>Dependency Injection</strong>: Automatic injection of framework services</li>
<li><strong>Event Publishing</strong>: Comprehensive execution monitoring and debugging</li>
<li><strong>Streaming Support</strong>: Real-time incremental result processing</li>
<li><strong>Interrupts &amp; Resume</strong>: Pauseable execution with checkpointing</li>
<li><strong>Tool Integration</strong>: Unified interface for various tool providers</li>
<li><strong>Type Safety</strong>: Generic typing for custom state classes</li>
<li><strong>Error Handling</strong>: Robust error recovery and callback mechanisms</li>
</ul>
<h2 id="pyagenity.graph--usage-example">Usage Example:<a class="headerlink" href="#pyagenity.graph--usage-example" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>```python
from pyagenity.graph import StateGraph, ToolNode
from pyagenity.utils import START, END


# Define workflow functions
def process_input(state, config):
    # Process user input
    result = analyze_input(state.context[-1].content)
    return [Message.text_message(f&quot;Analysis: {result}&quot;)]


def generate_response(state, config):
    # Generate final response
    response = create_response(state.context)
    return [Message.text_message(response)]


# Create tools
def search_tool(query: str) -&gt; str:
    return f&quot;Search results for: {query}&quot;


tools = ToolNode([search_tool])

# Build the graph
graph = StateGraph()
graph.add_node(&quot;process&quot;, process_input)
graph.add_node(&quot;search&quot;, tools)
graph.add_node(&quot;respond&quot;, generate_response)

# Define flow
graph.add_edge(START, &quot;process&quot;)
graph.add_edge(&quot;process&quot;, &quot;search&quot;)
graph.add_edge(&quot;search&quot;, &quot;respond&quot;)
graph.add_edge(&quot;respond&quot;, END)

# Compile and execute
compiled = graph.compile()
result = compiled.invoke({&quot;messages&quot;: [Message.text_message(&quot;Hello, world!&quot;)]})

# Cleanup
await compiled.aclose()
```
</code></pre></div>
<h2 id="pyagenity.graph--integration-points">Integration Points:<a class="headerlink" href="#pyagenity.graph--integration-points" title="Permanent link">&para;</a></h2>
<p>The graph module integrates with other PyAgenity components:</p>
<ul>
<li><strong>State Module</strong>: Provides AgentState and context management</li>
<li><strong>Utils Module</strong>: Supplies constants, messages, and helper functions</li>
<li><strong>Checkpointer Module</strong>: Enables state persistence and recovery</li>
<li><strong>Publisher Module</strong>: Handles event publishing and monitoring</li>
<li><strong>Adapters Module</strong>: Connects with external tools and services</li>
</ul>
<p>This architecture provides a flexible, extensible foundation for building
sophisticated agent workflows while maintaining simplicity for common use cases.</p>






<p><span class="doc-section-title">Modules:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            compiled_graph (pyagenity.graph.compiled_graph)" href="../#pyagenity.graph.compiled_graph">compiled_graph</a></code></td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            edge (pyagenity.graph.edge)" href="../#pyagenity.graph.edge">edge</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Graph edge representation and routing logic for PyAgenity workflows.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            node (pyagenity.graph.node)" href="../#pyagenity.graph.node">node</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Node execution and management for PyAgenity graph workflows.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            state_graph (pyagenity.graph.state_graph)" href="../#pyagenity.graph.state_graph">state_graph</a></code></td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            tool_node (pyagenity.graph.tool_node)" href="../#pyagenity.graph.tool_node">tool_node</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>ToolNode package.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            utils (pyagenity.graph.utils)" href="../#pyagenity.graph.utils">utils</a></code></td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>






<p><span class="doc-section-title">Classes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            CompiledGraph (pyagenity.graph.CompiledGraph)" href="../#pyagenity.graph.CompiledGraph">CompiledGraph</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>A fully compiled and executable graph ready for workflow execution.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            Edge (pyagenity.graph.Edge)" href="../#pyagenity.graph.Edge">Edge</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Represents a connection between two nodes in a graph workflow.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            Node (pyagenity.graph.Node)" href="../#pyagenity.graph.Node">Node</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Represents a node in the graph workflow.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            StateGraph (pyagenity.graph.StateGraph)" href="../#pyagenity.graph.StateGraph">StateGraph</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Main graph class for orchestrating multi-agent workflows.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            ToolNode (pyagenity.graph.ToolNode)" href="../#pyagenity.graph.ToolNode">ToolNode</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>A unified registry and executor for callable functions from various tool providers.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







  <div class="doc doc-children">





<h2 id="pyagenity.graph-attributes">Attributes<a href="#pyagenity.graph-attributes" class="headerlink" title="Permanent link">&para;</a></h2>

<div class="doc doc-object doc-attribute">



<h3 id="pyagenity.graph.__all__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">__all__</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#pyagenity.graph.__all__" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CompiledGraph&#39;</span><span class="p">,</span> <span class="s1">&#39;Edge&#39;</span><span class="p">,</span> <span class="s1">&#39;Node&#39;</span><span class="p">,</span> <span class="s1">&#39;StateGraph&#39;</span><span class="p">,</span> <span class="s1">&#39;ToolNode&#39;</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<h2 id="pyagenity.graph-classes">Classes<a href="#pyagenity.graph-classes" class="headerlink" title="Permanent link">&para;</a></h2>

<div class="doc doc-object doc-class">



<h3 id="pyagenity.graph.CompiledGraph" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">CompiledGraph</span>


<a href="#pyagenity.graph.CompiledGraph" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">


        <p>A fully compiled and executable graph ready for workflow execution.</p>
<p>CompiledGraph represents the final executable form of a StateGraph after compilation.
It encapsulates all the execution logic, handlers, and services needed to run
agent workflows. The graph supports both synchronous and asynchronous execution
with comprehensive state management, checkpointing, event publishing, and
streaming capabilities.</p>
<p>This class is generic over state types to support custom AgentState subclasses,
ensuring type safety throughout the execution process.</p>
<p>Key Features:
- Synchronous and asynchronous execution methods
- Real-time streaming with incremental results
- State persistence and checkpointing
- Interrupt and resume capabilities
- Event publishing for monitoring and debugging
- Background task management
- Graceful error handling and recovery</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.CompiledGraph._state">_state</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The initial/template state for graph executions.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.CompiledGraph._invoke_handler">_invoke_handler</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            InvokeHandler (pyagenity.graph.utils.invoke_handler.InvokeHandler)" href="../#pyagenity.graph.utils.invoke_handler.InvokeHandler">InvokeHandler</a>[<span title="pyagenity.graph.compiled_graph.CompiledGraph[StateT]">StateT</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Handler for non-streaming graph execution.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.CompiledGraph._stream_handler">_stream_handler</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            StreamHandler (pyagenity.graph.utils.stream_handler.StreamHandler)" href="../#pyagenity.graph.utils.stream_handler.StreamHandler">StreamHandler</a>[<span title="pyagenity.graph.compiled_graph.CompiledGraph[StateT]">StateT</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Handler for streaming graph execution.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.CompiledGraph._checkpointer">_checkpointer</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            BaseCheckpointer (pyagenity.checkpointer.base_checkpointer.BaseCheckpointer)" href="../#pyagenity.checkpointer.base_checkpointer.BaseCheckpointer">BaseCheckpointer</a>[<span title="pyagenity.graph.compiled_graph.CompiledGraph[StateT]">StateT</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional state persistence backend.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.CompiledGraph._publisher">_publisher</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            BasePublisher (pyagenity.publisher.base_publisher.BasePublisher)" href="../#pyagenity.publisher.base_publisher.BasePublisher">BasePublisher</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional event publishing backend.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.CompiledGraph._store">_store</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            BaseStore (pyagenity.store.base_store.BaseStore)" href="../#pyagenity.store.base_store.BaseStore">BaseStore</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional data storage backend.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.CompiledGraph._state_graph">_state_graph</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            StateGraph (pyagenity.graph.state_graph.StateGraph)" href="../#pyagenity.graph.state_graph.StateGraph">StateGraph</a>[<span title="pyagenity.graph.compiled_graph.CompiledGraph[StateT]">StateT</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Reference to the source StateGraph.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.CompiledGraph._interrupt_before">_interrupt_before</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nodes where execution should pause before execution.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.CompiledGraph._interrupt_after">_interrupt_after</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nodes where execution should pause after execution.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.CompiledGraph._task_manager">_task_manager</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Manager for background async tasks.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="c1"># After building and compiling a StateGraph</span>
<span class="n">compiled</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>

<span class="c1"># Synchronous execution</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">compiled</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Message</span><span class="o">.</span><span class="n">text_message</span><span class="p">(</span><span class="s2">&quot;Hello&quot;</span><span class="p">)]})</span>

<span class="c1"># Asynchronous execution with streaming</span>
<span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">compiled</span><span class="o">.</span><span class="n">astream</span><span class="p">({</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">message</span><span class="p">]}):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Streamed: </span><span class="si">{</span><span class="n">chunk</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Graceful cleanup</span>
<span class="k">await</span> <span class="n">compiled</span><span class="o">.</span><span class="n">aclose</span><span class="p">()</span>
</code></pre></div>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>CompiledGraph instances should be properly closed using aclose() to
release resources like database connections, background tasks, and
event publishers.</p>
</details>











<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            __init__ (pyagenity.graph.CompiledGraph.__init__)" href="../#pyagenity.graph.CompiledGraph.__init__">__init__</a></code></td>
              <td>
                <div class="doc-md-description">
                  
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            aclose


  
      async
   (pyagenity.graph.CompiledGraph.aclose)" href="../#pyagenity.graph.CompiledGraph.aclose">aclose</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Close the graph and release any resources.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            ainvoke


  
      async
   (pyagenity.graph.CompiledGraph.ainvoke)" href="../#pyagenity.graph.CompiledGraph.ainvoke">ainvoke</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Execute the graph asynchronously.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            astop


  
      async
   (pyagenity.graph.CompiledGraph.astop)" href="../#pyagenity.graph.CompiledGraph.astop">astop</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Request the current graph execution to stop (async).</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            astream


  
      async
   (pyagenity.graph.CompiledGraph.astream)" href="../#pyagenity.graph.CompiledGraph.astream">astream</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Execute the graph asynchronously with streaming support.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            generate_graph (pyagenity.graph.CompiledGraph.generate_graph)" href="../#pyagenity.graph.CompiledGraph.generate_graph">generate_graph</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Generate the graph representation.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            invoke (pyagenity.graph.CompiledGraph.invoke)" href="../#pyagenity.graph.CompiledGraph.invoke">invoke</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Execute the graph synchronously and return the final results.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            stop (pyagenity.graph.CompiledGraph.stop)" href="../#pyagenity.graph.CompiledGraph.stop">stop</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Request the current graph execution to stop (sync helper).</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            stream (pyagenity.graph.CompiledGraph.stream)" href="../#pyagenity.graph.CompiledGraph.stream">stream</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Execute the graph synchronously with streaming support.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>



              <details class="quote">
                <summary>Source code in <code>pyagenity/graph/compiled_graph.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CompiledGraph</span><span class="p">[</span><span class="n">StateT</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A fully compiled and executable graph ready for workflow execution.</span>

<span class="sd">    CompiledGraph represents the final executable form of a StateGraph after compilation.</span>
<span class="sd">    It encapsulates all the execution logic, handlers, and services needed to run</span>
<span class="sd">    agent workflows. The graph supports both synchronous and asynchronous execution</span>
<span class="sd">    with comprehensive state management, checkpointing, event publishing, and</span>
<span class="sd">    streaming capabilities.</span>

<span class="sd">    This class is generic over state types to support custom AgentState subclasses,</span>
<span class="sd">    ensuring type safety throughout the execution process.</span>

<span class="sd">    Key Features:</span>
<span class="sd">    - Synchronous and asynchronous execution methods</span>
<span class="sd">    - Real-time streaming with incremental results</span>
<span class="sd">    - State persistence and checkpointing</span>
<span class="sd">    - Interrupt and resume capabilities</span>
<span class="sd">    - Event publishing for monitoring and debugging</span>
<span class="sd">    - Background task management</span>
<span class="sd">    - Graceful error handling and recovery</span>

<span class="sd">    Attributes:</span>
<span class="sd">        _state: The initial/template state for graph executions.</span>
<span class="sd">        _invoke_handler: Handler for non-streaming graph execution.</span>
<span class="sd">        _stream_handler: Handler for streaming graph execution.</span>
<span class="sd">        _checkpointer: Optional state persistence backend.</span>
<span class="sd">        _publisher: Optional event publishing backend.</span>
<span class="sd">        _store: Optional data storage backend.</span>
<span class="sd">        _state_graph: Reference to the source StateGraph.</span>
<span class="sd">        _interrupt_before: Nodes where execution should pause before execution.</span>
<span class="sd">        _interrupt_after: Nodes where execution should pause after execution.</span>
<span class="sd">        _task_manager: Manager for background async tasks.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        # After building and compiling a StateGraph</span>
<span class="sd">        compiled = graph.compile()</span>

<span class="sd">        # Synchronous execution</span>
<span class="sd">        result = compiled.invoke({&quot;messages&quot;: [Message.text_message(&quot;Hello&quot;)]})</span>

<span class="sd">        # Asynchronous execution with streaming</span>
<span class="sd">        async for chunk in compiled.astream({&quot;messages&quot;: [message]}):</span>
<span class="sd">            print(f&quot;Streamed: {chunk.content}&quot;)</span>

<span class="sd">        # Graceful cleanup</span>
<span class="sd">        await compiled.aclose()</span>
<span class="sd">        ```</span>

<span class="sd">    Note:</span>
<span class="sd">        CompiledGraph instances should be properly closed using aclose() to</span>
<span class="sd">        release resources like database connections, background tasks, and</span>
<span class="sd">        event publishers.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">StateT</span><span class="p">,</span>
        <span class="n">checkpointer</span><span class="p">:</span> <span class="n">BaseCheckpointer</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">publisher</span><span class="p">:</span> <span class="n">BasePublisher</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">store</span><span class="p">:</span> <span class="n">BaseStore</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">state_graph</span><span class="p">:</span> <span class="n">StateGraph</span><span class="p">[</span><span class="n">StateT</span><span class="p">],</span>
        <span class="n">interrupt_before</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">interrupt_after</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">task_manager</span><span class="p">:</span> <span class="n">BackgroundTaskManager</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Initializing CompiledGraph with nodes: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">state_graph</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Save initial state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">state</span>

        <span class="c1"># create handlers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_invoke_handler</span><span class="p">:</span> <span class="n">InvokeHandler</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">=</span> <span class="n">InvokeHandler</span><span class="p">[</span><span class="n">StateT</span><span class="p">](</span>
            <span class="n">nodes</span><span class="o">=</span><span class="n">state_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
            <span class="n">edges</span><span class="o">=</span><span class="n">state_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stream_handler</span><span class="p">:</span> <span class="n">StreamHandler</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">=</span> <span class="n">StreamHandler</span><span class="p">[</span><span class="n">StateT</span><span class="p">](</span>
            <span class="n">nodes</span><span class="o">=</span><span class="n">state_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
            <span class="n">edges</span><span class="o">=</span><span class="n">state_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="p">:</span> <span class="n">BaseCheckpointer</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">checkpointer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span><span class="p">:</span> <span class="n">BasePublisher</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">publisher</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">:</span> <span class="n">BaseStore</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">store</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state_graph</span><span class="p">:</span> <span class="n">StateGraph</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">=</span> <span class="n">state_graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interrupt_before</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">interrupt_before</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interrupt_after</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">interrupt_after</span>
        <span class="c1"># generate task manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_task_manager</span> <span class="o">=</span> <span class="n">task_manager</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_config</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">is_stream</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s2">&quot;is_stream&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">:</span>
            <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;is_stream&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_stream</span>
        <span class="k">if</span> <span class="s2">&quot;user_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">:</span>
            <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;test-user-id&quot;</span>  <span class="c1"># mock user id</span>
        <span class="k">if</span> <span class="s2">&quot;run_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">:</span>
            <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;run_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">InjectQ</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span><span class="o">.</span><span class="n">try_get</span><span class="p">(</span><span class="s2">&quot;generated_id&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>

        <span class="k">if</span> <span class="s2">&quot;timestamp&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">:</span>
            <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">cfg</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">response_granularity</span><span class="p">:</span> <span class="n">ResponseGranularity</span> <span class="o">=</span> <span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the graph synchronously and return the final results.</span>

<span class="sd">        Runs the complete graph workflow from start to finish, handling state</span>
<span class="sd">        management, node execution, and result formatting. This method automatically</span>
<span class="sd">        detects whether to start a fresh execution or resume from an interrupted state.</span>

<span class="sd">        The execution is synchronous but internally uses async operations, making it</span>
<span class="sd">        suitable for use in non-async contexts while still benefiting from async</span>
<span class="sd">        capabilities for I/O operations.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_data: Input dictionary for graph execution. For new executions,</span>
<span class="sd">                should contain &#39;messages&#39; key with list of initial messages.</span>
<span class="sd">                For resumed executions, can contain additional data to merge.</span>
<span class="sd">            config: Optional configuration dictionary containing execution settings:</span>
<span class="sd">                - user_id: Identifier for the user/session</span>
<span class="sd">                - thread_id: Unique identifier for this execution thread</span>
<span class="sd">                - run_id: Unique identifier for this specific run</span>
<span class="sd">                - recursion_limit: Maximum steps before stopping (default: 25)</span>
<span class="sd">            response_granularity: Level of detail in the response:</span>
<span class="sd">                - LOW: Returns only messages (default)</span>
<span class="sd">                - PARTIAL: Returns context, summary, and messages</span>
<span class="sd">                - FULL: Returns complete state and messages</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary containing execution results formatted according to the</span>
<span class="sd">            specified granularity level. Always includes execution messages</span>
<span class="sd">            and may include additional state information.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If input_data is invalid for new execution.</span>
<span class="sd">            GraphRecursionError: If execution exceeds recursion limit.</span>
<span class="sd">            Various exceptions: Depending on node execution failures.</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            # Basic execution</span>
<span class="sd">            result = compiled.invoke({&quot;messages&quot;: [Message.text_message(&quot;Process this data&quot;)]})</span>
<span class="sd">            print(result[&quot;messages&quot;])  # Final execution messages</span>

<span class="sd">            # With configuration and full details</span>
<span class="sd">            result = compiled.invoke(</span>
<span class="sd">                input_data={&quot;messages&quot;: [message]},</span>
<span class="sd">                config={&quot;user_id&quot;: &quot;user123&quot;, &quot;thread_id&quot;: &quot;session456&quot;, &quot;recursion_limit&quot;: 50},</span>
<span class="sd">                response_granularity=ResponseGranularity.FULL,</span>
<span class="sd">            )</span>
<span class="sd">            print(result[&quot;state&quot;])  # Complete final state</span>
<span class="sd">            ```</span>

<span class="sd">        Note:</span>
<span class="sd">            This method uses asyncio.run() internally, so it should not be called</span>
<span class="sd">            from within an async context. Use ainvoke() instead for async execution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Starting synchronous graph execution with </span><span class="si">%d</span><span class="s2"> input keys, granularity=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="k">if</span> <span class="n">input_data</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">response_granularity</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Input data keys: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">input_data</span> <span class="k">else</span> <span class="p">[])</span>
        <span class="c1"># Async Will Handle Event Publish</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">response_granularity</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Synchronous graph execution completed successfully&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Synchronous graph execution failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">ainvoke</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">response_granularity</span><span class="p">:</span> <span class="n">ResponseGranularity</span> <span class="o">=</span> <span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the graph asynchronously.</span>

<span class="sd">        Auto-detects whether to start fresh execution or resume from interrupted state</span>
<span class="sd">        based on the AgentState&#39;s execution metadata.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_data: Input dict with &#39;messages&#39; key (for new execution) or</span>
<span class="sd">                       additional data for resuming</span>
<span class="sd">            config: Configuration dictionary</span>
<span class="sd">            response_granularity: Response parsing granularity</span>

<span class="sd">        Returns:</span>
<span class="sd">            Response dict based on granularity</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">is_stream</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_invoke_handler</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
            <span class="n">input_data</span><span class="p">,</span>
            <span class="n">cfg</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">,</span>
            <span class="n">response_granularity</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Request the current graph execution to stop (sync helper).</span>

<span class="sd">        This sets a stop flag in the checkpointer&#39;s thread store keyed by thread_id.</span>
<span class="sd">        Handlers periodically check this flag and interrupt execution.</span>
<span class="sd">        Returns a small status dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">astop</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">astop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Request the current graph execution to stop (async).</span>

<span class="sd">        Contract:</span>
<span class="sd">        - Requires a valid thread_id in config</span>
<span class="sd">        - If no active thread or no checkpointer, returns not-running</span>
<span class="sd">        - If state exists and is running, set stop_requested flag in thread info</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">is_stream</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_stream&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;no-checkpointer&quot;</span><span class="p">}</span>

        <span class="c1"># Load state to see if this thread is running</span>
        <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="o">.</span><span class="n">aget_state_cache</span><span class="p">(</span>
            <span class="n">cfg</span>
        <span class="p">)</span> <span class="ow">or</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="o">.</span><span class="n">aget_state</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;running&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;no-state&quot;</span><span class="p">}</span>

        <span class="n">running</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">is_running</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">is_interrupted</span><span class="p">()</span>
        <span class="c1"># Set stop flag regardless; handlers will act if running</span>
        <span class="k">if</span> <span class="n">running</span><span class="p">:</span>
            <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">stop_current_execution</span> <span class="o">=</span> <span class="n">StopRequestStatus</span><span class="o">.</span><span class="n">STOP_REQUESTED</span>
            <span class="c1"># update cache</span>
            <span class="c1"># Cache update is enough; state will be picked up by running execution</span>
            <span class="c1"># As its running, cache will be available immediately</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="o">.</span><span class="n">aput_state_cache</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
            <span class="c1"># Fixme: consider putting to main state as well</span>
            <span class="c1"># await self._checkpointer.aput_state(cfg, state)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set stop_current_execution flag for thread_id: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;thread_id&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;running&quot;</span><span class="p">:</span> <span class="n">running</span><span class="p">}</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;No running execution to stop for thread_id: </span><span class="si">%s</span><span class="s2"> (running=</span><span class="si">%s</span><span class="s2">, interrupted=</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;thread_id&quot;</span><span class="p">),</span>
            <span class="n">running</span><span class="p">,</span>
            <span class="n">state</span><span class="o">.</span><span class="n">is_interrupted</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;running&quot;</span><span class="p">:</span> <span class="n">running</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;not-running&quot;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stream</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">response_granularity</span><span class="p">:</span> <span class="n">ResponseGranularity</span> <span class="o">=</span> <span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Message</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the graph synchronously with streaming support.</span>

<span class="sd">        Yields Message objects containing incremental responses.</span>
<span class="sd">        If nodes return streaming responses, yields them directly.</span>
<span class="sd">        If nodes return complete responses, simulates streaming by chunking.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_data: Input dict</span>
<span class="sd">            config: Configuration dictionary</span>
<span class="sd">            response_granularity: Response parsing granularity</span>

<span class="sd">        Yields:</span>
<span class="sd">            Message objects with incremental content</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># For sync streaming, we&#39;ll use asyncio.run to handle the async implementation</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_async_stream</span><span class="p">():</span>
            <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">astream</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">response_granularity</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">chunk</span>

        <span class="c1"># Convert async generator to sync iteration with a dedicated event loop</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="n">_async_stream</span><span class="p">()</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">new_event_loop</span><span class="p">()</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop_policy</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">previous_loop</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">previous_loop</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Synchronous streaming started&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">chunk</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">gen</span><span class="o">.</span><span class="fm">__anext__</span><span class="p">())</span>
                    <span class="k">yield</span> <span class="n">chunk</span>
                <span class="k">except</span> <span class="ne">StopAsyncIteration</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Attempt to close the async generator cleanly</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">gen</span><span class="o">.</span><span class="n">aclose</span><span class="p">())</span>  <span class="c1"># type: ignore[attr-defined]</span>
            <span class="c1"># Restore previous loop if any, then close created loop</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">previous_loop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="n">previous_loop</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Synchronous streaming completed&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">astream</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">response_granularity</span><span class="p">:</span> <span class="n">ResponseGranularity</span> <span class="o">=</span> <span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="n">Message</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the graph asynchronously with streaming support.</span>

<span class="sd">        Yields Message objects containing incremental responses.</span>
<span class="sd">        If nodes return streaming responses, yields them directly.</span>
<span class="sd">        If nodes return complete responses, simulates streaming by chunking.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_data: Input dict</span>
<span class="sd">            config: Configuration dictionary</span>
<span class="sd">            response_granularity: Response parsing granularity</span>

<span class="sd">        Yields:</span>
<span class="sd">            Message objects with incremental content</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">is_stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream_handler</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
            <span class="n">input_data</span><span class="p">,</span>
            <span class="n">cfg</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">,</span>
            <span class="n">response_granularity</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">yield</span> <span class="n">chunk</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aclose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close the graph and release any resources.&quot;&quot;&quot;</span>
        <span class="c1"># close checkpointer</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="o">.</span><span class="n">arelease</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checkpointer closed successfully&quot;</span><span class="p">)</span>
                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;checkpointer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;closed&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;checkpointer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error closing graph: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Close Publisher</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Publisher closed successfully&quot;</span><span class="p">)</span>
                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;publisher&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;closed&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;publisher&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error closing publisher: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Close Store</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">arelease</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Store closed successfully&quot;</span><span class="p">)</span>
                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;store&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;closed&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;store&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error closing store: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Wait for all background tasks to complete</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_manager</span><span class="o">.</span><span class="n">wait_for_all</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All background tasks completed successfully&quot;</span><span class="p">)</span>
            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;background_tasks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;completed&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;background_tasks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error waiting for background tasks: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Graph close stats: </span><span class="si">{</span><span class="n">stats</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># You can also return or process the stats as needed</span>
        <span class="k">return</span> <span class="n">stats</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate the graph representation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dictionary representing the graph structure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;info&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;nodes&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;edges&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>
        <span class="c1"># Populate the graph with nodes and edges</span>
        <span class="k">for</span> <span class="n">node_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()),</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">node_name</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
            <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;edges&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()),</span>
                    <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">from_node</span><span class="p">,</span>
                    <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">to_node</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="c1"># Add few more extra info</span>
        <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;node_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;edge_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;edges&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;checkpointer&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;checkpointer_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;publisher&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;store&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;interrupt_before&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interrupt_before</span><span class="p">,</span>
            <span class="s2">&quot;interrupt_after&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interrupt_after</span><span class="p">,</span>
            <span class="s2">&quot;context_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_graph</span><span class="o">.</span><span class="n">_context_manager</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="s2">&quot;id_generator&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_graph</span><span class="o">.</span><span class="n">_id_generator</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="s2">&quot;id_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_graph</span><span class="o">.</span><span class="n">_id_generator</span><span class="o">.</span><span class="n">id_type</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="s2">&quot;state_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="s2">&quot;state_fields&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">graph</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">








<h4 id="pyagenity.graph.CompiledGraph-functions">Functions<a href="#pyagenity.graph.CompiledGraph-functions" class="headerlink" title="Permanent link">&para;</a></h4>

<div class="doc doc-object doc-function">


<h5 id="pyagenity.graph.CompiledGraph.__init__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">__init__</span>


<a href="#pyagenity.graph.CompiledGraph.__init__" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">__init__</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">checkpointer</span><span class="p">,</span> <span class="n">publisher</span><span class="p">,</span> <span class="n">store</span><span class="p">,</span> <span class="n">state_graph</span><span class="p">,</span> <span class="n">interrupt_before</span><span class="p">,</span> <span class="n">interrupt_after</span><span class="p">,</span> <span class="n">task_manager</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/compiled_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">StateT</span><span class="p">,</span>
    <span class="n">checkpointer</span><span class="p">:</span> <span class="n">BaseCheckpointer</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">publisher</span><span class="p">:</span> <span class="n">BasePublisher</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">store</span><span class="p">:</span> <span class="n">BaseStore</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">state_graph</span><span class="p">:</span> <span class="n">StateGraph</span><span class="p">[</span><span class="n">StateT</span><span class="p">],</span>
    <span class="n">interrupt_before</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">interrupt_after</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">task_manager</span><span class="p">:</span> <span class="n">BackgroundTaskManager</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Initializing CompiledGraph with nodes: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">state_graph</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Save initial state</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">state</span>

    <span class="c1"># create handlers</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_invoke_handler</span><span class="p">:</span> <span class="n">InvokeHandler</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">=</span> <span class="n">InvokeHandler</span><span class="p">[</span><span class="n">StateT</span><span class="p">](</span>
        <span class="n">nodes</span><span class="o">=</span><span class="n">state_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
        <span class="n">edges</span><span class="o">=</span><span class="n">state_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_stream_handler</span><span class="p">:</span> <span class="n">StreamHandler</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">=</span> <span class="n">StreamHandler</span><span class="p">[</span><span class="n">StateT</span><span class="p">](</span>
        <span class="n">nodes</span><span class="o">=</span><span class="n">state_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
        <span class="n">edges</span><span class="o">=</span><span class="n">state_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="p">:</span> <span class="n">BaseCheckpointer</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">checkpointer</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span><span class="p">:</span> <span class="n">BasePublisher</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">publisher</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">:</span> <span class="n">BaseStore</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">store</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_state_graph</span><span class="p">:</span> <span class="n">StateGraph</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">=</span> <span class="n">state_graph</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_interrupt_before</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">interrupt_before</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_interrupt_after</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">interrupt_after</span>
    <span class="c1"># generate task manager</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_task_manager</span> <span class="o">=</span> <span class="n">task_manager</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="pyagenity.graph.CompiledGraph.aclose" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">aclose</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.CompiledGraph.aclose" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">aclose</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Close the graph and release any resources.</p>


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/compiled_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aclose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Close the graph and release any resources.&quot;&quot;&quot;</span>
    <span class="c1"># close checkpointer</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="o">.</span><span class="n">arelease</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checkpointer closed successfully&quot;</span><span class="p">)</span>
            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;checkpointer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;closed&quot;</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;checkpointer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error closing graph: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Close Publisher</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Publisher closed successfully&quot;</span><span class="p">)</span>
            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;publisher&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;closed&quot;</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;publisher&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error closing publisher: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Close Store</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">arelease</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Store closed successfully&quot;</span><span class="p">)</span>
            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;store&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;closed&quot;</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;store&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error closing store: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Wait for all background tasks to complete</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_manager</span><span class="o">.</span><span class="n">wait_for_all</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All background tasks completed successfully&quot;</span><span class="p">)</span>
        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;background_tasks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;completed&quot;</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;background_tasks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error waiting for background tasks: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Graph close stats: </span><span class="si">{</span><span class="n">stats</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># You can also return or process the stats as needed</span>
    <span class="k">return</span> <span class="n">stats</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="pyagenity.graph.CompiledGraph.ainvoke" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">ainvoke</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.CompiledGraph.ainvoke" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">ainvoke</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">response_granularity</span><span class="o">=</span><span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Execute the graph asynchronously.</p>
<p>Auto-detects whether to start fresh execution or resume from interrupted state
based on the AgentState's execution metadata.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.CompiledGraph.ainvoke(input_data)" class="doc doc-heading doc-heading-parameter">                  <code>input_data</code>
<a href="#pyagenity.graph.CompiledGraph.ainvoke(input_data)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input dict with 'messages' key (for new execution) or
       additional data for resuming</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.CompiledGraph.ainvoke(config)" class="doc doc-heading doc-heading-parameter">                  <code>config</code>
<a href="#pyagenity.graph.CompiledGraph.ainvoke(config)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration dictionary</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.CompiledGraph.ainvoke(response_granularity)" class="doc doc-heading doc-heading-parameter">                  <code>response_granularity</code>
<a href="#pyagenity.graph.CompiledGraph.ainvoke(response_granularity)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            ResponseGranularity (pyagenity.utils.ResponseGranularity)" href="../#pyagenity.utils.ResponseGranularity">ResponseGranularity</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Response parsing granularity</p>
              </div>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            LOW


  
      class-attribute
      instance-attribute
   (pyagenity.utils.ResponseGranularity.LOW)" href="../#pyagenity.utils.ResponseGranularity.LOW">LOW</a></code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Response dict based on granularity</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/compiled_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">ainvoke</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">response_granularity</span><span class="p">:</span> <span class="n">ResponseGranularity</span> <span class="o">=</span> <span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the graph asynchronously.</span>

<span class="sd">    Auto-detects whether to start fresh execution or resume from interrupted state</span>
<span class="sd">    based on the AgentState&#39;s execution metadata.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_data: Input dict with &#39;messages&#39; key (for new execution) or</span>
<span class="sd">                   additional data for resuming</span>
<span class="sd">        config: Configuration dictionary</span>
<span class="sd">        response_granularity: Response parsing granularity</span>

<span class="sd">    Returns:</span>
<span class="sd">        Response dict based on granularity</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">is_stream</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_invoke_handler</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
        <span class="n">input_data</span><span class="p">,</span>
        <span class="n">cfg</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">,</span>
        <span class="n">response_granularity</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="pyagenity.graph.CompiledGraph.astop" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">astop</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.CompiledGraph.astop" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">astop</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Request the current graph execution to stop (async).</p>
<p>Contract:
- Requires a valid thread_id in config
- If no active thread or no checkpointer, returns not-running
- If state exists and is running, set stop_requested flag in thread info</p>


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/compiled_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">astop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Request the current graph execution to stop (async).</span>

<span class="sd">    Contract:</span>
<span class="sd">    - Requires a valid thread_id in config</span>
<span class="sd">    - If no active thread or no checkpointer, returns not-running</span>
<span class="sd">    - If state exists and is running, set stop_requested flag in thread info</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">is_stream</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_stream&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;no-checkpointer&quot;</span><span class="p">}</span>

    <span class="c1"># Load state to see if this thread is running</span>
    <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="o">.</span><span class="n">aget_state_cache</span><span class="p">(</span>
        <span class="n">cfg</span>
    <span class="p">)</span> <span class="ow">or</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="o">.</span><span class="n">aget_state</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;running&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;no-state&quot;</span><span class="p">}</span>

    <span class="n">running</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">is_running</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">is_interrupted</span><span class="p">()</span>
    <span class="c1"># Set stop flag regardless; handlers will act if running</span>
    <span class="k">if</span> <span class="n">running</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">stop_current_execution</span> <span class="o">=</span> <span class="n">StopRequestStatus</span><span class="o">.</span><span class="n">STOP_REQUESTED</span>
        <span class="c1"># update cache</span>
        <span class="c1"># Cache update is enough; state will be picked up by running execution</span>
        <span class="c1"># As its running, cache will be available immediately</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="o">.</span><span class="n">aput_state_cache</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="c1"># Fixme: consider putting to main state as well</span>
        <span class="c1"># await self._checkpointer.aput_state(cfg, state)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set stop_current_execution flag for thread_id: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;thread_id&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;running&quot;</span><span class="p">:</span> <span class="n">running</span><span class="p">}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;No running execution to stop for thread_id: </span><span class="si">%s</span><span class="s2"> (running=</span><span class="si">%s</span><span class="s2">, interrupted=</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;thread_id&quot;</span><span class="p">),</span>
        <span class="n">running</span><span class="p">,</span>
        <span class="n">state</span><span class="o">.</span><span class="n">is_interrupted</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;running&quot;</span><span class="p">:</span> <span class="n">running</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;not-running&quot;</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="pyagenity.graph.CompiledGraph.astream" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">astream</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.CompiledGraph.astream" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">astream</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">response_granularity</span><span class="o">=</span><span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Execute the graph asynchronously with streaming support.</p>
<p>Yields Message objects containing incremental responses.
If nodes return streaming responses, yields them directly.
If nodes return complete responses, simulates streaming by chunking.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.CompiledGraph.astream(input_data)" class="doc doc-heading doc-heading-parameter">                  <code>input_data</code>
<a href="#pyagenity.graph.CompiledGraph.astream(input_data)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input dict</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.CompiledGraph.astream(config)" class="doc doc-heading doc-heading-parameter">                  <code>config</code>
<a href="#pyagenity.graph.CompiledGraph.astream(config)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration dictionary</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.CompiledGraph.astream(response_granularity)" class="doc doc-heading doc-heading-parameter">                  <code>response_granularity</code>
<a href="#pyagenity.graph.CompiledGraph.astream(response_granularity)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            ResponseGranularity (pyagenity.utils.ResponseGranularity)" href="../#pyagenity.utils.ResponseGranularity">ResponseGranularity</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Response parsing granularity</p>
              </div>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            LOW


  
      class-attribute
      instance-attribute
   (pyagenity.utils.ResponseGranularity.LOW)" href="../#pyagenity.utils.ResponseGranularity.LOW">LOW</a></code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Yields:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="collections.abc.AsyncIterator">AsyncIterator</span>[<a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.message.Message)" href="../#pyagenity.utils.message.Message">Message</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Message objects with incremental content</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/compiled_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">astream</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">response_granularity</span><span class="p">:</span> <span class="n">ResponseGranularity</span> <span class="o">=</span> <span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="n">Message</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the graph asynchronously with streaming support.</span>

<span class="sd">    Yields Message objects containing incremental responses.</span>
<span class="sd">    If nodes return streaming responses, yields them directly.</span>
<span class="sd">    If nodes return complete responses, simulates streaming by chunking.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_data: Input dict</span>
<span class="sd">        config: Configuration dictionary</span>
<span class="sd">        response_granularity: Response parsing granularity</span>

<span class="sd">    Yields:</span>
<span class="sd">        Message objects with incremental content</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">is_stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream_handler</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
        <span class="n">input_data</span><span class="p">,</span>
        <span class="n">cfg</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">,</span>
        <span class="n">response_granularity</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">yield</span> <span class="n">chunk</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="pyagenity.graph.CompiledGraph.generate_graph" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">generate_graph</span>


<a href="#pyagenity.graph.CompiledGraph.generate_graph" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">generate_graph</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Generate the graph representation.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary representing the graph structure.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/compiled_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate the graph representation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary representing the graph structure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;info&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;nodes&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;edges&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>
    <span class="c1"># Populate the graph with nodes and edges</span>
    <span class="k">for</span> <span class="n">node_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
        <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()),</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">node_name</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
        <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;edges&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()),</span>
                <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">from_node</span><span class="p">,</span>
                <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">to_node</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="c1"># Add few more extra info</span>
    <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;node_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;edge_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;edges&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;checkpointer&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;checkpointer_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;publisher&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;store&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;interrupt_before&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interrupt_before</span><span class="p">,</span>
        <span class="s2">&quot;interrupt_after&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interrupt_after</span><span class="p">,</span>
        <span class="s2">&quot;context_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_graph</span><span class="o">.</span><span class="n">_context_manager</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="s2">&quot;id_generator&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_graph</span><span class="o">.</span><span class="n">_id_generator</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="s2">&quot;id_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_graph</span><span class="o">.</span><span class="n">_id_generator</span><span class="o">.</span><span class="n">id_type</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="s2">&quot;state_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="s2">&quot;state_fields&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">graph</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="pyagenity.graph.CompiledGraph.invoke" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">invoke</span>


<a href="#pyagenity.graph.CompiledGraph.invoke" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">invoke</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">response_granularity</span><span class="o">=</span><span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Execute the graph synchronously and return the final results.</p>
<p>Runs the complete graph workflow from start to finish, handling state
management, node execution, and result formatting. This method automatically
detects whether to start a fresh execution or resume from an interrupted state.</p>
<p>The execution is synchronous but internally uses async operations, making it
suitable for use in non-async contexts while still benefiting from async
capabilities for I/O operations.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.CompiledGraph.invoke(input_data)" class="doc doc-heading doc-heading-parameter">                  <code>input_data</code>
<a href="#pyagenity.graph.CompiledGraph.invoke(input_data)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input dictionary for graph execution. For new executions,
should contain 'messages' key with list of initial messages.
For resumed executions, can contain additional data to merge.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.CompiledGraph.invoke(config)" class="doc doc-heading doc-heading-parameter">                  <code>config</code>
<a href="#pyagenity.graph.CompiledGraph.invoke(config)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional configuration dictionary containing execution settings:
- user_id: Identifier for the user/session
- thread_id: Unique identifier for this execution thread
- run_id: Unique identifier for this specific run
- recursion_limit: Maximum steps before stopping (default: 25)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.CompiledGraph.invoke(response_granularity)" class="doc doc-heading doc-heading-parameter">                  <code>response_granularity</code>
<a href="#pyagenity.graph.CompiledGraph.invoke(response_granularity)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            ResponseGranularity (pyagenity.utils.ResponseGranularity)" href="../#pyagenity.utils.ResponseGranularity">ResponseGranularity</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Level of detail in the response:
- LOW: Returns only messages (default)
- PARTIAL: Returns context, summary, and messages
- FULL: Returns complete state and messages</p>
              </div>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            LOW


  
      class-attribute
      instance-attribute
   (pyagenity.utils.ResponseGranularity.LOW)" href="../#pyagenity.utils.ResponseGranularity.LOW">LOW</a></code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing execution results formatted according to the</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>specified granularity level. Always includes execution messages</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>and may include additional state information.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If input_data is invalid for new execution.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="GraphRecursionError">GraphRecursionError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If execution exceeds recursion limit.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code>Various exceptions</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Depending on node execution failures.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="c1"># Basic execution</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">compiled</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Message</span><span class="o">.</span><span class="n">text_message</span><span class="p">(</span><span class="s2">&quot;Process this data&quot;</span><span class="p">)]})</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">])</span>  <span class="c1"># Final execution messages</span>

<span class="c1"># With configuration and full details</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">compiled</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
    <span class="n">input_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">message</span><span class="p">]},</span>
    <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;user123&quot;</span><span class="p">,</span> <span class="s2">&quot;thread_id&quot;</span><span class="p">:</span> <span class="s2">&quot;session456&quot;</span><span class="p">,</span> <span class="s2">&quot;recursion_limit&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">},</span>
    <span class="n">response_granularity</span><span class="o">=</span><span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">FULL</span><span class="p">,</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">])</span>  <span class="c1"># Complete final state</span>
</code></pre></div>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>This method uses asyncio.run() internally, so it should not be called
from within an async context. Use ainvoke() instead for async execution.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/compiled_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">response_granularity</span><span class="p">:</span> <span class="n">ResponseGranularity</span> <span class="o">=</span> <span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the graph synchronously and return the final results.</span>

<span class="sd">    Runs the complete graph workflow from start to finish, handling state</span>
<span class="sd">    management, node execution, and result formatting. This method automatically</span>
<span class="sd">    detects whether to start a fresh execution or resume from an interrupted state.</span>

<span class="sd">    The execution is synchronous but internally uses async operations, making it</span>
<span class="sd">    suitable for use in non-async contexts while still benefiting from async</span>
<span class="sd">    capabilities for I/O operations.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_data: Input dictionary for graph execution. For new executions,</span>
<span class="sd">            should contain &#39;messages&#39; key with list of initial messages.</span>
<span class="sd">            For resumed executions, can contain additional data to merge.</span>
<span class="sd">        config: Optional configuration dictionary containing execution settings:</span>
<span class="sd">            - user_id: Identifier for the user/session</span>
<span class="sd">            - thread_id: Unique identifier for this execution thread</span>
<span class="sd">            - run_id: Unique identifier for this specific run</span>
<span class="sd">            - recursion_limit: Maximum steps before stopping (default: 25)</span>
<span class="sd">        response_granularity: Level of detail in the response:</span>
<span class="sd">            - LOW: Returns only messages (default)</span>
<span class="sd">            - PARTIAL: Returns context, summary, and messages</span>
<span class="sd">            - FULL: Returns complete state and messages</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary containing execution results formatted according to the</span>
<span class="sd">        specified granularity level. Always includes execution messages</span>
<span class="sd">        and may include additional state information.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If input_data is invalid for new execution.</span>
<span class="sd">        GraphRecursionError: If execution exceeds recursion limit.</span>
<span class="sd">        Various exceptions: Depending on node execution failures.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        # Basic execution</span>
<span class="sd">        result = compiled.invoke({&quot;messages&quot;: [Message.text_message(&quot;Process this data&quot;)]})</span>
<span class="sd">        print(result[&quot;messages&quot;])  # Final execution messages</span>

<span class="sd">        # With configuration and full details</span>
<span class="sd">        result = compiled.invoke(</span>
<span class="sd">            input_data={&quot;messages&quot;: [message]},</span>
<span class="sd">            config={&quot;user_id&quot;: &quot;user123&quot;, &quot;thread_id&quot;: &quot;session456&quot;, &quot;recursion_limit&quot;: 50},</span>
<span class="sd">            response_granularity=ResponseGranularity.FULL,</span>
<span class="sd">        )</span>
<span class="sd">        print(result[&quot;state&quot;])  # Complete final state</span>
<span class="sd">        ```</span>

<span class="sd">    Note:</span>
<span class="sd">        This method uses asyncio.run() internally, so it should not be called</span>
<span class="sd">        from within an async context. Use ainvoke() instead for async execution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Starting synchronous graph execution with </span><span class="si">%d</span><span class="s2"> input keys, granularity=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="k">if</span> <span class="n">input_data</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">response_granularity</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Input data keys: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">input_data</span> <span class="k">else</span> <span class="p">[])</span>
    <span class="c1"># Async Will Handle Event Publish</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">response_granularity</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Synchronous graph execution completed successfully&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Synchronous graph execution failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="pyagenity.graph.CompiledGraph.stop" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">stop</span>


<a href="#pyagenity.graph.CompiledGraph.stop" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">stop</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Request the current graph execution to stop (sync helper).</p>
<p>This sets a stop flag in the checkpointer's thread store keyed by thread_id.
Handlers periodically check this flag and interrupt execution.
Returns a small status dict.</p>


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/compiled_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Request the current graph execution to stop (sync helper).</span>

<span class="sd">    This sets a stop flag in the checkpointer&#39;s thread store keyed by thread_id.</span>
<span class="sd">    Handlers periodically check this flag and interrupt execution.</span>
<span class="sd">    Returns a small status dict.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">astop</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="pyagenity.graph.CompiledGraph.stream" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">stream</span>


<a href="#pyagenity.graph.CompiledGraph.stream" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">stream</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">response_granularity</span><span class="o">=</span><span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Execute the graph synchronously with streaming support.</p>
<p>Yields Message objects containing incremental responses.
If nodes return streaming responses, yields them directly.
If nodes return complete responses, simulates streaming by chunking.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.CompiledGraph.stream(input_data)" class="doc doc-heading doc-heading-parameter">                  <code>input_data</code>
<a href="#pyagenity.graph.CompiledGraph.stream(input_data)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input dict</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.CompiledGraph.stream(config)" class="doc doc-heading doc-heading-parameter">                  <code>config</code>
<a href="#pyagenity.graph.CompiledGraph.stream(config)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration dictionary</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.CompiledGraph.stream(response_granularity)" class="doc doc-heading doc-heading-parameter">                  <code>response_granularity</code>
<a href="#pyagenity.graph.CompiledGraph.stream(response_granularity)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            ResponseGranularity (pyagenity.utils.ResponseGranularity)" href="../#pyagenity.utils.ResponseGranularity">ResponseGranularity</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Response parsing granularity</p>
              </div>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            LOW


  
      class-attribute
      instance-attribute
   (pyagenity.utils.ResponseGranularity.LOW)" href="../#pyagenity.utils.ResponseGranularity.LOW">LOW</a></code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Yields:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="collections.abc.Generator">Generator</span>[<a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.message.Message)" href="../#pyagenity.utils.message.Message">Message</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Message objects with incremental content</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/compiled_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">stream</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">response_granularity</span><span class="p">:</span> <span class="n">ResponseGranularity</span> <span class="o">=</span> <span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Message</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the graph synchronously with streaming support.</span>

<span class="sd">    Yields Message objects containing incremental responses.</span>
<span class="sd">    If nodes return streaming responses, yields them directly.</span>
<span class="sd">    If nodes return complete responses, simulates streaming by chunking.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_data: Input dict</span>
<span class="sd">        config: Configuration dictionary</span>
<span class="sd">        response_granularity: Response parsing granularity</span>

<span class="sd">    Yields:</span>
<span class="sd">        Message objects with incremental content</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># For sync streaming, we&#39;ll use asyncio.run to handle the async implementation</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_async_stream</span><span class="p">():</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">astream</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">response_granularity</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">chunk</span>

    <span class="c1"># Convert async generator to sync iteration with a dedicated event loop</span>
    <span class="n">gen</span> <span class="o">=</span> <span class="n">_async_stream</span><span class="p">()</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">new_event_loop</span><span class="p">()</span>
    <span class="n">policy</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop_policy</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">previous_loop</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">previous_loop</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Synchronous streaming started&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">gen</span><span class="o">.</span><span class="fm">__anext__</span><span class="p">())</span>
                <span class="k">yield</span> <span class="n">chunk</span>
            <span class="k">except</span> <span class="ne">StopAsyncIteration</span><span class="p">:</span>
                <span class="k">break</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Attempt to close the async generator cleanly</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">gen</span><span class="o">.</span><span class="n">aclose</span><span class="p">())</span>  <span class="c1"># type: ignore[attr-defined]</span>
        <span class="c1"># Restore previous loop if any, then close created loop</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">previous_loop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="n">previous_loop</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Synchronous streaming completed&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="pyagenity.graph.Edge" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">Edge</span>


<a href="#pyagenity.graph.Edge" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">


        <p>Represents a connection between two nodes in a graph workflow.</p>
<p>An Edge defines the relationship and routing logic between nodes, specifying
how execution should flow from one node to another. Edges can be either
static (unconditional) or conditional based on runtime state evaluation.</p>
<p>Edges support complex routing scenarios including:
- Simple static connections between nodes
- Conditional routing based on state evaluation
- Dynamic routing with multiple possible destinations
- Decision trees and branching logic</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            from_node


  
      instance-attribute
   (pyagenity.graph.Edge.from_node)" href="../#pyagenity.graph.Edge.from_node">from_node</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the source node where execution originates.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            to_node


  
      instance-attribute
   (pyagenity.graph.Edge.to_node)" href="../#pyagenity.graph.Edge.to_node">to_node</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the destination node where execution continues.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            condition


  
      instance-attribute
   (pyagenity.graph.Edge.condition)" href="../#pyagenity.graph.Edge.condition">condition</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional callable that determines if this edge should be
followed. If None, the edge is always followed (static edge).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            condition_result


  
      instance-attribute
   (pyagenity.graph.Edge.condition_result)" href="../#pyagenity.graph.Edge.condition_result">condition_result</a></code></td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional value to match against condition result
for mapped conditional edges.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="c1"># Static edge - always followed</span>
<span class="n">static_edge</span> <span class="o">=</span> <span class="n">Edge</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;process&quot;</span><span class="p">)</span>


<span class="c1"># Conditional edge - followed only if condition returns True</span>
<span class="k">def</span><span class="w"> </span><span class="nf">needs_approval</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;requires_approval&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>


<span class="n">conditional_edge</span> <span class="o">=</span> <span class="n">Edge</span><span class="p">(</span><span class="s2">&quot;process&quot;</span><span class="p">,</span> <span class="s2">&quot;approval&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="n">needs_approval</span><span class="p">)</span>


<span class="c1"># Mapped conditional edge - follows based on specific condition result</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_priority</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;priority&quot;</span><span class="p">,</span> <span class="s2">&quot;normal&quot;</span><span class="p">)</span>


<span class="n">high_priority_edge</span> <span class="o">=</span> <span class="n">Edge</span><span class="p">(</span><span class="s2">&quot;triage&quot;</span><span class="p">,</span> <span class="s2">&quot;urgent&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="n">get_priority</span><span class="p">)</span>
<span class="n">high_priority_edge</span><span class="o">.</span><span class="n">condition_result</span> <span class="o">=</span> <span class="s2">&quot;high&quot;</span>
</code></pre></div>
</details>











<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            __init__ (pyagenity.graph.Edge.__init__)" href="../#pyagenity.graph.Edge.__init__">__init__</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Initialize a new Edge with source, destination, and optional condition.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>



              <details class="quote">
                <summary>Source code in <code>pyagenity/graph/edge.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Edge</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a connection between two nodes in a graph workflow.</span>

<span class="sd">    An Edge defines the relationship and routing logic between nodes, specifying</span>
<span class="sd">    how execution should flow from one node to another. Edges can be either</span>
<span class="sd">    static (unconditional) or conditional based on runtime state evaluation.</span>

<span class="sd">    Edges support complex routing scenarios including:</span>
<span class="sd">    - Simple static connections between nodes</span>
<span class="sd">    - Conditional routing based on state evaluation</span>
<span class="sd">    - Dynamic routing with multiple possible destinations</span>
<span class="sd">    - Decision trees and branching logic</span>

<span class="sd">    Attributes:</span>
<span class="sd">        from_node: Name of the source node where execution originates.</span>
<span class="sd">        to_node: Name of the destination node where execution continues.</span>
<span class="sd">        condition: Optional callable that determines if this edge should be</span>
<span class="sd">            followed. If None, the edge is always followed (static edge).</span>
<span class="sd">        condition_result: Optional value to match against condition result</span>
<span class="sd">            for mapped conditional edges.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        # Static edge - always followed</span>
<span class="sd">        static_edge = Edge(&quot;start&quot;, &quot;process&quot;)</span>


<span class="sd">        # Conditional edge - followed only if condition returns True</span>
<span class="sd">        def needs_approval(state):</span>
<span class="sd">            return state.data.get(&quot;requires_approval&quot;, False)</span>


<span class="sd">        conditional_edge = Edge(&quot;process&quot;, &quot;approval&quot;, condition=needs_approval)</span>


<span class="sd">        # Mapped conditional edge - follows based on specific condition result</span>
<span class="sd">        def get_priority(state):</span>
<span class="sd">            return state.data.get(&quot;priority&quot;, &quot;normal&quot;)</span>


<span class="sd">        high_priority_edge = Edge(&quot;triage&quot;, &quot;urgent&quot;, condition=get_priority)</span>
<span class="sd">        high_priority_edge.condition_result = &quot;high&quot;</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">from_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">to_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">condition</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a new Edge with source, destination, and optional condition.</span>

<span class="sd">        Args:</span>
<span class="sd">            from_node: Name of the source node. Must match a node name in the graph.</span>
<span class="sd">            to_node: Name of the destination node. Must match a node name in the graph</span>
<span class="sd">                or be a special constant like END.</span>
<span class="sd">            condition: Optional callable that takes an AgentState as argument and</span>
<span class="sd">                returns a value to determine if this edge should be followed.</span>
<span class="sd">                If None, this is a static edge that&#39;s always followed.</span>

<span class="sd">        Note:</span>
<span class="sd">            The condition function should be deterministic and side-effect free</span>
<span class="sd">            for predictable execution behavior. It receives the current AgentState</span>
<span class="sd">            and should return a boolean (for simple conditions) or a string/value</span>
<span class="sd">            (for mapped conditional routing).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Creating edge from &#39;</span><span class="si">%s</span><span class="s2">&#39; to &#39;</span><span class="si">%s</span><span class="s2">&#39; with condition=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">from_node</span><span class="p">,</span>
            <span class="n">to_node</span><span class="p">,</span>
            <span class="s2">&quot;yes&quot;</span> <span class="k">if</span> <span class="n">condition</span> <span class="k">else</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">from_node</span> <span class="o">=</span> <span class="n">from_node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to_node</span> <span class="o">=</span> <span class="n">to_node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">=</span> <span class="n">condition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">condition_result</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">





<h4 id="pyagenity.graph.Edge-attributes">Attributes<a href="#pyagenity.graph.Edge-attributes" class="headerlink" title="Permanent link">&para;</a></h4>

<div class="doc doc-object doc-attribute">



<h5 id="pyagenity.graph.Edge.condition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">condition</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.Edge.condition" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">condition</span> <span class="o">=</span> <span class="n">condition</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="pyagenity.graph.Edge.condition_result" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">condition_result</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.Edge.condition_result" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">condition_result</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="pyagenity.graph.Edge.from_node" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">from_node</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.Edge.from_node" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">from_node</span> <span class="o">=</span> <span class="n">from_node</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="pyagenity.graph.Edge.to_node" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">to_node</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.Edge.to_node" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">to_node</span> <span class="o">=</span> <span class="n">to_node</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>


<h4 id="pyagenity.graph.Edge-functions">Functions<a href="#pyagenity.graph.Edge-functions" class="headerlink" title="Permanent link">&para;</a></h4>

<div class="doc doc-object doc-function">


<h5 id="pyagenity.graph.Edge.__init__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">__init__</span>


<a href="#pyagenity.graph.Edge.__init__" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">__init__</span><span class="p">(</span><span class="n">from_node</span><span class="p">,</span> <span class="n">to_node</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Initialize a new Edge with source, destination, and optional condition.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.Edge.__init__(from_node)" class="doc doc-heading doc-heading-parameter">                  <code>from_node</code>
<a href="#pyagenity.graph.Edge.__init__(from_node)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the source node. Must match a node name in the graph.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.Edge.__init__(to_node)" class="doc doc-heading doc-heading-parameter">                  <code>to_node</code>
<a href="#pyagenity.graph.Edge.__init__(to_node)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the destination node. Must match a node name in the graph
or be a special constant like END.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.Edge.__init__(condition)" class="doc doc-heading doc-heading-parameter">                  <code>condition</code>
<a href="#pyagenity.graph.Edge.__init__(condition)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="collections.abc.Callable">Callable</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional callable that takes an AgentState as argument and
returns a value to determine if this edge should be followed.
If None, this is a static edge that's always followed.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>The condition function should be deterministic and side-effect free
for predictable execution behavior. It receives the current AgentState
and should return a boolean (for simple conditions) or a string/value
(for mapped conditional routing).</p>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/edge.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">from_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">to_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">condition</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize a new Edge with source, destination, and optional condition.</span>

<span class="sd">    Args:</span>
<span class="sd">        from_node: Name of the source node. Must match a node name in the graph.</span>
<span class="sd">        to_node: Name of the destination node. Must match a node name in the graph</span>
<span class="sd">            or be a special constant like END.</span>
<span class="sd">        condition: Optional callable that takes an AgentState as argument and</span>
<span class="sd">            returns a value to determine if this edge should be followed.</span>
<span class="sd">            If None, this is a static edge that&#39;s always followed.</span>

<span class="sd">    Note:</span>
<span class="sd">        The condition function should be deterministic and side-effect free</span>
<span class="sd">        for predictable execution behavior. It receives the current AgentState</span>
<span class="sd">        and should return a boolean (for simple conditions) or a string/value</span>
<span class="sd">        (for mapped conditional routing).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;Creating edge from &#39;</span><span class="si">%s</span><span class="s2">&#39; to &#39;</span><span class="si">%s</span><span class="s2">&#39; with condition=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">from_node</span><span class="p">,</span>
        <span class="n">to_node</span><span class="p">,</span>
        <span class="s2">&quot;yes&quot;</span> <span class="k">if</span> <span class="n">condition</span> <span class="k">else</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">from_node</span> <span class="o">=</span> <span class="n">from_node</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">to_node</span> <span class="o">=</span> <span class="n">to_node</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">=</span> <span class="n">condition</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">condition_result</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="pyagenity.graph.Node" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">Node</span>


<a href="#pyagenity.graph.Node" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">


        <p>Represents a node in the graph workflow.</p>
<p>A Node encapsulates a function or ToolNode that can be executed as part of
a graph workflow. It handles dependency injection, parameter mapping, and
execution context management.</p>
<p>The Node class supports both regular callable functions and ToolNode instances
for handling tool-based operations. It automatically injects dependencies
based on function signatures and provides legacy parameter support.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            name


  
      instance-attribute
   (pyagenity.graph.Node.name)" href="../#pyagenity.graph.Node.name">name</a></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique identifier for the node within the graph.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            func


  
      instance-attribute
   (pyagenity.graph.Node.func)" href="../#pyagenity.graph.Node.func">func</a></code></td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="collections.abc.Callable">Callable</span>, <a class="autorefs autorefs-internal" title="            ToolNode (pyagenity.graph.tool_node.ToolNode)" href="../#pyagenity.graph.tool_node.ToolNode">ToolNode</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The function or ToolNode to execute.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>def my_function(state, config):
...     return {"result": "processed"}
node = Node("processor", my_function)
result = await node.execute(state, config)</p>
</blockquote>
</blockquote>
</blockquote>
</details>











<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            __init__ (pyagenity.graph.Node.__init__)" href="../#pyagenity.graph.Node.__init__">__init__</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Initialize a new Node instance with function and dependencies.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            execute


  
      async
   (pyagenity.graph.Node.execute)" href="../#pyagenity.graph.Node.execute">execute</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Execute the node function with comprehensive context and callback support.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            stream


  
      async
   (pyagenity.graph.Node.stream)" href="../#pyagenity.graph.Node.stream">stream</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Execute the node function with streaming output support.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>



              <details class="quote">
                <summary>Source code in <code>pyagenity/graph/node.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Node</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a node in the graph workflow.</span>

<span class="sd">    A Node encapsulates a function or ToolNode that can be executed as part of</span>
<span class="sd">    a graph workflow. It handles dependency injection, parameter mapping, and</span>
<span class="sd">    execution context management.</span>

<span class="sd">    The Node class supports both regular callable functions and ToolNode instances</span>
<span class="sd">    for handling tool-based operations. It automatically injects dependencies</span>
<span class="sd">    based on function signatures and provides legacy parameter support.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        name (str): Unique identifier for the node within the graph.</span>
<span class="sd">        func (Union[Callable, ToolNode]): The function or ToolNode to execute.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; def my_function(state, config):</span>
<span class="sd">        ...     return {&quot;result&quot;: &quot;processed&quot;}</span>
<span class="sd">        &gt;&gt;&gt; node = Node(&quot;processor&quot;, my_function)</span>
<span class="sd">        &gt;&gt;&gt; result = await node.execute(state, config)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">func</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="s2">&quot;ToolNode&quot;</span><span class="p">],</span>
        <span class="n">publisher</span><span class="p">:</span> <span class="n">BasePublisher</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">BasePublisher</span><span class="p">],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a new Node instance with function and dependencies.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: Unique identifier for the node within the graph. This name</span>
<span class="sd">                is used for routing, logging, and referencing the node in</span>
<span class="sd">                graph configuration.</span>
<span class="sd">            func: The function or ToolNode to execute when this node is called.</span>
<span class="sd">                Functions should accept at least &#39;state&#39; and &#39;config&#39; parameters.</span>
<span class="sd">                ToolNode instances handle tool-based operations and provide</span>
<span class="sd">                their own execution logic.</span>
<span class="sd">            publisher: Optional event publisher for execution monitoring.</span>
<span class="sd">                Injected via dependency injection if not explicitly provided.</span>
<span class="sd">                Used for publishing node execution events and status updates.</span>

<span class="sd">        Note:</span>
<span class="sd">            The function signature is automatically analyzed to determine</span>
<span class="sd">            required parameters and dependency injection points. Parameters</span>
<span class="sd">            matching injectable service names will be automatically provided</span>
<span class="sd">            by the framework during execution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Initializing node &#39;</span><span class="si">%s</span><span class="s2">&#39; with func=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">publisher</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">invoke_handler</span> <span class="o">=</span> <span class="n">InvokeNodeHandler</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">func</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stream_handler</span> <span class="o">=</span> <span class="n">StreamNodeHandler</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">func</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
        <span class="n">callback_mgr</span><span class="p">:</span> <span class="n">CallbackManager</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">Message</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the node function with comprehensive context and callback support.</span>

<span class="sd">        Executes the node&#39;s function or ToolNode with full dependency injection,</span>
<span class="sd">        callback hook execution, and error handling. This method provides the</span>
<span class="sd">        complete execution environment including state access, configuration,</span>
<span class="sd">        and injected services.</span>

<span class="sd">        Args:</span>
<span class="sd">            config: Configuration dictionary containing execution context,</span>
<span class="sd">                user settings, thread identification, and runtime parameters.</span>
<span class="sd">            state: Current AgentState providing workflow context, message history,</span>
<span class="sd">                and shared state information accessible to the node function.</span>
<span class="sd">            callback_mgr: Callback manager for executing pre/post execution hooks.</span>
<span class="sd">                Injected via dependency injection if not explicitly provided.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Either a dictionary containing updated state and execution results,</span>
<span class="sd">            or a list of Message objects representing the node&#39;s output.</span>
<span class="sd">            The return type depends on the node function&#39;s implementation.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Various exceptions depending on node function behavior. All exceptions</span>
<span class="sd">            are handled by the callback manager&#39;s error handling hooks before</span>
<span class="sd">            being propagated.</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            # Node function that returns messages</span>
<span class="sd">            def process_data(state, config):</span>
<span class="sd">                result = process(state.data)</span>
<span class="sd">                return [Message.text_message(f&quot;Processed: {result}&quot;)]</span>


<span class="sd">            node = Node(&quot;processor&quot;, process_data)</span>
<span class="sd">            messages = await node.execute(config, state)</span>
<span class="sd">            ```</span>

<span class="sd">        Note:</span>
<span class="sd">            The node function receives dependency-injected parameters based on</span>
<span class="sd">            its signature. Common injectable parameters include &#39;state&#39;, &#39;config&#39;,</span>
<span class="sd">            &#39;context_manager&#39;, &#39;publisher&#39;, and other framework services.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">invoke_handler</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">state</span><span class="p">,</span>
            <span class="n">callback_mgr</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
        <span class="n">callback_mgr</span><span class="p">:</span> <span class="n">CallbackManager</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterable</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="n">Message</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the node function with streaming output support.</span>

<span class="sd">        Similar to execute() but designed for streaming scenarios where the node</span>
<span class="sd">        function can produce incremental results. This method provides an async</span>
<span class="sd">        iterator interface over the node&#39;s outputs, allowing for real-time</span>
<span class="sd">        processing and response streaming.</span>

<span class="sd">        Args:</span>
<span class="sd">            config: Configuration dictionary with execution context and settings.</span>
<span class="sd">            state: Current AgentState providing workflow context and shared state.</span>
<span class="sd">            callback_mgr: Callback manager for pre/post execution hook handling.</span>

<span class="sd">        Yields:</span>
<span class="sd">            Dictionary objects or Message instances representing incremental</span>
<span class="sd">            outputs from the node function. The exact type and frequency of</span>
<span class="sd">            yields depends on the node function&#39;s streaming implementation.</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            async def streaming_processor(state, config):</span>
<span class="sd">                for item in large_dataset:</span>
<span class="sd">                    result = process_item(item)</span>
<span class="sd">                    yield Message.text_message(f&quot;Processed item: {result}&quot;)</span>


<span class="sd">            node = Node(&quot;stream_processor&quot;, streaming_processor)</span>
<span class="sd">            async for output in node.stream(config, state):</span>
<span class="sd">                print(f&quot;Streamed: {output.content}&quot;)</span>
<span class="sd">            ```</span>

<span class="sd">        Note:</span>
<span class="sd">            Not all node functions support streaming. For non-streaming functions,</span>
<span class="sd">            this method will yield a single result equivalent to calling execute().</span>
<span class="sd">            The streaming capability is determined by the node function&#39;s implementation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_handler</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">state</span><span class="p">,</span>
            <span class="n">callback_mgr</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">async</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">item</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">





<h4 id="pyagenity.graph.Node-attributes">Attributes<a href="#pyagenity.graph.Node-attributes" class="headerlink" title="Permanent link">&para;</a></h4>

<div class="doc doc-object doc-attribute">



<h5 id="pyagenity.graph.Node.func" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">func</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.Node.func" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="pyagenity.graph.Node.invoke_handler" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">invoke_handler</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.Node.invoke_handler" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">invoke_handler</span> <span class="o">=</span> <span class="n">InvokeNodeHandler</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="pyagenity.graph.Node.name" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">name</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.Node.name" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="pyagenity.graph.Node.publisher" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">publisher</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.Node.publisher" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">publisher</span> <span class="o">=</span> <span class="n">publisher</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="pyagenity.graph.Node.stream_handler" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">stream_handler</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.Node.stream_handler" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">stream_handler</span> <span class="o">=</span> <span class="n">StreamNodeHandler</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>


<h4 id="pyagenity.graph.Node-functions">Functions<a href="#pyagenity.graph.Node-functions" class="headerlink" title="Permanent link">&para;</a></h4>

<div class="doc doc-object doc-function">


<h5 id="pyagenity.graph.Node.__init__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">__init__</span>


<a href="#pyagenity.graph.Node.__init__" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">publisher</span><span class="o">=</span><span class="n">Inject</span><span class="p">[</span><span class="n">BasePublisher</span><span class="p">])</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Initialize a new Node instance with function and dependencies.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.Node.__init__(name)" class="doc doc-heading doc-heading-parameter">                  <code>name</code>
<a href="#pyagenity.graph.Node.__init__(name)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique identifier for the node within the graph. This name
is used for routing, logging, and referencing the node in
graph configuration.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.Node.__init__(func)" class="doc doc-heading doc-heading-parameter">                  <code>func</code>
<a href="#pyagenity.graph.Node.__init__(func)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="collections.abc.Callable">Callable</span>, <a class="autorefs autorefs-internal" title="            ToolNode (pyagenity.graph.tool_node.ToolNode)" href="../#pyagenity.graph.tool_node.ToolNode">ToolNode</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The function or ToolNode to execute when this node is called.
Functions should accept at least 'state' and 'config' parameters.
ToolNode instances handle tool-based operations and provide
their own execution logic.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.Node.__init__(publisher)" class="doc doc-heading doc-heading-parameter">                  <code>publisher</code>
<a href="#pyagenity.graph.Node.__init__(publisher)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            BasePublisher (pyagenity.publisher.BasePublisher)" href="../#pyagenity.publisher.BasePublisher">BasePublisher</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional event publisher for execution monitoring.
Injected via dependency injection if not explicitly provided.
Used for publishing node execution events and status updates.</p>
              </div>
            </td>
            <td>
                  <code><span title="injectq.Inject">Inject</span>[<a class="autorefs autorefs-internal" title="            BasePublisher (pyagenity.publisher.BasePublisher)" href="../#pyagenity.publisher.BasePublisher">BasePublisher</a>]</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>The function signature is automatically analyzed to determine
required parameters and dependency injection points. Parameters
matching injectable service names will be automatically provided
by the framework during execution.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/node.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span>
<span class="normal">99</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">func</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="s2">&quot;ToolNode&quot;</span><span class="p">],</span>
    <span class="n">publisher</span><span class="p">:</span> <span class="n">BasePublisher</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">BasePublisher</span><span class="p">],</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize a new Node instance with function and dependencies.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: Unique identifier for the node within the graph. This name</span>
<span class="sd">            is used for routing, logging, and referencing the node in</span>
<span class="sd">            graph configuration.</span>
<span class="sd">        func: The function or ToolNode to execute when this node is called.</span>
<span class="sd">            Functions should accept at least &#39;state&#39; and &#39;config&#39; parameters.</span>
<span class="sd">            ToolNode instances handle tool-based operations and provide</span>
<span class="sd">            their own execution logic.</span>
<span class="sd">        publisher: Optional event publisher for execution monitoring.</span>
<span class="sd">            Injected via dependency injection if not explicitly provided.</span>
<span class="sd">            Used for publishing node execution events and status updates.</span>

<span class="sd">    Note:</span>
<span class="sd">        The function signature is automatically analyzed to determine</span>
<span class="sd">        required parameters and dependency injection points. Parameters</span>
<span class="sd">        matching injectable service names will be automatically provided</span>
<span class="sd">        by the framework during execution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;Initializing node &#39;</span><span class="si">%s</span><span class="s2">&#39; with func=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">publisher</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">invoke_handler</span> <span class="o">=</span> <span class="n">InvokeNodeHandler</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">func</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">stream_handler</span> <span class="o">=</span> <span class="n">StreamNodeHandler</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">func</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="pyagenity.graph.Node.execute" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">execute</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.Node.execute" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">execute</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">callback_mgr</span><span class="o">=</span><span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">])</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Execute the node function with comprehensive context and callback support.</p>
<p>Executes the node's function or ToolNode with full dependency injection,
callback hook execution, and error handling. This method provides the
complete execution environment including state access, configuration,
and injected services.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.Node.execute(config)" class="doc doc-heading doc-heading-parameter">                  <code>config</code>
<a href="#pyagenity.graph.Node.execute(config)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration dictionary containing execution context,
user settings, thread identification, and runtime parameters.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.Node.execute(state)" class="doc doc-heading doc-heading-parameter">                  <code>state</code>
<a href="#pyagenity.graph.Node.execute(state)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            AgentState (pyagenity.state.AgentState)" href="../#pyagenity.state.AgentState">AgentState</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Current AgentState providing workflow context, message history,
and shared state information accessible to the node function.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.Node.execute(callback_mgr)" class="doc doc-heading doc-heading-parameter">                  <code>callback_mgr</code>
<a href="#pyagenity.graph.Node.execute(callback_mgr)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            CallbackManager (pyagenity.utils.CallbackManager)" href="../#pyagenity.utils.CallbackManager">CallbackManager</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Callback manager for executing pre/post execution hooks.
Injected via dependency injection if not explicitly provided.</p>
              </div>
            </td>
            <td>
                  <code><span title="injectq.Inject">Inject</span>[<a class="autorefs autorefs-internal" title="            CallbackManager (pyagenity.utils.CallbackManager)" href="../#pyagenity.utils.CallbackManager">CallbackManager</a>]</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | <span title="list">list</span>[<a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.Message)" href="../#pyagenity.utils.Message">Message</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Either a dictionary containing updated state and execution results,</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | <span title="list">list</span>[<a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.Message)" href="../#pyagenity.utils.Message">Message</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>or a list of Message objects representing the node's output.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | <span title="list">list</span>[<a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.Message)" href="../#pyagenity.utils.Message">Message</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The return type depends on the node function's implementation.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="c1"># Node function that returns messages</span>
<span class="k">def</span><span class="w"> </span><span class="nf">process_data</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">Message</span><span class="o">.</span><span class="n">text_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)]</span>


<span class="n">node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="s2">&quot;processor&quot;</span><span class="p">,</span> <span class="n">process_data</span><span class="p">)</span>
<span class="n">messages</span> <span class="o">=</span> <span class="k">await</span> <span class="n">node</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</code></pre></div>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>The node function receives dependency-injected parameters based on
its signature. Common injectable parameters include 'state', 'config',
'context_manager', 'publisher', and other framework services.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/node.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
    <span class="n">callback_mgr</span><span class="p">:</span> <span class="n">CallbackManager</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">Message</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the node function with comprehensive context and callback support.</span>

<span class="sd">    Executes the node&#39;s function or ToolNode with full dependency injection,</span>
<span class="sd">    callback hook execution, and error handling. This method provides the</span>
<span class="sd">    complete execution environment including state access, configuration,</span>
<span class="sd">    and injected services.</span>

<span class="sd">    Args:</span>
<span class="sd">        config: Configuration dictionary containing execution context,</span>
<span class="sd">            user settings, thread identification, and runtime parameters.</span>
<span class="sd">        state: Current AgentState providing workflow context, message history,</span>
<span class="sd">            and shared state information accessible to the node function.</span>
<span class="sd">        callback_mgr: Callback manager for executing pre/post execution hooks.</span>
<span class="sd">            Injected via dependency injection if not explicitly provided.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Either a dictionary containing updated state and execution results,</span>
<span class="sd">        or a list of Message objects representing the node&#39;s output.</span>
<span class="sd">        The return type depends on the node function&#39;s implementation.</span>

<span class="sd">    Raises:</span>
<span class="sd">        Various exceptions depending on node function behavior. All exceptions</span>
<span class="sd">        are handled by the callback manager&#39;s error handling hooks before</span>
<span class="sd">        being propagated.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        # Node function that returns messages</span>
<span class="sd">        def process_data(state, config):</span>
<span class="sd">            result = process(state.data)</span>
<span class="sd">            return [Message.text_message(f&quot;Processed: {result}&quot;)]</span>


<span class="sd">        node = Node(&quot;processor&quot;, process_data)</span>
<span class="sd">        messages = await node.execute(config, state)</span>
<span class="sd">        ```</span>

<span class="sd">    Note:</span>
<span class="sd">        The node function receives dependency-injected parameters based on</span>
<span class="sd">        its signature. Common injectable parameters include &#39;state&#39;, &#39;config&#39;,</span>
<span class="sd">        &#39;context_manager&#39;, &#39;publisher&#39;, and other framework services.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">invoke_handler</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span>
        <span class="n">state</span><span class="p">,</span>
        <span class="n">callback_mgr</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="pyagenity.graph.Node.stream" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">stream</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.Node.stream" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">stream</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">callback_mgr</span><span class="o">=</span><span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">])</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Execute the node function with streaming output support.</p>
<p>Similar to execute() but designed for streaming scenarios where the node
function can produce incremental results. This method provides an async
iterator interface over the node's outputs, allowing for real-time
processing and response streaming.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.Node.stream(config)" class="doc doc-heading doc-heading-parameter">                  <code>config</code>
<a href="#pyagenity.graph.Node.stream(config)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration dictionary with execution context and settings.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.Node.stream(state)" class="doc doc-heading doc-heading-parameter">                  <code>state</code>
<a href="#pyagenity.graph.Node.stream(state)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            AgentState (pyagenity.state.AgentState)" href="../#pyagenity.state.AgentState">AgentState</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Current AgentState providing workflow context and shared state.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.Node.stream(callback_mgr)" class="doc doc-heading doc-heading-parameter">                  <code>callback_mgr</code>
<a href="#pyagenity.graph.Node.stream(callback_mgr)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            CallbackManager (pyagenity.utils.CallbackManager)" href="../#pyagenity.utils.CallbackManager">CallbackManager</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Callback manager for pre/post execution hook handling.</p>
              </div>
            </td>
            <td>
                  <code><span title="injectq.Inject">Inject</span>[<a class="autorefs autorefs-internal" title="            CallbackManager (pyagenity.utils.CallbackManager)" href="../#pyagenity.utils.CallbackManager">CallbackManager</a>]</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Yields:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="collections.abc.AsyncIterable">AsyncIterable</span>[<span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | <a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.Message)" href="../#pyagenity.utils.Message">Message</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary objects or Message instances representing incremental</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="collections.abc.AsyncIterable">AsyncIterable</span>[<span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | <a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.Message)" href="../#pyagenity.utils.Message">Message</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>outputs from the node function. The exact type and frequency of</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="collections.abc.AsyncIterable">AsyncIterable</span>[<span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | <a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.Message)" href="../#pyagenity.utils.Message">Message</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>yields depends on the node function's streaming implementation.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">streaming_processor</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">large_dataset</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">process_item</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">Message</span><span class="o">.</span><span class="n">text_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed item: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="n">node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="s2">&quot;stream_processor&quot;</span><span class="p">,</span> <span class="n">streaming_processor</span><span class="p">)</span>
<span class="k">async</span> <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Streamed: </span><span class="si">{</span><span class="n">output</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>Not all node functions support streaming. For non-streaming functions,
this method will yield a single result equivalent to calling execute().
The streaming capability is determined by the node function's implementation.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/node.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
    <span class="n">callback_mgr</span><span class="p">:</span> <span class="n">CallbackManager</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterable</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="n">Message</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the node function with streaming output support.</span>

<span class="sd">    Similar to execute() but designed for streaming scenarios where the node</span>
<span class="sd">    function can produce incremental results. This method provides an async</span>
<span class="sd">    iterator interface over the node&#39;s outputs, allowing for real-time</span>
<span class="sd">    processing and response streaming.</span>

<span class="sd">    Args:</span>
<span class="sd">        config: Configuration dictionary with execution context and settings.</span>
<span class="sd">        state: Current AgentState providing workflow context and shared state.</span>
<span class="sd">        callback_mgr: Callback manager for pre/post execution hook handling.</span>

<span class="sd">    Yields:</span>
<span class="sd">        Dictionary objects or Message instances representing incremental</span>
<span class="sd">        outputs from the node function. The exact type and frequency of</span>
<span class="sd">        yields depends on the node function&#39;s streaming implementation.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        async def streaming_processor(state, config):</span>
<span class="sd">            for item in large_dataset:</span>
<span class="sd">                result = process_item(item)</span>
<span class="sd">                yield Message.text_message(f&quot;Processed item: {result}&quot;)</span>


<span class="sd">        node = Node(&quot;stream_processor&quot;, streaming_processor)</span>
<span class="sd">        async for output in node.stream(config, state):</span>
<span class="sd">            print(f&quot;Streamed: {output.content}&quot;)</span>
<span class="sd">        ```</span>

<span class="sd">    Note:</span>
<span class="sd">        Not all node functions support streaming. For non-streaming functions,</span>
<span class="sd">        this method will yield a single result equivalent to calling execute().</span>
<span class="sd">        The streaming capability is determined by the node function&#39;s implementation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_handler</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span>
        <span class="n">state</span><span class="p">,</span>
        <span class="n">callback_mgr</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">async</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">item</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="pyagenity.graph.StateGraph" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">StateGraph</span>


<a href="#pyagenity.graph.StateGraph" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">


        <p>Main graph class for orchestrating multi-agent workflows.</p>
<p>This class provides the core functionality for building and managing stateful
agent workflows. It is similar to LangGraph's StateGraph
integration with support for dependency injection.</p>
<p>The graph is generic over state types to support custom AgentState subclasses,
allowing for type-safe state management throughout the workflow execution.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.StateGraph.state">state</span></code></td>
            <td>
                  <code><span title="pyagenity.graph.state_graph.StateGraph[StateT]">StateT</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current state of the graph workflow.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            nodes


  
      instance-attribute
   (pyagenity.graph.StateGraph.nodes)" href="../#pyagenity.graph.StateGraph.nodes">nodes</a></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <a class="autorefs autorefs-internal" title="            Node (pyagenity.graph.node.Node)" href="../#pyagenity.graph.node.Node">Node</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Collection of nodes in the graph.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            edges


  
      instance-attribute
   (pyagenity.graph.StateGraph.edges)" href="../#pyagenity.graph.StateGraph.edges">edges</a></code></td>
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="            Edge (pyagenity.graph.edge.Edge)" href="../#pyagenity.graph.edge.Edge">Edge</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Collection of edges connecting nodes.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            entry_point


  
      instance-attribute
   (pyagenity.graph.StateGraph.entry_point)" href="../#pyagenity.graph.StateGraph.entry_point">entry_point</a></code></td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the starting node for execution.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.StateGraph.context_manager">context_manager</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            BaseContextManager (pyagenity.state.BaseContextManager)" href="../#pyagenity.state.BaseContextManager">BaseContextManager</a>[<span title="pyagenity.graph.state_graph.StateGraph[StateT]">StateT</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional context manager
for handling cross-node state operations.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.StateGraph.dependency_container">dependency_container</span></code></td>
            <td>
                  <code><span title="DependencyContainer">DependencyContainer</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Container for managing
dependencies that can be injected into node functions.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.StateGraph.compiled">compiled</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether the graph has been compiled for execution.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>graph = StateGraph()
graph.add_node("process", process_function)
graph.add_edge(START, "process")
graph.add_edge("process", END)
compiled = graph.compile()
result = compiled.invoke({"input": "data"})</p>
</blockquote>
</blockquote>
</blockquote>
</details>











<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            __init__ (pyagenity.graph.StateGraph.__init__)" href="../#pyagenity.graph.StateGraph.__init__">__init__</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Initialize a new StateGraph instance.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            add_conditional_edges (pyagenity.graph.StateGraph.add_conditional_edges)" href="../#pyagenity.graph.StateGraph.add_conditional_edges">add_conditional_edges</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Add conditional routing between nodes based on runtime evaluation.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            add_edge (pyagenity.graph.StateGraph.add_edge)" href="../#pyagenity.graph.StateGraph.add_edge">add_edge</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Add a static edge between two nodes.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            add_node (pyagenity.graph.StateGraph.add_node)" href="../#pyagenity.graph.StateGraph.add_node">add_node</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Add a node to the graph.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            compile (pyagenity.graph.StateGraph.compile)" href="../#pyagenity.graph.StateGraph.compile">compile</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Compile the graph for execution.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            set_entry_point (pyagenity.graph.StateGraph.set_entry_point)" href="../#pyagenity.graph.StateGraph.set_entry_point">set_entry_point</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Set the entry point for the graph.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>



              <details class="quote">
                <summary>Source code in <code>pyagenity/graph/state_graph.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">StateGraph</span><span class="p">[</span><span class="n">StateT</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main graph class for orchestrating multi-agent workflows.</span>

<span class="sd">    This class provides the core functionality for building and managing stateful</span>
<span class="sd">    agent workflows. It is similar to LangGraph&#39;s StateGraph</span>
<span class="sd">    integration with support for dependency injection.</span>

<span class="sd">    The graph is generic over state types to support custom AgentState subclasses,</span>
<span class="sd">    allowing for type-safe state management throughout the workflow execution.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        state (StateT): The current state of the graph workflow.</span>
<span class="sd">        nodes (dict[str, Node]): Collection of nodes in the graph.</span>
<span class="sd">        edges (list[Edge]): Collection of edges connecting nodes.</span>
<span class="sd">        entry_point (str | None): Name of the starting node for execution.</span>
<span class="sd">        context_manager (BaseContextManager[StateT] | None): Optional context manager</span>
<span class="sd">            for handling cross-node state operations.</span>
<span class="sd">        dependency_container (DependencyContainer): Container for managing</span>
<span class="sd">            dependencies that can be injected into node functions.</span>
<span class="sd">        compiled (bool): Whether the graph has been compiled for execution.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; graph = StateGraph()</span>
<span class="sd">        &gt;&gt;&gt; graph.add_node(&quot;process&quot;, process_function)</span>
<span class="sd">        &gt;&gt;&gt; graph.add_edge(START, &quot;process&quot;)</span>
<span class="sd">        &gt;&gt;&gt; graph.add_edge(&quot;process&quot;, END)</span>
<span class="sd">        &gt;&gt;&gt; compiled = graph.compile()</span>
<span class="sd">        &gt;&gt;&gt; result = compiled.invoke({&quot;input&quot;: &quot;data&quot;})</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">StateT</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">context_manager</span><span class="p">:</span> <span class="n">BaseContextManager</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">publisher</span><span class="p">:</span> <span class="n">BasePublisher</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">id_generator</span><span class="p">:</span> <span class="n">BaseIDGenerator</span> <span class="o">=</span> <span class="n">DefaultIDGenerator</span><span class="p">(),</span>
        <span class="n">container</span><span class="p">:</span> <span class="n">InjectQ</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">thread_name_generator</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a new StateGraph instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            state: Initial state for the graph. If None, a default AgentState</span>
<span class="sd">                will be created.</span>
<span class="sd">            context_manager: Optional context manager for handling cross-node</span>
<span class="sd">                state operations and advanced state management patterns.</span>
<span class="sd">            dependency_container: Container for managing dependencies that can</span>
<span class="sd">                be injected into node functions. If None, a new empty container</span>
<span class="sd">                will be created.</span>
<span class="sd">            publisher: Publisher for emitting events during execution</span>

<span class="sd">        Note:</span>
<span class="sd">            START and END nodes are automatically added to the graph upon</span>
<span class="sd">            initialization and accept the full node signature including</span>
<span class="sd">            dependencies.</span>

<span class="sd">        Example:</span>
<span class="sd">            # Basic usage with default AgentState</span>
<span class="sd">            &gt;&gt;&gt; graph = StateGraph()</span>

<span class="sd">            # With custom state</span>
<span class="sd">            &gt;&gt;&gt; custom_state = MyCustomState()</span>
<span class="sd">            &gt;&gt;&gt; graph = StateGraph(custom_state)</span>

<span class="sd">            # Or using type hints for clarity</span>
<span class="sd">            &gt;&gt;&gt; graph = StateGraph[MyCustomState](MyCustomState())</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing StateGraph&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;StateGraph init with state=</span><span class="si">%s</span><span class="s2">, context_manager=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="n">state</span> <span class="k">else</span> <span class="s2">&quot;default AgentState&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="p">(</span><span class="n">context_manager</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="n">context_manager</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># State handling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">:</span> <span class="n">StateT</span> <span class="o">=</span> <span class="n">state</span> <span class="k">if</span> <span class="n">state</span> <span class="k">else</span> <span class="n">AgentState</span><span class="p">()</span>  <span class="c1"># type: ignore[assignment]</span>

        <span class="c1"># Graph structure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Node</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Edge</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entry_point</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Services</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span><span class="p">:</span> <span class="n">BasePublisher</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">publisher</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id_generator</span><span class="p">:</span> <span class="n">BaseIDGenerator</span> <span class="o">=</span> <span class="n">id_generator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_context_manager</span><span class="p">:</span> <span class="n">BaseContextManager</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">context_manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_name_generator</span> <span class="o">=</span> <span class="n">thread_name_generator</span>
        <span class="c1"># save container for dependency injection</span>
        <span class="c1"># if any container is passed then we will activate that</span>
        <span class="c1"># otherwise we can skip it and use the default one</span>
        <span class="k">if</span> <span class="n">container</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_container</span> <span class="o">=</span> <span class="n">InjectQ</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No container provided, using global singleton instance&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using provided dependency container instance&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_container</span> <span class="o">=</span> <span class="n">container</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>

        <span class="c1"># Register task_manager, for async tasks</span>
        <span class="c1"># This will be used to run background tasks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_task_manager</span> <span class="o">=</span> <span class="n">BackgroundTaskManager</span><span class="p">()</span>

        <span class="c1"># now setup the graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">()</span>

        <span class="c1"># Add START and END nodes (accept full node signature including dependencies)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding default START and END nodes&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">START</span><span class="p">]</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">deps</span><span class="p">:</span> <span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">END</span><span class="p">]</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">END</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">deps</span><span class="p">:</span> <span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;StateGraph initialized with </span><span class="si">%d</span><span class="s2"> nodes&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup the graph before compilation.</span>

<span class="sd">        This method can be used to perform any necessary setup or validation</span>
<span class="sd">        before compiling the graph for execution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting up StateGraph before compilation&quot;</span><span class="p">)</span>
        <span class="c1"># Placeholder for any setup logic needed before compilation</span>
        <span class="c1"># register dependencies</span>

        <span class="c1"># register state and context manager as singletons (these are nullable)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind_instance</span><span class="p">(</span>
            <span class="n">BaseContextManager</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_context_manager</span><span class="p">,</span>
            <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">allow_concrete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind_instance</span><span class="p">(</span>
            <span class="n">BasePublisher</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span><span class="p">,</span>
            <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">allow_concrete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># register id generator as factory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind_instance</span><span class="p">(</span>
            <span class="n">BaseIDGenerator</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_id_generator</span><span class="p">,</span>
            <span class="n">allow_concrete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;generated_id_type&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id_generator</span><span class="o">.</span><span class="n">id_type</span><span class="p">)</span>
        <span class="c1"># Allow async method also</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind_factory</span><span class="p">(</span>
            <span class="s2">&quot;generated_id&quot;</span><span class="p">,</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id_generator</span><span class="o">.</span><span class="n">generate</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="c1"># Attach Thread name generator if provided</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_name_generator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread_name_generator</span> <span class="o">=</span> <span class="n">generate_dummy_thread_name</span>

        <span class="n">generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_name_generator</span> <span class="ow">or</span> <span class="n">generate_dummy_thread_name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind_factory</span><span class="p">(</span>
            <span class="s2">&quot;generated_thread_name&quot;</span><span class="p">,</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">generator</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="c1"># Save BackgroundTaskManager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind_instance</span><span class="p">(</span>
            <span class="n">BackgroundTaskManager</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_task_manager</span><span class="p">,</span>
            <span class="n">allow_concrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_node</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name_or_func</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="n">func</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="s2">&quot;ToolNode&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StateGraph&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a node to the graph.</span>

<span class="sd">        This method supports two calling patterns:</span>
<span class="sd">        1. Pass a callable as the first argument (name inferred from function name)</span>
<span class="sd">        2. Pass a name string and callable/ToolNode as separate arguments</span>

<span class="sd">        Args:</span>
<span class="sd">            name_or_func: Either the node name (str) or a callable function.</span>
<span class="sd">                If callable, the function name will be used as the node name.</span>
<span class="sd">            func: The function or ToolNode to execute. Required if name_or_func</span>
<span class="sd">                is a string, ignored if name_or_func is callable.</span>

<span class="sd">        Returns:</span>
<span class="sd">            StateGraph: The graph instance for method chaining.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If invalid arguments are provided.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # Method 1: Function name inferred</span>
<span class="sd">            &gt;&gt;&gt; graph.add_node(my_function)</span>
<span class="sd">            &gt;&gt;&gt; # Method 2: Explicit name and function</span>
<span class="sd">            &gt;&gt;&gt; graph.add_node(&quot;process&quot;, my_function)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">name_or_func</span><span class="p">)</span> <span class="ow">and</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Function passed as first argument</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name_or_func</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">name_or_func</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding node &#39;</span><span class="si">%s</span><span class="s2">&#39; with inferred name from function&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name_or_func</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">callable</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">ToolNode</span><span class="p">)):</span>
            <span class="c1"># Name and function passed separately</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name_or_func</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Adding node &#39;</span><span class="si">%s</span><span class="s2">&#39; with explicit name and </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;ToolNode&quot;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">ToolNode</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;callable&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;Invalid arguments for add_node&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Added node &#39;</span><span class="si">%s</span><span class="s2">&#39; to graph (total nodes: </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_edge</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">from_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">to_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StateGraph&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a static edge between two nodes.</span>

<span class="sd">        Creates a direct connection from one node to another. If the source</span>
<span class="sd">        node is START, the target node becomes the entry point for the graph.</span>

<span class="sd">        Args:</span>
<span class="sd">            from_node: Name of the source node.</span>
<span class="sd">            to_node: Name of the target node.</span>

<span class="sd">        Returns:</span>
<span class="sd">            StateGraph: The graph instance for method chaining.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; graph.add_edge(&quot;node1&quot;, &quot;node2&quot;)</span>
<span class="sd">            &gt;&gt;&gt; graph.add_edge(START, &quot;entry_node&quot;)  # Sets entry point</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding edge from &#39;</span><span class="si">%s</span><span class="s2">&#39; to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">from_node</span><span class="p">,</span> <span class="n">to_node</span><span class="p">)</span>
        <span class="c1"># Set entry point if edge is from START</span>
        <span class="k">if</span> <span class="n">from_node</span> <span class="o">==</span> <span class="n">START</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">entry_point</span> <span class="o">=</span> <span class="n">to_node</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set entry point to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">to_node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Edge</span><span class="p">(</span><span class="n">from_node</span><span class="p">,</span> <span class="n">to_node</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Added edge (total edges: </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_conditional_edges</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">from_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">condition</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="n">path_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StateGraph&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add conditional routing between nodes based on runtime evaluation.</span>

<span class="sd">        Creates dynamic routing logic where the next node is determined by evaluating</span>
<span class="sd">        a condition function against the current state. This enables complex branching</span>
<span class="sd">        logic, decision trees, and adaptive workflow routing.</span>

<span class="sd">        Args:</span>
<span class="sd">            from_node: Name of the source node where the condition is evaluated.</span>
<span class="sd">            condition: Callable function that takes the current AgentState and returns</span>
<span class="sd">                a value used for routing decisions. Should be deterministic and</span>
<span class="sd">                side-effect free.</span>
<span class="sd">            path_map: Optional dictionary mapping condition results to destination nodes.</span>
<span class="sd">                If provided, the condition&#39;s return value is looked up in this mapping.</span>
<span class="sd">                If None, the condition should return the destination node name directly.</span>

<span class="sd">        Returns:</span>
<span class="sd">            StateGraph: The graph instance for method chaining.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the condition function or path_map configuration is invalid.</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            # Direct routing - condition returns node name</span>
<span class="sd">            def route_by_priority(state):</span>
<span class="sd">                priority = state.data.get(&quot;priority&quot;, &quot;normal&quot;)</span>
<span class="sd">                return &quot;urgent_handler&quot; if priority == &quot;high&quot; else &quot;normal_handler&quot;</span>


<span class="sd">            graph.add_conditional_edges(&quot;classifier&quot;, route_by_priority)</span>


<span class="sd">            # Mapped routing - condition result mapped to nodes</span>
<span class="sd">            def get_category(state):</span>
<span class="sd">                return state.data.get(&quot;category&quot;, &quot;default&quot;)</span>


<span class="sd">            category_map = {</span>
<span class="sd">                &quot;finance&quot;: &quot;finance_processor&quot;,</span>
<span class="sd">                &quot;legal&quot;: &quot;legal_processor&quot;,</span>
<span class="sd">                &quot;default&quot;: &quot;general_processor&quot;,</span>
<span class="sd">            }</span>
<span class="sd">            graph.add_conditional_edges(&quot;categorizer&quot;, get_category, category_map)</span>
<span class="sd">            ```</span>

<span class="sd">        Note:</span>
<span class="sd">            The condition function receives the current AgentState and should return</span>
<span class="sd">            consistent results for the same state. If using path_map, ensure the</span>
<span class="sd">            condition&#39;s return values match the map keys exactly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add conditional edges from a node based on a condition function.</span>

<span class="sd">        Creates edges that are traversed based on the result of a condition</span>
<span class="sd">        function. The condition function receives the current state and should</span>
<span class="sd">        return a value that determines which edge to follow.</span>

<span class="sd">        Args:</span>
<span class="sd">            from_node: Name of the source node.</span>
<span class="sd">            condition: Function that evaluates the current state and returns</span>
<span class="sd">                a value to determine the next node.</span>
<span class="sd">            path_map: Optional mapping from condition results to target nodes.</span>
<span class="sd">                If provided, creates multiple conditional edges. If None,</span>
<span class="sd">                creates a single conditional edge.</span>

<span class="sd">        Returns:</span>
<span class="sd">            StateGraph: The graph instance for method chaining.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; def route_condition(state):</span>
<span class="sd">            ...     return &quot;success&quot; if state.success else &quot;failure&quot;</span>
<span class="sd">            &gt;&gt;&gt; graph.add_conditional_edges(</span>
<span class="sd">            ...     &quot;processor&quot;,</span>
<span class="sd">            ...     route_condition,</span>
<span class="sd">            ...     {&quot;success&quot;: &quot;next_step&quot;, &quot;failure&quot;: &quot;error_handler&quot;},</span>
<span class="sd">            ... )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create edges based on possible returns from condition function</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; adding conditional edges with path_map: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">from_node</span><span class="p">,</span>
            <span class="n">path_map</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">path_map</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; adding conditional edges with path_map: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">from_node</span><span class="p">,</span> <span class="n">path_map</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">condition_result</span><span class="p">,</span> <span class="n">target_node</span> <span class="ow">in</span> <span class="n">path_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">edge</span> <span class="o">=</span> <span class="n">Edge</span><span class="p">(</span><span class="n">from_node</span><span class="p">,</span> <span class="n">target_node</span><span class="p">,</span> <span class="n">condition</span><span class="p">)</span>
                <span class="n">edge</span><span class="o">.</span><span class="n">condition_result</span> <span class="o">=</span> <span class="n">condition_result</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Single conditional edge</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; adding single conditional edge&quot;</span><span class="p">,</span> <span class="n">from_node</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Edge</span><span class="p">(</span><span class="n">from_node</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_entry_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StateGraph&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the entry point for the graph.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entry_point</span> <span class="o">=</span> <span class="n">node_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="n">node_name</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set entry point to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">node_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compile</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">checkpointer</span><span class="p">:</span> <span class="n">BaseCheckpointer</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">store</span><span class="p">:</span> <span class="n">BaseStore</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">interrupt_before</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">interrupt_after</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">callback_manager</span><span class="p">:</span> <span class="n">CallbackManager</span> <span class="o">=</span> <span class="n">CallbackManager</span><span class="p">(),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CompiledGraph[StateT]&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compile the graph for execution.</span>

<span class="sd">        Args:</span>
<span class="sd">            checkpointer: Checkpointer for state persistence</span>
<span class="sd">            store: Store for additional data</span>
<span class="sd">            debug: Enable debug mode</span>
<span class="sd">            interrupt_before: List of node names to interrupt before execution</span>
<span class="sd">            interrupt_after: List of node names to interrupt after execution</span>
<span class="sd">            callback_manager: Callback manager for executing hooks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Compiling graph with </span><span class="si">%d</span><span class="s2"> nodes, </span><span class="si">%d</span><span class="s2"> edges, entry_point=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">entry_point</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Compile options: interrupt_before=</span><span class="si">%s</span><span class="s2">, interrupt_after=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">interrupt_before</span><span class="p">,</span>
            <span class="n">interrupt_after</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_point</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;No entry point set. Use set_entry_point() or add an edge from START.&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">GraphError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

        <span class="c1"># Validate graph structure</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Validating graph structure&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_graph</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Graph structure validated successfully&quot;</span><span class="p">)</span>

        <span class="c1"># Validate interrupt node names</span>
        <span class="n">interrupt_before</span> <span class="o">=</span> <span class="n">interrupt_before</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">interrupt_after</span> <span class="o">=</span> <span class="n">interrupt_after</span> <span class="ow">or</span> <span class="p">[]</span>

        <span class="n">all_interrupt_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">interrupt_before</span> <span class="o">+</span> <span class="n">interrupt_after</span><span class="p">)</span>
        <span class="n">invalid_nodes</span> <span class="o">=</span> <span class="n">all_interrupt_nodes</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">invalid_nodes</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Invalid interrupt nodes: </span><span class="si">{</span><span class="n">invalid_nodes</span><span class="si">}</span><span class="s2">. Must be existing node names.&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">GraphError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Graph compilation completed successfully&quot;</span><span class="p">)</span>
        <span class="c1"># Import here to avoid circular import at module import time</span>
        <span class="c1"># Now update Checkpointer</span>
        <span class="k">if</span> <span class="n">checkpointer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">pyagenity.checkpointer</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemoryCheckpointer</span>

            <span class="n">checkpointer</span> <span class="o">=</span> <span class="n">InMemoryCheckpointer</span><span class="p">[</span><span class="n">StateT</span><span class="p">]()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No checkpointer provided, using InMemoryCheckpointer&quot;</span><span class="p">)</span>

        <span class="c1"># Import the CompiledGraph class</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.compiled_graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">CompiledGraph</span>

        <span class="c1"># Setup dependencies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind_instance</span><span class="p">(</span>
            <span class="n">BaseCheckpointer</span><span class="p">,</span>
            <span class="n">checkpointer</span><span class="p">,</span>
            <span class="n">allow_concrete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># not null as we set default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind_instance</span><span class="p">(</span>
            <span class="n">BaseStore</span><span class="p">,</span>
            <span class="n">store</span><span class="p">,</span>
            <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">allow_concrete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind_instance</span><span class="p">(</span>
            <span class="n">CallbackManager</span><span class="p">,</span>
            <span class="n">callback_manager</span><span class="p">,</span>
            <span class="n">allow_concrete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># not null as we set default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;interrupt_before&quot;</span><span class="p">,</span> <span class="n">interrupt_before</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;interrupt_after&quot;</span><span class="p">,</span> <span class="n">interrupt_after</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind_instance</span><span class="p">(</span><span class="n">StateGraph</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="n">app</span> <span class="o">=</span> <span class="n">CompiledGraph</span><span class="p">(</span>
            <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">,</span>
            <span class="n">interrupt_after</span><span class="o">=</span><span class="n">interrupt_after</span><span class="p">,</span>
            <span class="n">interrupt_before</span><span class="o">=</span><span class="n">interrupt_before</span><span class="p">,</span>
            <span class="n">state_graph</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">checkpointer</span><span class="o">=</span><span class="n">checkpointer</span><span class="p">,</span>
            <span class="n">publisher</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span><span class="p">,</span>
            <span class="n">store</span><span class="o">=</span><span class="n">store</span><span class="p">,</span>
            <span class="n">task_manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_task_manager</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">CompiledGraph</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span>
        <span class="c1"># Compile the Graph, so it will optimize the dependency graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">app</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate the graph structure.&quot;&quot;&quot;</span>
        <span class="c1"># Check for orphaned nodes</span>
        <span class="n">connected_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
            <span class="n">connected_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">from_node</span><span class="p">)</span>
            <span class="n">connected_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">to_node</span><span class="p">)</span>

        <span class="n">all_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">orphaned</span> <span class="o">=</span> <span class="n">all_nodes</span> <span class="o">-</span> <span class="n">connected_nodes</span>
        <span class="k">if</span> <span class="n">orphaned</span> <span class="o">-</span> <span class="p">{</span><span class="n">START</span><span class="p">,</span> <span class="n">END</span><span class="p">}:</span>  <span class="c1"># START and END can be orphaned</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Orphaned nodes detected: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">orphaned</span> <span class="o">-</span> <span class="p">{</span><span class="n">START</span><span class="p">,</span> <span class="n">END</span><span class="p">})</span>
            <span class="k">raise</span> <span class="n">GraphError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Orphaned nodes detected: </span><span class="si">{</span><span class="n">orphaned</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">{</span><span class="n">START</span><span class="p">,</span><span class="w"> </span><span class="n">END</span><span class="p">}</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Check that all edge targets exist</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">edge</span><span class="o">.</span><span class="n">to_node</span> <span class="ow">and</span> <span class="n">edge</span><span class="o">.</span><span class="n">to_node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Edge &#39;</span><span class="si">%s</span><span class="s2">&#39; targets non-existent node: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">edge</span><span class="p">,</span> <span class="n">edge</span><span class="o">.</span><span class="n">to_node</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">GraphError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Edge targets non-existent node: </span><span class="si">{</span><span class="n">edge</span><span class="o">.</span><span class="n">to_node</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">





<h4 id="pyagenity.graph.StateGraph-attributes">Attributes<a href="#pyagenity.graph.StateGraph-attributes" class="headerlink" title="Permanent link">&para;</a></h4>

<div class="doc doc-object doc-attribute">



<h5 id="pyagenity.graph.StateGraph.edges" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">edges</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.StateGraph.edges" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">edges</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="pyagenity.graph.StateGraph.entry_point" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">entry_point</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.StateGraph.entry_point" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">entry_point</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="pyagenity.graph.StateGraph.nodes" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">nodes</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.StateGraph.nodes" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">nodes</span> <span class="o">=</span> <span class="p">{}</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="pyagenity.graph.StateGraph.thread_name_generator" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">thread_name_generator</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.StateGraph.thread_name_generator" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">thread_name_generator</span> <span class="o">=</span> <span class="n">thread_name_generator</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>


<h4 id="pyagenity.graph.StateGraph-functions">Functions<a href="#pyagenity.graph.StateGraph-functions" class="headerlink" title="Permanent link">&para;</a></h4>

<div class="doc doc-object doc-function">


<h5 id="pyagenity.graph.StateGraph.__init__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">__init__</span>


<a href="#pyagenity.graph.StateGraph.__init__" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">__init__</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">context_manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">publisher</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">id_generator</span><span class="o">=</span><span class="n">DefaultIDGenerator</span><span class="p">(),</span> <span class="n">container</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">thread_name_generator</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Initialize a new StateGraph instance.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.StateGraph.__init__(state)" class="doc doc-heading doc-heading-parameter">                  <code>state</code>
<a href="#pyagenity.graph.StateGraph.__init__(state)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="pyagenity.graph.state_graph.StateGraph[StateT]">StateT</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial state for the graph. If None, a default AgentState
will be created.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.StateGraph.__init__(context_manager)" class="doc doc-heading doc-heading-parameter">                  <code>context_manager</code>
<a href="#pyagenity.graph.StateGraph.__init__(context_manager)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            BaseContextManager (pyagenity.state.BaseContextManager)" href="../#pyagenity.state.BaseContextManager">BaseContextManager</a>[<span title="pyagenity.graph.state_graph.StateGraph[StateT]">StateT</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional context manager for handling cross-node
state operations and advanced state management patterns.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.StateGraph.__init__(dependency_container)" class="doc doc-heading doc-heading-parameter">                  <code>dependency_container</code>
<a href="#pyagenity.graph.StateGraph.__init__(dependency_container)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Container for managing dependencies that can
be injected into node functions. If None, a new empty container
will be created.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.StateGraph.__init__(publisher)" class="doc doc-heading doc-heading-parameter">                  <code>publisher</code>
<a href="#pyagenity.graph.StateGraph.__init__(publisher)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            BasePublisher (pyagenity.publisher.BasePublisher)" href="../#pyagenity.publisher.BasePublisher">BasePublisher</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Publisher for emitting events during execution</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>START and END nodes are automatically added to the graph upon
initialization and accept the full node signature including
dependencies.</p>
</details>

<details class="example" open>
  <summary>Example</summary>
  <h6 id="pyagenity.graph.StateGraph.__init__--basic-usage-with-default-agentstate">Basic usage with default AgentState<a class="headerlink" href="#pyagenity.graph.StateGraph.__init__--basic-usage-with-default-agentstate" title="Permanent link">&para;</a></h6>
<blockquote>
<blockquote>
<blockquote>
<p>graph = StateGraph()</p>
</blockquote>
</blockquote>
</blockquote>
<h6 id="pyagenity.graph.StateGraph.__init__--with-custom-state">With custom state<a class="headerlink" href="#pyagenity.graph.StateGraph.__init__--with-custom-state" title="Permanent link">&para;</a></h6>
<blockquote>
<blockquote>
<blockquote>
<p>custom_state = MyCustomState()
graph = StateGraph(custom_state)</p>
</blockquote>
</blockquote>
</blockquote>
<h6 id="pyagenity.graph.StateGraph.__init__--or-using-type-hints-for-clarity">Or using type hints for clarity<a class="headerlink" href="#pyagenity.graph.StateGraph.__init__--or-using-type-hints-for-clarity" title="Permanent link">&para;</a></h6>
<blockquote>
<blockquote>
<blockquote>
<p>graph = StateGraph<a href="MyCustomState()">MyCustomState</a></p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/state_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">StateT</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">context_manager</span><span class="p">:</span> <span class="n">BaseContextManager</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">publisher</span><span class="p">:</span> <span class="n">BasePublisher</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">id_generator</span><span class="p">:</span> <span class="n">BaseIDGenerator</span> <span class="o">=</span> <span class="n">DefaultIDGenerator</span><span class="p">(),</span>
    <span class="n">container</span><span class="p">:</span> <span class="n">InjectQ</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">thread_name_generator</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize a new StateGraph instance.</span>

<span class="sd">    Args:</span>
<span class="sd">        state: Initial state for the graph. If None, a default AgentState</span>
<span class="sd">            will be created.</span>
<span class="sd">        context_manager: Optional context manager for handling cross-node</span>
<span class="sd">            state operations and advanced state management patterns.</span>
<span class="sd">        dependency_container: Container for managing dependencies that can</span>
<span class="sd">            be injected into node functions. If None, a new empty container</span>
<span class="sd">            will be created.</span>
<span class="sd">        publisher: Publisher for emitting events during execution</span>

<span class="sd">    Note:</span>
<span class="sd">        START and END nodes are automatically added to the graph upon</span>
<span class="sd">        initialization and accept the full node signature including</span>
<span class="sd">        dependencies.</span>

<span class="sd">    Example:</span>
<span class="sd">        # Basic usage with default AgentState</span>
<span class="sd">        &gt;&gt;&gt; graph = StateGraph()</span>

<span class="sd">        # With custom state</span>
<span class="sd">        &gt;&gt;&gt; custom_state = MyCustomState()</span>
<span class="sd">        &gt;&gt;&gt; graph = StateGraph(custom_state)</span>

<span class="sd">        # Or using type hints for clarity</span>
<span class="sd">        &gt;&gt;&gt; graph = StateGraph[MyCustomState](MyCustomState())</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing StateGraph&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;StateGraph init with state=</span><span class="si">%s</span><span class="s2">, context_manager=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="n">state</span> <span class="k">else</span> <span class="s2">&quot;default AgentState&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="p">(</span><span class="n">context_manager</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="n">context_manager</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># State handling</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">:</span> <span class="n">StateT</span> <span class="o">=</span> <span class="n">state</span> <span class="k">if</span> <span class="n">state</span> <span class="k">else</span> <span class="n">AgentState</span><span class="p">()</span>  <span class="c1"># type: ignore[assignment]</span>

    <span class="c1"># Graph structure</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Node</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Edge</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">entry_point</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Services</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span><span class="p">:</span> <span class="n">BasePublisher</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">publisher</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_id_generator</span><span class="p">:</span> <span class="n">BaseIDGenerator</span> <span class="o">=</span> <span class="n">id_generator</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_context_manager</span><span class="p">:</span> <span class="n">BaseContextManager</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">context_manager</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">thread_name_generator</span> <span class="o">=</span> <span class="n">thread_name_generator</span>
    <span class="c1"># save container for dependency injection</span>
    <span class="c1"># if any container is passed then we will activate that</span>
    <span class="c1"># otherwise we can skip it and use the default one</span>
    <span class="k">if</span> <span class="n">container</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span> <span class="o">=</span> <span class="n">InjectQ</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No container provided, using global singleton instance&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using provided dependency container instance&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span> <span class="o">=</span> <span class="n">container</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>

    <span class="c1"># Register task_manager, for async tasks</span>
    <span class="c1"># This will be used to run background tasks</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_task_manager</span> <span class="o">=</span> <span class="n">BackgroundTaskManager</span><span class="p">()</span>

    <span class="c1"># now setup the graph</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">()</span>

    <span class="c1"># Add START and END nodes (accept full node signature including dependencies)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding default START and END nodes&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">START</span><span class="p">]</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">deps</span><span class="p">:</span> <span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">END</span><span class="p">]</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">END</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">deps</span><span class="p">:</span> <span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;StateGraph initialized with </span><span class="si">%d</span><span class="s2"> nodes&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="pyagenity.graph.StateGraph.add_conditional_edges" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">add_conditional_edges</span>


<a href="#pyagenity.graph.StateGraph.add_conditional_edges" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">add_conditional_edges</span><span class="p">(</span><span class="n">from_node</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">path_map</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Add conditional routing between nodes based on runtime evaluation.</p>
<p>Creates dynamic routing logic where the next node is determined by evaluating
a condition function against the current state. This enables complex branching
logic, decision trees, and adaptive workflow routing.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.StateGraph.add_conditional_edges(from_node)" class="doc doc-heading doc-heading-parameter">                  <code>from_node</code>
<a href="#pyagenity.graph.StateGraph.add_conditional_edges(from_node)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the source node where the condition is evaluated.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.StateGraph.add_conditional_edges(condition)" class="doc doc-heading doc-heading-parameter">                  <code>condition</code>
<a href="#pyagenity.graph.StateGraph.add_conditional_edges(condition)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="collections.abc.Callable">Callable</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Callable function that takes the current AgentState and returns
a value used for routing decisions. Should be deterministic and
side-effect free.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.StateGraph.add_conditional_edges(path_map)" class="doc doc-heading doc-heading-parameter">                  <code>path_map</code>
<a href="#pyagenity.graph.StateGraph.add_conditional_edges(path_map)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional dictionary mapping condition results to destination nodes.
If provided, the condition's return value is looked up in this mapping.
If None, the condition should return the destination node name directly.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>StateGraph</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="            StateGraph (pyagenity.graph.state_graph.StateGraph)" href="../#pyagenity.graph.state_graph.StateGraph">StateGraph</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The graph instance for method chaining.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the condition function or path_map configuration is invalid.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="c1"># Direct routing - condition returns node name</span>
<span class="k">def</span><span class="w"> </span><span class="nf">route_by_priority</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="n">priority</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;priority&quot;</span><span class="p">,</span> <span class="s2">&quot;normal&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;urgent_handler&quot;</span> <span class="k">if</span> <span class="n">priority</span> <span class="o">==</span> <span class="s2">&quot;high&quot;</span> <span class="k">else</span> <span class="s2">&quot;normal_handler&quot;</span>


<span class="n">graph</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span><span class="s2">&quot;classifier&quot;</span><span class="p">,</span> <span class="n">route_by_priority</span><span class="p">)</span>


<span class="c1"># Mapped routing - condition result mapped to nodes</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_category</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">)</span>


<span class="n">category_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;finance&quot;</span><span class="p">:</span> <span class="s2">&quot;finance_processor&quot;</span><span class="p">,</span>
    <span class="s2">&quot;legal&quot;</span><span class="p">:</span> <span class="s2">&quot;legal_processor&quot;</span><span class="p">,</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;general_processor&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">graph</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span><span class="s2">&quot;categorizer&quot;</span><span class="p">,</span> <span class="n">get_category</span><span class="p">,</span> <span class="n">category_map</span><span class="p">)</span>
</code></pre></div>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>The condition function receives the current AgentState and should return
consistent results for the same state. If using path_map, ensure the
condition's return values match the map keys exactly.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/state_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_conditional_edges</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">from_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">condition</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
    <span class="n">path_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StateGraph&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add conditional routing between nodes based on runtime evaluation.</span>

<span class="sd">    Creates dynamic routing logic where the next node is determined by evaluating</span>
<span class="sd">    a condition function against the current state. This enables complex branching</span>
<span class="sd">    logic, decision trees, and adaptive workflow routing.</span>

<span class="sd">    Args:</span>
<span class="sd">        from_node: Name of the source node where the condition is evaluated.</span>
<span class="sd">        condition: Callable function that takes the current AgentState and returns</span>
<span class="sd">            a value used for routing decisions. Should be deterministic and</span>
<span class="sd">            side-effect free.</span>
<span class="sd">        path_map: Optional dictionary mapping condition results to destination nodes.</span>
<span class="sd">            If provided, the condition&#39;s return value is looked up in this mapping.</span>
<span class="sd">            If None, the condition should return the destination node name directly.</span>

<span class="sd">    Returns:</span>
<span class="sd">        StateGraph: The graph instance for method chaining.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the condition function or path_map configuration is invalid.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        # Direct routing - condition returns node name</span>
<span class="sd">        def route_by_priority(state):</span>
<span class="sd">            priority = state.data.get(&quot;priority&quot;, &quot;normal&quot;)</span>
<span class="sd">            return &quot;urgent_handler&quot; if priority == &quot;high&quot; else &quot;normal_handler&quot;</span>


<span class="sd">        graph.add_conditional_edges(&quot;classifier&quot;, route_by_priority)</span>


<span class="sd">        # Mapped routing - condition result mapped to nodes</span>
<span class="sd">        def get_category(state):</span>
<span class="sd">            return state.data.get(&quot;category&quot;, &quot;default&quot;)</span>


<span class="sd">        category_map = {</span>
<span class="sd">            &quot;finance&quot;: &quot;finance_processor&quot;,</span>
<span class="sd">            &quot;legal&quot;: &quot;legal_processor&quot;,</span>
<span class="sd">            &quot;default&quot;: &quot;general_processor&quot;,</span>
<span class="sd">        }</span>
<span class="sd">        graph.add_conditional_edges(&quot;categorizer&quot;, get_category, category_map)</span>
<span class="sd">        ```</span>

<span class="sd">    Note:</span>
<span class="sd">        The condition function receives the current AgentState and should return</span>
<span class="sd">        consistent results for the same state. If using path_map, ensure the</span>
<span class="sd">        condition&#39;s return values match the map keys exactly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add conditional edges from a node based on a condition function.</span>

<span class="sd">    Creates edges that are traversed based on the result of a condition</span>
<span class="sd">    function. The condition function receives the current state and should</span>
<span class="sd">    return a value that determines which edge to follow.</span>

<span class="sd">    Args:</span>
<span class="sd">        from_node: Name of the source node.</span>
<span class="sd">        condition: Function that evaluates the current state and returns</span>
<span class="sd">            a value to determine the next node.</span>
<span class="sd">        path_map: Optional mapping from condition results to target nodes.</span>
<span class="sd">            If provided, creates multiple conditional edges. If None,</span>
<span class="sd">            creates a single conditional edge.</span>

<span class="sd">    Returns:</span>
<span class="sd">        StateGraph: The graph instance for method chaining.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; def route_condition(state):</span>
<span class="sd">        ...     return &quot;success&quot; if state.success else &quot;failure&quot;</span>
<span class="sd">        &gt;&gt;&gt; graph.add_conditional_edges(</span>
<span class="sd">        ...     &quot;processor&quot;,</span>
<span class="sd">        ...     route_condition,</span>
<span class="sd">        ...     {&quot;success&quot;: &quot;next_step&quot;, &quot;failure&quot;: &quot;error_handler&quot;},</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create edges based on possible returns from condition function</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; adding conditional edges with path_map: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">from_node</span><span class="p">,</span>
        <span class="n">path_map</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">path_map</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; adding conditional edges with path_map: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">from_node</span><span class="p">,</span> <span class="n">path_map</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">condition_result</span><span class="p">,</span> <span class="n">target_node</span> <span class="ow">in</span> <span class="n">path_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">edge</span> <span class="o">=</span> <span class="n">Edge</span><span class="p">(</span><span class="n">from_node</span><span class="p">,</span> <span class="n">target_node</span><span class="p">,</span> <span class="n">condition</span><span class="p">)</span>
            <span class="n">edge</span><span class="o">.</span><span class="n">condition_result</span> <span class="o">=</span> <span class="n">condition_result</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Single conditional edge</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; adding single conditional edge&quot;</span><span class="p">,</span> <span class="n">from_node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Edge</span><span class="p">(</span><span class="n">from_node</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="pyagenity.graph.StateGraph.add_edge" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">add_edge</span>


<a href="#pyagenity.graph.StateGraph.add_edge" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">add_edge</span><span class="p">(</span><span class="n">from_node</span><span class="p">,</span> <span class="n">to_node</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Add a static edge between two nodes.</p>
<p>Creates a direct connection from one node to another. If the source
node is START, the target node becomes the entry point for the graph.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.StateGraph.add_edge(from_node)" class="doc doc-heading doc-heading-parameter">                  <code>from_node</code>
<a href="#pyagenity.graph.StateGraph.add_edge(from_node)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the source node.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.StateGraph.add_edge(to_node)" class="doc doc-heading doc-heading-parameter">                  <code>to_node</code>
<a href="#pyagenity.graph.StateGraph.add_edge(to_node)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the target node.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>StateGraph</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="            StateGraph (pyagenity.graph.state_graph.StateGraph)" href="../#pyagenity.graph.state_graph.StateGraph">StateGraph</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The graph instance for method chaining.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>graph.add_edge("node1", "node2")
graph.add_edge(START, "entry_node")  # Sets entry point</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/state_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_edge</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">from_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">to_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StateGraph&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a static edge between two nodes.</span>

<span class="sd">    Creates a direct connection from one node to another. If the source</span>
<span class="sd">    node is START, the target node becomes the entry point for the graph.</span>

<span class="sd">    Args:</span>
<span class="sd">        from_node: Name of the source node.</span>
<span class="sd">        to_node: Name of the target node.</span>

<span class="sd">    Returns:</span>
<span class="sd">        StateGraph: The graph instance for method chaining.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; graph.add_edge(&quot;node1&quot;, &quot;node2&quot;)</span>
<span class="sd">        &gt;&gt;&gt; graph.add_edge(START, &quot;entry_node&quot;)  # Sets entry point</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding edge from &#39;</span><span class="si">%s</span><span class="s2">&#39; to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">from_node</span><span class="p">,</span> <span class="n">to_node</span><span class="p">)</span>
    <span class="c1"># Set entry point if edge is from START</span>
    <span class="k">if</span> <span class="n">from_node</span> <span class="o">==</span> <span class="n">START</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entry_point</span> <span class="o">=</span> <span class="n">to_node</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set entry point to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">to_node</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Edge</span><span class="p">(</span><span class="n">from_node</span><span class="p">,</span> <span class="n">to_node</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Added edge (total edges: </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="pyagenity.graph.StateGraph.add_node" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">add_node</span>


<a href="#pyagenity.graph.StateGraph.add_node" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">add_node</span><span class="p">(</span><span class="n">name_or_func</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Add a node to the graph.</p>
<p>This method supports two calling patterns:
1. Pass a callable as the first argument (name inferred from function name)
2. Pass a name string and callable/ToolNode as separate arguments</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.StateGraph.add_node(name_or_func)" class="doc doc-heading doc-heading-parameter">                  <code>name_or_func</code>
<a href="#pyagenity.graph.StateGraph.add_node(name_or_func)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="str">str</span> | <span title="collections.abc.Callable">Callable</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Either the node name (str) or a callable function.
If callable, the function name will be used as the node name.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.StateGraph.add_node(func)" class="doc doc-heading doc-heading-parameter">                  <code>func</code>
<a href="#pyagenity.graph.StateGraph.add_node(func)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="collections.abc.Callable">Callable</span>, <a class="autorefs autorefs-internal" title="            ToolNode (pyagenity.graph.tool_node.ToolNode)" href="../#pyagenity.graph.tool_node.ToolNode">ToolNode</a>, None]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The function or ToolNode to execute. Required if name_or_func
is a string, ignored if name_or_func is callable.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>StateGraph</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="            StateGraph (pyagenity.graph.state_graph.StateGraph)" href="../#pyagenity.graph.state_graph.StateGraph">StateGraph</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The graph instance for method chaining.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If invalid arguments are provided.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<h6 id="pyagenity.graph.StateGraph.add_node--method-1-function-name-inferred">Method 1: Function name inferred<a class="headerlink" href="#pyagenity.graph.StateGraph.add_node--method-1-function-name-inferred" title="Permanent link">&para;</a></h6>
<p>graph.add_node(my_function)</p>
<h6 id="pyagenity.graph.StateGraph.add_node--method-2-explicit-name-and-function">Method 2: Explicit name and function<a class="headerlink" href="#pyagenity.graph.StateGraph.add_node--method-2-explicit-name-and-function" title="Permanent link">&para;</a></h6>
<p>graph.add_node("process", my_function)</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/state_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_node</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">name_or_func</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Callable</span><span class="p">,</span>
    <span class="n">func</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="s2">&quot;ToolNode&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StateGraph&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a node to the graph.</span>

<span class="sd">    This method supports two calling patterns:</span>
<span class="sd">    1. Pass a callable as the first argument (name inferred from function name)</span>
<span class="sd">    2. Pass a name string and callable/ToolNode as separate arguments</span>

<span class="sd">    Args:</span>
<span class="sd">        name_or_func: Either the node name (str) or a callable function.</span>
<span class="sd">            If callable, the function name will be used as the node name.</span>
<span class="sd">        func: The function or ToolNode to execute. Required if name_or_func</span>
<span class="sd">            is a string, ignored if name_or_func is callable.</span>

<span class="sd">    Returns:</span>
<span class="sd">        StateGraph: The graph instance for method chaining.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If invalid arguments are provided.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # Method 1: Function name inferred</span>
<span class="sd">        &gt;&gt;&gt; graph.add_node(my_function)</span>
<span class="sd">        &gt;&gt;&gt; # Method 2: Explicit name and function</span>
<span class="sd">        &gt;&gt;&gt; graph.add_node(&quot;process&quot;, my_function)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">name_or_func</span><span class="p">)</span> <span class="ow">and</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Function passed as first argument</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name_or_func</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">name_or_func</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding node &#39;</span><span class="si">%s</span><span class="s2">&#39; with inferred name from function&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name_or_func</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">callable</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">ToolNode</span><span class="p">)):</span>
        <span class="c1"># Name and function passed separately</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name_or_func</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Adding node &#39;</span><span class="si">%s</span><span class="s2">&#39; with explicit name and </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;ToolNode&quot;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">ToolNode</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;callable&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;Invalid arguments for add_node&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Added node &#39;</span><span class="si">%s</span><span class="s2">&#39; to graph (total nodes: </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="pyagenity.graph.StateGraph.compile" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">compile</span>


<a href="#pyagenity.graph.StateGraph.compile" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">compile</span><span class="p">(</span><span class="n">checkpointer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interrupt_before</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interrupt_after</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">callback_manager</span><span class="o">=</span><span class="n">CallbackManager</span><span class="p">())</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Compile the graph for execution.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.StateGraph.compile(checkpointer)" class="doc doc-heading doc-heading-parameter">                  <code>checkpointer</code>
<a href="#pyagenity.graph.StateGraph.compile(checkpointer)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            BaseCheckpointer (pyagenity.checkpointer.BaseCheckpointer)" href="../#pyagenity.checkpointer.BaseCheckpointer">BaseCheckpointer</a>[<span title="pyagenity.graph.state_graph.StateGraph[StateT]">StateT</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Checkpointer for state persistence</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.StateGraph.compile(store)" class="doc doc-heading doc-heading-parameter">                  <code>store</code>
<a href="#pyagenity.graph.StateGraph.compile(store)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            BaseStore (pyagenity.store.BaseStore)" href="../#pyagenity.store.BaseStore">BaseStore</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Store for additional data</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.StateGraph.compile(debug)" class="doc doc-heading doc-heading-parameter">                  <code>debug</code>
<a href="#pyagenity.graph.StateGraph.compile(debug)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Enable debug mode</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.StateGraph.compile(interrupt_before)" class="doc doc-heading doc-heading-parameter">                  <code>interrupt_before</code>
<a href="#pyagenity.graph.StateGraph.compile(interrupt_before)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of node names to interrupt before execution</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.StateGraph.compile(interrupt_after)" class="doc doc-heading doc-heading-parameter">                  <code>interrupt_after</code>
<a href="#pyagenity.graph.StateGraph.compile(interrupt_after)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of node names to interrupt after execution</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.StateGraph.compile(callback_manager)" class="doc doc-heading doc-heading-parameter">                  <code>callback_manager</code>
<a href="#pyagenity.graph.StateGraph.compile(callback_manager)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            CallbackManager (pyagenity.utils.CallbackManager)" href="../#pyagenity.utils.CallbackManager">CallbackManager</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Callback manager for executing hooks</p>
              </div>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            CallbackManager (pyagenity.utils.CallbackManager)" href="../#pyagenity.utils.CallbackManager">CallbackManager</a>()</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/state_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compile</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">checkpointer</span><span class="p">:</span> <span class="n">BaseCheckpointer</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">store</span><span class="p">:</span> <span class="n">BaseStore</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">interrupt_before</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">interrupt_after</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">callback_manager</span><span class="p">:</span> <span class="n">CallbackManager</span> <span class="o">=</span> <span class="n">CallbackManager</span><span class="p">(),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CompiledGraph[StateT]&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compile the graph for execution.</span>

<span class="sd">    Args:</span>
<span class="sd">        checkpointer: Checkpointer for state persistence</span>
<span class="sd">        store: Store for additional data</span>
<span class="sd">        debug: Enable debug mode</span>
<span class="sd">        interrupt_before: List of node names to interrupt before execution</span>
<span class="sd">        interrupt_after: List of node names to interrupt after execution</span>
<span class="sd">        callback_manager: Callback manager for executing hooks</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Compiling graph with </span><span class="si">%d</span><span class="s2"> nodes, </span><span class="si">%d</span><span class="s2"> edges, entry_point=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">),</span>
        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entry_point</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;Compile options: interrupt_before=</span><span class="si">%s</span><span class="s2">, interrupt_after=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">interrupt_before</span><span class="p">,</span>
        <span class="n">interrupt_after</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_point</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;No entry point set. Use set_entry_point() or add an edge from START.&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">GraphError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

    <span class="c1"># Validate graph structure</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Validating graph structure&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_validate_graph</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Graph structure validated successfully&quot;</span><span class="p">)</span>

    <span class="c1"># Validate interrupt node names</span>
    <span class="n">interrupt_before</span> <span class="o">=</span> <span class="n">interrupt_before</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">interrupt_after</span> <span class="o">=</span> <span class="n">interrupt_after</span> <span class="ow">or</span> <span class="p">[]</span>

    <span class="n">all_interrupt_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">interrupt_before</span> <span class="o">+</span> <span class="n">interrupt_after</span><span class="p">)</span>
    <span class="n">invalid_nodes</span> <span class="o">=</span> <span class="n">all_interrupt_nodes</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">invalid_nodes</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Invalid interrupt nodes: </span><span class="si">{</span><span class="n">invalid_nodes</span><span class="si">}</span><span class="s2">. Must be existing node names.&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">GraphError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Graph compilation completed successfully&quot;</span><span class="p">)</span>
    <span class="c1"># Import here to avoid circular import at module import time</span>
    <span class="c1"># Now update Checkpointer</span>
    <span class="k">if</span> <span class="n">checkpointer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pyagenity.checkpointer</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemoryCheckpointer</span>

        <span class="n">checkpointer</span> <span class="o">=</span> <span class="n">InMemoryCheckpointer</span><span class="p">[</span><span class="n">StateT</span><span class="p">]()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No checkpointer provided, using InMemoryCheckpointer&quot;</span><span class="p">)</span>

    <span class="c1"># Import the CompiledGraph class</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.compiled_graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">CompiledGraph</span>

    <span class="c1"># Setup dependencies</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind_instance</span><span class="p">(</span>
        <span class="n">BaseCheckpointer</span><span class="p">,</span>
        <span class="n">checkpointer</span><span class="p">,</span>
        <span class="n">allow_concrete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># not null as we set default</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind_instance</span><span class="p">(</span>
        <span class="n">BaseStore</span><span class="p">,</span>
        <span class="n">store</span><span class="p">,</span>
        <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">allow_concrete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind_instance</span><span class="p">(</span>
        <span class="n">CallbackManager</span><span class="p">,</span>
        <span class="n">callback_manager</span><span class="p">,</span>
        <span class="n">allow_concrete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># not null as we set default</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;interrupt_before&quot;</span><span class="p">,</span> <span class="n">interrupt_before</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;interrupt_after&quot;</span><span class="p">,</span> <span class="n">interrupt_after</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind_instance</span><span class="p">(</span><span class="n">StateGraph</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="n">app</span> <span class="o">=</span> <span class="n">CompiledGraph</span><span class="p">(</span>
        <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">,</span>
        <span class="n">interrupt_after</span><span class="o">=</span><span class="n">interrupt_after</span><span class="p">,</span>
        <span class="n">interrupt_before</span><span class="o">=</span><span class="n">interrupt_before</span><span class="p">,</span>
        <span class="n">state_graph</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">checkpointer</span><span class="o">=</span><span class="n">checkpointer</span><span class="p">,</span>
        <span class="n">publisher</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span><span class="p">,</span>
        <span class="n">store</span><span class="o">=</span><span class="n">store</span><span class="p">,</span>
        <span class="n">task_manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_task_manager</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">CompiledGraph</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span>
    <span class="c1"># Compile the Graph, so it will optimize the dependency graph</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">app</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="pyagenity.graph.StateGraph.set_entry_point" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">set_entry_point</span>


<a href="#pyagenity.graph.StateGraph.set_entry_point" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">set_entry_point</span><span class="p">(</span><span class="n">node_name</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Set the entry point for the graph.</p>


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/state_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_entry_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StateGraph&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the entry point for the graph.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">entry_point</span> <span class="o">=</span> <span class="n">node_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="n">node_name</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set entry point to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">node_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="pyagenity.graph.ToolNode" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">ToolNode</span>


<a href="#pyagenity.graph.ToolNode" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            SchemaMixin (pyagenity.graph.tool_node.schema.SchemaMixin)" href="../#pyagenity.graph.tool_node.schema.SchemaMixin">SchemaMixin</a></code>, <code><a class="autorefs autorefs-internal" title="            LocalExecMixin (pyagenity.graph.tool_node.executors.LocalExecMixin)" href="../#pyagenity.graph.tool_node.executors.LocalExecMixin">LocalExecMixin</a></code>, <code><a class="autorefs autorefs-internal" title="            MCPMixin (pyagenity.graph.tool_node.executors.MCPMixin)" href="../#pyagenity.graph.tool_node.executors.MCPMixin">MCPMixin</a></code>, <code><a class="autorefs autorefs-internal" title="            ComposioMixin (pyagenity.graph.tool_node.executors.ComposioMixin)" href="../#pyagenity.graph.tool_node.executors.ComposioMixin">ComposioMixin</a></code>, <code><a class="autorefs autorefs-internal" title="            LangChainMixin (pyagenity.graph.tool_node.executors.LangChainMixin)" href="../#pyagenity.graph.tool_node.executors.LangChainMixin">LangChainMixin</a></code>, <code><a class="autorefs autorefs-internal" title="            KwargsResolverMixin (pyagenity.graph.tool_node.executors.KwargsResolverMixin)" href="../#pyagenity.graph.tool_node.executors.KwargsResolverMixin">KwargsResolverMixin</a></code></p>


        <p>A unified registry and executor for callable functions from various tool providers.</p>
<p>ToolNode serves as the central hub for managing and executing tools from multiple sources:
- Local Python functions
- MCP (Model Context Protocol) tools
- Composio adapter tools
- LangChain tools</p>
<p>The class uses a mixin-based architecture to separate concerns and maintain clean
integration with different tool providers. It provides both synchronous and asynchronous
execution methods with comprehensive event publishing and error handling.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.ToolNode._funcs">_funcs</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Callable">Callable</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping function names to callable functions.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.ToolNode._client">_client</span></code></td>
            <td>
                  <code><span title="pyagenity.graph.tool_node.deps.Client">Client</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional MCP client for remote tool execution.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.ToolNode._composio">_composio</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            ComposioAdapter (pyagenity.adapters.tools.ComposioAdapter)" href="../#pyagenity.adapters.tools.ComposioAdapter">ComposioAdapter</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional Composio adapter for external integrations.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.ToolNode._langchain">_langchain</span></code></td>
            <td>
                  <code><span title="typing.Any">Any</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional LangChain adapter for LangChain tools.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            mcp_tools


  
      instance-attribute
   (pyagenity.graph.ToolNode.mcp_tools)" href="../#pyagenity.graph.ToolNode.mcp_tools">mcp_tools</a></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of available MCP tool names.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            composio_tools


  
      instance-attribute
   (pyagenity.graph.ToolNode.composio_tools)" href="../#pyagenity.graph.ToolNode.composio_tools">composio_tools</a></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of available Composio tool names.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            langchain_tools


  
      instance-attribute
   (pyagenity.graph.ToolNode.langchain_tools)" href="../#pyagenity.graph.ToolNode.langchain_tools">langchain_tools</a></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of available LangChain tool names.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="c1"># Define local tools</span>
<span class="k">def</span><span class="w"> </span><span class="nf">weather_tool</span><span class="p">(</span><span class="n">location</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Weather in </span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s2">: Sunny, 25°C&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">calculator</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>


<span class="c1"># Create ToolNode with local functions</span>
<span class="n">tools</span> <span class="o">=</span> <span class="n">ToolNode</span><span class="p">([</span><span class="n">weather_tool</span><span class="p">,</span> <span class="n">calculator</span><span class="p">])</span>

<span class="c1"># Execute a tool</span>
<span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">tools</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weather_tool&quot;</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="s2">&quot;New York&quot;</span><span class="p">},</span>
    <span class="n">tool_call_id</span><span class="o">=</span><span class="s2">&quot;call_123&quot;</span><span class="p">,</span>
    <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;user1&quot;</span><span class="p">},</span>
    <span class="n">state</span><span class="o">=</span><span class="n">agent_state</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>
</details>











<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            __init__ (pyagenity.graph.ToolNode.__init__)" href="../#pyagenity.graph.ToolNode.__init__">__init__</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Initialize ToolNode with functions and optional tool adapters.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            all_tools


  
      async
   (pyagenity.graph.ToolNode.all_tools)" href="../#pyagenity.graph.ToolNode.all_tools">all_tools</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Get all available tools from all configured providers.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            all_tools_sync (pyagenity.graph.ToolNode.all_tools_sync)" href="../#pyagenity.graph.ToolNode.all_tools_sync">all_tools_sync</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Synchronously get all available tools from all configured providers.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            get_local_tool (pyagenity.graph.ToolNode.get_local_tool)" href="../#pyagenity.graph.ToolNode.get_local_tool">get_local_tool</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Generate OpenAI-compatible tool definitions for all registered local functions.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            invoke


  
      async
   (pyagenity.graph.ToolNode.invoke)" href="../#pyagenity.graph.ToolNode.invoke">invoke</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Execute a specific tool by name with the provided arguments.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            stream


  
      async
   (pyagenity.graph.ToolNode.stream)" href="../#pyagenity.graph.ToolNode.stream">stream</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Execute a tool with streaming support, yielding incremental results.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>



              <details class="quote">
                <summary>Source code in <code>pyagenity/graph/tool_node/base.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ToolNode</span><span class="p">(</span>
    <span class="n">SchemaMixin</span><span class="p">,</span>
    <span class="n">LocalExecMixin</span><span class="p">,</span>
    <span class="n">MCPMixin</span><span class="p">,</span>
    <span class="n">ComposioMixin</span><span class="p">,</span>
    <span class="n">LangChainMixin</span><span class="p">,</span>
    <span class="n">KwargsResolverMixin</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A unified registry and executor for callable functions from various tool providers.</span>

<span class="sd">    ToolNode serves as the central hub for managing and executing tools from multiple sources:</span>
<span class="sd">    - Local Python functions</span>
<span class="sd">    - MCP (Model Context Protocol) tools</span>
<span class="sd">    - Composio adapter tools</span>
<span class="sd">    - LangChain tools</span>

<span class="sd">    The class uses a mixin-based architecture to separate concerns and maintain clean</span>
<span class="sd">    integration with different tool providers. It provides both synchronous and asynchronous</span>
<span class="sd">    execution methods with comprehensive event publishing and error handling.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        _funcs: Dictionary mapping function names to callable functions.</span>
<span class="sd">        _client: Optional MCP client for remote tool execution.</span>
<span class="sd">        _composio: Optional Composio adapter for external integrations.</span>
<span class="sd">        _langchain: Optional LangChain adapter for LangChain tools.</span>
<span class="sd">        mcp_tools: List of available MCP tool names.</span>
<span class="sd">        composio_tools: List of available Composio tool names.</span>
<span class="sd">        langchain_tools: List of available LangChain tool names.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        # Define local tools</span>
<span class="sd">        def weather_tool(location: str) -&gt; str:</span>
<span class="sd">            return f&quot;Weather in {location}: Sunny, 25°C&quot;</span>


<span class="sd">        def calculator(a: int, b: int) -&gt; int:</span>
<span class="sd">            return a + b</span>


<span class="sd">        # Create ToolNode with local functions</span>
<span class="sd">        tools = ToolNode([weather_tool, calculator])</span>

<span class="sd">        # Execute a tool</span>
<span class="sd">        result = await tools.invoke(</span>
<span class="sd">            name=&quot;weather_tool&quot;,</span>
<span class="sd">            args={&quot;location&quot;: &quot;New York&quot;},</span>
<span class="sd">            tool_call_id=&quot;call_123&quot;,</span>
<span class="sd">            config={&quot;user_id&quot;: &quot;user1&quot;},</span>
<span class="sd">            state=agent_state,</span>
<span class="sd">        )</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">functions</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">],</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">deps</span><span class="o">.</span><span class="n">Client</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
        <span class="n">composio_adapter</span><span class="p">:</span> <span class="n">ComposioAdapter</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">langchain_adapter</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize ToolNode with functions and optional tool adapters.</span>

<span class="sd">        Args:</span>
<span class="sd">            functions: Iterable of callable functions to register as tools. Each function</span>
<span class="sd">                will be registered with its `__name__` as the tool identifier.</span>
<span class="sd">            client: Optional MCP (Model Context Protocol) client for remote tool access.</span>
<span class="sd">                Requires &#39;fastmcp&#39; and &#39;mcp&#39; packages to be installed.</span>
<span class="sd">            composio_adapter: Optional Composio adapter for external integrations and</span>
<span class="sd">                third-party API access.</span>
<span class="sd">            langchain_adapter: Optional LangChain adapter for accessing LangChain tools</span>
<span class="sd">                and integrations.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ImportError: If MCP client is provided but required packages are not installed.</span>
<span class="sd">            TypeError: If any item in functions is not callable.</span>

<span class="sd">        Note:</span>
<span class="sd">            When using MCP client functionality, ensure you have installed the required</span>
<span class="sd">            dependencies with: `pip install pyagenity[mcp]`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing ToolNode with </span><span class="si">%d</span><span class="s2"> functions&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">functions</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Read flags dynamically so tests can patch pyagenity.graph.tool_node.HAS_*</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pyagenity.graph.tool_node&quot;</span><span class="p">)</span>
            <span class="n">has_fastmcp</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s2">&quot;HAS_FASTMCP&quot;</span><span class="p">,</span> <span class="n">deps</span><span class="o">.</span><span class="n">HAS_FASTMCP</span><span class="p">)</span> <span class="k">if</span> <span class="n">mod</span> <span class="k">else</span> <span class="n">deps</span><span class="o">.</span><span class="n">HAS_FASTMCP</span>
            <span class="n">has_mcp</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s2">&quot;HAS_MCP&quot;</span><span class="p">,</span> <span class="n">deps</span><span class="o">.</span><span class="n">HAS_MCP</span><span class="p">)</span> <span class="k">if</span> <span class="n">mod</span> <span class="k">else</span> <span class="n">deps</span><span class="o">.</span><span class="n">HAS_MCP</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_fastmcp</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">has_mcp</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                    <span class="s2">&quot;MCP client functionality requires &#39;fastmcp&#39; and &#39;mcp&#39; packages. &quot;</span>
                    <span class="s2">&quot;Install with: pip install pyagenity[mcp]&quot;</span>
                <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;ToolNode initialized with MCP client&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span> <span class="n">deps</span><span class="o">.</span><span class="n">Client</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">client</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_composio</span><span class="p">:</span> <span class="n">ComposioAdapter</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">composio_adapter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_langchain</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">langchain_adapter</span>

        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">functions</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;ToolNode only accepts callables&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">[</span><span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mcp_tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composio_tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">langchain_tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_all_tools_async</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
        <span class="n">tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_local_tool</span><span class="p">()</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mcp_tool</span><span class="p">())</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_composio_tools</span><span class="p">())</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_langchain_tools</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">all_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all available tools from all configured providers.</span>

<span class="sd">        Retrieves and combines tool definitions from local functions, MCP client,</span>
<span class="sd">        Composio adapter, and LangChain adapter. Each tool definition includes</span>
<span class="sd">        the function schema with parameters and descriptions.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of tool definitions in OpenAI function calling format. Each dict</span>
<span class="sd">            contains &#39;type&#39;: &#39;function&#39; and &#39;function&#39; with name, description,</span>
<span class="sd">            and parameters schema.</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            tools = await tool_node.all_tools()</span>
<span class="sd">            # Returns:</span>
<span class="sd">            # [</span>
<span class="sd">            #   {</span>
<span class="sd">            #     &quot;type&quot;: &quot;function&quot;,</span>
<span class="sd">            #     &quot;function&quot;: {</span>
<span class="sd">            #       &quot;name&quot;: &quot;weather_tool&quot;,</span>
<span class="sd">            #       &quot;description&quot;: &quot;Get weather information for a location&quot;,</span>
<span class="sd">            #       &quot;parameters&quot;: {</span>
<span class="sd">            #         &quot;type&quot;: &quot;object&quot;,</span>
<span class="sd">            #         &quot;properties&quot;: {</span>
<span class="sd">            #           &quot;location&quot;: {&quot;type&quot;: &quot;string&quot;}</span>
<span class="sd">            #         },</span>
<span class="sd">            #         &quot;required&quot;: [&quot;location&quot;]</span>
<span class="sd">            #       }</span>
<span class="sd">            #     }</span>
<span class="sd">            #   }</span>
<span class="sd">            # ]</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_tools_async</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">all_tools_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Synchronously get all available tools from all configured providers.</span>

<span class="sd">        This is a synchronous wrapper around the async all_tools() method.</span>
<span class="sd">        It uses asyncio.run() to handle async operations from MCP, Composio,</span>
<span class="sd">        and LangChain adapters.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of tool definitions in OpenAI function calling format.</span>

<span class="sd">        Note:</span>
<span class="sd">            Prefer using the async `all_tools()` method when possible, especially</span>
<span class="sd">            in async contexts, to avoid potential event loop issues.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_local_tool</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_mcp_tool</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_composio_tools</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">comp</span><span class="p">:</span>
            <span class="n">tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
        <span class="n">lc</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_langchain_tools</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">lc</span><span class="p">:</span>
            <span class="n">tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span>  <span class="c1"># noqa: PLR0915</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">tool_call_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
        <span class="n">callback_manager</span><span class="p">:</span> <span class="n">CallbackManager</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a specific tool by name with the provided arguments.</span>

<span class="sd">        This method handles tool execution across all configured providers (local,</span>
<span class="sd">        MCP, Composio, LangChain) with comprehensive error handling, event publishing,</span>
<span class="sd">        and callback management.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name of the tool to execute.</span>
<span class="sd">            args: Dictionary of arguments to pass to the tool function.</span>
<span class="sd">            tool_call_id: Unique identifier for this tool execution, used for</span>
<span class="sd">                tracking and result correlation.</span>
<span class="sd">            config: Configuration dictionary containing execution context and</span>
<span class="sd">                user-specific settings.</span>
<span class="sd">            state: Current agent state for context-aware tool execution.</span>
<span class="sd">            callback_manager: Manager for executing pre/post execution callbacks.</span>
<span class="sd">                Injected via dependency injection if not provided.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Message object containing tool execution results, either successful</span>
<span class="sd">            output or error information with appropriate status indicators.</span>

<span class="sd">        Raises:</span>
<span class="sd">            The method handles all exceptions internally and returns error Messages</span>
<span class="sd">            rather than raising exceptions, ensuring robust execution flow.</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            result = await tool_node.invoke(</span>
<span class="sd">                name=&quot;weather_tool&quot;,</span>
<span class="sd">                args={&quot;location&quot;: &quot;Paris&quot;, &quot;units&quot;: &quot;metric&quot;},</span>
<span class="sd">                tool_call_id=&quot;call_abc123&quot;,</span>
<span class="sd">                config={&quot;user_id&quot;: &quot;user1&quot;, &quot;session_id&quot;: &quot;session1&quot;},</span>
<span class="sd">                state=current_agent_state,</span>
<span class="sd">            )</span>

<span class="sd">            # result is a Message with tool execution results</span>
<span class="sd">            print(result.content)  # Tool output or error information</span>
<span class="sd">            ```</span>

<span class="sd">        Note:</span>
<span class="sd">            The method publishes execution events throughout the process for</span>
<span class="sd">            monitoring and debugging purposes. Tool execution is routed based</span>
<span class="sd">            on tool provider precedence: MCP → Composio → LangChain → Local.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Executing tool &#39;</span><span class="si">%s</span><span class="s2">&#39; with </span><span class="si">%d</span><span class="s2"> arguments&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Tool arguments: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

        <span class="n">event</span> <span class="o">=</span> <span class="n">EventModel</span><span class="o">.</span><span class="n">default</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call_id</span><span class="p">,</span> <span class="s2">&quot;function_name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">},</span>
            <span class="n">content_type</span><span class="o">=</span><span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_CALL</span><span class="p">],</span>
            <span class="n">event</span><span class="o">=</span><span class="n">Event</span><span class="o">.</span><span class="n">TOOL_EXECUTION</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">node_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="c1"># Attach structured tool call block</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">ToolCallBlock</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcp_tools</span><span class="p">:</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_mcp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mcp_execute</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">args</span><span class="p">,</span>
                <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="n">config</span><span class="p">,</span>
                <span class="n">callback_manager</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="c1"># Attach tool result block mirroring the tool output</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
                <span class="p">]</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">composio_tools</span><span class="p">:</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_composio&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_composio_execute</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">args</span><span class="p">,</span>
                <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="n">config</span><span class="p">,</span>
                <span class="n">callback_manager</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
                <span class="p">]</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">langchain_tools</span><span class="p">:</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_langchain&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_langchain_execute</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">args</span><span class="p">,</span>
                <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="n">config</span><span class="p">,</span>
                <span class="n">callback_manager</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
                <span class="p">]</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">:</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_mcp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_execute</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">args</span><span class="p">,</span>
                <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="n">config</span><span class="p">,</span>
                <span class="n">state</span><span class="p">,</span>
                <span class="n">callback_manager</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
                <span class="p">]</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Tool &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_msg</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">ERROR</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">ERROR</span><span class="p">]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Message</span><span class="o">.</span><span class="n">tool_message</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="p">[</span>
                <span class="n">ErrorBlock</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">error_msg</span><span class="p">),</span>
                <span class="n">ToolResultBlock</span><span class="p">(</span>
                    <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                    <span class="n">output</span><span class="o">=</span><span class="n">error_msg</span><span class="p">,</span>
                    <span class="n">is_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">status</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">],</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream</span><span class="p">(</span>  <span class="c1"># noqa: PLR0915</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">tool_call_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
        <span class="n">callback_manager</span><span class="p">:</span> <span class="n">CallbackManager</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">AsyncIterator</span><span class="p">[</span><span class="n">Message</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a tool with streaming support, yielding incremental results.</span>

<span class="sd">        Similar to invoke() but designed for tools that can provide streaming responses</span>
<span class="sd">        or when you want to process results as they become available. Currently,</span>
<span class="sd">        most tool providers return complete results, so this method typically yields</span>
<span class="sd">        a single Message with the full result.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name of the tool to execute.</span>
<span class="sd">            args: Dictionary of arguments to pass to the tool function.</span>
<span class="sd">            tool_call_id: Unique identifier for this tool execution.</span>
<span class="sd">            config: Configuration dictionary containing execution context.</span>
<span class="sd">            state: Current agent state for context-aware tool execution.</span>
<span class="sd">            callback_manager: Manager for executing pre/post execution callbacks.</span>

<span class="sd">        Yields:</span>
<span class="sd">            Message objects containing tool execution results or status updates.</span>
<span class="sd">            For most tools, this will yield a single complete result Message.</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            async for message in tool_node.stream(</span>
<span class="sd">                name=&quot;data_processor&quot;,</span>
<span class="sd">                args={&quot;dataset&quot;: &quot;large_data.csv&quot;},</span>
<span class="sd">                tool_call_id=&quot;call_stream123&quot;,</span>
<span class="sd">                config={&quot;user_id&quot;: &quot;user1&quot;},</span>
<span class="sd">                state=current_state,</span>
<span class="sd">            ):</span>
<span class="sd">                print(f&quot;Received: {message.content}&quot;)</span>
<span class="sd">                # Process each streamed result</span>
<span class="sd">            ```</span>

<span class="sd">        Note:</span>
<span class="sd">            The streaming interface is designed for future expansion where tools</span>
<span class="sd">            may provide true streaming responses. Currently, it provides a</span>
<span class="sd">            consistent async iterator interface over tool results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Executing tool &#39;</span><span class="si">%s</span><span class="s2">&#39; with </span><span class="si">%d</span><span class="s2"> arguments&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Tool arguments: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">EventModel</span><span class="o">.</span><span class="n">default</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call_id</span><span class="p">,</span> <span class="s2">&quot;function_name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">},</span>
            <span class="n">content_type</span><span class="o">=</span><span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_CALL</span><span class="p">],</span>
            <span class="n">event</span><span class="o">=</span><span class="n">Event</span><span class="o">.</span><span class="n">TOOL_EXECUTION</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">node_name</span> <span class="o">=</span> <span class="s2">&quot;ToolNode&quot;</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">ToolCallBlock</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcp_tools</span><span class="p">:</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;function_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mcp&quot;</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mcp_execute</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">args</span><span class="p">,</span>
                <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="n">config</span><span class="p">,</span>
                <span class="n">callback_manager</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
                <span class="p">]</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">message</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">composio_tools</span><span class="p">:</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;function_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;composio&quot;</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_composio_execute</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">args</span><span class="p">,</span>
                <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="n">config</span><span class="p">,</span>
                <span class="n">callback_manager</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
                <span class="p">]</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">message</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">langchain_tools</span><span class="p">:</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;function_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;langchain&quot;</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_langchain_execute</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">args</span><span class="p">,</span>
                <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="n">config</span><span class="p">,</span>
                <span class="n">callback_manager</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
                <span class="p">]</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">message</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">:</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;function_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;internal&quot;</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_execute</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">args</span><span class="p">,</span>
                <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="n">config</span><span class="p">,</span>
                <span class="n">state</span><span class="p">,</span>
                <span class="n">callback_manager</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
                <span class="p">]</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">result</span>
            <span class="k">return</span>

        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Tool &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_msg</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">ERROR</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">ERROR</span><span class="p">]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="k">yield</span> <span class="n">Message</span><span class="o">.</span><span class="n">tool_message</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="p">[</span>
                <span class="n">ErrorBlock</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">error_msg</span><span class="p">),</span>
                <span class="n">ToolResultBlock</span><span class="p">(</span>
                    <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                    <span class="n">output</span><span class="o">=</span><span class="n">error_msg</span><span class="p">,</span>
                    <span class="n">is_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">status</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">],</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">





<h4 id="pyagenity.graph.ToolNode-attributes">Attributes<a href="#pyagenity.graph.ToolNode-attributes" class="headerlink" title="Permanent link">&para;</a></h4>

<div class="doc doc-object doc-attribute">



<h5 id="pyagenity.graph.ToolNode.composio_tools" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">composio_tools</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.ToolNode.composio_tools" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">composio_tools</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="pyagenity.graph.ToolNode.langchain_tools" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">langchain_tools</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.ToolNode.langchain_tools" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">langchain_tools</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="pyagenity.graph.ToolNode.mcp_tools" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">mcp_tools</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.ToolNode.mcp_tools" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">mcp_tools</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>


<h4 id="pyagenity.graph.ToolNode-functions">Functions<a href="#pyagenity.graph.ToolNode-functions" class="headerlink" title="Permanent link">&para;</a></h4>

<div class="doc doc-object doc-function">


<h5 id="pyagenity.graph.ToolNode.__init__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">__init__</span>


<a href="#pyagenity.graph.ToolNode.__init__" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">__init__</span><span class="p">(</span><span class="n">functions</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">composio_adapter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">langchain_adapter</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Initialize ToolNode with functions and optional tool adapters.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.ToolNode.__init__(functions)" class="doc doc-heading doc-heading-parameter">                  <code>functions</code>
<a href="#pyagenity.graph.ToolNode.__init__(functions)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="typing.Iterable">Iterable</span>[<span title="typing.Callable">Callable</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Iterable of callable functions to register as tools. Each function
will be registered with its <code>__name__</code> as the tool identifier.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.ToolNode.__init__(client)" class="doc doc-heading doc-heading-parameter">                  <code>client</code>
<a href="#pyagenity.graph.ToolNode.__init__(client)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="pyagenity.graph.tool_node.deps.Client">Client</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional MCP (Model Context Protocol) client for remote tool access.
Requires 'fastmcp' and 'mcp' packages to be installed.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.ToolNode.__init__(composio_adapter)" class="doc doc-heading doc-heading-parameter">                  <code>composio_adapter</code>
<a href="#pyagenity.graph.ToolNode.__init__(composio_adapter)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            ComposioAdapter (pyagenity.adapters.tools.ComposioAdapter)" href="../#pyagenity.adapters.tools.ComposioAdapter">ComposioAdapter</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional Composio adapter for external integrations and
third-party API access.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.ToolNode.__init__(langchain_adapter)" class="doc doc-heading doc-heading-parameter">                  <code>langchain_adapter</code>
<a href="#pyagenity.graph.ToolNode.__init__(langchain_adapter)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="typing.Any">Any</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional LangChain adapter for accessing LangChain tools
and integrations.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ImportError">ImportError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If MCP client is provided but required packages are not installed.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If any item in functions is not callable.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>When using MCP client functionality, ensure you have installed the required
dependencies with: <code>pip install pyagenity[mcp]</code></p>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/tool_node/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">functions</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">],</span>
    <span class="n">client</span><span class="p">:</span> <span class="n">deps</span><span class="o">.</span><span class="n">Client</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
    <span class="n">composio_adapter</span><span class="p">:</span> <span class="n">ComposioAdapter</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">langchain_adapter</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize ToolNode with functions and optional tool adapters.</span>

<span class="sd">    Args:</span>
<span class="sd">        functions: Iterable of callable functions to register as tools. Each function</span>
<span class="sd">            will be registered with its `__name__` as the tool identifier.</span>
<span class="sd">        client: Optional MCP (Model Context Protocol) client for remote tool access.</span>
<span class="sd">            Requires &#39;fastmcp&#39; and &#39;mcp&#39; packages to be installed.</span>
<span class="sd">        composio_adapter: Optional Composio adapter for external integrations and</span>
<span class="sd">            third-party API access.</span>
<span class="sd">        langchain_adapter: Optional LangChain adapter for accessing LangChain tools</span>
<span class="sd">            and integrations.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ImportError: If MCP client is provided but required packages are not installed.</span>
<span class="sd">        TypeError: If any item in functions is not callable.</span>

<span class="sd">    Note:</span>
<span class="sd">        When using MCP client functionality, ensure you have installed the required</span>
<span class="sd">        dependencies with: `pip install pyagenity[mcp]`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing ToolNode with </span><span class="si">%d</span><span class="s2"> functions&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">functions</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Read flags dynamically so tests can patch pyagenity.graph.tool_node.HAS_*</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pyagenity.graph.tool_node&quot;</span><span class="p">)</span>
        <span class="n">has_fastmcp</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s2">&quot;HAS_FASTMCP&quot;</span><span class="p">,</span> <span class="n">deps</span><span class="o">.</span><span class="n">HAS_FASTMCP</span><span class="p">)</span> <span class="k">if</span> <span class="n">mod</span> <span class="k">else</span> <span class="n">deps</span><span class="o">.</span><span class="n">HAS_FASTMCP</span>
        <span class="n">has_mcp</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s2">&quot;HAS_MCP&quot;</span><span class="p">,</span> <span class="n">deps</span><span class="o">.</span><span class="n">HAS_MCP</span><span class="p">)</span> <span class="k">if</span> <span class="n">mod</span> <span class="k">else</span> <span class="n">deps</span><span class="o">.</span><span class="n">HAS_MCP</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_fastmcp</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">has_mcp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">&quot;MCP client functionality requires &#39;fastmcp&#39; and &#39;mcp&#39; packages. &quot;</span>
                <span class="s2">&quot;Install with: pip install pyagenity[mcp]&quot;</span>
            <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;ToolNode initialized with MCP client&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span> <span class="n">deps</span><span class="o">.</span><span class="n">Client</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">client</span>  <span class="c1"># type: ignore</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_composio</span><span class="p">:</span> <span class="n">ComposioAdapter</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">composio_adapter</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_langchain</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">langchain_adapter</span>

    <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">functions</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;ToolNode only accepts callables&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">[</span><span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">mcp_tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">composio_tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">langchain_tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="pyagenity.graph.ToolNode.all_tools" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">all_tools</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.ToolNode.all_tools" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">all_tools</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Get all available tools from all configured providers.</p>
<p>Retrieves and combines tool definitions from local functions, MCP client,
Composio adapter, and LangChain adapter. Each tool definition includes
the function schema with parameters and descriptions.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of tool definitions in OpenAI function calling format. Each dict</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>contains 'type': 'function' and 'function' with name, description,</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>and parameters schema.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">tool_node</span><span class="o">.</span><span class="n">all_tools</span><span class="p">()</span>
<span class="c1"># Returns:</span>
<span class="c1"># [</span>
<span class="c1">#   {</span>
<span class="c1">#     &quot;type&quot;: &quot;function&quot;,</span>
<span class="c1">#     &quot;function&quot;: {</span>
<span class="c1">#       &quot;name&quot;: &quot;weather_tool&quot;,</span>
<span class="c1">#       &quot;description&quot;: &quot;Get weather information for a location&quot;,</span>
<span class="c1">#       &quot;parameters&quot;: {</span>
<span class="c1">#         &quot;type&quot;: &quot;object&quot;,</span>
<span class="c1">#         &quot;properties&quot;: {</span>
<span class="c1">#           &quot;location&quot;: {&quot;type&quot;: &quot;string&quot;}</span>
<span class="c1">#         },</span>
<span class="c1">#         &quot;required&quot;: [&quot;location&quot;]</span>
<span class="c1">#       }</span>
<span class="c1">#     }</span>
<span class="c1">#   }</span>
<span class="c1"># ]</span>
</code></pre></div>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/tool_node/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">all_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get all available tools from all configured providers.</span>

<span class="sd">    Retrieves and combines tool definitions from local functions, MCP client,</span>
<span class="sd">    Composio adapter, and LangChain adapter. Each tool definition includes</span>
<span class="sd">    the function schema with parameters and descriptions.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of tool definitions in OpenAI function calling format. Each dict</span>
<span class="sd">        contains &#39;type&#39;: &#39;function&#39; and &#39;function&#39; with name, description,</span>
<span class="sd">        and parameters schema.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        tools = await tool_node.all_tools()</span>
<span class="sd">        # Returns:</span>
<span class="sd">        # [</span>
<span class="sd">        #   {</span>
<span class="sd">        #     &quot;type&quot;: &quot;function&quot;,</span>
<span class="sd">        #     &quot;function&quot;: {</span>
<span class="sd">        #       &quot;name&quot;: &quot;weather_tool&quot;,</span>
<span class="sd">        #       &quot;description&quot;: &quot;Get weather information for a location&quot;,</span>
<span class="sd">        #       &quot;parameters&quot;: {</span>
<span class="sd">        #         &quot;type&quot;: &quot;object&quot;,</span>
<span class="sd">        #         &quot;properties&quot;: {</span>
<span class="sd">        #           &quot;location&quot;: {&quot;type&quot;: &quot;string&quot;}</span>
<span class="sd">        #         },</span>
<span class="sd">        #         &quot;required&quot;: [&quot;location&quot;]</span>
<span class="sd">        #       }</span>
<span class="sd">        #     }</span>
<span class="sd">        #   }</span>
<span class="sd">        # ]</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_tools_async</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="pyagenity.graph.ToolNode.all_tools_sync" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">all_tools_sync</span>


<a href="#pyagenity.graph.ToolNode.all_tools_sync" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">all_tools_sync</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Synchronously get all available tools from all configured providers.</p>
<p>This is a synchronous wrapper around the async all_tools() method.
It uses asyncio.run() to handle async operations from MCP, Composio,
and LangChain adapters.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of tool definitions in OpenAI function calling format.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>Prefer using the async <code>all_tools()</code> method when possible, especially
in async contexts, to avoid potential event loop issues.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/tool_node/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">all_tools_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Synchronously get all available tools from all configured providers.</span>

<span class="sd">    This is a synchronous wrapper around the async all_tools() method.</span>
<span class="sd">    It uses asyncio.run() to handle async operations from MCP, Composio,</span>
<span class="sd">    and LangChain adapters.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of tool definitions in OpenAI function calling format.</span>

<span class="sd">    Note:</span>
<span class="sd">        Prefer using the async `all_tools()` method when possible, especially</span>
<span class="sd">        in async contexts, to avoid potential event loop issues.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_local_tool</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_mcp_tool</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">comp</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_composio_tools</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">comp</span><span class="p">:</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
    <span class="n">lc</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_langchain_tools</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">lc</span><span class="p">:</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tools</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="pyagenity.graph.ToolNode.get_local_tool" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">get_local_tool</span>


<a href="#pyagenity.graph.ToolNode.get_local_tool" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_local_tool</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Generate OpenAI-compatible tool definitions for all registered local functions.</p>
<p>Inspects all registered functions in _funcs and automatically generates
tool schemas by analyzing function signatures, type annotations, and docstrings.
Excludes injectable parameters that are provided by the framework.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of tool definitions in OpenAI function calling format. Each</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>definition includes the function name, description (from docstring),</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>and complete parameter schema with types and required fields.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>For a function:
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">operation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;add&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Perform arithmetic calculation.&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;add&quot;</span> <span class="k">else</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span>
</code></pre></div></p>
<p>Returns:
<div class="highlight"><pre><span></span><code><span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
        <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;calculate&quot;</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Perform arithmetic calculation.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;integer&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;integer&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;operation&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;add&quot;</span><span class="p">},</span>
                <span class="p">},</span>
                <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">],</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">}</span>
<span class="p">]</span>
</code></pre></div></p>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>Parameters listed in INJECTABLE_PARAMS (like 'state', 'config',
'tool_call_id') are automatically excluded from the generated schema
as they are provided by the framework during execution.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/tool_node/schema.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_local_tool</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate OpenAI-compatible tool definitions for all registered local functions.</span>

<span class="sd">    Inspects all registered functions in _funcs and automatically generates</span>
<span class="sd">    tool schemas by analyzing function signatures, type annotations, and docstrings.</span>
<span class="sd">    Excludes injectable parameters that are provided by the framework.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of tool definitions in OpenAI function calling format. Each</span>
<span class="sd">        definition includes the function name, description (from docstring),</span>
<span class="sd">        and complete parameter schema with types and required fields.</span>

<span class="sd">    Example:</span>
<span class="sd">        For a function:</span>
<span class="sd">        ```python</span>
<span class="sd">        def calculate(a: int, b: int, operation: str = &quot;add&quot;) -&gt; int:</span>
<span class="sd">            &#39;&#39;&#39;Perform arithmetic calculation.&#39;&#39;&#39;</span>
<span class="sd">            return a + b if operation == &quot;add&quot; else a - b</span>
<span class="sd">        ```</span>

<span class="sd">        Returns:</span>
<span class="sd">        ```python</span>
<span class="sd">        [</span>
<span class="sd">            {</span>
<span class="sd">                &quot;type&quot;: &quot;function&quot;,</span>
<span class="sd">                &quot;function&quot;: {</span>
<span class="sd">                    &quot;name&quot;: &quot;calculate&quot;,</span>
<span class="sd">                    &quot;description&quot;: &quot;Perform arithmetic calculation.&quot;,</span>
<span class="sd">                    &quot;parameters&quot;: {</span>
<span class="sd">                        &quot;type&quot;: &quot;object&quot;,</span>
<span class="sd">                        &quot;properties&quot;: {</span>
<span class="sd">                            &quot;a&quot;: {&quot;type&quot;: &quot;integer&quot;},</span>
<span class="sd">                            &quot;b&quot;: {&quot;type&quot;: &quot;integer&quot;},</span>
<span class="sd">                            &quot;operation&quot;: {&quot;type&quot;: &quot;string&quot;, &quot;default&quot;: &quot;add&quot;},</span>
<span class="sd">                        },</span>
<span class="sd">                        &quot;required&quot;: [&quot;a&quot;, &quot;b&quot;],</span>
<span class="sd">                    },</span>
<span class="sd">                },</span>
<span class="sd">            }</span>
<span class="sd">        ]</span>
<span class="sd">        ```</span>

<span class="sd">    Note:</span>
<span class="sd">        Parameters listed in INJECTABLE_PARAMS (like &#39;state&#39;, &#39;config&#39;,</span>
<span class="sd">        &#39;tool_call_id&#39;) are automatically excluded from the generated schema</span>
<span class="sd">        as they are provided by the framework during execution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">params_schema</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="k">for</span> <span class="n">p_name</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">VAR_POSITIONAL</span><span class="p">,</span>
                <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">VAR_KEYWORD</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="n">INJECTABLE_PARAMS</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">annotation</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">annotation</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">_empty</span> <span class="k">else</span> <span class="nb">str</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="n">SchemaMixin</span><span class="o">.</span><span class="n">_annotation_to_schema</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>
            <span class="n">params_schema</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="n">p_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">prop</span>

            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="n">inspect</span><span class="o">.</span><span class="n">_empty</span><span class="p">:</span>
                <span class="n">params_schema</span><span class="p">[</span><span class="s2">&quot;required&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">params_schema</span><span class="p">[</span><span class="s2">&quot;required&quot;</span><span class="p">]:</span>
            <span class="n">params_schema</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;required&quot;</span><span class="p">)</span>

        <span class="n">description</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;No description provided.&quot;</span>

        <span class="c1"># provider = getattr(fn, &quot;_py_tool_provider&quot;, None)</span>
        <span class="c1"># tags = getattr(fn, &quot;_py_tool_tags&quot;, None)</span>
        <span class="c1"># capabilities = getattr(fn, &quot;_py_tool_capabilities&quot;, None)</span>

        <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">params_schema</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="c1"># meta: dict[str, t.Any] = {}</span>
        <span class="c1"># if provider:</span>
        <span class="c1">#     meta[&quot;provider&quot;] = provider</span>
        <span class="c1"># if tags:</span>
        <span class="c1">#     meta[&quot;tags&quot;] = tags</span>
        <span class="c1"># if capabilities:</span>
        <span class="c1">#     meta[&quot;capabilities&quot;] = capabilities</span>
        <span class="c1"># if meta:</span>
        <span class="c1">#     entry[&quot;x-pyagenity&quot;] = meta</span>

        <span class="n">tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tools</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="pyagenity.graph.ToolNode.invoke" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">invoke</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.ToolNode.invoke" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">invoke</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">tool_call_id</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">callback_manager</span><span class="o">=</span><span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">])</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Execute a specific tool by name with the provided arguments.</p>
<p>This method handles tool execution across all configured providers (local,
MCP, Composio, LangChain) with comprehensive error handling, event publishing,
and callback management.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.ToolNode.invoke(name)" class="doc doc-heading doc-heading-parameter">                  <code>name</code>
<a href="#pyagenity.graph.ToolNode.invoke(name)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the tool to execute.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.ToolNode.invoke(args)" class="doc doc-heading doc-heading-parameter">                  <code>args</code>
<a href="#pyagenity.graph.ToolNode.invoke(args)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of arguments to pass to the tool function.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.ToolNode.invoke(tool_call_id)" class="doc doc-heading doc-heading-parameter">                  <code>tool_call_id</code>
<a href="#pyagenity.graph.ToolNode.invoke(tool_call_id)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique identifier for this tool execution, used for
tracking and result correlation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.ToolNode.invoke(config)" class="doc doc-heading doc-heading-parameter">                  <code>config</code>
<a href="#pyagenity.graph.ToolNode.invoke(config)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration dictionary containing execution context and
user-specific settings.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.ToolNode.invoke(state)" class="doc doc-heading doc-heading-parameter">                  <code>state</code>
<a href="#pyagenity.graph.ToolNode.invoke(state)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            AgentState (pyagenity.state.AgentState)" href="../#pyagenity.state.AgentState">AgentState</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Current agent state for context-aware tool execution.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.ToolNode.invoke(callback_manager)" class="doc doc-heading doc-heading-parameter">                  <code>callback_manager</code>
<a href="#pyagenity.graph.ToolNode.invoke(callback_manager)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            CallbackManager (pyagenity.utils.CallbackManager)" href="../#pyagenity.utils.CallbackManager">CallbackManager</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Manager for executing pre/post execution callbacks.
Injected via dependency injection if not provided.</p>
              </div>
            </td>
            <td>
                  <code><span title="injectq.Inject">Inject</span>[<a class="autorefs autorefs-internal" title="            CallbackManager (pyagenity.utils.CallbackManager)" href="../#pyagenity.utils.CallbackManager">CallbackManager</a>]</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Message object containing tool execution results, either successful</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>output or error information with appropriate status indicators.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">tool_node</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weather_tool&quot;</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="s2">&quot;Paris&quot;</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;metric&quot;</span><span class="p">},</span>
    <span class="n">tool_call_id</span><span class="o">=</span><span class="s2">&quot;call_abc123&quot;</span><span class="p">,</span>
    <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;user1&quot;</span><span class="p">,</span> <span class="s2">&quot;session_id&quot;</span><span class="p">:</span> <span class="s2">&quot;session1&quot;</span><span class="p">},</span>
    <span class="n">state</span><span class="o">=</span><span class="n">current_agent_state</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># result is a Message with tool execution results</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>  <span class="c1"># Tool output or error information</span>
</code></pre></div>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>The method publishes execution events throughout the process for
monitoring and debugging purposes. Tool execution is routed based
on tool provider precedence: MCP → Composio → LangChain → Local.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/tool_node/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span>  <span class="c1"># noqa: PLR0915</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">tool_call_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
    <span class="n">callback_manager</span><span class="p">:</span> <span class="n">CallbackManager</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute a specific tool by name with the provided arguments.</span>

<span class="sd">    This method handles tool execution across all configured providers (local,</span>
<span class="sd">    MCP, Composio, LangChain) with comprehensive error handling, event publishing,</span>
<span class="sd">    and callback management.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: The name of the tool to execute.</span>
<span class="sd">        args: Dictionary of arguments to pass to the tool function.</span>
<span class="sd">        tool_call_id: Unique identifier for this tool execution, used for</span>
<span class="sd">            tracking and result correlation.</span>
<span class="sd">        config: Configuration dictionary containing execution context and</span>
<span class="sd">            user-specific settings.</span>
<span class="sd">        state: Current agent state for context-aware tool execution.</span>
<span class="sd">        callback_manager: Manager for executing pre/post execution callbacks.</span>
<span class="sd">            Injected via dependency injection if not provided.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Message object containing tool execution results, either successful</span>
<span class="sd">        output or error information with appropriate status indicators.</span>

<span class="sd">    Raises:</span>
<span class="sd">        The method handles all exceptions internally and returns error Messages</span>
<span class="sd">        rather than raising exceptions, ensuring robust execution flow.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        result = await tool_node.invoke(</span>
<span class="sd">            name=&quot;weather_tool&quot;,</span>
<span class="sd">            args={&quot;location&quot;: &quot;Paris&quot;, &quot;units&quot;: &quot;metric&quot;},</span>
<span class="sd">            tool_call_id=&quot;call_abc123&quot;,</span>
<span class="sd">            config={&quot;user_id&quot;: &quot;user1&quot;, &quot;session_id&quot;: &quot;session1&quot;},</span>
<span class="sd">            state=current_agent_state,</span>
<span class="sd">        )</span>

<span class="sd">        # result is a Message with tool execution results</span>
<span class="sd">        print(result.content)  # Tool output or error information</span>
<span class="sd">        ```</span>

<span class="sd">    Note:</span>
<span class="sd">        The method publishes execution events throughout the process for</span>
<span class="sd">        monitoring and debugging purposes. Tool execution is routed based</span>
<span class="sd">        on tool provider precedence: MCP → Composio → LangChain → Local.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Executing tool &#39;</span><span class="si">%s</span><span class="s2">&#39; with </span><span class="si">%d</span><span class="s2"> arguments&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Tool arguments: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="n">event</span> <span class="o">=</span> <span class="n">EventModel</span><span class="o">.</span><span class="n">default</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call_id</span><span class="p">,</span> <span class="s2">&quot;function_name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">},</span>
        <span class="n">content_type</span><span class="o">=</span><span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_CALL</span><span class="p">],</span>
        <span class="n">event</span><span class="o">=</span><span class="n">Event</span><span class="o">.</span><span class="n">TOOL_EXECUTION</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">node_name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="c1"># Attach structured tool call block</span>
    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">ToolCallBlock</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)]</span>
    <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcp_tools</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_mcp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mcp_execute</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="n">tool_call_id</span><span class="p">,</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">callback_manager</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="c1"># Attach tool result block mirroring the tool output</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
            <span class="p">]</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">composio_tools</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_composio&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_composio_execute</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="n">tool_call_id</span><span class="p">,</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">callback_manager</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
            <span class="p">]</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">langchain_tools</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_langchain&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_langchain_execute</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="n">tool_call_id</span><span class="p">,</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">callback_manager</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
            <span class="p">]</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_mcp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_execute</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="n">tool_call_id</span><span class="p">,</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">state</span><span class="p">,</span>
            <span class="n">callback_manager</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
            <span class="p">]</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Tool &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span>
    <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_msg</span>
    <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">ERROR</span>
    <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">ERROR</span><span class="p">]</span>
    <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Message</span><span class="o">.</span><span class="n">tool_message</span><span class="p">(</span>
        <span class="n">content</span><span class="o">=</span><span class="p">[</span>
            <span class="n">ErrorBlock</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">error_msg</span><span class="p">),</span>
            <span class="n">ToolResultBlock</span><span class="p">(</span>
                <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="n">error_msg</span><span class="p">,</span>
                <span class="n">is_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">],</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="pyagenity.graph.ToolNode.stream" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">stream</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.ToolNode.stream" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">stream</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">tool_call_id</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">callback_manager</span><span class="o">=</span><span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">])</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Execute a tool with streaming support, yielding incremental results.</p>
<p>Similar to invoke() but designed for tools that can provide streaming responses
or when you want to process results as they become available. Currently,
most tool providers return complete results, so this method typically yields
a single Message with the full result.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.ToolNode.stream(name)" class="doc doc-heading doc-heading-parameter">                  <code>name</code>
<a href="#pyagenity.graph.ToolNode.stream(name)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the tool to execute.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.ToolNode.stream(args)" class="doc doc-heading doc-heading-parameter">                  <code>args</code>
<a href="#pyagenity.graph.ToolNode.stream(args)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of arguments to pass to the tool function.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.ToolNode.stream(tool_call_id)" class="doc doc-heading doc-heading-parameter">                  <code>tool_call_id</code>
<a href="#pyagenity.graph.ToolNode.stream(tool_call_id)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique identifier for this tool execution.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.ToolNode.stream(config)" class="doc doc-heading doc-heading-parameter">                  <code>config</code>
<a href="#pyagenity.graph.ToolNode.stream(config)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration dictionary containing execution context.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.ToolNode.stream(state)" class="doc doc-heading doc-heading-parameter">                  <code>state</code>
<a href="#pyagenity.graph.ToolNode.stream(state)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            AgentState (pyagenity.state.AgentState)" href="../#pyagenity.state.AgentState">AgentState</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Current agent state for context-aware tool execution.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.ToolNode.stream(callback_manager)" class="doc doc-heading doc-heading-parameter">                  <code>callback_manager</code>
<a href="#pyagenity.graph.ToolNode.stream(callback_manager)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            CallbackManager (pyagenity.utils.CallbackManager)" href="../#pyagenity.utils.CallbackManager">CallbackManager</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Manager for executing pre/post execution callbacks.</p>
              </div>
            </td>
            <td>
                  <code><span title="injectq.Inject">Inject</span>[<a class="autorefs autorefs-internal" title="            CallbackManager (pyagenity.utils.CallbackManager)" href="../#pyagenity.utils.CallbackManager">CallbackManager</a>]</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Yields:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.AsyncIterator">AsyncIterator</span>[<a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.message.Message)" href="../#pyagenity.utils.message.Message">Message</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Message objects containing tool execution results or status updates.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.AsyncIterator">AsyncIterator</span>[<a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.message.Message)" href="../#pyagenity.utils.message.Message">Message</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>For most tools, this will yield a single complete result Message.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">tool_node</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;data_processor&quot;</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;dataset&quot;</span><span class="p">:</span> <span class="s2">&quot;large_data.csv&quot;</span><span class="p">},</span>
    <span class="n">tool_call_id</span><span class="o">=</span><span class="s2">&quot;call_stream123&quot;</span><span class="p">,</span>
    <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;user1&quot;</span><span class="p">},</span>
    <span class="n">state</span><span class="o">=</span><span class="n">current_state</span><span class="p">,</span>
<span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received: </span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Process each streamed result</span>
</code></pre></div>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>The streaming interface is designed for future expansion where tools
may provide true streaming responses. Currently, it provides a
consistent async iterator interface over tool results.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/tool_node/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream</span><span class="p">(</span>  <span class="c1"># noqa: PLR0915</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">tool_call_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
    <span class="n">callback_manager</span><span class="p">:</span> <span class="n">CallbackManager</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">AsyncIterator</span><span class="p">[</span><span class="n">Message</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute a tool with streaming support, yielding incremental results.</span>

<span class="sd">    Similar to invoke() but designed for tools that can provide streaming responses</span>
<span class="sd">    or when you want to process results as they become available. Currently,</span>
<span class="sd">    most tool providers return complete results, so this method typically yields</span>
<span class="sd">    a single Message with the full result.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: The name of the tool to execute.</span>
<span class="sd">        args: Dictionary of arguments to pass to the tool function.</span>
<span class="sd">        tool_call_id: Unique identifier for this tool execution.</span>
<span class="sd">        config: Configuration dictionary containing execution context.</span>
<span class="sd">        state: Current agent state for context-aware tool execution.</span>
<span class="sd">        callback_manager: Manager for executing pre/post execution callbacks.</span>

<span class="sd">    Yields:</span>
<span class="sd">        Message objects containing tool execution results or status updates.</span>
<span class="sd">        For most tools, this will yield a single complete result Message.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        async for message in tool_node.stream(</span>
<span class="sd">            name=&quot;data_processor&quot;,</span>
<span class="sd">            args={&quot;dataset&quot;: &quot;large_data.csv&quot;},</span>
<span class="sd">            tool_call_id=&quot;call_stream123&quot;,</span>
<span class="sd">            config={&quot;user_id&quot;: &quot;user1&quot;},</span>
<span class="sd">            state=current_state,</span>
<span class="sd">        ):</span>
<span class="sd">            print(f&quot;Received: {message.content}&quot;)</span>
<span class="sd">            # Process each streamed result</span>
<span class="sd">        ```</span>

<span class="sd">    Note:</span>
<span class="sd">        The streaming interface is designed for future expansion where tools</span>
<span class="sd">        may provide true streaming responses. Currently, it provides a</span>
<span class="sd">        consistent async iterator interface over tool results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Executing tool &#39;</span><span class="si">%s</span><span class="s2">&#39; with </span><span class="si">%d</span><span class="s2"> arguments&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Tool arguments: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">EventModel</span><span class="o">.</span><span class="n">default</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call_id</span><span class="p">,</span> <span class="s2">&quot;function_name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">},</span>
        <span class="n">content_type</span><span class="o">=</span><span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_CALL</span><span class="p">],</span>
        <span class="n">event</span><span class="o">=</span><span class="n">Event</span><span class="o">.</span><span class="n">TOOL_EXECUTION</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">node_name</span> <span class="o">=</span> <span class="s2">&quot;ToolNode&quot;</span>
    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">ToolCallBlock</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcp_tools</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;function_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mcp&quot;</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mcp_execute</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="n">tool_call_id</span><span class="p">,</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">callback_manager</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
            <span class="p">]</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">message</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">composio_tools</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;function_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;composio&quot;</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_composio_execute</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="n">tool_call_id</span><span class="p">,</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">callback_manager</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
            <span class="p">]</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">message</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">langchain_tools</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;function_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;langchain&quot;</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_langchain_execute</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="n">tool_call_id</span><span class="p">,</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">callback_manager</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
            <span class="p">]</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">message</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;function_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;internal&quot;</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_execute</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="n">tool_call_id</span><span class="p">,</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">state</span><span class="p">,</span>
            <span class="n">callback_manager</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
            <span class="p">]</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">result</span>
        <span class="k">return</span>

    <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Tool &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span>
    <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_msg</span>
    <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">ERROR</span>
    <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">ERROR</span><span class="p">]</span>
    <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

    <span class="k">yield</span> <span class="n">Message</span><span class="o">.</span><span class="n">tool_message</span><span class="p">(</span>
        <span class="n">content</span><span class="o">=</span><span class="p">[</span>
            <span class="n">ErrorBlock</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">error_msg</span><span class="p">),</span>
            <span class="n">ToolResultBlock</span><span class="p">(</span>
                <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="n">error_msg</span><span class="p">,</span>
                <span class="n">is_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">],</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<h2 id="pyagenity.graph-modules">Modules<a href="#pyagenity.graph-modules" class="headerlink" title="Permanent link">&para;</a></h2>

<div class="doc doc-object doc-module">



<h3 id="pyagenity.graph.compiled_graph" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">compiled_graph</span>


<a href="#pyagenity.graph.compiled_graph" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">










<p><span class="doc-section-title">Classes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            CompiledGraph (pyagenity.graph.compiled_graph.CompiledGraph)" href="../#pyagenity.graph.compiled_graph.CompiledGraph">CompiledGraph</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>A fully compiled and executable graph ready for workflow execution.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>






<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            StateT


  
      module-attribute
   (pyagenity.graph.compiled_graph.StateT)" href="../#pyagenity.graph.compiled_graph.StateT">StateT</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            logger


  
      module-attribute
   (pyagenity.graph.compiled_graph.logger)" href="../#pyagenity.graph.compiled_graph.logger">logger</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>



  <div class="doc doc-children">





<h4 id="pyagenity.graph.compiled_graph-attributes">Attributes<a href="#pyagenity.graph.compiled_graph-attributes" class="headerlink" title="Permanent link">&para;</a></h4>

<div class="doc doc-object doc-attribute">



<h5 id="pyagenity.graph.compiled_graph.StateT" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">StateT</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#pyagenity.graph.compiled_graph.StateT" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">StateT</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;StateT&#39;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">AgentState</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="pyagenity.graph.compiled_graph.logger" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">logger</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#pyagenity.graph.compiled_graph.logger" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<h4 id="pyagenity.graph.compiled_graph-classes">Classes<a href="#pyagenity.graph.compiled_graph-classes" class="headerlink" title="Permanent link">&para;</a></h4>

<div class="doc doc-object doc-class">



<h5 id="pyagenity.graph.compiled_graph.CompiledGraph" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">CompiledGraph</span>


<a href="#pyagenity.graph.compiled_graph.CompiledGraph" class="headerlink" title="Permanent link">&para;</a></h5>


    <div class="doc doc-contents ">


        <p>A fully compiled and executable graph ready for workflow execution.</p>
<p>CompiledGraph represents the final executable form of a StateGraph after compilation.
It encapsulates all the execution logic, handlers, and services needed to run
agent workflows. The graph supports both synchronous and asynchronous execution
with comprehensive state management, checkpointing, event publishing, and
streaming capabilities.</p>
<p>This class is generic over state types to support custom AgentState subclasses,
ensuring type safety throughout the execution process.</p>
<p>Key Features:
- Synchronous and asynchronous execution methods
- Real-time streaming with incremental results
- State persistence and checkpointing
- Interrupt and resume capabilities
- Event publishing for monitoring and debugging
- Background task management
- Graceful error handling and recovery</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.compiled_graph.CompiledGraph._state">_state</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The initial/template state for graph executions.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.compiled_graph.CompiledGraph._invoke_handler">_invoke_handler</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            InvokeHandler (pyagenity.graph.utils.invoke_handler.InvokeHandler)" href="../#pyagenity.graph.utils.invoke_handler.InvokeHandler">InvokeHandler</a>[<span title="pyagenity.graph.compiled_graph.CompiledGraph[StateT]">StateT</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Handler for non-streaming graph execution.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.compiled_graph.CompiledGraph._stream_handler">_stream_handler</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            StreamHandler (pyagenity.graph.utils.stream_handler.StreamHandler)" href="../#pyagenity.graph.utils.stream_handler.StreamHandler">StreamHandler</a>[<span title="pyagenity.graph.compiled_graph.CompiledGraph[StateT]">StateT</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Handler for streaming graph execution.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.compiled_graph.CompiledGraph._checkpointer">_checkpointer</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            BaseCheckpointer (pyagenity.checkpointer.base_checkpointer.BaseCheckpointer)" href="../#pyagenity.checkpointer.base_checkpointer.BaseCheckpointer">BaseCheckpointer</a>[<span title="pyagenity.graph.compiled_graph.CompiledGraph[StateT]">StateT</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional state persistence backend.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.compiled_graph.CompiledGraph._publisher">_publisher</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            BasePublisher (pyagenity.publisher.base_publisher.BasePublisher)" href="../#pyagenity.publisher.base_publisher.BasePublisher">BasePublisher</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional event publishing backend.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.compiled_graph.CompiledGraph._store">_store</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            BaseStore (pyagenity.store.base_store.BaseStore)" href="../#pyagenity.store.base_store.BaseStore">BaseStore</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional data storage backend.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.compiled_graph.CompiledGraph._state_graph">_state_graph</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            StateGraph (pyagenity.graph.state_graph.StateGraph)" href="../#pyagenity.graph.state_graph.StateGraph">StateGraph</a>[<span title="pyagenity.graph.compiled_graph.CompiledGraph[StateT]">StateT</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Reference to the source StateGraph.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.compiled_graph.CompiledGraph._interrupt_before">_interrupt_before</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nodes where execution should pause before execution.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.compiled_graph.CompiledGraph._interrupt_after">_interrupt_after</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nodes where execution should pause after execution.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.compiled_graph.CompiledGraph._task_manager">_task_manager</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Manager for background async tasks.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="c1"># After building and compiling a StateGraph</span>
<span class="n">compiled</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>

<span class="c1"># Synchronous execution</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">compiled</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Message</span><span class="o">.</span><span class="n">text_message</span><span class="p">(</span><span class="s2">&quot;Hello&quot;</span><span class="p">)]})</span>

<span class="c1"># Asynchronous execution with streaming</span>
<span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">compiled</span><span class="o">.</span><span class="n">astream</span><span class="p">({</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">message</span><span class="p">]}):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Streamed: </span><span class="si">{</span><span class="n">chunk</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Graceful cleanup</span>
<span class="k">await</span> <span class="n">compiled</span><span class="o">.</span><span class="n">aclose</span><span class="p">()</span>
</code></pre></div>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>CompiledGraph instances should be properly closed using aclose() to
release resources like database connections, background tasks, and
event publishers.</p>
</details>











<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            __init__ (pyagenity.graph.compiled_graph.CompiledGraph.__init__)" href="../#pyagenity.graph.compiled_graph.CompiledGraph.__init__">__init__</a></code></td>
              <td>
                <div class="doc-md-description">
                  
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            aclose


  
      async
   (pyagenity.graph.compiled_graph.CompiledGraph.aclose)" href="../#pyagenity.graph.compiled_graph.CompiledGraph.aclose">aclose</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Close the graph and release any resources.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            ainvoke


  
      async
   (pyagenity.graph.compiled_graph.CompiledGraph.ainvoke)" href="../#pyagenity.graph.compiled_graph.CompiledGraph.ainvoke">ainvoke</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Execute the graph asynchronously.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            astop


  
      async
   (pyagenity.graph.compiled_graph.CompiledGraph.astop)" href="../#pyagenity.graph.compiled_graph.CompiledGraph.astop">astop</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Request the current graph execution to stop (async).</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            astream


  
      async
   (pyagenity.graph.compiled_graph.CompiledGraph.astream)" href="../#pyagenity.graph.compiled_graph.CompiledGraph.astream">astream</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Execute the graph asynchronously with streaming support.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            generate_graph (pyagenity.graph.compiled_graph.CompiledGraph.generate_graph)" href="../#pyagenity.graph.compiled_graph.CompiledGraph.generate_graph">generate_graph</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Generate the graph representation.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            invoke (pyagenity.graph.compiled_graph.CompiledGraph.invoke)" href="../#pyagenity.graph.compiled_graph.CompiledGraph.invoke">invoke</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Execute the graph synchronously and return the final results.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            stop (pyagenity.graph.compiled_graph.CompiledGraph.stop)" href="../#pyagenity.graph.compiled_graph.CompiledGraph.stop">stop</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Request the current graph execution to stop (sync helper).</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            stream (pyagenity.graph.compiled_graph.CompiledGraph.stream)" href="../#pyagenity.graph.compiled_graph.CompiledGraph.stream">stream</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Execute the graph synchronously with streaming support.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>



              <details class="quote">
                <summary>Source code in <code>pyagenity/graph/compiled_graph.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CompiledGraph</span><span class="p">[</span><span class="n">StateT</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A fully compiled and executable graph ready for workflow execution.</span>

<span class="sd">    CompiledGraph represents the final executable form of a StateGraph after compilation.</span>
<span class="sd">    It encapsulates all the execution logic, handlers, and services needed to run</span>
<span class="sd">    agent workflows. The graph supports both synchronous and asynchronous execution</span>
<span class="sd">    with comprehensive state management, checkpointing, event publishing, and</span>
<span class="sd">    streaming capabilities.</span>

<span class="sd">    This class is generic over state types to support custom AgentState subclasses,</span>
<span class="sd">    ensuring type safety throughout the execution process.</span>

<span class="sd">    Key Features:</span>
<span class="sd">    - Synchronous and asynchronous execution methods</span>
<span class="sd">    - Real-time streaming with incremental results</span>
<span class="sd">    - State persistence and checkpointing</span>
<span class="sd">    - Interrupt and resume capabilities</span>
<span class="sd">    - Event publishing for monitoring and debugging</span>
<span class="sd">    - Background task management</span>
<span class="sd">    - Graceful error handling and recovery</span>

<span class="sd">    Attributes:</span>
<span class="sd">        _state: The initial/template state for graph executions.</span>
<span class="sd">        _invoke_handler: Handler for non-streaming graph execution.</span>
<span class="sd">        _stream_handler: Handler for streaming graph execution.</span>
<span class="sd">        _checkpointer: Optional state persistence backend.</span>
<span class="sd">        _publisher: Optional event publishing backend.</span>
<span class="sd">        _store: Optional data storage backend.</span>
<span class="sd">        _state_graph: Reference to the source StateGraph.</span>
<span class="sd">        _interrupt_before: Nodes where execution should pause before execution.</span>
<span class="sd">        _interrupt_after: Nodes where execution should pause after execution.</span>
<span class="sd">        _task_manager: Manager for background async tasks.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        # After building and compiling a StateGraph</span>
<span class="sd">        compiled = graph.compile()</span>

<span class="sd">        # Synchronous execution</span>
<span class="sd">        result = compiled.invoke({&quot;messages&quot;: [Message.text_message(&quot;Hello&quot;)]})</span>

<span class="sd">        # Asynchronous execution with streaming</span>
<span class="sd">        async for chunk in compiled.astream({&quot;messages&quot;: [message]}):</span>
<span class="sd">            print(f&quot;Streamed: {chunk.content}&quot;)</span>

<span class="sd">        # Graceful cleanup</span>
<span class="sd">        await compiled.aclose()</span>
<span class="sd">        ```</span>

<span class="sd">    Note:</span>
<span class="sd">        CompiledGraph instances should be properly closed using aclose() to</span>
<span class="sd">        release resources like database connections, background tasks, and</span>
<span class="sd">        event publishers.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">StateT</span><span class="p">,</span>
        <span class="n">checkpointer</span><span class="p">:</span> <span class="n">BaseCheckpointer</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">publisher</span><span class="p">:</span> <span class="n">BasePublisher</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">store</span><span class="p">:</span> <span class="n">BaseStore</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">state_graph</span><span class="p">:</span> <span class="n">StateGraph</span><span class="p">[</span><span class="n">StateT</span><span class="p">],</span>
        <span class="n">interrupt_before</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">interrupt_after</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">task_manager</span><span class="p">:</span> <span class="n">BackgroundTaskManager</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Initializing CompiledGraph with nodes: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">state_graph</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Save initial state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">state</span>

        <span class="c1"># create handlers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_invoke_handler</span><span class="p">:</span> <span class="n">InvokeHandler</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">=</span> <span class="n">InvokeHandler</span><span class="p">[</span><span class="n">StateT</span><span class="p">](</span>
            <span class="n">nodes</span><span class="o">=</span><span class="n">state_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
            <span class="n">edges</span><span class="o">=</span><span class="n">state_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stream_handler</span><span class="p">:</span> <span class="n">StreamHandler</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">=</span> <span class="n">StreamHandler</span><span class="p">[</span><span class="n">StateT</span><span class="p">](</span>
            <span class="n">nodes</span><span class="o">=</span><span class="n">state_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
            <span class="n">edges</span><span class="o">=</span><span class="n">state_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="p">:</span> <span class="n">BaseCheckpointer</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">checkpointer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span><span class="p">:</span> <span class="n">BasePublisher</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">publisher</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">:</span> <span class="n">BaseStore</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">store</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state_graph</span><span class="p">:</span> <span class="n">StateGraph</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">=</span> <span class="n">state_graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interrupt_before</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">interrupt_before</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interrupt_after</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">interrupt_after</span>
        <span class="c1"># generate task manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_task_manager</span> <span class="o">=</span> <span class="n">task_manager</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_config</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">is_stream</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s2">&quot;is_stream&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">:</span>
            <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;is_stream&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_stream</span>
        <span class="k">if</span> <span class="s2">&quot;user_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">:</span>
            <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;test-user-id&quot;</span>  <span class="c1"># mock user id</span>
        <span class="k">if</span> <span class="s2">&quot;run_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">:</span>
            <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;run_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">InjectQ</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span><span class="o">.</span><span class="n">try_get</span><span class="p">(</span><span class="s2">&quot;generated_id&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>

        <span class="k">if</span> <span class="s2">&quot;timestamp&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">:</span>
            <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">cfg</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">response_granularity</span><span class="p">:</span> <span class="n">ResponseGranularity</span> <span class="o">=</span> <span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the graph synchronously and return the final results.</span>

<span class="sd">        Runs the complete graph workflow from start to finish, handling state</span>
<span class="sd">        management, node execution, and result formatting. This method automatically</span>
<span class="sd">        detects whether to start a fresh execution or resume from an interrupted state.</span>

<span class="sd">        The execution is synchronous but internally uses async operations, making it</span>
<span class="sd">        suitable for use in non-async contexts while still benefiting from async</span>
<span class="sd">        capabilities for I/O operations.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_data: Input dictionary for graph execution. For new executions,</span>
<span class="sd">                should contain &#39;messages&#39; key with list of initial messages.</span>
<span class="sd">                For resumed executions, can contain additional data to merge.</span>
<span class="sd">            config: Optional configuration dictionary containing execution settings:</span>
<span class="sd">                - user_id: Identifier for the user/session</span>
<span class="sd">                - thread_id: Unique identifier for this execution thread</span>
<span class="sd">                - run_id: Unique identifier for this specific run</span>
<span class="sd">                - recursion_limit: Maximum steps before stopping (default: 25)</span>
<span class="sd">            response_granularity: Level of detail in the response:</span>
<span class="sd">                - LOW: Returns only messages (default)</span>
<span class="sd">                - PARTIAL: Returns context, summary, and messages</span>
<span class="sd">                - FULL: Returns complete state and messages</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary containing execution results formatted according to the</span>
<span class="sd">            specified granularity level. Always includes execution messages</span>
<span class="sd">            and may include additional state information.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If input_data is invalid for new execution.</span>
<span class="sd">            GraphRecursionError: If execution exceeds recursion limit.</span>
<span class="sd">            Various exceptions: Depending on node execution failures.</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            # Basic execution</span>
<span class="sd">            result = compiled.invoke({&quot;messages&quot;: [Message.text_message(&quot;Process this data&quot;)]})</span>
<span class="sd">            print(result[&quot;messages&quot;])  # Final execution messages</span>

<span class="sd">            # With configuration and full details</span>
<span class="sd">            result = compiled.invoke(</span>
<span class="sd">                input_data={&quot;messages&quot;: [message]},</span>
<span class="sd">                config={&quot;user_id&quot;: &quot;user123&quot;, &quot;thread_id&quot;: &quot;session456&quot;, &quot;recursion_limit&quot;: 50},</span>
<span class="sd">                response_granularity=ResponseGranularity.FULL,</span>
<span class="sd">            )</span>
<span class="sd">            print(result[&quot;state&quot;])  # Complete final state</span>
<span class="sd">            ```</span>

<span class="sd">        Note:</span>
<span class="sd">            This method uses asyncio.run() internally, so it should not be called</span>
<span class="sd">            from within an async context. Use ainvoke() instead for async execution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Starting synchronous graph execution with </span><span class="si">%d</span><span class="s2"> input keys, granularity=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="k">if</span> <span class="n">input_data</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">response_granularity</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Input data keys: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">input_data</span> <span class="k">else</span> <span class="p">[])</span>
        <span class="c1"># Async Will Handle Event Publish</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">response_granularity</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Synchronous graph execution completed successfully&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Synchronous graph execution failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">ainvoke</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">response_granularity</span><span class="p">:</span> <span class="n">ResponseGranularity</span> <span class="o">=</span> <span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the graph asynchronously.</span>

<span class="sd">        Auto-detects whether to start fresh execution or resume from interrupted state</span>
<span class="sd">        based on the AgentState&#39;s execution metadata.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_data: Input dict with &#39;messages&#39; key (for new execution) or</span>
<span class="sd">                       additional data for resuming</span>
<span class="sd">            config: Configuration dictionary</span>
<span class="sd">            response_granularity: Response parsing granularity</span>

<span class="sd">        Returns:</span>
<span class="sd">            Response dict based on granularity</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">is_stream</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_invoke_handler</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
            <span class="n">input_data</span><span class="p">,</span>
            <span class="n">cfg</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">,</span>
            <span class="n">response_granularity</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Request the current graph execution to stop (sync helper).</span>

<span class="sd">        This sets a stop flag in the checkpointer&#39;s thread store keyed by thread_id.</span>
<span class="sd">        Handlers periodically check this flag and interrupt execution.</span>
<span class="sd">        Returns a small status dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">astop</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">astop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Request the current graph execution to stop (async).</span>

<span class="sd">        Contract:</span>
<span class="sd">        - Requires a valid thread_id in config</span>
<span class="sd">        - If no active thread or no checkpointer, returns not-running</span>
<span class="sd">        - If state exists and is running, set stop_requested flag in thread info</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">is_stream</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_stream&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;no-checkpointer&quot;</span><span class="p">}</span>

        <span class="c1"># Load state to see if this thread is running</span>
        <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="o">.</span><span class="n">aget_state_cache</span><span class="p">(</span>
            <span class="n">cfg</span>
        <span class="p">)</span> <span class="ow">or</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="o">.</span><span class="n">aget_state</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;running&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;no-state&quot;</span><span class="p">}</span>

        <span class="n">running</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">is_running</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">is_interrupted</span><span class="p">()</span>
        <span class="c1"># Set stop flag regardless; handlers will act if running</span>
        <span class="k">if</span> <span class="n">running</span><span class="p">:</span>
            <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">stop_current_execution</span> <span class="o">=</span> <span class="n">StopRequestStatus</span><span class="o">.</span><span class="n">STOP_REQUESTED</span>
            <span class="c1"># update cache</span>
            <span class="c1"># Cache update is enough; state will be picked up by running execution</span>
            <span class="c1"># As its running, cache will be available immediately</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="o">.</span><span class="n">aput_state_cache</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
            <span class="c1"># Fixme: consider putting to main state as well</span>
            <span class="c1"># await self._checkpointer.aput_state(cfg, state)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set stop_current_execution flag for thread_id: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;thread_id&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;running&quot;</span><span class="p">:</span> <span class="n">running</span><span class="p">}</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;No running execution to stop for thread_id: </span><span class="si">%s</span><span class="s2"> (running=</span><span class="si">%s</span><span class="s2">, interrupted=</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;thread_id&quot;</span><span class="p">),</span>
            <span class="n">running</span><span class="p">,</span>
            <span class="n">state</span><span class="o">.</span><span class="n">is_interrupted</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;running&quot;</span><span class="p">:</span> <span class="n">running</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;not-running&quot;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stream</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">response_granularity</span><span class="p">:</span> <span class="n">ResponseGranularity</span> <span class="o">=</span> <span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Message</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the graph synchronously with streaming support.</span>

<span class="sd">        Yields Message objects containing incremental responses.</span>
<span class="sd">        If nodes return streaming responses, yields them directly.</span>
<span class="sd">        If nodes return complete responses, simulates streaming by chunking.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_data: Input dict</span>
<span class="sd">            config: Configuration dictionary</span>
<span class="sd">            response_granularity: Response parsing granularity</span>

<span class="sd">        Yields:</span>
<span class="sd">            Message objects with incremental content</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># For sync streaming, we&#39;ll use asyncio.run to handle the async implementation</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_async_stream</span><span class="p">():</span>
            <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">astream</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">response_granularity</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">chunk</span>

        <span class="c1"># Convert async generator to sync iteration with a dedicated event loop</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="n">_async_stream</span><span class="p">()</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">new_event_loop</span><span class="p">()</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop_policy</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">previous_loop</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">previous_loop</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Synchronous streaming started&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">chunk</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">gen</span><span class="o">.</span><span class="fm">__anext__</span><span class="p">())</span>
                    <span class="k">yield</span> <span class="n">chunk</span>
                <span class="k">except</span> <span class="ne">StopAsyncIteration</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Attempt to close the async generator cleanly</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">gen</span><span class="o">.</span><span class="n">aclose</span><span class="p">())</span>  <span class="c1"># type: ignore[attr-defined]</span>
            <span class="c1"># Restore previous loop if any, then close created loop</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">previous_loop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="n">previous_loop</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Synchronous streaming completed&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">astream</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">response_granularity</span><span class="p">:</span> <span class="n">ResponseGranularity</span> <span class="o">=</span> <span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="n">Message</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the graph asynchronously with streaming support.</span>

<span class="sd">        Yields Message objects containing incremental responses.</span>
<span class="sd">        If nodes return streaming responses, yields them directly.</span>
<span class="sd">        If nodes return complete responses, simulates streaming by chunking.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_data: Input dict</span>
<span class="sd">            config: Configuration dictionary</span>
<span class="sd">            response_granularity: Response parsing granularity</span>

<span class="sd">        Yields:</span>
<span class="sd">            Message objects with incremental content</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">is_stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream_handler</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
            <span class="n">input_data</span><span class="p">,</span>
            <span class="n">cfg</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">,</span>
            <span class="n">response_granularity</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">yield</span> <span class="n">chunk</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aclose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close the graph and release any resources.&quot;&quot;&quot;</span>
        <span class="c1"># close checkpointer</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="o">.</span><span class="n">arelease</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checkpointer closed successfully&quot;</span><span class="p">)</span>
                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;checkpointer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;closed&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;checkpointer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error closing graph: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Close Publisher</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Publisher closed successfully&quot;</span><span class="p">)</span>
                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;publisher&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;closed&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;publisher&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error closing publisher: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Close Store</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">arelease</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Store closed successfully&quot;</span><span class="p">)</span>
                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;store&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;closed&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;store&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error closing store: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Wait for all background tasks to complete</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_manager</span><span class="o">.</span><span class="n">wait_for_all</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All background tasks completed successfully&quot;</span><span class="p">)</span>
            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;background_tasks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;completed&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;background_tasks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error waiting for background tasks: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Graph close stats: </span><span class="si">{</span><span class="n">stats</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># You can also return or process the stats as needed</span>
        <span class="k">return</span> <span class="n">stats</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate the graph representation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dictionary representing the graph structure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;info&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;nodes&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;edges&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>
        <span class="c1"># Populate the graph with nodes and edges</span>
        <span class="k">for</span> <span class="n">node_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()),</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">node_name</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
            <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;edges&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()),</span>
                    <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">from_node</span><span class="p">,</span>
                    <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">to_node</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="c1"># Add few more extra info</span>
        <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;node_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;edge_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;edges&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;checkpointer&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;checkpointer_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;publisher&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;store&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;interrupt_before&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interrupt_before</span><span class="p">,</span>
            <span class="s2">&quot;interrupt_after&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interrupt_after</span><span class="p">,</span>
            <span class="s2">&quot;context_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_graph</span><span class="o">.</span><span class="n">_context_manager</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="s2">&quot;id_generator&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_graph</span><span class="o">.</span><span class="n">_id_generator</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="s2">&quot;id_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_graph</span><span class="o">.</span><span class="n">_id_generator</span><span class="o">.</span><span class="n">id_type</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="s2">&quot;state_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="s2">&quot;state_fields&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">graph</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">








<h6 id="pyagenity.graph.compiled_graph.CompiledGraph-functions">Functions<a href="#pyagenity.graph.compiled_graph.CompiledGraph-functions" class="headerlink" title="Permanent link">&para;</a></h6>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.compiled_graph.CompiledGraph.__init__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">__init__</span>


<a href="#pyagenity.graph.compiled_graph.CompiledGraph.__init__" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">__init__</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">checkpointer</span><span class="p">,</span> <span class="n">publisher</span><span class="p">,</span> <span class="n">store</span><span class="p">,</span> <span class="n">state_graph</span><span class="p">,</span> <span class="n">interrupt_before</span><span class="p">,</span> <span class="n">interrupt_after</span><span class="p">,</span> <span class="n">task_manager</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/compiled_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">StateT</span><span class="p">,</span>
    <span class="n">checkpointer</span><span class="p">:</span> <span class="n">BaseCheckpointer</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">publisher</span><span class="p">:</span> <span class="n">BasePublisher</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">store</span><span class="p">:</span> <span class="n">BaseStore</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">state_graph</span><span class="p">:</span> <span class="n">StateGraph</span><span class="p">[</span><span class="n">StateT</span><span class="p">],</span>
    <span class="n">interrupt_before</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">interrupt_after</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">task_manager</span><span class="p">:</span> <span class="n">BackgroundTaskManager</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Initializing CompiledGraph with nodes: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">state_graph</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Save initial state</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">state</span>

    <span class="c1"># create handlers</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_invoke_handler</span><span class="p">:</span> <span class="n">InvokeHandler</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">=</span> <span class="n">InvokeHandler</span><span class="p">[</span><span class="n">StateT</span><span class="p">](</span>
        <span class="n">nodes</span><span class="o">=</span><span class="n">state_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
        <span class="n">edges</span><span class="o">=</span><span class="n">state_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_stream_handler</span><span class="p">:</span> <span class="n">StreamHandler</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">=</span> <span class="n">StreamHandler</span><span class="p">[</span><span class="n">StateT</span><span class="p">](</span>
        <span class="n">nodes</span><span class="o">=</span><span class="n">state_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
        <span class="n">edges</span><span class="o">=</span><span class="n">state_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="p">:</span> <span class="n">BaseCheckpointer</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">checkpointer</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span><span class="p">:</span> <span class="n">BasePublisher</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">publisher</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">:</span> <span class="n">BaseStore</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">store</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_state_graph</span><span class="p">:</span> <span class="n">StateGraph</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">=</span> <span class="n">state_graph</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_interrupt_before</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">interrupt_before</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_interrupt_after</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">interrupt_after</span>
    <span class="c1"># generate task manager</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_task_manager</span> <span class="o">=</span> <span class="n">task_manager</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.compiled_graph.CompiledGraph.aclose" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">aclose</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.compiled_graph.CompiledGraph.aclose" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">aclose</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Close the graph and release any resources.</p>


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/compiled_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aclose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Close the graph and release any resources.&quot;&quot;&quot;</span>
    <span class="c1"># close checkpointer</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="o">.</span><span class="n">arelease</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checkpointer closed successfully&quot;</span><span class="p">)</span>
            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;checkpointer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;closed&quot;</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;checkpointer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error closing graph: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Close Publisher</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Publisher closed successfully&quot;</span><span class="p">)</span>
            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;publisher&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;closed&quot;</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;publisher&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error closing publisher: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Close Store</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">arelease</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Store closed successfully&quot;</span><span class="p">)</span>
            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;store&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;closed&quot;</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;store&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error closing store: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Wait for all background tasks to complete</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_manager</span><span class="o">.</span><span class="n">wait_for_all</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All background tasks completed successfully&quot;</span><span class="p">)</span>
        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;background_tasks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;completed&quot;</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;background_tasks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error waiting for background tasks: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Graph close stats: </span><span class="si">{</span><span class="n">stats</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># You can also return or process the stats as needed</span>
    <span class="k">return</span> <span class="n">stats</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.compiled_graph.CompiledGraph.ainvoke" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">ainvoke</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.compiled_graph.CompiledGraph.ainvoke" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">ainvoke</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">response_granularity</span><span class="o">=</span><span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Execute the graph asynchronously.</p>
<p>Auto-detects whether to start fresh execution or resume from interrupted state
based on the AgentState's execution metadata.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.compiled_graph.CompiledGraph.ainvoke(input_data)" class="doc doc-heading doc-heading-parameter">                  <code>input_data</code>
<a href="#pyagenity.graph.compiled_graph.CompiledGraph.ainvoke(input_data)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input dict with 'messages' key (for new execution) or
       additional data for resuming</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.compiled_graph.CompiledGraph.ainvoke(config)" class="doc doc-heading doc-heading-parameter">                  <code>config</code>
<a href="#pyagenity.graph.compiled_graph.CompiledGraph.ainvoke(config)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration dictionary</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.compiled_graph.CompiledGraph.ainvoke(response_granularity)" class="doc doc-heading doc-heading-parameter">                  <code>response_granularity</code>
<a href="#pyagenity.graph.compiled_graph.CompiledGraph.ainvoke(response_granularity)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            ResponseGranularity (pyagenity.utils.ResponseGranularity)" href="../#pyagenity.utils.ResponseGranularity">ResponseGranularity</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Response parsing granularity</p>
              </div>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            LOW


  
      class-attribute
      instance-attribute
   (pyagenity.utils.ResponseGranularity.LOW)" href="../#pyagenity.utils.ResponseGranularity.LOW">LOW</a></code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Response dict based on granularity</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/compiled_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">ainvoke</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">response_granularity</span><span class="p">:</span> <span class="n">ResponseGranularity</span> <span class="o">=</span> <span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the graph asynchronously.</span>

<span class="sd">    Auto-detects whether to start fresh execution or resume from interrupted state</span>
<span class="sd">    based on the AgentState&#39;s execution metadata.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_data: Input dict with &#39;messages&#39; key (for new execution) or</span>
<span class="sd">                   additional data for resuming</span>
<span class="sd">        config: Configuration dictionary</span>
<span class="sd">        response_granularity: Response parsing granularity</span>

<span class="sd">    Returns:</span>
<span class="sd">        Response dict based on granularity</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">is_stream</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_invoke_handler</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
        <span class="n">input_data</span><span class="p">,</span>
        <span class="n">cfg</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">,</span>
        <span class="n">response_granularity</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.compiled_graph.CompiledGraph.astop" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">astop</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.compiled_graph.CompiledGraph.astop" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">astop</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Request the current graph execution to stop (async).</p>
<p>Contract:
- Requires a valid thread_id in config
- If no active thread or no checkpointer, returns not-running
- If state exists and is running, set stop_requested flag in thread info</p>


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/compiled_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">astop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Request the current graph execution to stop (async).</span>

<span class="sd">    Contract:</span>
<span class="sd">    - Requires a valid thread_id in config</span>
<span class="sd">    - If no active thread or no checkpointer, returns not-running</span>
<span class="sd">    - If state exists and is running, set stop_requested flag in thread info</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">is_stream</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_stream&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;no-checkpointer&quot;</span><span class="p">}</span>

    <span class="c1"># Load state to see if this thread is running</span>
    <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="o">.</span><span class="n">aget_state_cache</span><span class="p">(</span>
        <span class="n">cfg</span>
    <span class="p">)</span> <span class="ow">or</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="o">.</span><span class="n">aget_state</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;running&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;no-state&quot;</span><span class="p">}</span>

    <span class="n">running</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">is_running</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">is_interrupted</span><span class="p">()</span>
    <span class="c1"># Set stop flag regardless; handlers will act if running</span>
    <span class="k">if</span> <span class="n">running</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">stop_current_execution</span> <span class="o">=</span> <span class="n">StopRequestStatus</span><span class="o">.</span><span class="n">STOP_REQUESTED</span>
        <span class="c1"># update cache</span>
        <span class="c1"># Cache update is enough; state will be picked up by running execution</span>
        <span class="c1"># As its running, cache will be available immediately</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="o">.</span><span class="n">aput_state_cache</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="c1"># Fixme: consider putting to main state as well</span>
        <span class="c1"># await self._checkpointer.aput_state(cfg, state)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set stop_current_execution flag for thread_id: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;thread_id&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;running&quot;</span><span class="p">:</span> <span class="n">running</span><span class="p">}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;No running execution to stop for thread_id: </span><span class="si">%s</span><span class="s2"> (running=</span><span class="si">%s</span><span class="s2">, interrupted=</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;thread_id&quot;</span><span class="p">),</span>
        <span class="n">running</span><span class="p">,</span>
        <span class="n">state</span><span class="o">.</span><span class="n">is_interrupted</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;running&quot;</span><span class="p">:</span> <span class="n">running</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;not-running&quot;</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.compiled_graph.CompiledGraph.astream" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">astream</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.compiled_graph.CompiledGraph.astream" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">astream</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">response_granularity</span><span class="o">=</span><span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Execute the graph asynchronously with streaming support.</p>
<p>Yields Message objects containing incremental responses.
If nodes return streaming responses, yields them directly.
If nodes return complete responses, simulates streaming by chunking.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.compiled_graph.CompiledGraph.astream(input_data)" class="doc doc-heading doc-heading-parameter">                  <code>input_data</code>
<a href="#pyagenity.graph.compiled_graph.CompiledGraph.astream(input_data)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input dict</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.compiled_graph.CompiledGraph.astream(config)" class="doc doc-heading doc-heading-parameter">                  <code>config</code>
<a href="#pyagenity.graph.compiled_graph.CompiledGraph.astream(config)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration dictionary</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.compiled_graph.CompiledGraph.astream(response_granularity)" class="doc doc-heading doc-heading-parameter">                  <code>response_granularity</code>
<a href="#pyagenity.graph.compiled_graph.CompiledGraph.astream(response_granularity)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            ResponseGranularity (pyagenity.utils.ResponseGranularity)" href="../#pyagenity.utils.ResponseGranularity">ResponseGranularity</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Response parsing granularity</p>
              </div>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            LOW


  
      class-attribute
      instance-attribute
   (pyagenity.utils.ResponseGranularity.LOW)" href="../#pyagenity.utils.ResponseGranularity.LOW">LOW</a></code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Yields:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="collections.abc.AsyncIterator">AsyncIterator</span>[<a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.message.Message)" href="../#pyagenity.utils.message.Message">Message</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Message objects with incremental content</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/compiled_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">astream</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">response_granularity</span><span class="p">:</span> <span class="n">ResponseGranularity</span> <span class="o">=</span> <span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="n">Message</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the graph asynchronously with streaming support.</span>

<span class="sd">    Yields Message objects containing incremental responses.</span>
<span class="sd">    If nodes return streaming responses, yields them directly.</span>
<span class="sd">    If nodes return complete responses, simulates streaming by chunking.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_data: Input dict</span>
<span class="sd">        config: Configuration dictionary</span>
<span class="sd">        response_granularity: Response parsing granularity</span>

<span class="sd">    Yields:</span>
<span class="sd">        Message objects with incremental content</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">is_stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream_handler</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
        <span class="n">input_data</span><span class="p">,</span>
        <span class="n">cfg</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">,</span>
        <span class="n">response_granularity</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">yield</span> <span class="n">chunk</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.compiled_graph.CompiledGraph.generate_graph" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">generate_graph</span>


<a href="#pyagenity.graph.compiled_graph.CompiledGraph.generate_graph" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">generate_graph</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Generate the graph representation.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary representing the graph structure.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/compiled_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate the graph representation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary representing the graph structure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;info&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;nodes&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;edges&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>
    <span class="c1"># Populate the graph with nodes and edges</span>
    <span class="k">for</span> <span class="n">node_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
        <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()),</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">node_name</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
        <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;edges&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()),</span>
                <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">from_node</span><span class="p">,</span>
                <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">to_node</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="c1"># Add few more extra info</span>
    <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;node_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;edge_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;edges&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;checkpointer&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;checkpointer_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;publisher&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;store&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;interrupt_before&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interrupt_before</span><span class="p">,</span>
        <span class="s2">&quot;interrupt_after&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interrupt_after</span><span class="p">,</span>
        <span class="s2">&quot;context_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_graph</span><span class="o">.</span><span class="n">_context_manager</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="s2">&quot;id_generator&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_graph</span><span class="o">.</span><span class="n">_id_generator</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="s2">&quot;id_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_graph</span><span class="o">.</span><span class="n">_id_generator</span><span class="o">.</span><span class="n">id_type</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="s2">&quot;state_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="s2">&quot;state_fields&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">graph</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.compiled_graph.CompiledGraph.invoke" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">invoke</span>


<a href="#pyagenity.graph.compiled_graph.CompiledGraph.invoke" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">invoke</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">response_granularity</span><span class="o">=</span><span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Execute the graph synchronously and return the final results.</p>
<p>Runs the complete graph workflow from start to finish, handling state
management, node execution, and result formatting. This method automatically
detects whether to start a fresh execution or resume from an interrupted state.</p>
<p>The execution is synchronous but internally uses async operations, making it
suitable for use in non-async contexts while still benefiting from async
capabilities for I/O operations.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.compiled_graph.CompiledGraph.invoke(input_data)" class="doc doc-heading doc-heading-parameter">                  <code>input_data</code>
<a href="#pyagenity.graph.compiled_graph.CompiledGraph.invoke(input_data)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input dictionary for graph execution. For new executions,
should contain 'messages' key with list of initial messages.
For resumed executions, can contain additional data to merge.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.compiled_graph.CompiledGraph.invoke(config)" class="doc doc-heading doc-heading-parameter">                  <code>config</code>
<a href="#pyagenity.graph.compiled_graph.CompiledGraph.invoke(config)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional configuration dictionary containing execution settings:
- user_id: Identifier for the user/session
- thread_id: Unique identifier for this execution thread
- run_id: Unique identifier for this specific run
- recursion_limit: Maximum steps before stopping (default: 25)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.compiled_graph.CompiledGraph.invoke(response_granularity)" class="doc doc-heading doc-heading-parameter">                  <code>response_granularity</code>
<a href="#pyagenity.graph.compiled_graph.CompiledGraph.invoke(response_granularity)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            ResponseGranularity (pyagenity.utils.ResponseGranularity)" href="../#pyagenity.utils.ResponseGranularity">ResponseGranularity</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Level of detail in the response:
- LOW: Returns only messages (default)
- PARTIAL: Returns context, summary, and messages
- FULL: Returns complete state and messages</p>
              </div>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            LOW


  
      class-attribute
      instance-attribute
   (pyagenity.utils.ResponseGranularity.LOW)" href="../#pyagenity.utils.ResponseGranularity.LOW">LOW</a></code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing execution results formatted according to the</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>specified granularity level. Always includes execution messages</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>and may include additional state information.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If input_data is invalid for new execution.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="GraphRecursionError">GraphRecursionError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If execution exceeds recursion limit.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code>Various exceptions</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Depending on node execution failures.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="c1"># Basic execution</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">compiled</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Message</span><span class="o">.</span><span class="n">text_message</span><span class="p">(</span><span class="s2">&quot;Process this data&quot;</span><span class="p">)]})</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">])</span>  <span class="c1"># Final execution messages</span>

<span class="c1"># With configuration and full details</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">compiled</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
    <span class="n">input_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">message</span><span class="p">]},</span>
    <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;user123&quot;</span><span class="p">,</span> <span class="s2">&quot;thread_id&quot;</span><span class="p">:</span> <span class="s2">&quot;session456&quot;</span><span class="p">,</span> <span class="s2">&quot;recursion_limit&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">},</span>
    <span class="n">response_granularity</span><span class="o">=</span><span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">FULL</span><span class="p">,</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">])</span>  <span class="c1"># Complete final state</span>
</code></pre></div>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>This method uses asyncio.run() internally, so it should not be called
from within an async context. Use ainvoke() instead for async execution.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/compiled_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">response_granularity</span><span class="p">:</span> <span class="n">ResponseGranularity</span> <span class="o">=</span> <span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the graph synchronously and return the final results.</span>

<span class="sd">    Runs the complete graph workflow from start to finish, handling state</span>
<span class="sd">    management, node execution, and result formatting. This method automatically</span>
<span class="sd">    detects whether to start a fresh execution or resume from an interrupted state.</span>

<span class="sd">    The execution is synchronous but internally uses async operations, making it</span>
<span class="sd">    suitable for use in non-async contexts while still benefiting from async</span>
<span class="sd">    capabilities for I/O operations.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_data: Input dictionary for graph execution. For new executions,</span>
<span class="sd">            should contain &#39;messages&#39; key with list of initial messages.</span>
<span class="sd">            For resumed executions, can contain additional data to merge.</span>
<span class="sd">        config: Optional configuration dictionary containing execution settings:</span>
<span class="sd">            - user_id: Identifier for the user/session</span>
<span class="sd">            - thread_id: Unique identifier for this execution thread</span>
<span class="sd">            - run_id: Unique identifier for this specific run</span>
<span class="sd">            - recursion_limit: Maximum steps before stopping (default: 25)</span>
<span class="sd">        response_granularity: Level of detail in the response:</span>
<span class="sd">            - LOW: Returns only messages (default)</span>
<span class="sd">            - PARTIAL: Returns context, summary, and messages</span>
<span class="sd">            - FULL: Returns complete state and messages</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary containing execution results formatted according to the</span>
<span class="sd">        specified granularity level. Always includes execution messages</span>
<span class="sd">        and may include additional state information.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If input_data is invalid for new execution.</span>
<span class="sd">        GraphRecursionError: If execution exceeds recursion limit.</span>
<span class="sd">        Various exceptions: Depending on node execution failures.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        # Basic execution</span>
<span class="sd">        result = compiled.invoke({&quot;messages&quot;: [Message.text_message(&quot;Process this data&quot;)]})</span>
<span class="sd">        print(result[&quot;messages&quot;])  # Final execution messages</span>

<span class="sd">        # With configuration and full details</span>
<span class="sd">        result = compiled.invoke(</span>
<span class="sd">            input_data={&quot;messages&quot;: [message]},</span>
<span class="sd">            config={&quot;user_id&quot;: &quot;user123&quot;, &quot;thread_id&quot;: &quot;session456&quot;, &quot;recursion_limit&quot;: 50},</span>
<span class="sd">            response_granularity=ResponseGranularity.FULL,</span>
<span class="sd">        )</span>
<span class="sd">        print(result[&quot;state&quot;])  # Complete final state</span>
<span class="sd">        ```</span>

<span class="sd">    Note:</span>
<span class="sd">        This method uses asyncio.run() internally, so it should not be called</span>
<span class="sd">        from within an async context. Use ainvoke() instead for async execution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Starting synchronous graph execution with </span><span class="si">%d</span><span class="s2"> input keys, granularity=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="k">if</span> <span class="n">input_data</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">response_granularity</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Input data keys: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">input_data</span> <span class="k">else</span> <span class="p">[])</span>
    <span class="c1"># Async Will Handle Event Publish</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">response_granularity</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Synchronous graph execution completed successfully&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Synchronous graph execution failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.compiled_graph.CompiledGraph.stop" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">stop</span>


<a href="#pyagenity.graph.compiled_graph.CompiledGraph.stop" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">stop</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Request the current graph execution to stop (sync helper).</p>
<p>This sets a stop flag in the checkpointer's thread store keyed by thread_id.
Handlers periodically check this flag and interrupt execution.
Returns a small status dict.</p>


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/compiled_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Request the current graph execution to stop (sync helper).</span>

<span class="sd">    This sets a stop flag in the checkpointer&#39;s thread store keyed by thread_id.</span>
<span class="sd">    Handlers periodically check this flag and interrupt execution.</span>
<span class="sd">    Returns a small status dict.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">astop</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.compiled_graph.CompiledGraph.stream" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">stream</span>


<a href="#pyagenity.graph.compiled_graph.CompiledGraph.stream" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">stream</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">response_granularity</span><span class="o">=</span><span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Execute the graph synchronously with streaming support.</p>
<p>Yields Message objects containing incremental responses.
If nodes return streaming responses, yields them directly.
If nodes return complete responses, simulates streaming by chunking.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.compiled_graph.CompiledGraph.stream(input_data)" class="doc doc-heading doc-heading-parameter">                  <code>input_data</code>
<a href="#pyagenity.graph.compiled_graph.CompiledGraph.stream(input_data)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input dict</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.compiled_graph.CompiledGraph.stream(config)" class="doc doc-heading doc-heading-parameter">                  <code>config</code>
<a href="#pyagenity.graph.compiled_graph.CompiledGraph.stream(config)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration dictionary</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.compiled_graph.CompiledGraph.stream(response_granularity)" class="doc doc-heading doc-heading-parameter">                  <code>response_granularity</code>
<a href="#pyagenity.graph.compiled_graph.CompiledGraph.stream(response_granularity)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            ResponseGranularity (pyagenity.utils.ResponseGranularity)" href="../#pyagenity.utils.ResponseGranularity">ResponseGranularity</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Response parsing granularity</p>
              </div>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            LOW


  
      class-attribute
      instance-attribute
   (pyagenity.utils.ResponseGranularity.LOW)" href="../#pyagenity.utils.ResponseGranularity.LOW">LOW</a></code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Yields:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="collections.abc.Generator">Generator</span>[<a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.message.Message)" href="../#pyagenity.utils.message.Message">Message</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Message objects with incremental content</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/compiled_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">stream</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">response_granularity</span><span class="p">:</span> <span class="n">ResponseGranularity</span> <span class="o">=</span> <span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Message</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the graph synchronously with streaming support.</span>

<span class="sd">    Yields Message objects containing incremental responses.</span>
<span class="sd">    If nodes return streaming responses, yields them directly.</span>
<span class="sd">    If nodes return complete responses, simulates streaming by chunking.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_data: Input dict</span>
<span class="sd">        config: Configuration dictionary</span>
<span class="sd">        response_granularity: Response parsing granularity</span>

<span class="sd">    Yields:</span>
<span class="sd">        Message objects with incremental content</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># For sync streaming, we&#39;ll use asyncio.run to handle the async implementation</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_async_stream</span><span class="p">():</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">astream</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">response_granularity</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">chunk</span>

    <span class="c1"># Convert async generator to sync iteration with a dedicated event loop</span>
    <span class="n">gen</span> <span class="o">=</span> <span class="n">_async_stream</span><span class="p">()</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">new_event_loop</span><span class="p">()</span>
    <span class="n">policy</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop_policy</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">previous_loop</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">previous_loop</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Synchronous streaming started&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">gen</span><span class="o">.</span><span class="fm">__anext__</span><span class="p">())</span>
                <span class="k">yield</span> <span class="n">chunk</span>
            <span class="k">except</span> <span class="ne">StopAsyncIteration</span><span class="p">:</span>
                <span class="k">break</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Attempt to close the async generator cleanly</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">gen</span><span class="o">.</span><span class="n">aclose</span><span class="p">())</span>  <span class="c1"># type: ignore[attr-defined]</span>
        <span class="c1"># Restore previous loop if any, then close created loop</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">previous_loop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="n">previous_loop</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Synchronous streaming completed&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="pyagenity.graph.edge" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">edge</span>


<a href="#pyagenity.graph.edge" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

        <p>Graph edge representation and routing logic for PyAgenity workflows.</p>
<p>This module defines the Edge class, which represents connections between nodes
in a PyAgenity graph workflow. Edges can be either static (always followed) or
conditional (followed only when certain conditions are met), enabling complex
routing logic and decision-making within graph execution.</p>
<p>Edges are fundamental building blocks that define the flow of execution through
a graph, determining which node should execute next based on the current state
and any conditional logic.</p>










<p><span class="doc-section-title">Classes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            Edge (pyagenity.graph.edge.Edge)" href="../#pyagenity.graph.edge.Edge">Edge</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Represents a connection between two nodes in a graph workflow.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>






<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            logger


  
      module-attribute
   (pyagenity.graph.edge.logger)" href="../#pyagenity.graph.edge.logger">logger</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>



  <div class="doc doc-children">





<h4 id="pyagenity.graph.edge-attributes">Attributes<a href="#pyagenity.graph.edge-attributes" class="headerlink" title="Permanent link">&para;</a></h4>

<div class="doc doc-object doc-attribute">



<h5 id="pyagenity.graph.edge.logger" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">logger</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#pyagenity.graph.edge.logger" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<h4 id="pyagenity.graph.edge-classes">Classes<a href="#pyagenity.graph.edge-classes" class="headerlink" title="Permanent link">&para;</a></h4>

<div class="doc doc-object doc-class">



<h5 id="pyagenity.graph.edge.Edge" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">Edge</span>


<a href="#pyagenity.graph.edge.Edge" class="headerlink" title="Permanent link">&para;</a></h5>


    <div class="doc doc-contents ">


        <p>Represents a connection between two nodes in a graph workflow.</p>
<p>An Edge defines the relationship and routing logic between nodes, specifying
how execution should flow from one node to another. Edges can be either
static (unconditional) or conditional based on runtime state evaluation.</p>
<p>Edges support complex routing scenarios including:
- Simple static connections between nodes
- Conditional routing based on state evaluation
- Dynamic routing with multiple possible destinations
- Decision trees and branching logic</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            from_node


  
      instance-attribute
   (pyagenity.graph.edge.Edge.from_node)" href="../#pyagenity.graph.edge.Edge.from_node">from_node</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the source node where execution originates.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            to_node


  
      instance-attribute
   (pyagenity.graph.edge.Edge.to_node)" href="../#pyagenity.graph.edge.Edge.to_node">to_node</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the destination node where execution continues.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            condition


  
      instance-attribute
   (pyagenity.graph.edge.Edge.condition)" href="../#pyagenity.graph.edge.Edge.condition">condition</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional callable that determines if this edge should be
followed. If None, the edge is always followed (static edge).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            condition_result


  
      instance-attribute
   (pyagenity.graph.edge.Edge.condition_result)" href="../#pyagenity.graph.edge.Edge.condition_result">condition_result</a></code></td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional value to match against condition result
for mapped conditional edges.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="c1"># Static edge - always followed</span>
<span class="n">static_edge</span> <span class="o">=</span> <span class="n">Edge</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;process&quot;</span><span class="p">)</span>


<span class="c1"># Conditional edge - followed only if condition returns True</span>
<span class="k">def</span><span class="w"> </span><span class="nf">needs_approval</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;requires_approval&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>


<span class="n">conditional_edge</span> <span class="o">=</span> <span class="n">Edge</span><span class="p">(</span><span class="s2">&quot;process&quot;</span><span class="p">,</span> <span class="s2">&quot;approval&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="n">needs_approval</span><span class="p">)</span>


<span class="c1"># Mapped conditional edge - follows based on specific condition result</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_priority</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;priority&quot;</span><span class="p">,</span> <span class="s2">&quot;normal&quot;</span><span class="p">)</span>


<span class="n">high_priority_edge</span> <span class="o">=</span> <span class="n">Edge</span><span class="p">(</span><span class="s2">&quot;triage&quot;</span><span class="p">,</span> <span class="s2">&quot;urgent&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="n">get_priority</span><span class="p">)</span>
<span class="n">high_priority_edge</span><span class="o">.</span><span class="n">condition_result</span> <span class="o">=</span> <span class="s2">&quot;high&quot;</span>
</code></pre></div>
</details>











<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            __init__ (pyagenity.graph.edge.Edge.__init__)" href="../#pyagenity.graph.edge.Edge.__init__">__init__</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Initialize a new Edge with source, destination, and optional condition.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>



              <details class="quote">
                <summary>Source code in <code>pyagenity/graph/edge.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Edge</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a connection between two nodes in a graph workflow.</span>

<span class="sd">    An Edge defines the relationship and routing logic between nodes, specifying</span>
<span class="sd">    how execution should flow from one node to another. Edges can be either</span>
<span class="sd">    static (unconditional) or conditional based on runtime state evaluation.</span>

<span class="sd">    Edges support complex routing scenarios including:</span>
<span class="sd">    - Simple static connections between nodes</span>
<span class="sd">    - Conditional routing based on state evaluation</span>
<span class="sd">    - Dynamic routing with multiple possible destinations</span>
<span class="sd">    - Decision trees and branching logic</span>

<span class="sd">    Attributes:</span>
<span class="sd">        from_node: Name of the source node where execution originates.</span>
<span class="sd">        to_node: Name of the destination node where execution continues.</span>
<span class="sd">        condition: Optional callable that determines if this edge should be</span>
<span class="sd">            followed. If None, the edge is always followed (static edge).</span>
<span class="sd">        condition_result: Optional value to match against condition result</span>
<span class="sd">            for mapped conditional edges.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        # Static edge - always followed</span>
<span class="sd">        static_edge = Edge(&quot;start&quot;, &quot;process&quot;)</span>


<span class="sd">        # Conditional edge - followed only if condition returns True</span>
<span class="sd">        def needs_approval(state):</span>
<span class="sd">            return state.data.get(&quot;requires_approval&quot;, False)</span>


<span class="sd">        conditional_edge = Edge(&quot;process&quot;, &quot;approval&quot;, condition=needs_approval)</span>


<span class="sd">        # Mapped conditional edge - follows based on specific condition result</span>
<span class="sd">        def get_priority(state):</span>
<span class="sd">            return state.data.get(&quot;priority&quot;, &quot;normal&quot;)</span>


<span class="sd">        high_priority_edge = Edge(&quot;triage&quot;, &quot;urgent&quot;, condition=get_priority)</span>
<span class="sd">        high_priority_edge.condition_result = &quot;high&quot;</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">from_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">to_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">condition</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a new Edge with source, destination, and optional condition.</span>

<span class="sd">        Args:</span>
<span class="sd">            from_node: Name of the source node. Must match a node name in the graph.</span>
<span class="sd">            to_node: Name of the destination node. Must match a node name in the graph</span>
<span class="sd">                or be a special constant like END.</span>
<span class="sd">            condition: Optional callable that takes an AgentState as argument and</span>
<span class="sd">                returns a value to determine if this edge should be followed.</span>
<span class="sd">                If None, this is a static edge that&#39;s always followed.</span>

<span class="sd">        Note:</span>
<span class="sd">            The condition function should be deterministic and side-effect free</span>
<span class="sd">            for predictable execution behavior. It receives the current AgentState</span>
<span class="sd">            and should return a boolean (for simple conditions) or a string/value</span>
<span class="sd">            (for mapped conditional routing).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Creating edge from &#39;</span><span class="si">%s</span><span class="s2">&#39; to &#39;</span><span class="si">%s</span><span class="s2">&#39; with condition=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">from_node</span><span class="p">,</span>
            <span class="n">to_node</span><span class="p">,</span>
            <span class="s2">&quot;yes&quot;</span> <span class="k">if</span> <span class="n">condition</span> <span class="k">else</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">from_node</span> <span class="o">=</span> <span class="n">from_node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to_node</span> <span class="o">=</span> <span class="n">to_node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">=</span> <span class="n">condition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">condition_result</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">





<h6 id="pyagenity.graph.edge.Edge-attributes">Attributes<a href="#pyagenity.graph.edge.Edge-attributes" class="headerlink" title="Permanent link">&para;</a></h6>

<div class="doc doc-object doc-attribute">



<h7 id="pyagenity.graph.edge.Edge.condition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">condition</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.edge.Edge.condition" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">condition</span> <span class="o">=</span> <span class="n">condition</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="pyagenity.graph.edge.Edge.condition_result" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">condition_result</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.edge.Edge.condition_result" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">condition_result</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="pyagenity.graph.edge.Edge.from_node" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">from_node</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.edge.Edge.from_node" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">from_node</span> <span class="o">=</span> <span class="n">from_node</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="pyagenity.graph.edge.Edge.to_node" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">to_node</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.edge.Edge.to_node" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">to_node</span> <span class="o">=</span> <span class="n">to_node</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>


<h6 id="pyagenity.graph.edge.Edge-functions">Functions<a href="#pyagenity.graph.edge.Edge-functions" class="headerlink" title="Permanent link">&para;</a></h6>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.edge.Edge.__init__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">__init__</span>


<a href="#pyagenity.graph.edge.Edge.__init__" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">__init__</span><span class="p">(</span><span class="n">from_node</span><span class="p">,</span> <span class="n">to_node</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Initialize a new Edge with source, destination, and optional condition.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.edge.Edge.__init__(from_node)" class="doc doc-heading doc-heading-parameter">                  <code>from_node</code>
<a href="#pyagenity.graph.edge.Edge.__init__(from_node)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the source node. Must match a node name in the graph.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.edge.Edge.__init__(to_node)" class="doc doc-heading doc-heading-parameter">                  <code>to_node</code>
<a href="#pyagenity.graph.edge.Edge.__init__(to_node)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the destination node. Must match a node name in the graph
or be a special constant like END.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.edge.Edge.__init__(condition)" class="doc doc-heading doc-heading-parameter">                  <code>condition</code>
<a href="#pyagenity.graph.edge.Edge.__init__(condition)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="collections.abc.Callable">Callable</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional callable that takes an AgentState as argument and
returns a value to determine if this edge should be followed.
If None, this is a static edge that's always followed.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>The condition function should be deterministic and side-effect free
for predictable execution behavior. It receives the current AgentState
and should return a boolean (for simple conditions) or a string/value
(for mapped conditional routing).</p>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/edge.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">from_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">to_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">condition</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize a new Edge with source, destination, and optional condition.</span>

<span class="sd">    Args:</span>
<span class="sd">        from_node: Name of the source node. Must match a node name in the graph.</span>
<span class="sd">        to_node: Name of the destination node. Must match a node name in the graph</span>
<span class="sd">            or be a special constant like END.</span>
<span class="sd">        condition: Optional callable that takes an AgentState as argument and</span>
<span class="sd">            returns a value to determine if this edge should be followed.</span>
<span class="sd">            If None, this is a static edge that&#39;s always followed.</span>

<span class="sd">    Note:</span>
<span class="sd">        The condition function should be deterministic and side-effect free</span>
<span class="sd">        for predictable execution behavior. It receives the current AgentState</span>
<span class="sd">        and should return a boolean (for simple conditions) or a string/value</span>
<span class="sd">        (for mapped conditional routing).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;Creating edge from &#39;</span><span class="si">%s</span><span class="s2">&#39; to &#39;</span><span class="si">%s</span><span class="s2">&#39; with condition=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">from_node</span><span class="p">,</span>
        <span class="n">to_node</span><span class="p">,</span>
        <span class="s2">&quot;yes&quot;</span> <span class="k">if</span> <span class="n">condition</span> <span class="k">else</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">from_node</span> <span class="o">=</span> <span class="n">from_node</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">to_node</span> <span class="o">=</span> <span class="n">to_node</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">=</span> <span class="n">condition</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">condition_result</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="pyagenity.graph.node" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">node</span>


<a href="#pyagenity.graph.node" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

        <p>Node execution and management for PyAgenity graph workflows.</p>
<p>This module defines the Node class, which represents executable units within
a PyAgenity graph workflow. Nodes encapsulate functions or ToolNode instances
that perform specific tasks, handle dependency injection, manage execution context,
and support both synchronous and streaming execution modes.</p>
<p>Nodes are the fundamental building blocks of graph workflows, responsible for
processing state, executing business logic, and producing outputs that drive
the workflow forward. They integrate seamlessly with PyAgenity's dependency
injection system and callback management framework.</p>










<p><span class="doc-section-title">Classes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            Node (pyagenity.graph.node.Node)" href="../#pyagenity.graph.node.Node">Node</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Represents a node in the graph workflow.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>






<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            logger


  
      module-attribute
   (pyagenity.graph.node.logger)" href="../#pyagenity.graph.node.logger">logger</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>



  <div class="doc doc-children">





<h4 id="pyagenity.graph.node-attributes">Attributes<a href="#pyagenity.graph.node-attributes" class="headerlink" title="Permanent link">&para;</a></h4>

<div class="doc doc-object doc-attribute">



<h5 id="pyagenity.graph.node.logger" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">logger</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#pyagenity.graph.node.logger" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<h4 id="pyagenity.graph.node-classes">Classes<a href="#pyagenity.graph.node-classes" class="headerlink" title="Permanent link">&para;</a></h4>

<div class="doc doc-object doc-class">



<h5 id="pyagenity.graph.node.Node" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">Node</span>


<a href="#pyagenity.graph.node.Node" class="headerlink" title="Permanent link">&para;</a></h5>


    <div class="doc doc-contents ">


        <p>Represents a node in the graph workflow.</p>
<p>A Node encapsulates a function or ToolNode that can be executed as part of
a graph workflow. It handles dependency injection, parameter mapping, and
execution context management.</p>
<p>The Node class supports both regular callable functions and ToolNode instances
for handling tool-based operations. It automatically injects dependencies
based on function signatures and provides legacy parameter support.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            name


  
      instance-attribute
   (pyagenity.graph.node.Node.name)" href="../#pyagenity.graph.node.Node.name">name</a></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique identifier for the node within the graph.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            func


  
      instance-attribute
   (pyagenity.graph.node.Node.func)" href="../#pyagenity.graph.node.Node.func">func</a></code></td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="collections.abc.Callable">Callable</span>, <a class="autorefs autorefs-internal" title="            ToolNode (pyagenity.graph.tool_node.ToolNode)" href="../#pyagenity.graph.tool_node.ToolNode">ToolNode</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The function or ToolNode to execute.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>def my_function(state, config):
...     return {"result": "processed"}
node = Node("processor", my_function)
result = await node.execute(state, config)</p>
</blockquote>
</blockquote>
</blockquote>
</details>











<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            __init__ (pyagenity.graph.node.Node.__init__)" href="../#pyagenity.graph.node.Node.__init__">__init__</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Initialize a new Node instance with function and dependencies.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            execute


  
      async
   (pyagenity.graph.node.Node.execute)" href="../#pyagenity.graph.node.Node.execute">execute</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Execute the node function with comprehensive context and callback support.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            stream


  
      async
   (pyagenity.graph.node.Node.stream)" href="../#pyagenity.graph.node.Node.stream">stream</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Execute the node function with streaming output support.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>



              <details class="quote">
                <summary>Source code in <code>pyagenity/graph/node.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Node</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a node in the graph workflow.</span>

<span class="sd">    A Node encapsulates a function or ToolNode that can be executed as part of</span>
<span class="sd">    a graph workflow. It handles dependency injection, parameter mapping, and</span>
<span class="sd">    execution context management.</span>

<span class="sd">    The Node class supports both regular callable functions and ToolNode instances</span>
<span class="sd">    for handling tool-based operations. It automatically injects dependencies</span>
<span class="sd">    based on function signatures and provides legacy parameter support.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        name (str): Unique identifier for the node within the graph.</span>
<span class="sd">        func (Union[Callable, ToolNode]): The function or ToolNode to execute.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; def my_function(state, config):</span>
<span class="sd">        ...     return {&quot;result&quot;: &quot;processed&quot;}</span>
<span class="sd">        &gt;&gt;&gt; node = Node(&quot;processor&quot;, my_function)</span>
<span class="sd">        &gt;&gt;&gt; result = await node.execute(state, config)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">func</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="s2">&quot;ToolNode&quot;</span><span class="p">],</span>
        <span class="n">publisher</span><span class="p">:</span> <span class="n">BasePublisher</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">BasePublisher</span><span class="p">],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a new Node instance with function and dependencies.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: Unique identifier for the node within the graph. This name</span>
<span class="sd">                is used for routing, logging, and referencing the node in</span>
<span class="sd">                graph configuration.</span>
<span class="sd">            func: The function or ToolNode to execute when this node is called.</span>
<span class="sd">                Functions should accept at least &#39;state&#39; and &#39;config&#39; parameters.</span>
<span class="sd">                ToolNode instances handle tool-based operations and provide</span>
<span class="sd">                their own execution logic.</span>
<span class="sd">            publisher: Optional event publisher for execution monitoring.</span>
<span class="sd">                Injected via dependency injection if not explicitly provided.</span>
<span class="sd">                Used for publishing node execution events and status updates.</span>

<span class="sd">        Note:</span>
<span class="sd">            The function signature is automatically analyzed to determine</span>
<span class="sd">            required parameters and dependency injection points. Parameters</span>
<span class="sd">            matching injectable service names will be automatically provided</span>
<span class="sd">            by the framework during execution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Initializing node &#39;</span><span class="si">%s</span><span class="s2">&#39; with func=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">publisher</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">invoke_handler</span> <span class="o">=</span> <span class="n">InvokeNodeHandler</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">func</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stream_handler</span> <span class="o">=</span> <span class="n">StreamNodeHandler</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">func</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
        <span class="n">callback_mgr</span><span class="p">:</span> <span class="n">CallbackManager</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">Message</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the node function with comprehensive context and callback support.</span>

<span class="sd">        Executes the node&#39;s function or ToolNode with full dependency injection,</span>
<span class="sd">        callback hook execution, and error handling. This method provides the</span>
<span class="sd">        complete execution environment including state access, configuration,</span>
<span class="sd">        and injected services.</span>

<span class="sd">        Args:</span>
<span class="sd">            config: Configuration dictionary containing execution context,</span>
<span class="sd">                user settings, thread identification, and runtime parameters.</span>
<span class="sd">            state: Current AgentState providing workflow context, message history,</span>
<span class="sd">                and shared state information accessible to the node function.</span>
<span class="sd">            callback_mgr: Callback manager for executing pre/post execution hooks.</span>
<span class="sd">                Injected via dependency injection if not explicitly provided.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Either a dictionary containing updated state and execution results,</span>
<span class="sd">            or a list of Message objects representing the node&#39;s output.</span>
<span class="sd">            The return type depends on the node function&#39;s implementation.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Various exceptions depending on node function behavior. All exceptions</span>
<span class="sd">            are handled by the callback manager&#39;s error handling hooks before</span>
<span class="sd">            being propagated.</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            # Node function that returns messages</span>
<span class="sd">            def process_data(state, config):</span>
<span class="sd">                result = process(state.data)</span>
<span class="sd">                return [Message.text_message(f&quot;Processed: {result}&quot;)]</span>


<span class="sd">            node = Node(&quot;processor&quot;, process_data)</span>
<span class="sd">            messages = await node.execute(config, state)</span>
<span class="sd">            ```</span>

<span class="sd">        Note:</span>
<span class="sd">            The node function receives dependency-injected parameters based on</span>
<span class="sd">            its signature. Common injectable parameters include &#39;state&#39;, &#39;config&#39;,</span>
<span class="sd">            &#39;context_manager&#39;, &#39;publisher&#39;, and other framework services.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">invoke_handler</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">state</span><span class="p">,</span>
            <span class="n">callback_mgr</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
        <span class="n">callback_mgr</span><span class="p">:</span> <span class="n">CallbackManager</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterable</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="n">Message</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the node function with streaming output support.</span>

<span class="sd">        Similar to execute() but designed for streaming scenarios where the node</span>
<span class="sd">        function can produce incremental results. This method provides an async</span>
<span class="sd">        iterator interface over the node&#39;s outputs, allowing for real-time</span>
<span class="sd">        processing and response streaming.</span>

<span class="sd">        Args:</span>
<span class="sd">            config: Configuration dictionary with execution context and settings.</span>
<span class="sd">            state: Current AgentState providing workflow context and shared state.</span>
<span class="sd">            callback_mgr: Callback manager for pre/post execution hook handling.</span>

<span class="sd">        Yields:</span>
<span class="sd">            Dictionary objects or Message instances representing incremental</span>
<span class="sd">            outputs from the node function. The exact type and frequency of</span>
<span class="sd">            yields depends on the node function&#39;s streaming implementation.</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            async def streaming_processor(state, config):</span>
<span class="sd">                for item in large_dataset:</span>
<span class="sd">                    result = process_item(item)</span>
<span class="sd">                    yield Message.text_message(f&quot;Processed item: {result}&quot;)</span>


<span class="sd">            node = Node(&quot;stream_processor&quot;, streaming_processor)</span>
<span class="sd">            async for output in node.stream(config, state):</span>
<span class="sd">                print(f&quot;Streamed: {output.content}&quot;)</span>
<span class="sd">            ```</span>

<span class="sd">        Note:</span>
<span class="sd">            Not all node functions support streaming. For non-streaming functions,</span>
<span class="sd">            this method will yield a single result equivalent to calling execute().</span>
<span class="sd">            The streaming capability is determined by the node function&#39;s implementation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_handler</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">state</span><span class="p">,</span>
            <span class="n">callback_mgr</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">async</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">item</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">





<h6 id="pyagenity.graph.node.Node-attributes">Attributes<a href="#pyagenity.graph.node.Node-attributes" class="headerlink" title="Permanent link">&para;</a></h6>

<div class="doc doc-object doc-attribute">



<h7 id="pyagenity.graph.node.Node.func" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">func</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.node.Node.func" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="pyagenity.graph.node.Node.invoke_handler" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">invoke_handler</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.node.Node.invoke_handler" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">invoke_handler</span> <span class="o">=</span> <span class="n">InvokeNodeHandler</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="pyagenity.graph.node.Node.name" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">name</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.node.Node.name" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="pyagenity.graph.node.Node.publisher" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">publisher</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.node.Node.publisher" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">publisher</span> <span class="o">=</span> <span class="n">publisher</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="pyagenity.graph.node.Node.stream_handler" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">stream_handler</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.node.Node.stream_handler" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">stream_handler</span> <span class="o">=</span> <span class="n">StreamNodeHandler</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>


<h6 id="pyagenity.graph.node.Node-functions">Functions<a href="#pyagenity.graph.node.Node-functions" class="headerlink" title="Permanent link">&para;</a></h6>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.node.Node.__init__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">__init__</span>


<a href="#pyagenity.graph.node.Node.__init__" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">publisher</span><span class="o">=</span><span class="n">Inject</span><span class="p">[</span><span class="n">BasePublisher</span><span class="p">])</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Initialize a new Node instance with function and dependencies.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.node.Node.__init__(name)" class="doc doc-heading doc-heading-parameter">                  <code>name</code>
<a href="#pyagenity.graph.node.Node.__init__(name)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique identifier for the node within the graph. This name
is used for routing, logging, and referencing the node in
graph configuration.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.node.Node.__init__(func)" class="doc doc-heading doc-heading-parameter">                  <code>func</code>
<a href="#pyagenity.graph.node.Node.__init__(func)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="collections.abc.Callable">Callable</span>, <a class="autorefs autorefs-internal" title="            ToolNode (pyagenity.graph.tool_node.ToolNode)" href="../#pyagenity.graph.tool_node.ToolNode">ToolNode</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The function or ToolNode to execute when this node is called.
Functions should accept at least 'state' and 'config' parameters.
ToolNode instances handle tool-based operations and provide
their own execution logic.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.node.Node.__init__(publisher)" class="doc doc-heading doc-heading-parameter">                  <code>publisher</code>
<a href="#pyagenity.graph.node.Node.__init__(publisher)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            BasePublisher (pyagenity.publisher.BasePublisher)" href="../#pyagenity.publisher.BasePublisher">BasePublisher</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional event publisher for execution monitoring.
Injected via dependency injection if not explicitly provided.
Used for publishing node execution events and status updates.</p>
              </div>
            </td>
            <td>
                  <code><span title="injectq.Inject">Inject</span>[<a class="autorefs autorefs-internal" title="            BasePublisher (pyagenity.publisher.BasePublisher)" href="../#pyagenity.publisher.BasePublisher">BasePublisher</a>]</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>The function signature is automatically analyzed to determine
required parameters and dependency injection points. Parameters
matching injectable service names will be automatically provided
by the framework during execution.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/node.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span>
<span class="normal">99</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">func</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="s2">&quot;ToolNode&quot;</span><span class="p">],</span>
    <span class="n">publisher</span><span class="p">:</span> <span class="n">BasePublisher</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">BasePublisher</span><span class="p">],</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize a new Node instance with function and dependencies.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: Unique identifier for the node within the graph. This name</span>
<span class="sd">            is used for routing, logging, and referencing the node in</span>
<span class="sd">            graph configuration.</span>
<span class="sd">        func: The function or ToolNode to execute when this node is called.</span>
<span class="sd">            Functions should accept at least &#39;state&#39; and &#39;config&#39; parameters.</span>
<span class="sd">            ToolNode instances handle tool-based operations and provide</span>
<span class="sd">            their own execution logic.</span>
<span class="sd">        publisher: Optional event publisher for execution monitoring.</span>
<span class="sd">            Injected via dependency injection if not explicitly provided.</span>
<span class="sd">            Used for publishing node execution events and status updates.</span>

<span class="sd">    Note:</span>
<span class="sd">        The function signature is automatically analyzed to determine</span>
<span class="sd">        required parameters and dependency injection points. Parameters</span>
<span class="sd">        matching injectable service names will be automatically provided</span>
<span class="sd">        by the framework during execution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;Initializing node &#39;</span><span class="si">%s</span><span class="s2">&#39; with func=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">publisher</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">invoke_handler</span> <span class="o">=</span> <span class="n">InvokeNodeHandler</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">func</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">stream_handler</span> <span class="o">=</span> <span class="n">StreamNodeHandler</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">func</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.node.Node.execute" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">execute</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.node.Node.execute" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">execute</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">callback_mgr</span><span class="o">=</span><span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">])</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Execute the node function with comprehensive context and callback support.</p>
<p>Executes the node's function or ToolNode with full dependency injection,
callback hook execution, and error handling. This method provides the
complete execution environment including state access, configuration,
and injected services.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.node.Node.execute(config)" class="doc doc-heading doc-heading-parameter">                  <code>config</code>
<a href="#pyagenity.graph.node.Node.execute(config)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration dictionary containing execution context,
user settings, thread identification, and runtime parameters.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.node.Node.execute(state)" class="doc doc-heading doc-heading-parameter">                  <code>state</code>
<a href="#pyagenity.graph.node.Node.execute(state)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            AgentState (pyagenity.state.AgentState)" href="../#pyagenity.state.AgentState">AgentState</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Current AgentState providing workflow context, message history,
and shared state information accessible to the node function.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.node.Node.execute(callback_mgr)" class="doc doc-heading doc-heading-parameter">                  <code>callback_mgr</code>
<a href="#pyagenity.graph.node.Node.execute(callback_mgr)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            CallbackManager (pyagenity.utils.CallbackManager)" href="../#pyagenity.utils.CallbackManager">CallbackManager</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Callback manager for executing pre/post execution hooks.
Injected via dependency injection if not explicitly provided.</p>
              </div>
            </td>
            <td>
                  <code><span title="injectq.Inject">Inject</span>[<a class="autorefs autorefs-internal" title="            CallbackManager (pyagenity.utils.CallbackManager)" href="../#pyagenity.utils.CallbackManager">CallbackManager</a>]</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | <span title="list">list</span>[<a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.Message)" href="../#pyagenity.utils.Message">Message</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Either a dictionary containing updated state and execution results,</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | <span title="list">list</span>[<a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.Message)" href="../#pyagenity.utils.Message">Message</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>or a list of Message objects representing the node's output.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | <span title="list">list</span>[<a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.Message)" href="../#pyagenity.utils.Message">Message</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The return type depends on the node function's implementation.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="c1"># Node function that returns messages</span>
<span class="k">def</span><span class="w"> </span><span class="nf">process_data</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">Message</span><span class="o">.</span><span class="n">text_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)]</span>


<span class="n">node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="s2">&quot;processor&quot;</span><span class="p">,</span> <span class="n">process_data</span><span class="p">)</span>
<span class="n">messages</span> <span class="o">=</span> <span class="k">await</span> <span class="n">node</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</code></pre></div>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>The node function receives dependency-injected parameters based on
its signature. Common injectable parameters include 'state', 'config',
'context_manager', 'publisher', and other framework services.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/node.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
    <span class="n">callback_mgr</span><span class="p">:</span> <span class="n">CallbackManager</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">Message</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the node function with comprehensive context and callback support.</span>

<span class="sd">    Executes the node&#39;s function or ToolNode with full dependency injection,</span>
<span class="sd">    callback hook execution, and error handling. This method provides the</span>
<span class="sd">    complete execution environment including state access, configuration,</span>
<span class="sd">    and injected services.</span>

<span class="sd">    Args:</span>
<span class="sd">        config: Configuration dictionary containing execution context,</span>
<span class="sd">            user settings, thread identification, and runtime parameters.</span>
<span class="sd">        state: Current AgentState providing workflow context, message history,</span>
<span class="sd">            and shared state information accessible to the node function.</span>
<span class="sd">        callback_mgr: Callback manager for executing pre/post execution hooks.</span>
<span class="sd">            Injected via dependency injection if not explicitly provided.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Either a dictionary containing updated state and execution results,</span>
<span class="sd">        or a list of Message objects representing the node&#39;s output.</span>
<span class="sd">        The return type depends on the node function&#39;s implementation.</span>

<span class="sd">    Raises:</span>
<span class="sd">        Various exceptions depending on node function behavior. All exceptions</span>
<span class="sd">        are handled by the callback manager&#39;s error handling hooks before</span>
<span class="sd">        being propagated.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        # Node function that returns messages</span>
<span class="sd">        def process_data(state, config):</span>
<span class="sd">            result = process(state.data)</span>
<span class="sd">            return [Message.text_message(f&quot;Processed: {result}&quot;)]</span>


<span class="sd">        node = Node(&quot;processor&quot;, process_data)</span>
<span class="sd">        messages = await node.execute(config, state)</span>
<span class="sd">        ```</span>

<span class="sd">    Note:</span>
<span class="sd">        The node function receives dependency-injected parameters based on</span>
<span class="sd">        its signature. Common injectable parameters include &#39;state&#39;, &#39;config&#39;,</span>
<span class="sd">        &#39;context_manager&#39;, &#39;publisher&#39;, and other framework services.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">invoke_handler</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span>
        <span class="n">state</span><span class="p">,</span>
        <span class="n">callback_mgr</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.node.Node.stream" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">stream</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.node.Node.stream" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">stream</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">callback_mgr</span><span class="o">=</span><span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">])</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Execute the node function with streaming output support.</p>
<p>Similar to execute() but designed for streaming scenarios where the node
function can produce incremental results. This method provides an async
iterator interface over the node's outputs, allowing for real-time
processing and response streaming.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.node.Node.stream(config)" class="doc doc-heading doc-heading-parameter">                  <code>config</code>
<a href="#pyagenity.graph.node.Node.stream(config)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration dictionary with execution context and settings.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.node.Node.stream(state)" class="doc doc-heading doc-heading-parameter">                  <code>state</code>
<a href="#pyagenity.graph.node.Node.stream(state)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            AgentState (pyagenity.state.AgentState)" href="../#pyagenity.state.AgentState">AgentState</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Current AgentState providing workflow context and shared state.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.node.Node.stream(callback_mgr)" class="doc doc-heading doc-heading-parameter">                  <code>callback_mgr</code>
<a href="#pyagenity.graph.node.Node.stream(callback_mgr)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            CallbackManager (pyagenity.utils.CallbackManager)" href="../#pyagenity.utils.CallbackManager">CallbackManager</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Callback manager for pre/post execution hook handling.</p>
              </div>
            </td>
            <td>
                  <code><span title="injectq.Inject">Inject</span>[<a class="autorefs autorefs-internal" title="            CallbackManager (pyagenity.utils.CallbackManager)" href="../#pyagenity.utils.CallbackManager">CallbackManager</a>]</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Yields:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="collections.abc.AsyncIterable">AsyncIterable</span>[<span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | <a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.Message)" href="../#pyagenity.utils.Message">Message</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary objects or Message instances representing incremental</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="collections.abc.AsyncIterable">AsyncIterable</span>[<span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | <a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.Message)" href="../#pyagenity.utils.Message">Message</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>outputs from the node function. The exact type and frequency of</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="collections.abc.AsyncIterable">AsyncIterable</span>[<span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | <a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.Message)" href="../#pyagenity.utils.Message">Message</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>yields depends on the node function's streaming implementation.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">streaming_processor</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">large_dataset</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">process_item</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">Message</span><span class="o">.</span><span class="n">text_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed item: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="n">node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="s2">&quot;stream_processor&quot;</span><span class="p">,</span> <span class="n">streaming_processor</span><span class="p">)</span>
<span class="k">async</span> <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Streamed: </span><span class="si">{</span><span class="n">output</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>Not all node functions support streaming. For non-streaming functions,
this method will yield a single result equivalent to calling execute().
The streaming capability is determined by the node function's implementation.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/node.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
    <span class="n">callback_mgr</span><span class="p">:</span> <span class="n">CallbackManager</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterable</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="n">Message</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the node function with streaming output support.</span>

<span class="sd">    Similar to execute() but designed for streaming scenarios where the node</span>
<span class="sd">    function can produce incremental results. This method provides an async</span>
<span class="sd">    iterator interface over the node&#39;s outputs, allowing for real-time</span>
<span class="sd">    processing and response streaming.</span>

<span class="sd">    Args:</span>
<span class="sd">        config: Configuration dictionary with execution context and settings.</span>
<span class="sd">        state: Current AgentState providing workflow context and shared state.</span>
<span class="sd">        callback_mgr: Callback manager for pre/post execution hook handling.</span>

<span class="sd">    Yields:</span>
<span class="sd">        Dictionary objects or Message instances representing incremental</span>
<span class="sd">        outputs from the node function. The exact type and frequency of</span>
<span class="sd">        yields depends on the node function&#39;s streaming implementation.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        async def streaming_processor(state, config):</span>
<span class="sd">            for item in large_dataset:</span>
<span class="sd">                result = process_item(item)</span>
<span class="sd">                yield Message.text_message(f&quot;Processed item: {result}&quot;)</span>


<span class="sd">        node = Node(&quot;stream_processor&quot;, streaming_processor)</span>
<span class="sd">        async for output in node.stream(config, state):</span>
<span class="sd">            print(f&quot;Streamed: {output.content}&quot;)</span>
<span class="sd">        ```</span>

<span class="sd">    Note:</span>
<span class="sd">        Not all node functions support streaming. For non-streaming functions,</span>
<span class="sd">        this method will yield a single result equivalent to calling execute().</span>
<span class="sd">        The streaming capability is determined by the node function&#39;s implementation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_handler</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span>
        <span class="n">state</span><span class="p">,</span>
        <span class="n">callback_mgr</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">async</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">item</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="pyagenity.graph.state_graph" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">state_graph</span>


<a href="#pyagenity.graph.state_graph" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">










<p><span class="doc-section-title">Classes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            StateGraph (pyagenity.graph.state_graph.StateGraph)" href="../#pyagenity.graph.state_graph.StateGraph">StateGraph</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Main graph class for orchestrating multi-agent workflows.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>






<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            StateT


  
      module-attribute
   (pyagenity.graph.state_graph.StateT)" href="../#pyagenity.graph.state_graph.StateT">StateT</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            logger


  
      module-attribute
   (pyagenity.graph.state_graph.logger)" href="../#pyagenity.graph.state_graph.logger">logger</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>



  <div class="doc doc-children">





<h4 id="pyagenity.graph.state_graph-attributes">Attributes<a href="#pyagenity.graph.state_graph-attributes" class="headerlink" title="Permanent link">&para;</a></h4>

<div class="doc doc-object doc-attribute">



<h5 id="pyagenity.graph.state_graph.StateT" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">StateT</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#pyagenity.graph.state_graph.StateT" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">StateT</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;StateT&#39;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">AgentState</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="pyagenity.graph.state_graph.logger" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">logger</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#pyagenity.graph.state_graph.logger" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<h4 id="pyagenity.graph.state_graph-classes">Classes<a href="#pyagenity.graph.state_graph-classes" class="headerlink" title="Permanent link">&para;</a></h4>

<div class="doc doc-object doc-class">



<h5 id="pyagenity.graph.state_graph.StateGraph" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">StateGraph</span>


<a href="#pyagenity.graph.state_graph.StateGraph" class="headerlink" title="Permanent link">&para;</a></h5>


    <div class="doc doc-contents ">


        <p>Main graph class for orchestrating multi-agent workflows.</p>
<p>This class provides the core functionality for building and managing stateful
agent workflows. It is similar to LangGraph's StateGraph
integration with support for dependency injection.</p>
<p>The graph is generic over state types to support custom AgentState subclasses,
allowing for type-safe state management throughout the workflow execution.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.state_graph.StateGraph.state">state</span></code></td>
            <td>
                  <code><span title="pyagenity.graph.state_graph.StateGraph[StateT]">StateT</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current state of the graph workflow.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            nodes


  
      instance-attribute
   (pyagenity.graph.state_graph.StateGraph.nodes)" href="../#pyagenity.graph.state_graph.StateGraph.nodes">nodes</a></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <a class="autorefs autorefs-internal" title="            Node (pyagenity.graph.node.Node)" href="../#pyagenity.graph.node.Node">Node</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Collection of nodes in the graph.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            edges


  
      instance-attribute
   (pyagenity.graph.state_graph.StateGraph.edges)" href="../#pyagenity.graph.state_graph.StateGraph.edges">edges</a></code></td>
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="            Edge (pyagenity.graph.edge.Edge)" href="../#pyagenity.graph.edge.Edge">Edge</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Collection of edges connecting nodes.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            entry_point


  
      instance-attribute
   (pyagenity.graph.state_graph.StateGraph.entry_point)" href="../#pyagenity.graph.state_graph.StateGraph.entry_point">entry_point</a></code></td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the starting node for execution.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.state_graph.StateGraph.context_manager">context_manager</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            BaseContextManager (pyagenity.state.BaseContextManager)" href="../#pyagenity.state.BaseContextManager">BaseContextManager</a>[<span title="pyagenity.graph.state_graph.StateGraph[StateT]">StateT</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional context manager
for handling cross-node state operations.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.state_graph.StateGraph.dependency_container">dependency_container</span></code></td>
            <td>
                  <code><span title="DependencyContainer">DependencyContainer</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Container for managing
dependencies that can be injected into node functions.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.state_graph.StateGraph.compiled">compiled</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether the graph has been compiled for execution.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>graph = StateGraph()
graph.add_node("process", process_function)
graph.add_edge(START, "process")
graph.add_edge("process", END)
compiled = graph.compile()
result = compiled.invoke({"input": "data"})</p>
</blockquote>
</blockquote>
</blockquote>
</details>











<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            __init__ (pyagenity.graph.state_graph.StateGraph.__init__)" href="../#pyagenity.graph.state_graph.StateGraph.__init__">__init__</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Initialize a new StateGraph instance.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            add_conditional_edges (pyagenity.graph.state_graph.StateGraph.add_conditional_edges)" href="../#pyagenity.graph.state_graph.StateGraph.add_conditional_edges">add_conditional_edges</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Add conditional routing between nodes based on runtime evaluation.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            add_edge (pyagenity.graph.state_graph.StateGraph.add_edge)" href="../#pyagenity.graph.state_graph.StateGraph.add_edge">add_edge</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Add a static edge between two nodes.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            add_node (pyagenity.graph.state_graph.StateGraph.add_node)" href="../#pyagenity.graph.state_graph.StateGraph.add_node">add_node</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Add a node to the graph.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            compile (pyagenity.graph.state_graph.StateGraph.compile)" href="../#pyagenity.graph.state_graph.StateGraph.compile">compile</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Compile the graph for execution.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            set_entry_point (pyagenity.graph.state_graph.StateGraph.set_entry_point)" href="../#pyagenity.graph.state_graph.StateGraph.set_entry_point">set_entry_point</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Set the entry point for the graph.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>



              <details class="quote">
                <summary>Source code in <code>pyagenity/graph/state_graph.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">StateGraph</span><span class="p">[</span><span class="n">StateT</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main graph class for orchestrating multi-agent workflows.</span>

<span class="sd">    This class provides the core functionality for building and managing stateful</span>
<span class="sd">    agent workflows. It is similar to LangGraph&#39;s StateGraph</span>
<span class="sd">    integration with support for dependency injection.</span>

<span class="sd">    The graph is generic over state types to support custom AgentState subclasses,</span>
<span class="sd">    allowing for type-safe state management throughout the workflow execution.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        state (StateT): The current state of the graph workflow.</span>
<span class="sd">        nodes (dict[str, Node]): Collection of nodes in the graph.</span>
<span class="sd">        edges (list[Edge]): Collection of edges connecting nodes.</span>
<span class="sd">        entry_point (str | None): Name of the starting node for execution.</span>
<span class="sd">        context_manager (BaseContextManager[StateT] | None): Optional context manager</span>
<span class="sd">            for handling cross-node state operations.</span>
<span class="sd">        dependency_container (DependencyContainer): Container for managing</span>
<span class="sd">            dependencies that can be injected into node functions.</span>
<span class="sd">        compiled (bool): Whether the graph has been compiled for execution.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; graph = StateGraph()</span>
<span class="sd">        &gt;&gt;&gt; graph.add_node(&quot;process&quot;, process_function)</span>
<span class="sd">        &gt;&gt;&gt; graph.add_edge(START, &quot;process&quot;)</span>
<span class="sd">        &gt;&gt;&gt; graph.add_edge(&quot;process&quot;, END)</span>
<span class="sd">        &gt;&gt;&gt; compiled = graph.compile()</span>
<span class="sd">        &gt;&gt;&gt; result = compiled.invoke({&quot;input&quot;: &quot;data&quot;})</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">StateT</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">context_manager</span><span class="p">:</span> <span class="n">BaseContextManager</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">publisher</span><span class="p">:</span> <span class="n">BasePublisher</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">id_generator</span><span class="p">:</span> <span class="n">BaseIDGenerator</span> <span class="o">=</span> <span class="n">DefaultIDGenerator</span><span class="p">(),</span>
        <span class="n">container</span><span class="p">:</span> <span class="n">InjectQ</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">thread_name_generator</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a new StateGraph instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            state: Initial state for the graph. If None, a default AgentState</span>
<span class="sd">                will be created.</span>
<span class="sd">            context_manager: Optional context manager for handling cross-node</span>
<span class="sd">                state operations and advanced state management patterns.</span>
<span class="sd">            dependency_container: Container for managing dependencies that can</span>
<span class="sd">                be injected into node functions. If None, a new empty container</span>
<span class="sd">                will be created.</span>
<span class="sd">            publisher: Publisher for emitting events during execution</span>

<span class="sd">        Note:</span>
<span class="sd">            START and END nodes are automatically added to the graph upon</span>
<span class="sd">            initialization and accept the full node signature including</span>
<span class="sd">            dependencies.</span>

<span class="sd">        Example:</span>
<span class="sd">            # Basic usage with default AgentState</span>
<span class="sd">            &gt;&gt;&gt; graph = StateGraph()</span>

<span class="sd">            # With custom state</span>
<span class="sd">            &gt;&gt;&gt; custom_state = MyCustomState()</span>
<span class="sd">            &gt;&gt;&gt; graph = StateGraph(custom_state)</span>

<span class="sd">            # Or using type hints for clarity</span>
<span class="sd">            &gt;&gt;&gt; graph = StateGraph[MyCustomState](MyCustomState())</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing StateGraph&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;StateGraph init with state=</span><span class="si">%s</span><span class="s2">, context_manager=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="n">state</span> <span class="k">else</span> <span class="s2">&quot;default AgentState&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="p">(</span><span class="n">context_manager</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="n">context_manager</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># State handling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">:</span> <span class="n">StateT</span> <span class="o">=</span> <span class="n">state</span> <span class="k">if</span> <span class="n">state</span> <span class="k">else</span> <span class="n">AgentState</span><span class="p">()</span>  <span class="c1"># type: ignore[assignment]</span>

        <span class="c1"># Graph structure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Node</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Edge</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entry_point</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Services</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span><span class="p">:</span> <span class="n">BasePublisher</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">publisher</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id_generator</span><span class="p">:</span> <span class="n">BaseIDGenerator</span> <span class="o">=</span> <span class="n">id_generator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_context_manager</span><span class="p">:</span> <span class="n">BaseContextManager</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">context_manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_name_generator</span> <span class="o">=</span> <span class="n">thread_name_generator</span>
        <span class="c1"># save container for dependency injection</span>
        <span class="c1"># if any container is passed then we will activate that</span>
        <span class="c1"># otherwise we can skip it and use the default one</span>
        <span class="k">if</span> <span class="n">container</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_container</span> <span class="o">=</span> <span class="n">InjectQ</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No container provided, using global singleton instance&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using provided dependency container instance&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_container</span> <span class="o">=</span> <span class="n">container</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>

        <span class="c1"># Register task_manager, for async tasks</span>
        <span class="c1"># This will be used to run background tasks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_task_manager</span> <span class="o">=</span> <span class="n">BackgroundTaskManager</span><span class="p">()</span>

        <span class="c1"># now setup the graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">()</span>

        <span class="c1"># Add START and END nodes (accept full node signature including dependencies)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding default START and END nodes&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">START</span><span class="p">]</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">deps</span><span class="p">:</span> <span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">END</span><span class="p">]</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">END</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">deps</span><span class="p">:</span> <span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;StateGraph initialized with </span><span class="si">%d</span><span class="s2"> nodes&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup the graph before compilation.</span>

<span class="sd">        This method can be used to perform any necessary setup or validation</span>
<span class="sd">        before compiling the graph for execution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting up StateGraph before compilation&quot;</span><span class="p">)</span>
        <span class="c1"># Placeholder for any setup logic needed before compilation</span>
        <span class="c1"># register dependencies</span>

        <span class="c1"># register state and context manager as singletons (these are nullable)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind_instance</span><span class="p">(</span>
            <span class="n">BaseContextManager</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_context_manager</span><span class="p">,</span>
            <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">allow_concrete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind_instance</span><span class="p">(</span>
            <span class="n">BasePublisher</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span><span class="p">,</span>
            <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">allow_concrete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># register id generator as factory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind_instance</span><span class="p">(</span>
            <span class="n">BaseIDGenerator</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_id_generator</span><span class="p">,</span>
            <span class="n">allow_concrete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;generated_id_type&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id_generator</span><span class="o">.</span><span class="n">id_type</span><span class="p">)</span>
        <span class="c1"># Allow async method also</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind_factory</span><span class="p">(</span>
            <span class="s2">&quot;generated_id&quot;</span><span class="p">,</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id_generator</span><span class="o">.</span><span class="n">generate</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="c1"># Attach Thread name generator if provided</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_name_generator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread_name_generator</span> <span class="o">=</span> <span class="n">generate_dummy_thread_name</span>

        <span class="n">generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_name_generator</span> <span class="ow">or</span> <span class="n">generate_dummy_thread_name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind_factory</span><span class="p">(</span>
            <span class="s2">&quot;generated_thread_name&quot;</span><span class="p">,</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">generator</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="c1"># Save BackgroundTaskManager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind_instance</span><span class="p">(</span>
            <span class="n">BackgroundTaskManager</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_task_manager</span><span class="p">,</span>
            <span class="n">allow_concrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_node</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name_or_func</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="n">func</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="s2">&quot;ToolNode&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StateGraph&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a node to the graph.</span>

<span class="sd">        This method supports two calling patterns:</span>
<span class="sd">        1. Pass a callable as the first argument (name inferred from function name)</span>
<span class="sd">        2. Pass a name string and callable/ToolNode as separate arguments</span>

<span class="sd">        Args:</span>
<span class="sd">            name_or_func: Either the node name (str) or a callable function.</span>
<span class="sd">                If callable, the function name will be used as the node name.</span>
<span class="sd">            func: The function or ToolNode to execute. Required if name_or_func</span>
<span class="sd">                is a string, ignored if name_or_func is callable.</span>

<span class="sd">        Returns:</span>
<span class="sd">            StateGraph: The graph instance for method chaining.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If invalid arguments are provided.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # Method 1: Function name inferred</span>
<span class="sd">            &gt;&gt;&gt; graph.add_node(my_function)</span>
<span class="sd">            &gt;&gt;&gt; # Method 2: Explicit name and function</span>
<span class="sd">            &gt;&gt;&gt; graph.add_node(&quot;process&quot;, my_function)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">name_or_func</span><span class="p">)</span> <span class="ow">and</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Function passed as first argument</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name_or_func</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">name_or_func</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding node &#39;</span><span class="si">%s</span><span class="s2">&#39; with inferred name from function&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name_or_func</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">callable</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">ToolNode</span><span class="p">)):</span>
            <span class="c1"># Name and function passed separately</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name_or_func</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Adding node &#39;</span><span class="si">%s</span><span class="s2">&#39; with explicit name and </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;ToolNode&quot;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">ToolNode</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;callable&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;Invalid arguments for add_node&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Added node &#39;</span><span class="si">%s</span><span class="s2">&#39; to graph (total nodes: </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_edge</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">from_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">to_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StateGraph&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a static edge between two nodes.</span>

<span class="sd">        Creates a direct connection from one node to another. If the source</span>
<span class="sd">        node is START, the target node becomes the entry point for the graph.</span>

<span class="sd">        Args:</span>
<span class="sd">            from_node: Name of the source node.</span>
<span class="sd">            to_node: Name of the target node.</span>

<span class="sd">        Returns:</span>
<span class="sd">            StateGraph: The graph instance for method chaining.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; graph.add_edge(&quot;node1&quot;, &quot;node2&quot;)</span>
<span class="sd">            &gt;&gt;&gt; graph.add_edge(START, &quot;entry_node&quot;)  # Sets entry point</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding edge from &#39;</span><span class="si">%s</span><span class="s2">&#39; to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">from_node</span><span class="p">,</span> <span class="n">to_node</span><span class="p">)</span>
        <span class="c1"># Set entry point if edge is from START</span>
        <span class="k">if</span> <span class="n">from_node</span> <span class="o">==</span> <span class="n">START</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">entry_point</span> <span class="o">=</span> <span class="n">to_node</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set entry point to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">to_node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Edge</span><span class="p">(</span><span class="n">from_node</span><span class="p">,</span> <span class="n">to_node</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Added edge (total edges: </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_conditional_edges</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">from_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">condition</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="n">path_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StateGraph&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add conditional routing between nodes based on runtime evaluation.</span>

<span class="sd">        Creates dynamic routing logic where the next node is determined by evaluating</span>
<span class="sd">        a condition function against the current state. This enables complex branching</span>
<span class="sd">        logic, decision trees, and adaptive workflow routing.</span>

<span class="sd">        Args:</span>
<span class="sd">            from_node: Name of the source node where the condition is evaluated.</span>
<span class="sd">            condition: Callable function that takes the current AgentState and returns</span>
<span class="sd">                a value used for routing decisions. Should be deterministic and</span>
<span class="sd">                side-effect free.</span>
<span class="sd">            path_map: Optional dictionary mapping condition results to destination nodes.</span>
<span class="sd">                If provided, the condition&#39;s return value is looked up in this mapping.</span>
<span class="sd">                If None, the condition should return the destination node name directly.</span>

<span class="sd">        Returns:</span>
<span class="sd">            StateGraph: The graph instance for method chaining.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the condition function or path_map configuration is invalid.</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            # Direct routing - condition returns node name</span>
<span class="sd">            def route_by_priority(state):</span>
<span class="sd">                priority = state.data.get(&quot;priority&quot;, &quot;normal&quot;)</span>
<span class="sd">                return &quot;urgent_handler&quot; if priority == &quot;high&quot; else &quot;normal_handler&quot;</span>


<span class="sd">            graph.add_conditional_edges(&quot;classifier&quot;, route_by_priority)</span>


<span class="sd">            # Mapped routing - condition result mapped to nodes</span>
<span class="sd">            def get_category(state):</span>
<span class="sd">                return state.data.get(&quot;category&quot;, &quot;default&quot;)</span>


<span class="sd">            category_map = {</span>
<span class="sd">                &quot;finance&quot;: &quot;finance_processor&quot;,</span>
<span class="sd">                &quot;legal&quot;: &quot;legal_processor&quot;,</span>
<span class="sd">                &quot;default&quot;: &quot;general_processor&quot;,</span>
<span class="sd">            }</span>
<span class="sd">            graph.add_conditional_edges(&quot;categorizer&quot;, get_category, category_map)</span>
<span class="sd">            ```</span>

<span class="sd">        Note:</span>
<span class="sd">            The condition function receives the current AgentState and should return</span>
<span class="sd">            consistent results for the same state. If using path_map, ensure the</span>
<span class="sd">            condition&#39;s return values match the map keys exactly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add conditional edges from a node based on a condition function.</span>

<span class="sd">        Creates edges that are traversed based on the result of a condition</span>
<span class="sd">        function. The condition function receives the current state and should</span>
<span class="sd">        return a value that determines which edge to follow.</span>

<span class="sd">        Args:</span>
<span class="sd">            from_node: Name of the source node.</span>
<span class="sd">            condition: Function that evaluates the current state and returns</span>
<span class="sd">                a value to determine the next node.</span>
<span class="sd">            path_map: Optional mapping from condition results to target nodes.</span>
<span class="sd">                If provided, creates multiple conditional edges. If None,</span>
<span class="sd">                creates a single conditional edge.</span>

<span class="sd">        Returns:</span>
<span class="sd">            StateGraph: The graph instance for method chaining.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; def route_condition(state):</span>
<span class="sd">            ...     return &quot;success&quot; if state.success else &quot;failure&quot;</span>
<span class="sd">            &gt;&gt;&gt; graph.add_conditional_edges(</span>
<span class="sd">            ...     &quot;processor&quot;,</span>
<span class="sd">            ...     route_condition,</span>
<span class="sd">            ...     {&quot;success&quot;: &quot;next_step&quot;, &quot;failure&quot;: &quot;error_handler&quot;},</span>
<span class="sd">            ... )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create edges based on possible returns from condition function</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; adding conditional edges with path_map: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">from_node</span><span class="p">,</span>
            <span class="n">path_map</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">path_map</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; adding conditional edges with path_map: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">from_node</span><span class="p">,</span> <span class="n">path_map</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">condition_result</span><span class="p">,</span> <span class="n">target_node</span> <span class="ow">in</span> <span class="n">path_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">edge</span> <span class="o">=</span> <span class="n">Edge</span><span class="p">(</span><span class="n">from_node</span><span class="p">,</span> <span class="n">target_node</span><span class="p">,</span> <span class="n">condition</span><span class="p">)</span>
                <span class="n">edge</span><span class="o">.</span><span class="n">condition_result</span> <span class="o">=</span> <span class="n">condition_result</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Single conditional edge</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; adding single conditional edge&quot;</span><span class="p">,</span> <span class="n">from_node</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Edge</span><span class="p">(</span><span class="n">from_node</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_entry_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StateGraph&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the entry point for the graph.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entry_point</span> <span class="o">=</span> <span class="n">node_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="n">node_name</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set entry point to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">node_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compile</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">checkpointer</span><span class="p">:</span> <span class="n">BaseCheckpointer</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">store</span><span class="p">:</span> <span class="n">BaseStore</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">interrupt_before</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">interrupt_after</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">callback_manager</span><span class="p">:</span> <span class="n">CallbackManager</span> <span class="o">=</span> <span class="n">CallbackManager</span><span class="p">(),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CompiledGraph[StateT]&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compile the graph for execution.</span>

<span class="sd">        Args:</span>
<span class="sd">            checkpointer: Checkpointer for state persistence</span>
<span class="sd">            store: Store for additional data</span>
<span class="sd">            debug: Enable debug mode</span>
<span class="sd">            interrupt_before: List of node names to interrupt before execution</span>
<span class="sd">            interrupt_after: List of node names to interrupt after execution</span>
<span class="sd">            callback_manager: Callback manager for executing hooks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Compiling graph with </span><span class="si">%d</span><span class="s2"> nodes, </span><span class="si">%d</span><span class="s2"> edges, entry_point=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">entry_point</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Compile options: interrupt_before=</span><span class="si">%s</span><span class="s2">, interrupt_after=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">interrupt_before</span><span class="p">,</span>
            <span class="n">interrupt_after</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_point</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;No entry point set. Use set_entry_point() or add an edge from START.&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">GraphError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

        <span class="c1"># Validate graph structure</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Validating graph structure&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_graph</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Graph structure validated successfully&quot;</span><span class="p">)</span>

        <span class="c1"># Validate interrupt node names</span>
        <span class="n">interrupt_before</span> <span class="o">=</span> <span class="n">interrupt_before</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">interrupt_after</span> <span class="o">=</span> <span class="n">interrupt_after</span> <span class="ow">or</span> <span class="p">[]</span>

        <span class="n">all_interrupt_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">interrupt_before</span> <span class="o">+</span> <span class="n">interrupt_after</span><span class="p">)</span>
        <span class="n">invalid_nodes</span> <span class="o">=</span> <span class="n">all_interrupt_nodes</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">invalid_nodes</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Invalid interrupt nodes: </span><span class="si">{</span><span class="n">invalid_nodes</span><span class="si">}</span><span class="s2">. Must be existing node names.&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">GraphError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Graph compilation completed successfully&quot;</span><span class="p">)</span>
        <span class="c1"># Import here to avoid circular import at module import time</span>
        <span class="c1"># Now update Checkpointer</span>
        <span class="k">if</span> <span class="n">checkpointer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">pyagenity.checkpointer</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemoryCheckpointer</span>

            <span class="n">checkpointer</span> <span class="o">=</span> <span class="n">InMemoryCheckpointer</span><span class="p">[</span><span class="n">StateT</span><span class="p">]()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No checkpointer provided, using InMemoryCheckpointer&quot;</span><span class="p">)</span>

        <span class="c1"># Import the CompiledGraph class</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.compiled_graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">CompiledGraph</span>

        <span class="c1"># Setup dependencies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind_instance</span><span class="p">(</span>
            <span class="n">BaseCheckpointer</span><span class="p">,</span>
            <span class="n">checkpointer</span><span class="p">,</span>
            <span class="n">allow_concrete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># not null as we set default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind_instance</span><span class="p">(</span>
            <span class="n">BaseStore</span><span class="p">,</span>
            <span class="n">store</span><span class="p">,</span>
            <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">allow_concrete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind_instance</span><span class="p">(</span>
            <span class="n">CallbackManager</span><span class="p">,</span>
            <span class="n">callback_manager</span><span class="p">,</span>
            <span class="n">allow_concrete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># not null as we set default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;interrupt_before&quot;</span><span class="p">,</span> <span class="n">interrupt_before</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;interrupt_after&quot;</span><span class="p">,</span> <span class="n">interrupt_after</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind_instance</span><span class="p">(</span><span class="n">StateGraph</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="n">app</span> <span class="o">=</span> <span class="n">CompiledGraph</span><span class="p">(</span>
            <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">,</span>
            <span class="n">interrupt_after</span><span class="o">=</span><span class="n">interrupt_after</span><span class="p">,</span>
            <span class="n">interrupt_before</span><span class="o">=</span><span class="n">interrupt_before</span><span class="p">,</span>
            <span class="n">state_graph</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">checkpointer</span><span class="o">=</span><span class="n">checkpointer</span><span class="p">,</span>
            <span class="n">publisher</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span><span class="p">,</span>
            <span class="n">store</span><span class="o">=</span><span class="n">store</span><span class="p">,</span>
            <span class="n">task_manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_task_manager</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">CompiledGraph</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span>
        <span class="c1"># Compile the Graph, so it will optimize the dependency graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">app</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate the graph structure.&quot;&quot;&quot;</span>
        <span class="c1"># Check for orphaned nodes</span>
        <span class="n">connected_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
            <span class="n">connected_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">from_node</span><span class="p">)</span>
            <span class="n">connected_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">to_node</span><span class="p">)</span>

        <span class="n">all_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">orphaned</span> <span class="o">=</span> <span class="n">all_nodes</span> <span class="o">-</span> <span class="n">connected_nodes</span>
        <span class="k">if</span> <span class="n">orphaned</span> <span class="o">-</span> <span class="p">{</span><span class="n">START</span><span class="p">,</span> <span class="n">END</span><span class="p">}:</span>  <span class="c1"># START and END can be orphaned</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Orphaned nodes detected: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">orphaned</span> <span class="o">-</span> <span class="p">{</span><span class="n">START</span><span class="p">,</span> <span class="n">END</span><span class="p">})</span>
            <span class="k">raise</span> <span class="n">GraphError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Orphaned nodes detected: </span><span class="si">{</span><span class="n">orphaned</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">{</span><span class="n">START</span><span class="p">,</span><span class="w"> </span><span class="n">END</span><span class="p">}</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Check that all edge targets exist</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">edge</span><span class="o">.</span><span class="n">to_node</span> <span class="ow">and</span> <span class="n">edge</span><span class="o">.</span><span class="n">to_node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Edge &#39;</span><span class="si">%s</span><span class="s2">&#39; targets non-existent node: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">edge</span><span class="p">,</span> <span class="n">edge</span><span class="o">.</span><span class="n">to_node</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">GraphError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Edge targets non-existent node: </span><span class="si">{</span><span class="n">edge</span><span class="o">.</span><span class="n">to_node</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">





<h6 id="pyagenity.graph.state_graph.StateGraph-attributes">Attributes<a href="#pyagenity.graph.state_graph.StateGraph-attributes" class="headerlink" title="Permanent link">&para;</a></h6>

<div class="doc doc-object doc-attribute">



<h7 id="pyagenity.graph.state_graph.StateGraph.edges" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">edges</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.state_graph.StateGraph.edges" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">edges</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="pyagenity.graph.state_graph.StateGraph.entry_point" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">entry_point</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.state_graph.StateGraph.entry_point" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">entry_point</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="pyagenity.graph.state_graph.StateGraph.nodes" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">nodes</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.state_graph.StateGraph.nodes" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">nodes</span> <span class="o">=</span> <span class="p">{}</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="pyagenity.graph.state_graph.StateGraph.thread_name_generator" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">thread_name_generator</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.state_graph.StateGraph.thread_name_generator" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">thread_name_generator</span> <span class="o">=</span> <span class="n">thread_name_generator</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>


<h6 id="pyagenity.graph.state_graph.StateGraph-functions">Functions<a href="#pyagenity.graph.state_graph.StateGraph-functions" class="headerlink" title="Permanent link">&para;</a></h6>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.state_graph.StateGraph.__init__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">__init__</span>


<a href="#pyagenity.graph.state_graph.StateGraph.__init__" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">__init__</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">context_manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">publisher</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">id_generator</span><span class="o">=</span><span class="n">DefaultIDGenerator</span><span class="p">(),</span> <span class="n">container</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">thread_name_generator</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Initialize a new StateGraph instance.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.state_graph.StateGraph.__init__(state)" class="doc doc-heading doc-heading-parameter">                  <code>state</code>
<a href="#pyagenity.graph.state_graph.StateGraph.__init__(state)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="pyagenity.graph.state_graph.StateGraph[StateT]">StateT</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial state for the graph. If None, a default AgentState
will be created.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.state_graph.StateGraph.__init__(context_manager)" class="doc doc-heading doc-heading-parameter">                  <code>context_manager</code>
<a href="#pyagenity.graph.state_graph.StateGraph.__init__(context_manager)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            BaseContextManager (pyagenity.state.BaseContextManager)" href="../#pyagenity.state.BaseContextManager">BaseContextManager</a>[<span title="pyagenity.graph.state_graph.StateGraph[StateT]">StateT</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional context manager for handling cross-node
state operations and advanced state management patterns.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.state_graph.StateGraph.__init__(dependency_container)" class="doc doc-heading doc-heading-parameter">                  <code>dependency_container</code>
<a href="#pyagenity.graph.state_graph.StateGraph.__init__(dependency_container)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Container for managing dependencies that can
be injected into node functions. If None, a new empty container
will be created.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.state_graph.StateGraph.__init__(publisher)" class="doc doc-heading doc-heading-parameter">                  <code>publisher</code>
<a href="#pyagenity.graph.state_graph.StateGraph.__init__(publisher)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            BasePublisher (pyagenity.publisher.BasePublisher)" href="../#pyagenity.publisher.BasePublisher">BasePublisher</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Publisher for emitting events during execution</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>START and END nodes are automatically added to the graph upon
initialization and accept the full node signature including
dependencies.</p>
</details>

<details class="example" open>
  <summary>Example</summary>
  <h6 id="pyagenity.graph.state_graph.StateGraph.__init__--basic-usage-with-default-agentstate">Basic usage with default AgentState<a class="headerlink" href="#pyagenity.graph.state_graph.StateGraph.__init__--basic-usage-with-default-agentstate" title="Permanent link">&para;</a></h6>
<blockquote>
<blockquote>
<blockquote>
<p>graph = StateGraph()</p>
</blockquote>
</blockquote>
</blockquote>
<h6 id="pyagenity.graph.state_graph.StateGraph.__init__--with-custom-state">With custom state<a class="headerlink" href="#pyagenity.graph.state_graph.StateGraph.__init__--with-custom-state" title="Permanent link">&para;</a></h6>
<blockquote>
<blockquote>
<blockquote>
<p>custom_state = MyCustomState()
graph = StateGraph(custom_state)</p>
</blockquote>
</blockquote>
</blockquote>
<h6 id="pyagenity.graph.state_graph.StateGraph.__init__--or-using-type-hints-for-clarity">Or using type hints for clarity<a class="headerlink" href="#pyagenity.graph.state_graph.StateGraph.__init__--or-using-type-hints-for-clarity" title="Permanent link">&para;</a></h6>
<blockquote>
<blockquote>
<blockquote>
<p>graph = StateGraph<a href="MyCustomState()">MyCustomState</a></p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/state_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">StateT</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">context_manager</span><span class="p">:</span> <span class="n">BaseContextManager</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">publisher</span><span class="p">:</span> <span class="n">BasePublisher</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">id_generator</span><span class="p">:</span> <span class="n">BaseIDGenerator</span> <span class="o">=</span> <span class="n">DefaultIDGenerator</span><span class="p">(),</span>
    <span class="n">container</span><span class="p">:</span> <span class="n">InjectQ</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">thread_name_generator</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize a new StateGraph instance.</span>

<span class="sd">    Args:</span>
<span class="sd">        state: Initial state for the graph. If None, a default AgentState</span>
<span class="sd">            will be created.</span>
<span class="sd">        context_manager: Optional context manager for handling cross-node</span>
<span class="sd">            state operations and advanced state management patterns.</span>
<span class="sd">        dependency_container: Container for managing dependencies that can</span>
<span class="sd">            be injected into node functions. If None, a new empty container</span>
<span class="sd">            will be created.</span>
<span class="sd">        publisher: Publisher for emitting events during execution</span>

<span class="sd">    Note:</span>
<span class="sd">        START and END nodes are automatically added to the graph upon</span>
<span class="sd">        initialization and accept the full node signature including</span>
<span class="sd">        dependencies.</span>

<span class="sd">    Example:</span>
<span class="sd">        # Basic usage with default AgentState</span>
<span class="sd">        &gt;&gt;&gt; graph = StateGraph()</span>

<span class="sd">        # With custom state</span>
<span class="sd">        &gt;&gt;&gt; custom_state = MyCustomState()</span>
<span class="sd">        &gt;&gt;&gt; graph = StateGraph(custom_state)</span>

<span class="sd">        # Or using type hints for clarity</span>
<span class="sd">        &gt;&gt;&gt; graph = StateGraph[MyCustomState](MyCustomState())</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing StateGraph&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;StateGraph init with state=</span><span class="si">%s</span><span class="s2">, context_manager=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="n">state</span> <span class="k">else</span> <span class="s2">&quot;default AgentState&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="p">(</span><span class="n">context_manager</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="n">context_manager</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># State handling</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">:</span> <span class="n">StateT</span> <span class="o">=</span> <span class="n">state</span> <span class="k">if</span> <span class="n">state</span> <span class="k">else</span> <span class="n">AgentState</span><span class="p">()</span>  <span class="c1"># type: ignore[assignment]</span>

    <span class="c1"># Graph structure</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Node</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Edge</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">entry_point</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Services</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span><span class="p">:</span> <span class="n">BasePublisher</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">publisher</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_id_generator</span><span class="p">:</span> <span class="n">BaseIDGenerator</span> <span class="o">=</span> <span class="n">id_generator</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_context_manager</span><span class="p">:</span> <span class="n">BaseContextManager</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">context_manager</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">thread_name_generator</span> <span class="o">=</span> <span class="n">thread_name_generator</span>
    <span class="c1"># save container for dependency injection</span>
    <span class="c1"># if any container is passed then we will activate that</span>
    <span class="c1"># otherwise we can skip it and use the default one</span>
    <span class="k">if</span> <span class="n">container</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span> <span class="o">=</span> <span class="n">InjectQ</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No container provided, using global singleton instance&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using provided dependency container instance&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span> <span class="o">=</span> <span class="n">container</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>

    <span class="c1"># Register task_manager, for async tasks</span>
    <span class="c1"># This will be used to run background tasks</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_task_manager</span> <span class="o">=</span> <span class="n">BackgroundTaskManager</span><span class="p">()</span>

    <span class="c1"># now setup the graph</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">()</span>

    <span class="c1"># Add START and END nodes (accept full node signature including dependencies)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding default START and END nodes&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">START</span><span class="p">]</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">deps</span><span class="p">:</span> <span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">END</span><span class="p">]</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">END</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">deps</span><span class="p">:</span> <span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;StateGraph initialized with </span><span class="si">%d</span><span class="s2"> nodes&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.state_graph.StateGraph.add_conditional_edges" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">add_conditional_edges</span>


<a href="#pyagenity.graph.state_graph.StateGraph.add_conditional_edges" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">add_conditional_edges</span><span class="p">(</span><span class="n">from_node</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">path_map</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Add conditional routing between nodes based on runtime evaluation.</p>
<p>Creates dynamic routing logic where the next node is determined by evaluating
a condition function against the current state. This enables complex branching
logic, decision trees, and adaptive workflow routing.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.state_graph.StateGraph.add_conditional_edges(from_node)" class="doc doc-heading doc-heading-parameter">                  <code>from_node</code>
<a href="#pyagenity.graph.state_graph.StateGraph.add_conditional_edges(from_node)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the source node where the condition is evaluated.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.state_graph.StateGraph.add_conditional_edges(condition)" class="doc doc-heading doc-heading-parameter">                  <code>condition</code>
<a href="#pyagenity.graph.state_graph.StateGraph.add_conditional_edges(condition)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="collections.abc.Callable">Callable</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Callable function that takes the current AgentState and returns
a value used for routing decisions. Should be deterministic and
side-effect free.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.state_graph.StateGraph.add_conditional_edges(path_map)" class="doc doc-heading doc-heading-parameter">                  <code>path_map</code>
<a href="#pyagenity.graph.state_graph.StateGraph.add_conditional_edges(path_map)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional dictionary mapping condition results to destination nodes.
If provided, the condition's return value is looked up in this mapping.
If None, the condition should return the destination node name directly.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>StateGraph</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="            StateGraph (pyagenity.graph.state_graph.StateGraph)" href="../#pyagenity.graph.state_graph.StateGraph">StateGraph</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The graph instance for method chaining.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the condition function or path_map configuration is invalid.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="c1"># Direct routing - condition returns node name</span>
<span class="k">def</span><span class="w"> </span><span class="nf">route_by_priority</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="n">priority</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;priority&quot;</span><span class="p">,</span> <span class="s2">&quot;normal&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;urgent_handler&quot;</span> <span class="k">if</span> <span class="n">priority</span> <span class="o">==</span> <span class="s2">&quot;high&quot;</span> <span class="k">else</span> <span class="s2">&quot;normal_handler&quot;</span>


<span class="n">graph</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span><span class="s2">&quot;classifier&quot;</span><span class="p">,</span> <span class="n">route_by_priority</span><span class="p">)</span>


<span class="c1"># Mapped routing - condition result mapped to nodes</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_category</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">)</span>


<span class="n">category_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;finance&quot;</span><span class="p">:</span> <span class="s2">&quot;finance_processor&quot;</span><span class="p">,</span>
    <span class="s2">&quot;legal&quot;</span><span class="p">:</span> <span class="s2">&quot;legal_processor&quot;</span><span class="p">,</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;general_processor&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">graph</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span><span class="s2">&quot;categorizer&quot;</span><span class="p">,</span> <span class="n">get_category</span><span class="p">,</span> <span class="n">category_map</span><span class="p">)</span>
</code></pre></div>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>The condition function receives the current AgentState and should return
consistent results for the same state. If using path_map, ensure the
condition's return values match the map keys exactly.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/state_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_conditional_edges</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">from_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">condition</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
    <span class="n">path_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StateGraph&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add conditional routing between nodes based on runtime evaluation.</span>

<span class="sd">    Creates dynamic routing logic where the next node is determined by evaluating</span>
<span class="sd">    a condition function against the current state. This enables complex branching</span>
<span class="sd">    logic, decision trees, and adaptive workflow routing.</span>

<span class="sd">    Args:</span>
<span class="sd">        from_node: Name of the source node where the condition is evaluated.</span>
<span class="sd">        condition: Callable function that takes the current AgentState and returns</span>
<span class="sd">            a value used for routing decisions. Should be deterministic and</span>
<span class="sd">            side-effect free.</span>
<span class="sd">        path_map: Optional dictionary mapping condition results to destination nodes.</span>
<span class="sd">            If provided, the condition&#39;s return value is looked up in this mapping.</span>
<span class="sd">            If None, the condition should return the destination node name directly.</span>

<span class="sd">    Returns:</span>
<span class="sd">        StateGraph: The graph instance for method chaining.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the condition function or path_map configuration is invalid.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        # Direct routing - condition returns node name</span>
<span class="sd">        def route_by_priority(state):</span>
<span class="sd">            priority = state.data.get(&quot;priority&quot;, &quot;normal&quot;)</span>
<span class="sd">            return &quot;urgent_handler&quot; if priority == &quot;high&quot; else &quot;normal_handler&quot;</span>


<span class="sd">        graph.add_conditional_edges(&quot;classifier&quot;, route_by_priority)</span>


<span class="sd">        # Mapped routing - condition result mapped to nodes</span>
<span class="sd">        def get_category(state):</span>
<span class="sd">            return state.data.get(&quot;category&quot;, &quot;default&quot;)</span>


<span class="sd">        category_map = {</span>
<span class="sd">            &quot;finance&quot;: &quot;finance_processor&quot;,</span>
<span class="sd">            &quot;legal&quot;: &quot;legal_processor&quot;,</span>
<span class="sd">            &quot;default&quot;: &quot;general_processor&quot;,</span>
<span class="sd">        }</span>
<span class="sd">        graph.add_conditional_edges(&quot;categorizer&quot;, get_category, category_map)</span>
<span class="sd">        ```</span>

<span class="sd">    Note:</span>
<span class="sd">        The condition function receives the current AgentState and should return</span>
<span class="sd">        consistent results for the same state. If using path_map, ensure the</span>
<span class="sd">        condition&#39;s return values match the map keys exactly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add conditional edges from a node based on a condition function.</span>

<span class="sd">    Creates edges that are traversed based on the result of a condition</span>
<span class="sd">    function. The condition function receives the current state and should</span>
<span class="sd">    return a value that determines which edge to follow.</span>

<span class="sd">    Args:</span>
<span class="sd">        from_node: Name of the source node.</span>
<span class="sd">        condition: Function that evaluates the current state and returns</span>
<span class="sd">            a value to determine the next node.</span>
<span class="sd">        path_map: Optional mapping from condition results to target nodes.</span>
<span class="sd">            If provided, creates multiple conditional edges. If None,</span>
<span class="sd">            creates a single conditional edge.</span>

<span class="sd">    Returns:</span>
<span class="sd">        StateGraph: The graph instance for method chaining.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; def route_condition(state):</span>
<span class="sd">        ...     return &quot;success&quot; if state.success else &quot;failure&quot;</span>
<span class="sd">        &gt;&gt;&gt; graph.add_conditional_edges(</span>
<span class="sd">        ...     &quot;processor&quot;,</span>
<span class="sd">        ...     route_condition,</span>
<span class="sd">        ...     {&quot;success&quot;: &quot;next_step&quot;, &quot;failure&quot;: &quot;error_handler&quot;},</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create edges based on possible returns from condition function</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; adding conditional edges with path_map: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">from_node</span><span class="p">,</span>
        <span class="n">path_map</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">path_map</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; adding conditional edges with path_map: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">from_node</span><span class="p">,</span> <span class="n">path_map</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">condition_result</span><span class="p">,</span> <span class="n">target_node</span> <span class="ow">in</span> <span class="n">path_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">edge</span> <span class="o">=</span> <span class="n">Edge</span><span class="p">(</span><span class="n">from_node</span><span class="p">,</span> <span class="n">target_node</span><span class="p">,</span> <span class="n">condition</span><span class="p">)</span>
            <span class="n">edge</span><span class="o">.</span><span class="n">condition_result</span> <span class="o">=</span> <span class="n">condition_result</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Single conditional edge</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; adding single conditional edge&quot;</span><span class="p">,</span> <span class="n">from_node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Edge</span><span class="p">(</span><span class="n">from_node</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.state_graph.StateGraph.add_edge" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">add_edge</span>


<a href="#pyagenity.graph.state_graph.StateGraph.add_edge" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">add_edge</span><span class="p">(</span><span class="n">from_node</span><span class="p">,</span> <span class="n">to_node</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Add a static edge between two nodes.</p>
<p>Creates a direct connection from one node to another. If the source
node is START, the target node becomes the entry point for the graph.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.state_graph.StateGraph.add_edge(from_node)" class="doc doc-heading doc-heading-parameter">                  <code>from_node</code>
<a href="#pyagenity.graph.state_graph.StateGraph.add_edge(from_node)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the source node.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.state_graph.StateGraph.add_edge(to_node)" class="doc doc-heading doc-heading-parameter">                  <code>to_node</code>
<a href="#pyagenity.graph.state_graph.StateGraph.add_edge(to_node)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the target node.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>StateGraph</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="            StateGraph (pyagenity.graph.state_graph.StateGraph)" href="../#pyagenity.graph.state_graph.StateGraph">StateGraph</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The graph instance for method chaining.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>graph.add_edge("node1", "node2")
graph.add_edge(START, "entry_node")  # Sets entry point</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/state_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_edge</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">from_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">to_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StateGraph&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a static edge between two nodes.</span>

<span class="sd">    Creates a direct connection from one node to another. If the source</span>
<span class="sd">    node is START, the target node becomes the entry point for the graph.</span>

<span class="sd">    Args:</span>
<span class="sd">        from_node: Name of the source node.</span>
<span class="sd">        to_node: Name of the target node.</span>

<span class="sd">    Returns:</span>
<span class="sd">        StateGraph: The graph instance for method chaining.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; graph.add_edge(&quot;node1&quot;, &quot;node2&quot;)</span>
<span class="sd">        &gt;&gt;&gt; graph.add_edge(START, &quot;entry_node&quot;)  # Sets entry point</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding edge from &#39;</span><span class="si">%s</span><span class="s2">&#39; to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">from_node</span><span class="p">,</span> <span class="n">to_node</span><span class="p">)</span>
    <span class="c1"># Set entry point if edge is from START</span>
    <span class="k">if</span> <span class="n">from_node</span> <span class="o">==</span> <span class="n">START</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entry_point</span> <span class="o">=</span> <span class="n">to_node</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set entry point to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">to_node</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Edge</span><span class="p">(</span><span class="n">from_node</span><span class="p">,</span> <span class="n">to_node</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Added edge (total edges: </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.state_graph.StateGraph.add_node" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">add_node</span>


<a href="#pyagenity.graph.state_graph.StateGraph.add_node" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">add_node</span><span class="p">(</span><span class="n">name_or_func</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Add a node to the graph.</p>
<p>This method supports two calling patterns:
1. Pass a callable as the first argument (name inferred from function name)
2. Pass a name string and callable/ToolNode as separate arguments</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.state_graph.StateGraph.add_node(name_or_func)" class="doc doc-heading doc-heading-parameter">                  <code>name_or_func</code>
<a href="#pyagenity.graph.state_graph.StateGraph.add_node(name_or_func)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="str">str</span> | <span title="collections.abc.Callable">Callable</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Either the node name (str) or a callable function.
If callable, the function name will be used as the node name.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.state_graph.StateGraph.add_node(func)" class="doc doc-heading doc-heading-parameter">                  <code>func</code>
<a href="#pyagenity.graph.state_graph.StateGraph.add_node(func)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="collections.abc.Callable">Callable</span>, <a class="autorefs autorefs-internal" title="            ToolNode (pyagenity.graph.tool_node.ToolNode)" href="../#pyagenity.graph.tool_node.ToolNode">ToolNode</a>, None]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The function or ToolNode to execute. Required if name_or_func
is a string, ignored if name_or_func is callable.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>StateGraph</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="            StateGraph (pyagenity.graph.state_graph.StateGraph)" href="../#pyagenity.graph.state_graph.StateGraph">StateGraph</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The graph instance for method chaining.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If invalid arguments are provided.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<h6 id="pyagenity.graph.state_graph.StateGraph.add_node--method-1-function-name-inferred">Method 1: Function name inferred<a class="headerlink" href="#pyagenity.graph.state_graph.StateGraph.add_node--method-1-function-name-inferred" title="Permanent link">&para;</a></h6>
<p>graph.add_node(my_function)</p>
<h6 id="pyagenity.graph.state_graph.StateGraph.add_node--method-2-explicit-name-and-function">Method 2: Explicit name and function<a class="headerlink" href="#pyagenity.graph.state_graph.StateGraph.add_node--method-2-explicit-name-and-function" title="Permanent link">&para;</a></h6>
<p>graph.add_node("process", my_function)</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/state_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_node</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">name_or_func</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Callable</span><span class="p">,</span>
    <span class="n">func</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="s2">&quot;ToolNode&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StateGraph&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a node to the graph.</span>

<span class="sd">    This method supports two calling patterns:</span>
<span class="sd">    1. Pass a callable as the first argument (name inferred from function name)</span>
<span class="sd">    2. Pass a name string and callable/ToolNode as separate arguments</span>

<span class="sd">    Args:</span>
<span class="sd">        name_or_func: Either the node name (str) or a callable function.</span>
<span class="sd">            If callable, the function name will be used as the node name.</span>
<span class="sd">        func: The function or ToolNode to execute. Required if name_or_func</span>
<span class="sd">            is a string, ignored if name_or_func is callable.</span>

<span class="sd">    Returns:</span>
<span class="sd">        StateGraph: The graph instance for method chaining.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If invalid arguments are provided.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # Method 1: Function name inferred</span>
<span class="sd">        &gt;&gt;&gt; graph.add_node(my_function)</span>
<span class="sd">        &gt;&gt;&gt; # Method 2: Explicit name and function</span>
<span class="sd">        &gt;&gt;&gt; graph.add_node(&quot;process&quot;, my_function)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">name_or_func</span><span class="p">)</span> <span class="ow">and</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Function passed as first argument</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name_or_func</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">name_or_func</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding node &#39;</span><span class="si">%s</span><span class="s2">&#39; with inferred name from function&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name_or_func</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">callable</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">ToolNode</span><span class="p">)):</span>
        <span class="c1"># Name and function passed separately</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name_or_func</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Adding node &#39;</span><span class="si">%s</span><span class="s2">&#39; with explicit name and </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;ToolNode&quot;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">ToolNode</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;callable&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;Invalid arguments for add_node&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Added node &#39;</span><span class="si">%s</span><span class="s2">&#39; to graph (total nodes: </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.state_graph.StateGraph.compile" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">compile</span>


<a href="#pyagenity.graph.state_graph.StateGraph.compile" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">compile</span><span class="p">(</span><span class="n">checkpointer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interrupt_before</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interrupt_after</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">callback_manager</span><span class="o">=</span><span class="n">CallbackManager</span><span class="p">())</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Compile the graph for execution.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.state_graph.StateGraph.compile(checkpointer)" class="doc doc-heading doc-heading-parameter">                  <code>checkpointer</code>
<a href="#pyagenity.graph.state_graph.StateGraph.compile(checkpointer)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            BaseCheckpointer (pyagenity.checkpointer.BaseCheckpointer)" href="../#pyagenity.checkpointer.BaseCheckpointer">BaseCheckpointer</a>[<span title="pyagenity.graph.state_graph.StateGraph[StateT]">StateT</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Checkpointer for state persistence</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.state_graph.StateGraph.compile(store)" class="doc doc-heading doc-heading-parameter">                  <code>store</code>
<a href="#pyagenity.graph.state_graph.StateGraph.compile(store)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            BaseStore (pyagenity.store.BaseStore)" href="../#pyagenity.store.BaseStore">BaseStore</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Store for additional data</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.state_graph.StateGraph.compile(debug)" class="doc doc-heading doc-heading-parameter">                  <code>debug</code>
<a href="#pyagenity.graph.state_graph.StateGraph.compile(debug)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Enable debug mode</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.state_graph.StateGraph.compile(interrupt_before)" class="doc doc-heading doc-heading-parameter">                  <code>interrupt_before</code>
<a href="#pyagenity.graph.state_graph.StateGraph.compile(interrupt_before)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of node names to interrupt before execution</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.state_graph.StateGraph.compile(interrupt_after)" class="doc doc-heading doc-heading-parameter">                  <code>interrupt_after</code>
<a href="#pyagenity.graph.state_graph.StateGraph.compile(interrupt_after)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of node names to interrupt after execution</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.state_graph.StateGraph.compile(callback_manager)" class="doc doc-heading doc-heading-parameter">                  <code>callback_manager</code>
<a href="#pyagenity.graph.state_graph.StateGraph.compile(callback_manager)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            CallbackManager (pyagenity.utils.CallbackManager)" href="../#pyagenity.utils.CallbackManager">CallbackManager</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Callback manager for executing hooks</p>
              </div>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            CallbackManager (pyagenity.utils.CallbackManager)" href="../#pyagenity.utils.CallbackManager">CallbackManager</a>()</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/state_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compile</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">checkpointer</span><span class="p">:</span> <span class="n">BaseCheckpointer</span><span class="p">[</span><span class="n">StateT</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">store</span><span class="p">:</span> <span class="n">BaseStore</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">interrupt_before</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">interrupt_after</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">callback_manager</span><span class="p">:</span> <span class="n">CallbackManager</span> <span class="o">=</span> <span class="n">CallbackManager</span><span class="p">(),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CompiledGraph[StateT]&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compile the graph for execution.</span>

<span class="sd">    Args:</span>
<span class="sd">        checkpointer: Checkpointer for state persistence</span>
<span class="sd">        store: Store for additional data</span>
<span class="sd">        debug: Enable debug mode</span>
<span class="sd">        interrupt_before: List of node names to interrupt before execution</span>
<span class="sd">        interrupt_after: List of node names to interrupt after execution</span>
<span class="sd">        callback_manager: Callback manager for executing hooks</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Compiling graph with </span><span class="si">%d</span><span class="s2"> nodes, </span><span class="si">%d</span><span class="s2"> edges, entry_point=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">),</span>
        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entry_point</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;Compile options: interrupt_before=</span><span class="si">%s</span><span class="s2">, interrupt_after=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">interrupt_before</span><span class="p">,</span>
        <span class="n">interrupt_after</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_point</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;No entry point set. Use set_entry_point() or add an edge from START.&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">GraphError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

    <span class="c1"># Validate graph structure</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Validating graph structure&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_validate_graph</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Graph structure validated successfully&quot;</span><span class="p">)</span>

    <span class="c1"># Validate interrupt node names</span>
    <span class="n">interrupt_before</span> <span class="o">=</span> <span class="n">interrupt_before</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">interrupt_after</span> <span class="o">=</span> <span class="n">interrupt_after</span> <span class="ow">or</span> <span class="p">[]</span>

    <span class="n">all_interrupt_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">interrupt_before</span> <span class="o">+</span> <span class="n">interrupt_after</span><span class="p">)</span>
    <span class="n">invalid_nodes</span> <span class="o">=</span> <span class="n">all_interrupt_nodes</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">invalid_nodes</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Invalid interrupt nodes: </span><span class="si">{</span><span class="n">invalid_nodes</span><span class="si">}</span><span class="s2">. Must be existing node names.&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">GraphError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Graph compilation completed successfully&quot;</span><span class="p">)</span>
    <span class="c1"># Import here to avoid circular import at module import time</span>
    <span class="c1"># Now update Checkpointer</span>
    <span class="k">if</span> <span class="n">checkpointer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pyagenity.checkpointer</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemoryCheckpointer</span>

        <span class="n">checkpointer</span> <span class="o">=</span> <span class="n">InMemoryCheckpointer</span><span class="p">[</span><span class="n">StateT</span><span class="p">]()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No checkpointer provided, using InMemoryCheckpointer&quot;</span><span class="p">)</span>

    <span class="c1"># Import the CompiledGraph class</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.compiled_graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">CompiledGraph</span>

    <span class="c1"># Setup dependencies</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind_instance</span><span class="p">(</span>
        <span class="n">BaseCheckpointer</span><span class="p">,</span>
        <span class="n">checkpointer</span><span class="p">,</span>
        <span class="n">allow_concrete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># not null as we set default</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind_instance</span><span class="p">(</span>
        <span class="n">BaseStore</span><span class="p">,</span>
        <span class="n">store</span><span class="p">,</span>
        <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">allow_concrete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind_instance</span><span class="p">(</span>
        <span class="n">CallbackManager</span><span class="p">,</span>
        <span class="n">callback_manager</span><span class="p">,</span>
        <span class="n">allow_concrete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># not null as we set default</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;interrupt_before&quot;</span><span class="p">,</span> <span class="n">interrupt_before</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;interrupt_after&quot;</span><span class="p">,</span> <span class="n">interrupt_after</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind_instance</span><span class="p">(</span><span class="n">StateGraph</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="n">app</span> <span class="o">=</span> <span class="n">CompiledGraph</span><span class="p">(</span>
        <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">,</span>
        <span class="n">interrupt_after</span><span class="o">=</span><span class="n">interrupt_after</span><span class="p">,</span>
        <span class="n">interrupt_before</span><span class="o">=</span><span class="n">interrupt_before</span><span class="p">,</span>
        <span class="n">state_graph</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">checkpointer</span><span class="o">=</span><span class="n">checkpointer</span><span class="p">,</span>
        <span class="n">publisher</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_publisher</span><span class="p">,</span>
        <span class="n">store</span><span class="o">=</span><span class="n">store</span><span class="p">,</span>
        <span class="n">task_manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_task_manager</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">CompiledGraph</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span>
    <span class="c1"># Compile the Graph, so it will optimize the dependency graph</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">app</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.state_graph.StateGraph.set_entry_point" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">set_entry_point</span>


<a href="#pyagenity.graph.state_graph.StateGraph.set_entry_point" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">set_entry_point</span><span class="p">(</span><span class="n">node_name</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Set the entry point for the graph.</p>


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/state_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_entry_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StateGraph&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the entry point for the graph.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">entry_point</span> <span class="o">=</span> <span class="n">node_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="n">node_name</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set entry point to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">node_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>
<h4 id="pyagenity.graph.state_graph-functions">Functions<a href="#pyagenity.graph.state_graph-functions" class="headerlink" title="Permanent link">&para;</a></h4>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="pyagenity.graph.tool_node" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">tool_node</span>


<a href="#pyagenity.graph.tool_node" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

        <p>ToolNode package.</p>
<p>This package provides a modularized implementation of ToolNode. Public API:</p>
<ul>
<li>ToolNode</li>
<li>HAS_FASTMCP, HAS_MCP</li>
</ul>
<p>Backwards-compatible import path: <code>from pyagenity.graph.tool_node import ToolNode</code></p>






<p><span class="doc-section-title">Modules:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            base (pyagenity.graph.tool_node.base)" href="../#pyagenity.graph.tool_node.base">base</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Tool execution node for PyAgenity graph workflows.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            constants (pyagenity.graph.tool_node.constants)" href="../#pyagenity.graph.tool_node.constants">constants</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Constants for ToolNode package.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            deps (pyagenity.graph.tool_node.deps)" href="../#pyagenity.graph.tool_node.deps">deps</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Dependency flags and optional imports for ToolNode.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            executors (pyagenity.graph.tool_node.executors)" href="../#pyagenity.graph.tool_node.executors">executors</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Executors for different tool providers and local functions.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            schema (pyagenity.graph.tool_node.schema)" href="../#pyagenity.graph.tool_node.schema">schema</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Schema utilities and local tool description building for ToolNode.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>






<p><span class="doc-section-title">Classes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            ToolNode (pyagenity.graph.tool_node.ToolNode)" href="../#pyagenity.graph.tool_node.ToolNode">ToolNode</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>A unified registry and executor for callable functions from various tool providers.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>






<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            HAS_FASTMCP


  
      module-attribute
   (pyagenity.graph.tool_node.HAS_FASTMCP)" href="../#pyagenity.graph.tool_node.HAS_FASTMCP">HAS_FASTMCP</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            HAS_MCP


  
      module-attribute
   (pyagenity.graph.tool_node.HAS_MCP)" href="../#pyagenity.graph.tool_node.HAS_MCP">HAS_MCP</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>



  <div class="doc doc-children">





<h4 id="pyagenity.graph.tool_node-attributes">Attributes<a href="#pyagenity.graph.tool_node-attributes" class="headerlink" title="Permanent link">&para;</a></h4>

<div class="doc doc-object doc-attribute">



<h5 id="pyagenity.graph.tool_node.HAS_FASTMCP" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">HAS_FASTMCP</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#pyagenity.graph.tool_node.HAS_FASTMCP" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">HAS_FASTMCP</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="pyagenity.graph.tool_node.HAS_MCP" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">HAS_MCP</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#pyagenity.graph.tool_node.HAS_MCP" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">HAS_MCP</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="pyagenity.graph.tool_node.__all__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">__all__</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#pyagenity.graph.tool_node.__all__" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;HAS_FASTMCP&#39;</span><span class="p">,</span> <span class="s1">&#39;HAS_MCP&#39;</span><span class="p">,</span> <span class="s1">&#39;ToolNode&#39;</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<h4 id="pyagenity.graph.tool_node-classes">Classes<a href="#pyagenity.graph.tool_node-classes" class="headerlink" title="Permanent link">&para;</a></h4>

<div class="doc doc-object doc-class">



<h5 id="pyagenity.graph.tool_node.ToolNode" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">ToolNode</span>


<a href="#pyagenity.graph.tool_node.ToolNode" class="headerlink" title="Permanent link">&para;</a></h5>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            SchemaMixin (pyagenity.graph.tool_node.schema.SchemaMixin)" href="../#pyagenity.graph.tool_node.schema.SchemaMixin">SchemaMixin</a></code>, <code><a class="autorefs autorefs-internal" title="            LocalExecMixin (pyagenity.graph.tool_node.executors.LocalExecMixin)" href="../#pyagenity.graph.tool_node.executors.LocalExecMixin">LocalExecMixin</a></code>, <code><a class="autorefs autorefs-internal" title="            MCPMixin (pyagenity.graph.tool_node.executors.MCPMixin)" href="../#pyagenity.graph.tool_node.executors.MCPMixin">MCPMixin</a></code>, <code><a class="autorefs autorefs-internal" title="            ComposioMixin (pyagenity.graph.tool_node.executors.ComposioMixin)" href="../#pyagenity.graph.tool_node.executors.ComposioMixin">ComposioMixin</a></code>, <code><a class="autorefs autorefs-internal" title="            LangChainMixin (pyagenity.graph.tool_node.executors.LangChainMixin)" href="../#pyagenity.graph.tool_node.executors.LangChainMixin">LangChainMixin</a></code>, <code><a class="autorefs autorefs-internal" title="            KwargsResolverMixin (pyagenity.graph.tool_node.executors.KwargsResolverMixin)" href="../#pyagenity.graph.tool_node.executors.KwargsResolverMixin">KwargsResolverMixin</a></code></p>


        <p>A unified registry and executor for callable functions from various tool providers.</p>
<p>ToolNode serves as the central hub for managing and executing tools from multiple sources:
- Local Python functions
- MCP (Model Context Protocol) tools
- Composio adapter tools
- LangChain tools</p>
<p>The class uses a mixin-based architecture to separate concerns and maintain clean
integration with different tool providers. It provides both synchronous and asynchronous
execution methods with comprehensive event publishing and error handling.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.tool_node.ToolNode._funcs">_funcs</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Callable">Callable</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping function names to callable functions.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.tool_node.ToolNode._client">_client</span></code></td>
            <td>
                  <code><span title="pyagenity.graph.tool_node.deps.Client">Client</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional MCP client for remote tool execution.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.tool_node.ToolNode._composio">_composio</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            ComposioAdapter (pyagenity.adapters.tools.ComposioAdapter)" href="../#pyagenity.adapters.tools.ComposioAdapter">ComposioAdapter</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional Composio adapter for external integrations.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.tool_node.ToolNode._langchain">_langchain</span></code></td>
            <td>
                  <code><span title="typing.Any">Any</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional LangChain adapter for LangChain tools.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            mcp_tools


  
      instance-attribute
   (pyagenity.graph.tool_node.ToolNode.mcp_tools)" href="../#pyagenity.graph.tool_node.ToolNode.mcp_tools">mcp_tools</a></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of available MCP tool names.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            composio_tools


  
      instance-attribute
   (pyagenity.graph.tool_node.ToolNode.composio_tools)" href="../#pyagenity.graph.tool_node.ToolNode.composio_tools">composio_tools</a></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of available Composio tool names.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            langchain_tools


  
      instance-attribute
   (pyagenity.graph.tool_node.ToolNode.langchain_tools)" href="../#pyagenity.graph.tool_node.ToolNode.langchain_tools">langchain_tools</a></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of available LangChain tool names.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="c1"># Define local tools</span>
<span class="k">def</span><span class="w"> </span><span class="nf">weather_tool</span><span class="p">(</span><span class="n">location</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Weather in </span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s2">: Sunny, 25°C&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">calculator</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>


<span class="c1"># Create ToolNode with local functions</span>
<span class="n">tools</span> <span class="o">=</span> <span class="n">ToolNode</span><span class="p">([</span><span class="n">weather_tool</span><span class="p">,</span> <span class="n">calculator</span><span class="p">])</span>

<span class="c1"># Execute a tool</span>
<span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">tools</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weather_tool&quot;</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="s2">&quot;New York&quot;</span><span class="p">},</span>
    <span class="n">tool_call_id</span><span class="o">=</span><span class="s2">&quot;call_123&quot;</span><span class="p">,</span>
    <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;user1&quot;</span><span class="p">},</span>
    <span class="n">state</span><span class="o">=</span><span class="n">agent_state</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>
</details>











<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            __init__ (pyagenity.graph.tool_node.ToolNode.__init__)" href="../#pyagenity.graph.tool_node.ToolNode.__init__">__init__</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Initialize ToolNode with functions and optional tool adapters.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            all_tools


  
      async
   (pyagenity.graph.tool_node.ToolNode.all_tools)" href="../#pyagenity.graph.tool_node.ToolNode.all_tools">all_tools</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Get all available tools from all configured providers.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            all_tools_sync (pyagenity.graph.tool_node.ToolNode.all_tools_sync)" href="../#pyagenity.graph.tool_node.ToolNode.all_tools_sync">all_tools_sync</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Synchronously get all available tools from all configured providers.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            get_local_tool (pyagenity.graph.tool_node.ToolNode.get_local_tool)" href="../#pyagenity.graph.tool_node.ToolNode.get_local_tool">get_local_tool</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Generate OpenAI-compatible tool definitions for all registered local functions.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            invoke


  
      async
   (pyagenity.graph.tool_node.ToolNode.invoke)" href="../#pyagenity.graph.tool_node.ToolNode.invoke">invoke</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Execute a specific tool by name with the provided arguments.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            stream


  
      async
   (pyagenity.graph.tool_node.ToolNode.stream)" href="../#pyagenity.graph.tool_node.ToolNode.stream">stream</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Execute a tool with streaming support, yielding incremental results.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>



              <details class="quote">
                <summary>Source code in <code>pyagenity/graph/tool_node/base.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ToolNode</span><span class="p">(</span>
    <span class="n">SchemaMixin</span><span class="p">,</span>
    <span class="n">LocalExecMixin</span><span class="p">,</span>
    <span class="n">MCPMixin</span><span class="p">,</span>
    <span class="n">ComposioMixin</span><span class="p">,</span>
    <span class="n">LangChainMixin</span><span class="p">,</span>
    <span class="n">KwargsResolverMixin</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A unified registry and executor for callable functions from various tool providers.</span>

<span class="sd">    ToolNode serves as the central hub for managing and executing tools from multiple sources:</span>
<span class="sd">    - Local Python functions</span>
<span class="sd">    - MCP (Model Context Protocol) tools</span>
<span class="sd">    - Composio adapter tools</span>
<span class="sd">    - LangChain tools</span>

<span class="sd">    The class uses a mixin-based architecture to separate concerns and maintain clean</span>
<span class="sd">    integration with different tool providers. It provides both synchronous and asynchronous</span>
<span class="sd">    execution methods with comprehensive event publishing and error handling.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        _funcs: Dictionary mapping function names to callable functions.</span>
<span class="sd">        _client: Optional MCP client for remote tool execution.</span>
<span class="sd">        _composio: Optional Composio adapter for external integrations.</span>
<span class="sd">        _langchain: Optional LangChain adapter for LangChain tools.</span>
<span class="sd">        mcp_tools: List of available MCP tool names.</span>
<span class="sd">        composio_tools: List of available Composio tool names.</span>
<span class="sd">        langchain_tools: List of available LangChain tool names.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        # Define local tools</span>
<span class="sd">        def weather_tool(location: str) -&gt; str:</span>
<span class="sd">            return f&quot;Weather in {location}: Sunny, 25°C&quot;</span>


<span class="sd">        def calculator(a: int, b: int) -&gt; int:</span>
<span class="sd">            return a + b</span>


<span class="sd">        # Create ToolNode with local functions</span>
<span class="sd">        tools = ToolNode([weather_tool, calculator])</span>

<span class="sd">        # Execute a tool</span>
<span class="sd">        result = await tools.invoke(</span>
<span class="sd">            name=&quot;weather_tool&quot;,</span>
<span class="sd">            args={&quot;location&quot;: &quot;New York&quot;},</span>
<span class="sd">            tool_call_id=&quot;call_123&quot;,</span>
<span class="sd">            config={&quot;user_id&quot;: &quot;user1&quot;},</span>
<span class="sd">            state=agent_state,</span>
<span class="sd">        )</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">functions</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">],</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">deps</span><span class="o">.</span><span class="n">Client</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
        <span class="n">composio_adapter</span><span class="p">:</span> <span class="n">ComposioAdapter</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">langchain_adapter</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize ToolNode with functions and optional tool adapters.</span>

<span class="sd">        Args:</span>
<span class="sd">            functions: Iterable of callable functions to register as tools. Each function</span>
<span class="sd">                will be registered with its `__name__` as the tool identifier.</span>
<span class="sd">            client: Optional MCP (Model Context Protocol) client for remote tool access.</span>
<span class="sd">                Requires &#39;fastmcp&#39; and &#39;mcp&#39; packages to be installed.</span>
<span class="sd">            composio_adapter: Optional Composio adapter for external integrations and</span>
<span class="sd">                third-party API access.</span>
<span class="sd">            langchain_adapter: Optional LangChain adapter for accessing LangChain tools</span>
<span class="sd">                and integrations.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ImportError: If MCP client is provided but required packages are not installed.</span>
<span class="sd">            TypeError: If any item in functions is not callable.</span>

<span class="sd">        Note:</span>
<span class="sd">            When using MCP client functionality, ensure you have installed the required</span>
<span class="sd">            dependencies with: `pip install pyagenity[mcp]`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing ToolNode with </span><span class="si">%d</span><span class="s2"> functions&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">functions</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Read flags dynamically so tests can patch pyagenity.graph.tool_node.HAS_*</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pyagenity.graph.tool_node&quot;</span><span class="p">)</span>
            <span class="n">has_fastmcp</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s2">&quot;HAS_FASTMCP&quot;</span><span class="p">,</span> <span class="n">deps</span><span class="o">.</span><span class="n">HAS_FASTMCP</span><span class="p">)</span> <span class="k">if</span> <span class="n">mod</span> <span class="k">else</span> <span class="n">deps</span><span class="o">.</span><span class="n">HAS_FASTMCP</span>
            <span class="n">has_mcp</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s2">&quot;HAS_MCP&quot;</span><span class="p">,</span> <span class="n">deps</span><span class="o">.</span><span class="n">HAS_MCP</span><span class="p">)</span> <span class="k">if</span> <span class="n">mod</span> <span class="k">else</span> <span class="n">deps</span><span class="o">.</span><span class="n">HAS_MCP</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_fastmcp</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">has_mcp</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                    <span class="s2">&quot;MCP client functionality requires &#39;fastmcp&#39; and &#39;mcp&#39; packages. &quot;</span>
                    <span class="s2">&quot;Install with: pip install pyagenity[mcp]&quot;</span>
                <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;ToolNode initialized with MCP client&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span> <span class="n">deps</span><span class="o">.</span><span class="n">Client</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">client</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_composio</span><span class="p">:</span> <span class="n">ComposioAdapter</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">composio_adapter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_langchain</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">langchain_adapter</span>

        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">functions</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;ToolNode only accepts callables&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">[</span><span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mcp_tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composio_tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">langchain_tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_all_tools_async</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
        <span class="n">tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_local_tool</span><span class="p">()</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mcp_tool</span><span class="p">())</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_composio_tools</span><span class="p">())</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_langchain_tools</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">all_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all available tools from all configured providers.</span>

<span class="sd">        Retrieves and combines tool definitions from local functions, MCP client,</span>
<span class="sd">        Composio adapter, and LangChain adapter. Each tool definition includes</span>
<span class="sd">        the function schema with parameters and descriptions.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of tool definitions in OpenAI function calling format. Each dict</span>
<span class="sd">            contains &#39;type&#39;: &#39;function&#39; and &#39;function&#39; with name, description,</span>
<span class="sd">            and parameters schema.</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            tools = await tool_node.all_tools()</span>
<span class="sd">            # Returns:</span>
<span class="sd">            # [</span>
<span class="sd">            #   {</span>
<span class="sd">            #     &quot;type&quot;: &quot;function&quot;,</span>
<span class="sd">            #     &quot;function&quot;: {</span>
<span class="sd">            #       &quot;name&quot;: &quot;weather_tool&quot;,</span>
<span class="sd">            #       &quot;description&quot;: &quot;Get weather information for a location&quot;,</span>
<span class="sd">            #       &quot;parameters&quot;: {</span>
<span class="sd">            #         &quot;type&quot;: &quot;object&quot;,</span>
<span class="sd">            #         &quot;properties&quot;: {</span>
<span class="sd">            #           &quot;location&quot;: {&quot;type&quot;: &quot;string&quot;}</span>
<span class="sd">            #         },</span>
<span class="sd">            #         &quot;required&quot;: [&quot;location&quot;]</span>
<span class="sd">            #       }</span>
<span class="sd">            #     }</span>
<span class="sd">            #   }</span>
<span class="sd">            # ]</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_tools_async</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">all_tools_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Synchronously get all available tools from all configured providers.</span>

<span class="sd">        This is a synchronous wrapper around the async all_tools() method.</span>
<span class="sd">        It uses asyncio.run() to handle async operations from MCP, Composio,</span>
<span class="sd">        and LangChain adapters.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of tool definitions in OpenAI function calling format.</span>

<span class="sd">        Note:</span>
<span class="sd">            Prefer using the async `all_tools()` method when possible, especially</span>
<span class="sd">            in async contexts, to avoid potential event loop issues.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_local_tool</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_mcp_tool</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_composio_tools</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">comp</span><span class="p">:</span>
            <span class="n">tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
        <span class="n">lc</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_langchain_tools</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">lc</span><span class="p">:</span>
            <span class="n">tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span>  <span class="c1"># noqa: PLR0915</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">tool_call_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
        <span class="n">callback_manager</span><span class="p">:</span> <span class="n">CallbackManager</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a specific tool by name with the provided arguments.</span>

<span class="sd">        This method handles tool execution across all configured providers (local,</span>
<span class="sd">        MCP, Composio, LangChain) with comprehensive error handling, event publishing,</span>
<span class="sd">        and callback management.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name of the tool to execute.</span>
<span class="sd">            args: Dictionary of arguments to pass to the tool function.</span>
<span class="sd">            tool_call_id: Unique identifier for this tool execution, used for</span>
<span class="sd">                tracking and result correlation.</span>
<span class="sd">            config: Configuration dictionary containing execution context and</span>
<span class="sd">                user-specific settings.</span>
<span class="sd">            state: Current agent state for context-aware tool execution.</span>
<span class="sd">            callback_manager: Manager for executing pre/post execution callbacks.</span>
<span class="sd">                Injected via dependency injection if not provided.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Message object containing tool execution results, either successful</span>
<span class="sd">            output or error information with appropriate status indicators.</span>

<span class="sd">        Raises:</span>
<span class="sd">            The method handles all exceptions internally and returns error Messages</span>
<span class="sd">            rather than raising exceptions, ensuring robust execution flow.</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            result = await tool_node.invoke(</span>
<span class="sd">                name=&quot;weather_tool&quot;,</span>
<span class="sd">                args={&quot;location&quot;: &quot;Paris&quot;, &quot;units&quot;: &quot;metric&quot;},</span>
<span class="sd">                tool_call_id=&quot;call_abc123&quot;,</span>
<span class="sd">                config={&quot;user_id&quot;: &quot;user1&quot;, &quot;session_id&quot;: &quot;session1&quot;},</span>
<span class="sd">                state=current_agent_state,</span>
<span class="sd">            )</span>

<span class="sd">            # result is a Message with tool execution results</span>
<span class="sd">            print(result.content)  # Tool output or error information</span>
<span class="sd">            ```</span>

<span class="sd">        Note:</span>
<span class="sd">            The method publishes execution events throughout the process for</span>
<span class="sd">            monitoring and debugging purposes. Tool execution is routed based</span>
<span class="sd">            on tool provider precedence: MCP → Composio → LangChain → Local.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Executing tool &#39;</span><span class="si">%s</span><span class="s2">&#39; with </span><span class="si">%d</span><span class="s2"> arguments&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Tool arguments: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

        <span class="n">event</span> <span class="o">=</span> <span class="n">EventModel</span><span class="o">.</span><span class="n">default</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call_id</span><span class="p">,</span> <span class="s2">&quot;function_name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">},</span>
            <span class="n">content_type</span><span class="o">=</span><span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_CALL</span><span class="p">],</span>
            <span class="n">event</span><span class="o">=</span><span class="n">Event</span><span class="o">.</span><span class="n">TOOL_EXECUTION</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">node_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="c1"># Attach structured tool call block</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">ToolCallBlock</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcp_tools</span><span class="p">:</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_mcp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mcp_execute</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">args</span><span class="p">,</span>
                <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="n">config</span><span class="p">,</span>
                <span class="n">callback_manager</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="c1"># Attach tool result block mirroring the tool output</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
                <span class="p">]</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">composio_tools</span><span class="p">:</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_composio&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_composio_execute</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">args</span><span class="p">,</span>
                <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="n">config</span><span class="p">,</span>
                <span class="n">callback_manager</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
                <span class="p">]</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">langchain_tools</span><span class="p">:</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_langchain&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_langchain_execute</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">args</span><span class="p">,</span>
                <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="n">config</span><span class="p">,</span>
                <span class="n">callback_manager</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
                <span class="p">]</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">:</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_mcp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_execute</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">args</span><span class="p">,</span>
                <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="n">config</span><span class="p">,</span>
                <span class="n">state</span><span class="p">,</span>
                <span class="n">callback_manager</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
                <span class="p">]</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Tool &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_msg</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">ERROR</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">ERROR</span><span class="p">]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Message</span><span class="o">.</span><span class="n">tool_message</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="p">[</span>
                <span class="n">ErrorBlock</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">error_msg</span><span class="p">),</span>
                <span class="n">ToolResultBlock</span><span class="p">(</span>
                    <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                    <span class="n">output</span><span class="o">=</span><span class="n">error_msg</span><span class="p">,</span>
                    <span class="n">is_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">status</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">],</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream</span><span class="p">(</span>  <span class="c1"># noqa: PLR0915</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">tool_call_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
        <span class="n">callback_manager</span><span class="p">:</span> <span class="n">CallbackManager</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">AsyncIterator</span><span class="p">[</span><span class="n">Message</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a tool with streaming support, yielding incremental results.</span>

<span class="sd">        Similar to invoke() but designed for tools that can provide streaming responses</span>
<span class="sd">        or when you want to process results as they become available. Currently,</span>
<span class="sd">        most tool providers return complete results, so this method typically yields</span>
<span class="sd">        a single Message with the full result.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name of the tool to execute.</span>
<span class="sd">            args: Dictionary of arguments to pass to the tool function.</span>
<span class="sd">            tool_call_id: Unique identifier for this tool execution.</span>
<span class="sd">            config: Configuration dictionary containing execution context.</span>
<span class="sd">            state: Current agent state for context-aware tool execution.</span>
<span class="sd">            callback_manager: Manager for executing pre/post execution callbacks.</span>

<span class="sd">        Yields:</span>
<span class="sd">            Message objects containing tool execution results or status updates.</span>
<span class="sd">            For most tools, this will yield a single complete result Message.</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            async for message in tool_node.stream(</span>
<span class="sd">                name=&quot;data_processor&quot;,</span>
<span class="sd">                args={&quot;dataset&quot;: &quot;large_data.csv&quot;},</span>
<span class="sd">                tool_call_id=&quot;call_stream123&quot;,</span>
<span class="sd">                config={&quot;user_id&quot;: &quot;user1&quot;},</span>
<span class="sd">                state=current_state,</span>
<span class="sd">            ):</span>
<span class="sd">                print(f&quot;Received: {message.content}&quot;)</span>
<span class="sd">                # Process each streamed result</span>
<span class="sd">            ```</span>

<span class="sd">        Note:</span>
<span class="sd">            The streaming interface is designed for future expansion where tools</span>
<span class="sd">            may provide true streaming responses. Currently, it provides a</span>
<span class="sd">            consistent async iterator interface over tool results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Executing tool &#39;</span><span class="si">%s</span><span class="s2">&#39; with </span><span class="si">%d</span><span class="s2"> arguments&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Tool arguments: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">EventModel</span><span class="o">.</span><span class="n">default</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call_id</span><span class="p">,</span> <span class="s2">&quot;function_name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">},</span>
            <span class="n">content_type</span><span class="o">=</span><span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_CALL</span><span class="p">],</span>
            <span class="n">event</span><span class="o">=</span><span class="n">Event</span><span class="o">.</span><span class="n">TOOL_EXECUTION</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">node_name</span> <span class="o">=</span> <span class="s2">&quot;ToolNode&quot;</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">ToolCallBlock</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcp_tools</span><span class="p">:</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;function_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mcp&quot;</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mcp_execute</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">args</span><span class="p">,</span>
                <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="n">config</span><span class="p">,</span>
                <span class="n">callback_manager</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
                <span class="p">]</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">message</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">composio_tools</span><span class="p">:</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;function_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;composio&quot;</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_composio_execute</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">args</span><span class="p">,</span>
                <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="n">config</span><span class="p">,</span>
                <span class="n">callback_manager</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
                <span class="p">]</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">message</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">langchain_tools</span><span class="p">:</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;function_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;langchain&quot;</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_langchain_execute</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">args</span><span class="p">,</span>
                <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="n">config</span><span class="p">,</span>
                <span class="n">callback_manager</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
                <span class="p">]</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">message</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">:</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;function_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;internal&quot;</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_execute</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">args</span><span class="p">,</span>
                <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="n">config</span><span class="p">,</span>
                <span class="n">state</span><span class="p">,</span>
                <span class="n">callback_manager</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
                <span class="p">]</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">result</span>
            <span class="k">return</span>

        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Tool &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_msg</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">ERROR</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">ERROR</span><span class="p">]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="k">yield</span> <span class="n">Message</span><span class="o">.</span><span class="n">tool_message</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="p">[</span>
                <span class="n">ErrorBlock</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">error_msg</span><span class="p">),</span>
                <span class="n">ToolResultBlock</span><span class="p">(</span>
                    <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                    <span class="n">output</span><span class="o">=</span><span class="n">error_msg</span><span class="p">,</span>
                    <span class="n">is_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">status</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">],</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">





<h6 id="pyagenity.graph.tool_node.ToolNode-attributes">Attributes<a href="#pyagenity.graph.tool_node.ToolNode-attributes" class="headerlink" title="Permanent link">&para;</a></h6>

<div class="doc doc-object doc-attribute">



<h7 id="pyagenity.graph.tool_node.ToolNode.composio_tools" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">composio_tools</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.tool_node.ToolNode.composio_tools" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">composio_tools</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="pyagenity.graph.tool_node.ToolNode.langchain_tools" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">langchain_tools</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.tool_node.ToolNode.langchain_tools" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">langchain_tools</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="pyagenity.graph.tool_node.ToolNode.mcp_tools" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">mcp_tools</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.tool_node.ToolNode.mcp_tools" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">mcp_tools</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>


<h6 id="pyagenity.graph.tool_node.ToolNode-functions">Functions<a href="#pyagenity.graph.tool_node.ToolNode-functions" class="headerlink" title="Permanent link">&para;</a></h6>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.tool_node.ToolNode.__init__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">__init__</span>


<a href="#pyagenity.graph.tool_node.ToolNode.__init__" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">__init__</span><span class="p">(</span><span class="n">functions</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">composio_adapter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">langchain_adapter</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Initialize ToolNode with functions and optional tool adapters.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.tool_node.ToolNode.__init__(functions)" class="doc doc-heading doc-heading-parameter">                  <code>functions</code>
<a href="#pyagenity.graph.tool_node.ToolNode.__init__(functions)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="typing.Iterable">Iterable</span>[<span title="typing.Callable">Callable</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Iterable of callable functions to register as tools. Each function
will be registered with its <code>__name__</code> as the tool identifier.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.tool_node.ToolNode.__init__(client)" class="doc doc-heading doc-heading-parameter">                  <code>client</code>
<a href="#pyagenity.graph.tool_node.ToolNode.__init__(client)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="pyagenity.graph.tool_node.deps.Client">Client</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional MCP (Model Context Protocol) client for remote tool access.
Requires 'fastmcp' and 'mcp' packages to be installed.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.tool_node.ToolNode.__init__(composio_adapter)" class="doc doc-heading doc-heading-parameter">                  <code>composio_adapter</code>
<a href="#pyagenity.graph.tool_node.ToolNode.__init__(composio_adapter)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            ComposioAdapter (pyagenity.adapters.tools.ComposioAdapter)" href="../#pyagenity.adapters.tools.ComposioAdapter">ComposioAdapter</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional Composio adapter for external integrations and
third-party API access.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.tool_node.ToolNode.__init__(langchain_adapter)" class="doc doc-heading doc-heading-parameter">                  <code>langchain_adapter</code>
<a href="#pyagenity.graph.tool_node.ToolNode.__init__(langchain_adapter)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="typing.Any">Any</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional LangChain adapter for accessing LangChain tools
and integrations.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ImportError">ImportError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If MCP client is provided but required packages are not installed.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If any item in functions is not callable.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>When using MCP client functionality, ensure you have installed the required
dependencies with: <code>pip install pyagenity[mcp]</code></p>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/tool_node/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">functions</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">],</span>
    <span class="n">client</span><span class="p">:</span> <span class="n">deps</span><span class="o">.</span><span class="n">Client</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
    <span class="n">composio_adapter</span><span class="p">:</span> <span class="n">ComposioAdapter</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">langchain_adapter</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize ToolNode with functions and optional tool adapters.</span>

<span class="sd">    Args:</span>
<span class="sd">        functions: Iterable of callable functions to register as tools. Each function</span>
<span class="sd">            will be registered with its `__name__` as the tool identifier.</span>
<span class="sd">        client: Optional MCP (Model Context Protocol) client for remote tool access.</span>
<span class="sd">            Requires &#39;fastmcp&#39; and &#39;mcp&#39; packages to be installed.</span>
<span class="sd">        composio_adapter: Optional Composio adapter for external integrations and</span>
<span class="sd">            third-party API access.</span>
<span class="sd">        langchain_adapter: Optional LangChain adapter for accessing LangChain tools</span>
<span class="sd">            and integrations.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ImportError: If MCP client is provided but required packages are not installed.</span>
<span class="sd">        TypeError: If any item in functions is not callable.</span>

<span class="sd">    Note:</span>
<span class="sd">        When using MCP client functionality, ensure you have installed the required</span>
<span class="sd">        dependencies with: `pip install pyagenity[mcp]`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing ToolNode with </span><span class="si">%d</span><span class="s2"> functions&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">functions</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Read flags dynamically so tests can patch pyagenity.graph.tool_node.HAS_*</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pyagenity.graph.tool_node&quot;</span><span class="p">)</span>
        <span class="n">has_fastmcp</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s2">&quot;HAS_FASTMCP&quot;</span><span class="p">,</span> <span class="n">deps</span><span class="o">.</span><span class="n">HAS_FASTMCP</span><span class="p">)</span> <span class="k">if</span> <span class="n">mod</span> <span class="k">else</span> <span class="n">deps</span><span class="o">.</span><span class="n">HAS_FASTMCP</span>
        <span class="n">has_mcp</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s2">&quot;HAS_MCP&quot;</span><span class="p">,</span> <span class="n">deps</span><span class="o">.</span><span class="n">HAS_MCP</span><span class="p">)</span> <span class="k">if</span> <span class="n">mod</span> <span class="k">else</span> <span class="n">deps</span><span class="o">.</span><span class="n">HAS_MCP</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_fastmcp</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">has_mcp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">&quot;MCP client functionality requires &#39;fastmcp&#39; and &#39;mcp&#39; packages. &quot;</span>
                <span class="s2">&quot;Install with: pip install pyagenity[mcp]&quot;</span>
            <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;ToolNode initialized with MCP client&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span> <span class="n">deps</span><span class="o">.</span><span class="n">Client</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">client</span>  <span class="c1"># type: ignore</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_composio</span><span class="p">:</span> <span class="n">ComposioAdapter</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">composio_adapter</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_langchain</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">langchain_adapter</span>

    <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">functions</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;ToolNode only accepts callables&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">[</span><span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">mcp_tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">composio_tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">langchain_tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.tool_node.ToolNode.all_tools" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">all_tools</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.tool_node.ToolNode.all_tools" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">all_tools</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Get all available tools from all configured providers.</p>
<p>Retrieves and combines tool definitions from local functions, MCP client,
Composio adapter, and LangChain adapter. Each tool definition includes
the function schema with parameters and descriptions.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of tool definitions in OpenAI function calling format. Each dict</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>contains 'type': 'function' and 'function' with name, description,</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>and parameters schema.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">tool_node</span><span class="o">.</span><span class="n">all_tools</span><span class="p">()</span>
<span class="c1"># Returns:</span>
<span class="c1"># [</span>
<span class="c1">#   {</span>
<span class="c1">#     &quot;type&quot;: &quot;function&quot;,</span>
<span class="c1">#     &quot;function&quot;: {</span>
<span class="c1">#       &quot;name&quot;: &quot;weather_tool&quot;,</span>
<span class="c1">#       &quot;description&quot;: &quot;Get weather information for a location&quot;,</span>
<span class="c1">#       &quot;parameters&quot;: {</span>
<span class="c1">#         &quot;type&quot;: &quot;object&quot;,</span>
<span class="c1">#         &quot;properties&quot;: {</span>
<span class="c1">#           &quot;location&quot;: {&quot;type&quot;: &quot;string&quot;}</span>
<span class="c1">#         },</span>
<span class="c1">#         &quot;required&quot;: [&quot;location&quot;]</span>
<span class="c1">#       }</span>
<span class="c1">#     }</span>
<span class="c1">#   }</span>
<span class="c1"># ]</span>
</code></pre></div>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/tool_node/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">all_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get all available tools from all configured providers.</span>

<span class="sd">    Retrieves and combines tool definitions from local functions, MCP client,</span>
<span class="sd">    Composio adapter, and LangChain adapter. Each tool definition includes</span>
<span class="sd">    the function schema with parameters and descriptions.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of tool definitions in OpenAI function calling format. Each dict</span>
<span class="sd">        contains &#39;type&#39;: &#39;function&#39; and &#39;function&#39; with name, description,</span>
<span class="sd">        and parameters schema.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        tools = await tool_node.all_tools()</span>
<span class="sd">        # Returns:</span>
<span class="sd">        # [</span>
<span class="sd">        #   {</span>
<span class="sd">        #     &quot;type&quot;: &quot;function&quot;,</span>
<span class="sd">        #     &quot;function&quot;: {</span>
<span class="sd">        #       &quot;name&quot;: &quot;weather_tool&quot;,</span>
<span class="sd">        #       &quot;description&quot;: &quot;Get weather information for a location&quot;,</span>
<span class="sd">        #       &quot;parameters&quot;: {</span>
<span class="sd">        #         &quot;type&quot;: &quot;object&quot;,</span>
<span class="sd">        #         &quot;properties&quot;: {</span>
<span class="sd">        #           &quot;location&quot;: {&quot;type&quot;: &quot;string&quot;}</span>
<span class="sd">        #         },</span>
<span class="sd">        #         &quot;required&quot;: [&quot;location&quot;]</span>
<span class="sd">        #       }</span>
<span class="sd">        #     }</span>
<span class="sd">        #   }</span>
<span class="sd">        # ]</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_tools_async</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.tool_node.ToolNode.all_tools_sync" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">all_tools_sync</span>


<a href="#pyagenity.graph.tool_node.ToolNode.all_tools_sync" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">all_tools_sync</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Synchronously get all available tools from all configured providers.</p>
<p>This is a synchronous wrapper around the async all_tools() method.
It uses asyncio.run() to handle async operations from MCP, Composio,
and LangChain adapters.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of tool definitions in OpenAI function calling format.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>Prefer using the async <code>all_tools()</code> method when possible, especially
in async contexts, to avoid potential event loop issues.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/tool_node/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">all_tools_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Synchronously get all available tools from all configured providers.</span>

<span class="sd">    This is a synchronous wrapper around the async all_tools() method.</span>
<span class="sd">    It uses asyncio.run() to handle async operations from MCP, Composio,</span>
<span class="sd">    and LangChain adapters.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of tool definitions in OpenAI function calling format.</span>

<span class="sd">    Note:</span>
<span class="sd">        Prefer using the async `all_tools()` method when possible, especially</span>
<span class="sd">        in async contexts, to avoid potential event loop issues.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_local_tool</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_mcp_tool</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">comp</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_composio_tools</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">comp</span><span class="p">:</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
    <span class="n">lc</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_langchain_tools</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">lc</span><span class="p">:</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tools</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.tool_node.ToolNode.get_local_tool" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">get_local_tool</span>


<a href="#pyagenity.graph.tool_node.ToolNode.get_local_tool" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_local_tool</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Generate OpenAI-compatible tool definitions for all registered local functions.</p>
<p>Inspects all registered functions in _funcs and automatically generates
tool schemas by analyzing function signatures, type annotations, and docstrings.
Excludes injectable parameters that are provided by the framework.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of tool definitions in OpenAI function calling format. Each</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>definition includes the function name, description (from docstring),</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>and complete parameter schema with types and required fields.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>For a function:
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">operation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;add&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Perform arithmetic calculation.&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;add&quot;</span> <span class="k">else</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span>
</code></pre></div></p>
<p>Returns:
<div class="highlight"><pre><span></span><code><span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
        <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;calculate&quot;</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Perform arithmetic calculation.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;integer&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;integer&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;operation&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;add&quot;</span><span class="p">},</span>
                <span class="p">},</span>
                <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">],</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">}</span>
<span class="p">]</span>
</code></pre></div></p>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>Parameters listed in INJECTABLE_PARAMS (like 'state', 'config',
'tool_call_id') are automatically excluded from the generated schema
as they are provided by the framework during execution.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/tool_node/schema.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_local_tool</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate OpenAI-compatible tool definitions for all registered local functions.</span>

<span class="sd">    Inspects all registered functions in _funcs and automatically generates</span>
<span class="sd">    tool schemas by analyzing function signatures, type annotations, and docstrings.</span>
<span class="sd">    Excludes injectable parameters that are provided by the framework.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of tool definitions in OpenAI function calling format. Each</span>
<span class="sd">        definition includes the function name, description (from docstring),</span>
<span class="sd">        and complete parameter schema with types and required fields.</span>

<span class="sd">    Example:</span>
<span class="sd">        For a function:</span>
<span class="sd">        ```python</span>
<span class="sd">        def calculate(a: int, b: int, operation: str = &quot;add&quot;) -&gt; int:</span>
<span class="sd">            &#39;&#39;&#39;Perform arithmetic calculation.&#39;&#39;&#39;</span>
<span class="sd">            return a + b if operation == &quot;add&quot; else a - b</span>
<span class="sd">        ```</span>

<span class="sd">        Returns:</span>
<span class="sd">        ```python</span>
<span class="sd">        [</span>
<span class="sd">            {</span>
<span class="sd">                &quot;type&quot;: &quot;function&quot;,</span>
<span class="sd">                &quot;function&quot;: {</span>
<span class="sd">                    &quot;name&quot;: &quot;calculate&quot;,</span>
<span class="sd">                    &quot;description&quot;: &quot;Perform arithmetic calculation.&quot;,</span>
<span class="sd">                    &quot;parameters&quot;: {</span>
<span class="sd">                        &quot;type&quot;: &quot;object&quot;,</span>
<span class="sd">                        &quot;properties&quot;: {</span>
<span class="sd">                            &quot;a&quot;: {&quot;type&quot;: &quot;integer&quot;},</span>
<span class="sd">                            &quot;b&quot;: {&quot;type&quot;: &quot;integer&quot;},</span>
<span class="sd">                            &quot;operation&quot;: {&quot;type&quot;: &quot;string&quot;, &quot;default&quot;: &quot;add&quot;},</span>
<span class="sd">                        },</span>
<span class="sd">                        &quot;required&quot;: [&quot;a&quot;, &quot;b&quot;],</span>
<span class="sd">                    },</span>
<span class="sd">                },</span>
<span class="sd">            }</span>
<span class="sd">        ]</span>
<span class="sd">        ```</span>

<span class="sd">    Note:</span>
<span class="sd">        Parameters listed in INJECTABLE_PARAMS (like &#39;state&#39;, &#39;config&#39;,</span>
<span class="sd">        &#39;tool_call_id&#39;) are automatically excluded from the generated schema</span>
<span class="sd">        as they are provided by the framework during execution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">params_schema</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="k">for</span> <span class="n">p_name</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">VAR_POSITIONAL</span><span class="p">,</span>
                <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">VAR_KEYWORD</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="n">INJECTABLE_PARAMS</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">annotation</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">annotation</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">_empty</span> <span class="k">else</span> <span class="nb">str</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="n">SchemaMixin</span><span class="o">.</span><span class="n">_annotation_to_schema</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>
            <span class="n">params_schema</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="n">p_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">prop</span>

            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="n">inspect</span><span class="o">.</span><span class="n">_empty</span><span class="p">:</span>
                <span class="n">params_schema</span><span class="p">[</span><span class="s2">&quot;required&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">params_schema</span><span class="p">[</span><span class="s2">&quot;required&quot;</span><span class="p">]:</span>
            <span class="n">params_schema</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;required&quot;</span><span class="p">)</span>

        <span class="n">description</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;No description provided.&quot;</span>

        <span class="c1"># provider = getattr(fn, &quot;_py_tool_provider&quot;, None)</span>
        <span class="c1"># tags = getattr(fn, &quot;_py_tool_tags&quot;, None)</span>
        <span class="c1"># capabilities = getattr(fn, &quot;_py_tool_capabilities&quot;, None)</span>

        <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">params_schema</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="c1"># meta: dict[str, t.Any] = {}</span>
        <span class="c1"># if provider:</span>
        <span class="c1">#     meta[&quot;provider&quot;] = provider</span>
        <span class="c1"># if tags:</span>
        <span class="c1">#     meta[&quot;tags&quot;] = tags</span>
        <span class="c1"># if capabilities:</span>
        <span class="c1">#     meta[&quot;capabilities&quot;] = capabilities</span>
        <span class="c1"># if meta:</span>
        <span class="c1">#     entry[&quot;x-pyagenity&quot;] = meta</span>

        <span class="n">tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tools</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.tool_node.ToolNode.invoke" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">invoke</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.tool_node.ToolNode.invoke" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">invoke</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">tool_call_id</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">callback_manager</span><span class="o">=</span><span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">])</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Execute a specific tool by name with the provided arguments.</p>
<p>This method handles tool execution across all configured providers (local,
MCP, Composio, LangChain) with comprehensive error handling, event publishing,
and callback management.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.tool_node.ToolNode.invoke(name)" class="doc doc-heading doc-heading-parameter">                  <code>name</code>
<a href="#pyagenity.graph.tool_node.ToolNode.invoke(name)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the tool to execute.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.tool_node.ToolNode.invoke(args)" class="doc doc-heading doc-heading-parameter">                  <code>args</code>
<a href="#pyagenity.graph.tool_node.ToolNode.invoke(args)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of arguments to pass to the tool function.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.tool_node.ToolNode.invoke(tool_call_id)" class="doc doc-heading doc-heading-parameter">                  <code>tool_call_id</code>
<a href="#pyagenity.graph.tool_node.ToolNode.invoke(tool_call_id)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique identifier for this tool execution, used for
tracking and result correlation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.tool_node.ToolNode.invoke(config)" class="doc doc-heading doc-heading-parameter">                  <code>config</code>
<a href="#pyagenity.graph.tool_node.ToolNode.invoke(config)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration dictionary containing execution context and
user-specific settings.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.tool_node.ToolNode.invoke(state)" class="doc doc-heading doc-heading-parameter">                  <code>state</code>
<a href="#pyagenity.graph.tool_node.ToolNode.invoke(state)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            AgentState (pyagenity.state.AgentState)" href="../#pyagenity.state.AgentState">AgentState</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Current agent state for context-aware tool execution.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.tool_node.ToolNode.invoke(callback_manager)" class="doc doc-heading doc-heading-parameter">                  <code>callback_manager</code>
<a href="#pyagenity.graph.tool_node.ToolNode.invoke(callback_manager)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            CallbackManager (pyagenity.utils.CallbackManager)" href="../#pyagenity.utils.CallbackManager">CallbackManager</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Manager for executing pre/post execution callbacks.
Injected via dependency injection if not provided.</p>
              </div>
            </td>
            <td>
                  <code><span title="injectq.Inject">Inject</span>[<a class="autorefs autorefs-internal" title="            CallbackManager (pyagenity.utils.CallbackManager)" href="../#pyagenity.utils.CallbackManager">CallbackManager</a>]</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Message object containing tool execution results, either successful</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>output or error information with appropriate status indicators.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">tool_node</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weather_tool&quot;</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="s2">&quot;Paris&quot;</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;metric&quot;</span><span class="p">},</span>
    <span class="n">tool_call_id</span><span class="o">=</span><span class="s2">&quot;call_abc123&quot;</span><span class="p">,</span>
    <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;user1&quot;</span><span class="p">,</span> <span class="s2">&quot;session_id&quot;</span><span class="p">:</span> <span class="s2">&quot;session1&quot;</span><span class="p">},</span>
    <span class="n">state</span><span class="o">=</span><span class="n">current_agent_state</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># result is a Message with tool execution results</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>  <span class="c1"># Tool output or error information</span>
</code></pre></div>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>The method publishes execution events throughout the process for
monitoring and debugging purposes. Tool execution is routed based
on tool provider precedence: MCP → Composio → LangChain → Local.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/tool_node/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span>  <span class="c1"># noqa: PLR0915</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">tool_call_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
    <span class="n">callback_manager</span><span class="p">:</span> <span class="n">CallbackManager</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute a specific tool by name with the provided arguments.</span>

<span class="sd">    This method handles tool execution across all configured providers (local,</span>
<span class="sd">    MCP, Composio, LangChain) with comprehensive error handling, event publishing,</span>
<span class="sd">    and callback management.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: The name of the tool to execute.</span>
<span class="sd">        args: Dictionary of arguments to pass to the tool function.</span>
<span class="sd">        tool_call_id: Unique identifier for this tool execution, used for</span>
<span class="sd">            tracking and result correlation.</span>
<span class="sd">        config: Configuration dictionary containing execution context and</span>
<span class="sd">            user-specific settings.</span>
<span class="sd">        state: Current agent state for context-aware tool execution.</span>
<span class="sd">        callback_manager: Manager for executing pre/post execution callbacks.</span>
<span class="sd">            Injected via dependency injection if not provided.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Message object containing tool execution results, either successful</span>
<span class="sd">        output or error information with appropriate status indicators.</span>

<span class="sd">    Raises:</span>
<span class="sd">        The method handles all exceptions internally and returns error Messages</span>
<span class="sd">        rather than raising exceptions, ensuring robust execution flow.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        result = await tool_node.invoke(</span>
<span class="sd">            name=&quot;weather_tool&quot;,</span>
<span class="sd">            args={&quot;location&quot;: &quot;Paris&quot;, &quot;units&quot;: &quot;metric&quot;},</span>
<span class="sd">            tool_call_id=&quot;call_abc123&quot;,</span>
<span class="sd">            config={&quot;user_id&quot;: &quot;user1&quot;, &quot;session_id&quot;: &quot;session1&quot;},</span>
<span class="sd">            state=current_agent_state,</span>
<span class="sd">        )</span>

<span class="sd">        # result is a Message with tool execution results</span>
<span class="sd">        print(result.content)  # Tool output or error information</span>
<span class="sd">        ```</span>

<span class="sd">    Note:</span>
<span class="sd">        The method publishes execution events throughout the process for</span>
<span class="sd">        monitoring and debugging purposes. Tool execution is routed based</span>
<span class="sd">        on tool provider precedence: MCP → Composio → LangChain → Local.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Executing tool &#39;</span><span class="si">%s</span><span class="s2">&#39; with </span><span class="si">%d</span><span class="s2"> arguments&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Tool arguments: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="n">event</span> <span class="o">=</span> <span class="n">EventModel</span><span class="o">.</span><span class="n">default</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call_id</span><span class="p">,</span> <span class="s2">&quot;function_name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">},</span>
        <span class="n">content_type</span><span class="o">=</span><span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_CALL</span><span class="p">],</span>
        <span class="n">event</span><span class="o">=</span><span class="n">Event</span><span class="o">.</span><span class="n">TOOL_EXECUTION</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">node_name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="c1"># Attach structured tool call block</span>
    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">ToolCallBlock</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)]</span>
    <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcp_tools</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_mcp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mcp_execute</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="n">tool_call_id</span><span class="p">,</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">callback_manager</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="c1"># Attach tool result block mirroring the tool output</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
            <span class="p">]</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">composio_tools</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_composio&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_composio_execute</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="n">tool_call_id</span><span class="p">,</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">callback_manager</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
            <span class="p">]</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">langchain_tools</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_langchain&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_langchain_execute</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="n">tool_call_id</span><span class="p">,</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">callback_manager</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
            <span class="p">]</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_mcp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_execute</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="n">tool_call_id</span><span class="p">,</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">state</span><span class="p">,</span>
            <span class="n">callback_manager</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
            <span class="p">]</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Tool &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span>
    <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_msg</span>
    <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">ERROR</span>
    <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">ERROR</span><span class="p">]</span>
    <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Message</span><span class="o">.</span><span class="n">tool_message</span><span class="p">(</span>
        <span class="n">content</span><span class="o">=</span><span class="p">[</span>
            <span class="n">ErrorBlock</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">error_msg</span><span class="p">),</span>
            <span class="n">ToolResultBlock</span><span class="p">(</span>
                <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="n">error_msg</span><span class="p">,</span>
                <span class="n">is_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">],</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.tool_node.ToolNode.stream" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">stream</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.tool_node.ToolNode.stream" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">stream</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">tool_call_id</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">callback_manager</span><span class="o">=</span><span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">])</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Execute a tool with streaming support, yielding incremental results.</p>
<p>Similar to invoke() but designed for tools that can provide streaming responses
or when you want to process results as they become available. Currently,
most tool providers return complete results, so this method typically yields
a single Message with the full result.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.tool_node.ToolNode.stream(name)" class="doc doc-heading doc-heading-parameter">                  <code>name</code>
<a href="#pyagenity.graph.tool_node.ToolNode.stream(name)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the tool to execute.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.tool_node.ToolNode.stream(args)" class="doc doc-heading doc-heading-parameter">                  <code>args</code>
<a href="#pyagenity.graph.tool_node.ToolNode.stream(args)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of arguments to pass to the tool function.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.tool_node.ToolNode.stream(tool_call_id)" class="doc doc-heading doc-heading-parameter">                  <code>tool_call_id</code>
<a href="#pyagenity.graph.tool_node.ToolNode.stream(tool_call_id)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique identifier for this tool execution.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.tool_node.ToolNode.stream(config)" class="doc doc-heading doc-heading-parameter">                  <code>config</code>
<a href="#pyagenity.graph.tool_node.ToolNode.stream(config)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration dictionary containing execution context.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.tool_node.ToolNode.stream(state)" class="doc doc-heading doc-heading-parameter">                  <code>state</code>
<a href="#pyagenity.graph.tool_node.ToolNode.stream(state)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            AgentState (pyagenity.state.AgentState)" href="../#pyagenity.state.AgentState">AgentState</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Current agent state for context-aware tool execution.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.tool_node.ToolNode.stream(callback_manager)" class="doc doc-heading doc-heading-parameter">                  <code>callback_manager</code>
<a href="#pyagenity.graph.tool_node.ToolNode.stream(callback_manager)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            CallbackManager (pyagenity.utils.CallbackManager)" href="../#pyagenity.utils.CallbackManager">CallbackManager</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Manager for executing pre/post execution callbacks.</p>
              </div>
            </td>
            <td>
                  <code><span title="injectq.Inject">Inject</span>[<a class="autorefs autorefs-internal" title="            CallbackManager (pyagenity.utils.CallbackManager)" href="../#pyagenity.utils.CallbackManager">CallbackManager</a>]</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Yields:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.AsyncIterator">AsyncIterator</span>[<a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.message.Message)" href="../#pyagenity.utils.message.Message">Message</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Message objects containing tool execution results or status updates.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.AsyncIterator">AsyncIterator</span>[<a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.message.Message)" href="../#pyagenity.utils.message.Message">Message</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>For most tools, this will yield a single complete result Message.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">tool_node</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;data_processor&quot;</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;dataset&quot;</span><span class="p">:</span> <span class="s2">&quot;large_data.csv&quot;</span><span class="p">},</span>
    <span class="n">tool_call_id</span><span class="o">=</span><span class="s2">&quot;call_stream123&quot;</span><span class="p">,</span>
    <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;user1&quot;</span><span class="p">},</span>
    <span class="n">state</span><span class="o">=</span><span class="n">current_state</span><span class="p">,</span>
<span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received: </span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Process each streamed result</span>
</code></pre></div>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>The streaming interface is designed for future expansion where tools
may provide true streaming responses. Currently, it provides a
consistent async iterator interface over tool results.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/tool_node/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream</span><span class="p">(</span>  <span class="c1"># noqa: PLR0915</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">tool_call_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
    <span class="n">callback_manager</span><span class="p">:</span> <span class="n">CallbackManager</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">AsyncIterator</span><span class="p">[</span><span class="n">Message</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute a tool with streaming support, yielding incremental results.</span>

<span class="sd">    Similar to invoke() but designed for tools that can provide streaming responses</span>
<span class="sd">    or when you want to process results as they become available. Currently,</span>
<span class="sd">    most tool providers return complete results, so this method typically yields</span>
<span class="sd">    a single Message with the full result.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: The name of the tool to execute.</span>
<span class="sd">        args: Dictionary of arguments to pass to the tool function.</span>
<span class="sd">        tool_call_id: Unique identifier for this tool execution.</span>
<span class="sd">        config: Configuration dictionary containing execution context.</span>
<span class="sd">        state: Current agent state for context-aware tool execution.</span>
<span class="sd">        callback_manager: Manager for executing pre/post execution callbacks.</span>

<span class="sd">    Yields:</span>
<span class="sd">        Message objects containing tool execution results or status updates.</span>
<span class="sd">        For most tools, this will yield a single complete result Message.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        async for message in tool_node.stream(</span>
<span class="sd">            name=&quot;data_processor&quot;,</span>
<span class="sd">            args={&quot;dataset&quot;: &quot;large_data.csv&quot;},</span>
<span class="sd">            tool_call_id=&quot;call_stream123&quot;,</span>
<span class="sd">            config={&quot;user_id&quot;: &quot;user1&quot;},</span>
<span class="sd">            state=current_state,</span>
<span class="sd">        ):</span>
<span class="sd">            print(f&quot;Received: {message.content}&quot;)</span>
<span class="sd">            # Process each streamed result</span>
<span class="sd">        ```</span>

<span class="sd">    Note:</span>
<span class="sd">        The streaming interface is designed for future expansion where tools</span>
<span class="sd">        may provide true streaming responses. Currently, it provides a</span>
<span class="sd">        consistent async iterator interface over tool results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Executing tool &#39;</span><span class="si">%s</span><span class="s2">&#39; with </span><span class="si">%d</span><span class="s2"> arguments&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Tool arguments: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">EventModel</span><span class="o">.</span><span class="n">default</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call_id</span><span class="p">,</span> <span class="s2">&quot;function_name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">},</span>
        <span class="n">content_type</span><span class="o">=</span><span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_CALL</span><span class="p">],</span>
        <span class="n">event</span><span class="o">=</span><span class="n">Event</span><span class="o">.</span><span class="n">TOOL_EXECUTION</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">node_name</span> <span class="o">=</span> <span class="s2">&quot;ToolNode&quot;</span>
    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">ToolCallBlock</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcp_tools</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;function_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mcp&quot;</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mcp_execute</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="n">tool_call_id</span><span class="p">,</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">callback_manager</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
            <span class="p">]</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">message</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">composio_tools</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;function_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;composio&quot;</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_composio_execute</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="n">tool_call_id</span><span class="p">,</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">callback_manager</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
            <span class="p">]</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">message</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">langchain_tools</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;function_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;langchain&quot;</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_langchain_execute</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="n">tool_call_id</span><span class="p">,</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">callback_manager</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
            <span class="p">]</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">message</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;function_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;internal&quot;</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_execute</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="n">tool_call_id</span><span class="p">,</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">state</span><span class="p">,</span>
            <span class="n">callback_manager</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
            <span class="p">]</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">result</span>
        <span class="k">return</span>

    <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Tool &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span>
    <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_msg</span>
    <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">ERROR</span>
    <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">ERROR</span><span class="p">]</span>
    <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

    <span class="k">yield</span> <span class="n">Message</span><span class="o">.</span><span class="n">tool_message</span><span class="p">(</span>
        <span class="n">content</span><span class="o">=</span><span class="p">[</span>
            <span class="n">ErrorBlock</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">error_msg</span><span class="p">),</span>
            <span class="n">ToolResultBlock</span><span class="p">(</span>
                <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="n">error_msg</span><span class="p">,</span>
                <span class="n">is_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">],</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<h4 id="pyagenity.graph.tool_node-modules">Modules<a href="#pyagenity.graph.tool_node-modules" class="headerlink" title="Permanent link">&para;</a></h4>

<div class="doc doc-object doc-module">



<h5 id="pyagenity.graph.tool_node.base" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">base</span>


<a href="#pyagenity.graph.tool_node.base" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

        <p>Tool execution node for PyAgenity graph workflows.</p>
<p>This module provides the ToolNode class, which serves as a unified registry and executor
for callable functions from various sources including local functions, MCP (Model Context Protocol)
tools, Composio adapters, and LangChain tools. The ToolNode is designed with a modular
architecture using mixins to handle different tool providers.</p>
<p>The ToolNode maintains compatibility with PyAgenity's dependency injection system and
publishes execution events for monitoring and debugging purposes.</p>


<details class="typical-usage-example" open>
  <summary>Typical usage example</summary>
  <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">my_tool</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Result for: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="n">tools</span> <span class="o">=</span> <span class="n">ToolNode</span><span class="p">([</span><span class="n">my_tool</span><span class="p">])</span>
<span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">tools</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="s2">&quot;my_tool&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span><span class="p">},</span> <span class="s2">&quot;call_id&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</code></pre></div>
</details>









<p><span class="doc-section-title">Classes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            ToolNode (pyagenity.graph.tool_node.base.ToolNode)" href="../#pyagenity.graph.tool_node.base.ToolNode">ToolNode</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>A unified registry and executor for callable functions from various tool providers.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>






<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            logger


  
      module-attribute
   (pyagenity.graph.tool_node.base.logger)" href="../#pyagenity.graph.tool_node.base.logger">logger</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>



  <div class="doc doc-children">





<h6 id="pyagenity.graph.tool_node.base-attributes">Attributes<a href="#pyagenity.graph.tool_node.base-attributes" class="headerlink" title="Permanent link">&para;</a></h6>

<div class="doc doc-object doc-attribute">



<h7 id="pyagenity.graph.tool_node.base.logger" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">logger</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#pyagenity.graph.tool_node.base.logger" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<h6 id="pyagenity.graph.tool_node.base-classes">Classes<a href="#pyagenity.graph.tool_node.base-classes" class="headerlink" title="Permanent link">&para;</a></h6>

<div class="doc doc-object doc-class">



<h7 id="pyagenity.graph.tool_node.base.ToolNode" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">ToolNode</span>


<a href="#pyagenity.graph.tool_node.base.ToolNode" class="headerlink" title="Permanent link">&para;</a></h7>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            SchemaMixin (pyagenity.graph.tool_node.schema.SchemaMixin)" href="../#pyagenity.graph.tool_node.schema.SchemaMixin">SchemaMixin</a></code>, <code><a class="autorefs autorefs-internal" title="            LocalExecMixin (pyagenity.graph.tool_node.executors.LocalExecMixin)" href="../#pyagenity.graph.tool_node.executors.LocalExecMixin">LocalExecMixin</a></code>, <code><a class="autorefs autorefs-internal" title="            MCPMixin (pyagenity.graph.tool_node.executors.MCPMixin)" href="../#pyagenity.graph.tool_node.executors.MCPMixin">MCPMixin</a></code>, <code><a class="autorefs autorefs-internal" title="            ComposioMixin (pyagenity.graph.tool_node.executors.ComposioMixin)" href="../#pyagenity.graph.tool_node.executors.ComposioMixin">ComposioMixin</a></code>, <code><a class="autorefs autorefs-internal" title="            LangChainMixin (pyagenity.graph.tool_node.executors.LangChainMixin)" href="../#pyagenity.graph.tool_node.executors.LangChainMixin">LangChainMixin</a></code>, <code><a class="autorefs autorefs-internal" title="            KwargsResolverMixin (pyagenity.graph.tool_node.executors.KwargsResolverMixin)" href="../#pyagenity.graph.tool_node.executors.KwargsResolverMixin">KwargsResolverMixin</a></code></p>


        <p>A unified registry and executor for callable functions from various tool providers.</p>
<p>ToolNode serves as the central hub for managing and executing tools from multiple sources:
- Local Python functions
- MCP (Model Context Protocol) tools
- Composio adapter tools
- LangChain tools</p>
<p>The class uses a mixin-based architecture to separate concerns and maintain clean
integration with different tool providers. It provides both synchronous and asynchronous
execution methods with comprehensive event publishing and error handling.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.tool_node.base.ToolNode._funcs">_funcs</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Callable">Callable</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping function names to callable functions.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.tool_node.base.ToolNode._client">_client</span></code></td>
            <td>
                  <code><span title="pyagenity.graph.tool_node.deps.Client">Client</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional MCP client for remote tool execution.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.tool_node.base.ToolNode._composio">_composio</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            ComposioAdapter (pyagenity.adapters.tools.ComposioAdapter)" href="../#pyagenity.adapters.tools.ComposioAdapter">ComposioAdapter</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional Composio adapter for external integrations.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.tool_node.base.ToolNode._langchain">_langchain</span></code></td>
            <td>
                  <code><span title="typing.Any">Any</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional LangChain adapter for LangChain tools.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            mcp_tools


  
      instance-attribute
   (pyagenity.graph.tool_node.base.ToolNode.mcp_tools)" href="../#pyagenity.graph.tool_node.base.ToolNode.mcp_tools">mcp_tools</a></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of available MCP tool names.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            composio_tools


  
      instance-attribute
   (pyagenity.graph.tool_node.base.ToolNode.composio_tools)" href="../#pyagenity.graph.tool_node.base.ToolNode.composio_tools">composio_tools</a></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of available Composio tool names.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            langchain_tools


  
      instance-attribute
   (pyagenity.graph.tool_node.base.ToolNode.langchain_tools)" href="../#pyagenity.graph.tool_node.base.ToolNode.langchain_tools">langchain_tools</a></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of available LangChain tool names.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="c1"># Define local tools</span>
<span class="k">def</span><span class="w"> </span><span class="nf">weather_tool</span><span class="p">(</span><span class="n">location</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Weather in </span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s2">: Sunny, 25°C&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">calculator</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>


<span class="c1"># Create ToolNode with local functions</span>
<span class="n">tools</span> <span class="o">=</span> <span class="n">ToolNode</span><span class="p">([</span><span class="n">weather_tool</span><span class="p">,</span> <span class="n">calculator</span><span class="p">])</span>

<span class="c1"># Execute a tool</span>
<span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">tools</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weather_tool&quot;</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="s2">&quot;New York&quot;</span><span class="p">},</span>
    <span class="n">tool_call_id</span><span class="o">=</span><span class="s2">&quot;call_123&quot;</span><span class="p">,</span>
    <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;user1&quot;</span><span class="p">},</span>
    <span class="n">state</span><span class="o">=</span><span class="n">agent_state</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>
</details>











<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            __init__ (pyagenity.graph.tool_node.base.ToolNode.__init__)" href="../#pyagenity.graph.tool_node.base.ToolNode.__init__">__init__</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Initialize ToolNode with functions and optional tool adapters.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            all_tools


  
      async
   (pyagenity.graph.tool_node.base.ToolNode.all_tools)" href="../#pyagenity.graph.tool_node.base.ToolNode.all_tools">all_tools</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Get all available tools from all configured providers.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            all_tools_sync (pyagenity.graph.tool_node.base.ToolNode.all_tools_sync)" href="../#pyagenity.graph.tool_node.base.ToolNode.all_tools_sync">all_tools_sync</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Synchronously get all available tools from all configured providers.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            get_local_tool (pyagenity.graph.tool_node.base.ToolNode.get_local_tool)" href="../#pyagenity.graph.tool_node.base.ToolNode.get_local_tool">get_local_tool</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Generate OpenAI-compatible tool definitions for all registered local functions.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            invoke


  
      async
   (pyagenity.graph.tool_node.base.ToolNode.invoke)" href="../#pyagenity.graph.tool_node.base.ToolNode.invoke">invoke</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Execute a specific tool by name with the provided arguments.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            stream


  
      async
   (pyagenity.graph.tool_node.base.ToolNode.stream)" href="../#pyagenity.graph.tool_node.base.ToolNode.stream">stream</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Execute a tool with streaming support, yielding incremental results.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>



              <details class="quote">
                <summary>Source code in <code>pyagenity/graph/tool_node/base.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ToolNode</span><span class="p">(</span>
    <span class="n">SchemaMixin</span><span class="p">,</span>
    <span class="n">LocalExecMixin</span><span class="p">,</span>
    <span class="n">MCPMixin</span><span class="p">,</span>
    <span class="n">ComposioMixin</span><span class="p">,</span>
    <span class="n">LangChainMixin</span><span class="p">,</span>
    <span class="n">KwargsResolverMixin</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A unified registry and executor for callable functions from various tool providers.</span>

<span class="sd">    ToolNode serves as the central hub for managing and executing tools from multiple sources:</span>
<span class="sd">    - Local Python functions</span>
<span class="sd">    - MCP (Model Context Protocol) tools</span>
<span class="sd">    - Composio adapter tools</span>
<span class="sd">    - LangChain tools</span>

<span class="sd">    The class uses a mixin-based architecture to separate concerns and maintain clean</span>
<span class="sd">    integration with different tool providers. It provides both synchronous and asynchronous</span>
<span class="sd">    execution methods with comprehensive event publishing and error handling.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        _funcs: Dictionary mapping function names to callable functions.</span>
<span class="sd">        _client: Optional MCP client for remote tool execution.</span>
<span class="sd">        _composio: Optional Composio adapter for external integrations.</span>
<span class="sd">        _langchain: Optional LangChain adapter for LangChain tools.</span>
<span class="sd">        mcp_tools: List of available MCP tool names.</span>
<span class="sd">        composio_tools: List of available Composio tool names.</span>
<span class="sd">        langchain_tools: List of available LangChain tool names.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        # Define local tools</span>
<span class="sd">        def weather_tool(location: str) -&gt; str:</span>
<span class="sd">            return f&quot;Weather in {location}: Sunny, 25°C&quot;</span>


<span class="sd">        def calculator(a: int, b: int) -&gt; int:</span>
<span class="sd">            return a + b</span>


<span class="sd">        # Create ToolNode with local functions</span>
<span class="sd">        tools = ToolNode([weather_tool, calculator])</span>

<span class="sd">        # Execute a tool</span>
<span class="sd">        result = await tools.invoke(</span>
<span class="sd">            name=&quot;weather_tool&quot;,</span>
<span class="sd">            args={&quot;location&quot;: &quot;New York&quot;},</span>
<span class="sd">            tool_call_id=&quot;call_123&quot;,</span>
<span class="sd">            config={&quot;user_id&quot;: &quot;user1&quot;},</span>
<span class="sd">            state=agent_state,</span>
<span class="sd">        )</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">functions</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">],</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">deps</span><span class="o">.</span><span class="n">Client</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
        <span class="n">composio_adapter</span><span class="p">:</span> <span class="n">ComposioAdapter</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">langchain_adapter</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize ToolNode with functions and optional tool adapters.</span>

<span class="sd">        Args:</span>
<span class="sd">            functions: Iterable of callable functions to register as tools. Each function</span>
<span class="sd">                will be registered with its `__name__` as the tool identifier.</span>
<span class="sd">            client: Optional MCP (Model Context Protocol) client for remote tool access.</span>
<span class="sd">                Requires &#39;fastmcp&#39; and &#39;mcp&#39; packages to be installed.</span>
<span class="sd">            composio_adapter: Optional Composio adapter for external integrations and</span>
<span class="sd">                third-party API access.</span>
<span class="sd">            langchain_adapter: Optional LangChain adapter for accessing LangChain tools</span>
<span class="sd">                and integrations.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ImportError: If MCP client is provided but required packages are not installed.</span>
<span class="sd">            TypeError: If any item in functions is not callable.</span>

<span class="sd">        Note:</span>
<span class="sd">            When using MCP client functionality, ensure you have installed the required</span>
<span class="sd">            dependencies with: `pip install pyagenity[mcp]`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing ToolNode with </span><span class="si">%d</span><span class="s2"> functions&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">functions</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Read flags dynamically so tests can patch pyagenity.graph.tool_node.HAS_*</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pyagenity.graph.tool_node&quot;</span><span class="p">)</span>
            <span class="n">has_fastmcp</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s2">&quot;HAS_FASTMCP&quot;</span><span class="p">,</span> <span class="n">deps</span><span class="o">.</span><span class="n">HAS_FASTMCP</span><span class="p">)</span> <span class="k">if</span> <span class="n">mod</span> <span class="k">else</span> <span class="n">deps</span><span class="o">.</span><span class="n">HAS_FASTMCP</span>
            <span class="n">has_mcp</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s2">&quot;HAS_MCP&quot;</span><span class="p">,</span> <span class="n">deps</span><span class="o">.</span><span class="n">HAS_MCP</span><span class="p">)</span> <span class="k">if</span> <span class="n">mod</span> <span class="k">else</span> <span class="n">deps</span><span class="o">.</span><span class="n">HAS_MCP</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_fastmcp</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">has_mcp</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                    <span class="s2">&quot;MCP client functionality requires &#39;fastmcp&#39; and &#39;mcp&#39; packages. &quot;</span>
                    <span class="s2">&quot;Install with: pip install pyagenity[mcp]&quot;</span>
                <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;ToolNode initialized with MCP client&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span> <span class="n">deps</span><span class="o">.</span><span class="n">Client</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">client</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_composio</span><span class="p">:</span> <span class="n">ComposioAdapter</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">composio_adapter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_langchain</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">langchain_adapter</span>

        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">functions</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;ToolNode only accepts callables&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">[</span><span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mcp_tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composio_tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">langchain_tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_all_tools_async</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
        <span class="n">tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_local_tool</span><span class="p">()</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mcp_tool</span><span class="p">())</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_composio_tools</span><span class="p">())</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_langchain_tools</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">all_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all available tools from all configured providers.</span>

<span class="sd">        Retrieves and combines tool definitions from local functions, MCP client,</span>
<span class="sd">        Composio adapter, and LangChain adapter. Each tool definition includes</span>
<span class="sd">        the function schema with parameters and descriptions.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of tool definitions in OpenAI function calling format. Each dict</span>
<span class="sd">            contains &#39;type&#39;: &#39;function&#39; and &#39;function&#39; with name, description,</span>
<span class="sd">            and parameters schema.</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            tools = await tool_node.all_tools()</span>
<span class="sd">            # Returns:</span>
<span class="sd">            # [</span>
<span class="sd">            #   {</span>
<span class="sd">            #     &quot;type&quot;: &quot;function&quot;,</span>
<span class="sd">            #     &quot;function&quot;: {</span>
<span class="sd">            #       &quot;name&quot;: &quot;weather_tool&quot;,</span>
<span class="sd">            #       &quot;description&quot;: &quot;Get weather information for a location&quot;,</span>
<span class="sd">            #       &quot;parameters&quot;: {</span>
<span class="sd">            #         &quot;type&quot;: &quot;object&quot;,</span>
<span class="sd">            #         &quot;properties&quot;: {</span>
<span class="sd">            #           &quot;location&quot;: {&quot;type&quot;: &quot;string&quot;}</span>
<span class="sd">            #         },</span>
<span class="sd">            #         &quot;required&quot;: [&quot;location&quot;]</span>
<span class="sd">            #       }</span>
<span class="sd">            #     }</span>
<span class="sd">            #   }</span>
<span class="sd">            # ]</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_tools_async</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">all_tools_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Synchronously get all available tools from all configured providers.</span>

<span class="sd">        This is a synchronous wrapper around the async all_tools() method.</span>
<span class="sd">        It uses asyncio.run() to handle async operations from MCP, Composio,</span>
<span class="sd">        and LangChain adapters.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of tool definitions in OpenAI function calling format.</span>

<span class="sd">        Note:</span>
<span class="sd">            Prefer using the async `all_tools()` method when possible, especially</span>
<span class="sd">            in async contexts, to avoid potential event loop issues.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_local_tool</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_mcp_tool</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_composio_tools</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">comp</span><span class="p">:</span>
            <span class="n">tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
        <span class="n">lc</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_langchain_tools</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">lc</span><span class="p">:</span>
            <span class="n">tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span>  <span class="c1"># noqa: PLR0915</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">tool_call_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
        <span class="n">callback_manager</span><span class="p">:</span> <span class="n">CallbackManager</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a specific tool by name with the provided arguments.</span>

<span class="sd">        This method handles tool execution across all configured providers (local,</span>
<span class="sd">        MCP, Composio, LangChain) with comprehensive error handling, event publishing,</span>
<span class="sd">        and callback management.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name of the tool to execute.</span>
<span class="sd">            args: Dictionary of arguments to pass to the tool function.</span>
<span class="sd">            tool_call_id: Unique identifier for this tool execution, used for</span>
<span class="sd">                tracking and result correlation.</span>
<span class="sd">            config: Configuration dictionary containing execution context and</span>
<span class="sd">                user-specific settings.</span>
<span class="sd">            state: Current agent state for context-aware tool execution.</span>
<span class="sd">            callback_manager: Manager for executing pre/post execution callbacks.</span>
<span class="sd">                Injected via dependency injection if not provided.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Message object containing tool execution results, either successful</span>
<span class="sd">            output or error information with appropriate status indicators.</span>

<span class="sd">        Raises:</span>
<span class="sd">            The method handles all exceptions internally and returns error Messages</span>
<span class="sd">            rather than raising exceptions, ensuring robust execution flow.</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            result = await tool_node.invoke(</span>
<span class="sd">                name=&quot;weather_tool&quot;,</span>
<span class="sd">                args={&quot;location&quot;: &quot;Paris&quot;, &quot;units&quot;: &quot;metric&quot;},</span>
<span class="sd">                tool_call_id=&quot;call_abc123&quot;,</span>
<span class="sd">                config={&quot;user_id&quot;: &quot;user1&quot;, &quot;session_id&quot;: &quot;session1&quot;},</span>
<span class="sd">                state=current_agent_state,</span>
<span class="sd">            )</span>

<span class="sd">            # result is a Message with tool execution results</span>
<span class="sd">            print(result.content)  # Tool output or error information</span>
<span class="sd">            ```</span>

<span class="sd">        Note:</span>
<span class="sd">            The method publishes execution events throughout the process for</span>
<span class="sd">            monitoring and debugging purposes. Tool execution is routed based</span>
<span class="sd">            on tool provider precedence: MCP → Composio → LangChain → Local.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Executing tool &#39;</span><span class="si">%s</span><span class="s2">&#39; with </span><span class="si">%d</span><span class="s2"> arguments&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Tool arguments: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

        <span class="n">event</span> <span class="o">=</span> <span class="n">EventModel</span><span class="o">.</span><span class="n">default</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call_id</span><span class="p">,</span> <span class="s2">&quot;function_name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">},</span>
            <span class="n">content_type</span><span class="o">=</span><span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_CALL</span><span class="p">],</span>
            <span class="n">event</span><span class="o">=</span><span class="n">Event</span><span class="o">.</span><span class="n">TOOL_EXECUTION</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">node_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="c1"># Attach structured tool call block</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">ToolCallBlock</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcp_tools</span><span class="p">:</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_mcp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mcp_execute</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">args</span><span class="p">,</span>
                <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="n">config</span><span class="p">,</span>
                <span class="n">callback_manager</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="c1"># Attach tool result block mirroring the tool output</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
                <span class="p">]</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">composio_tools</span><span class="p">:</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_composio&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_composio_execute</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">args</span><span class="p">,</span>
                <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="n">config</span><span class="p">,</span>
                <span class="n">callback_manager</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
                <span class="p">]</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">langchain_tools</span><span class="p">:</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_langchain&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_langchain_execute</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">args</span><span class="p">,</span>
                <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="n">config</span><span class="p">,</span>
                <span class="n">callback_manager</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
                <span class="p">]</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">:</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_mcp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_execute</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">args</span><span class="p">,</span>
                <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="n">config</span><span class="p">,</span>
                <span class="n">state</span><span class="p">,</span>
                <span class="n">callback_manager</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
                <span class="p">]</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Tool &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_msg</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">ERROR</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">ERROR</span><span class="p">]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Message</span><span class="o">.</span><span class="n">tool_message</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="p">[</span>
                <span class="n">ErrorBlock</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">error_msg</span><span class="p">),</span>
                <span class="n">ToolResultBlock</span><span class="p">(</span>
                    <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                    <span class="n">output</span><span class="o">=</span><span class="n">error_msg</span><span class="p">,</span>
                    <span class="n">is_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">status</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">],</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream</span><span class="p">(</span>  <span class="c1"># noqa: PLR0915</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">tool_call_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
        <span class="n">callback_manager</span><span class="p">:</span> <span class="n">CallbackManager</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">AsyncIterator</span><span class="p">[</span><span class="n">Message</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a tool with streaming support, yielding incremental results.</span>

<span class="sd">        Similar to invoke() but designed for tools that can provide streaming responses</span>
<span class="sd">        or when you want to process results as they become available. Currently,</span>
<span class="sd">        most tool providers return complete results, so this method typically yields</span>
<span class="sd">        a single Message with the full result.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name of the tool to execute.</span>
<span class="sd">            args: Dictionary of arguments to pass to the tool function.</span>
<span class="sd">            tool_call_id: Unique identifier for this tool execution.</span>
<span class="sd">            config: Configuration dictionary containing execution context.</span>
<span class="sd">            state: Current agent state for context-aware tool execution.</span>
<span class="sd">            callback_manager: Manager for executing pre/post execution callbacks.</span>

<span class="sd">        Yields:</span>
<span class="sd">            Message objects containing tool execution results or status updates.</span>
<span class="sd">            For most tools, this will yield a single complete result Message.</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            async for message in tool_node.stream(</span>
<span class="sd">                name=&quot;data_processor&quot;,</span>
<span class="sd">                args={&quot;dataset&quot;: &quot;large_data.csv&quot;},</span>
<span class="sd">                tool_call_id=&quot;call_stream123&quot;,</span>
<span class="sd">                config={&quot;user_id&quot;: &quot;user1&quot;},</span>
<span class="sd">                state=current_state,</span>
<span class="sd">            ):</span>
<span class="sd">                print(f&quot;Received: {message.content}&quot;)</span>
<span class="sd">                # Process each streamed result</span>
<span class="sd">            ```</span>

<span class="sd">        Note:</span>
<span class="sd">            The streaming interface is designed for future expansion where tools</span>
<span class="sd">            may provide true streaming responses. Currently, it provides a</span>
<span class="sd">            consistent async iterator interface over tool results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Executing tool &#39;</span><span class="si">%s</span><span class="s2">&#39; with </span><span class="si">%d</span><span class="s2"> arguments&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Tool arguments: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">EventModel</span><span class="o">.</span><span class="n">default</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call_id</span><span class="p">,</span> <span class="s2">&quot;function_name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">},</span>
            <span class="n">content_type</span><span class="o">=</span><span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_CALL</span><span class="p">],</span>
            <span class="n">event</span><span class="o">=</span><span class="n">Event</span><span class="o">.</span><span class="n">TOOL_EXECUTION</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">node_name</span> <span class="o">=</span> <span class="s2">&quot;ToolNode&quot;</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">ToolCallBlock</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcp_tools</span><span class="p">:</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;function_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mcp&quot;</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mcp_execute</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">args</span><span class="p">,</span>
                <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="n">config</span><span class="p">,</span>
                <span class="n">callback_manager</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
                <span class="p">]</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">message</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">composio_tools</span><span class="p">:</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;function_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;composio&quot;</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_composio_execute</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">args</span><span class="p">,</span>
                <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="n">config</span><span class="p">,</span>
                <span class="n">callback_manager</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
                <span class="p">]</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">message</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">langchain_tools</span><span class="p">:</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;function_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;langchain&quot;</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_langchain_execute</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">args</span><span class="p">,</span>
                <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="n">config</span><span class="p">,</span>
                <span class="n">callback_manager</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
                <span class="p">]</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">message</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">:</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;function_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;internal&quot;</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_execute</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">args</span><span class="p">,</span>
                <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="n">config</span><span class="p">,</span>
                <span class="n">state</span><span class="p">,</span>
                <span class="n">callback_manager</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
                <span class="p">]</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">result</span>
            <span class="k">return</span>

        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Tool &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_msg</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">ERROR</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">ERROR</span><span class="p">]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="k">yield</span> <span class="n">Message</span><span class="o">.</span><span class="n">tool_message</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="p">[</span>
                <span class="n">ErrorBlock</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">error_msg</span><span class="p">),</span>
                <span class="n">ToolResultBlock</span><span class="p">(</span>
                    <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                    <span class="n">output</span><span class="o">=</span><span class="n">error_msg</span><span class="p">,</span>
                    <span class="n">is_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">status</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">],</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">





<h8 id="pyagenity.graph.tool_node.base.ToolNode-attributes">Attributes<a href="#pyagenity.graph.tool_node.base.ToolNode-attributes" class="headerlink" title="Permanent link">&para;</a></h8>

<div class="doc doc-object doc-attribute">



<h9 id="pyagenity.graph.tool_node.base.ToolNode.composio_tools" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">composio_tools</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.tool_node.base.ToolNode.composio_tools" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">composio_tools</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h9 id="pyagenity.graph.tool_node.base.ToolNode.langchain_tools" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">langchain_tools</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.tool_node.base.ToolNode.langchain_tools" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">langchain_tools</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h9 id="pyagenity.graph.tool_node.base.ToolNode.mcp_tools" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">mcp_tools</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.tool_node.base.ToolNode.mcp_tools" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">mcp_tools</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>


<h8 id="pyagenity.graph.tool_node.base.ToolNode-functions">Functions<a href="#pyagenity.graph.tool_node.base.ToolNode-functions" class="headerlink" title="Permanent link">&para;</a></h8>

<div class="doc doc-object doc-function">


<h9 id="pyagenity.graph.tool_node.base.ToolNode.__init__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">__init__</span>


<a href="#pyagenity.graph.tool_node.base.ToolNode.__init__" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">__init__</span><span class="p">(</span><span class="n">functions</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">composio_adapter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">langchain_adapter</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Initialize ToolNode with functions and optional tool adapters.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h10 id="pyagenity.graph.tool_node.base.ToolNode.__init__(functions)" class="doc doc-heading doc-heading-parameter">                  <code>functions</code>
<a href="#pyagenity.graph.tool_node.base.ToolNode.__init__(functions)" class="headerlink" title="Permanent link">&para;</a></h10>            </td>
            <td>
                  <code><span title="typing.Iterable">Iterable</span>[<span title="typing.Callable">Callable</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Iterable of callable functions to register as tools. Each function
will be registered with its <code>__name__</code> as the tool identifier.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h10 id="pyagenity.graph.tool_node.base.ToolNode.__init__(client)" class="doc doc-heading doc-heading-parameter">                  <code>client</code>
<a href="#pyagenity.graph.tool_node.base.ToolNode.__init__(client)" class="headerlink" title="Permanent link">&para;</a></h10>            </td>
            <td>
                  <code><span title="pyagenity.graph.tool_node.deps.Client">Client</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional MCP (Model Context Protocol) client for remote tool access.
Requires 'fastmcp' and 'mcp' packages to be installed.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h10 id="pyagenity.graph.tool_node.base.ToolNode.__init__(composio_adapter)" class="doc doc-heading doc-heading-parameter">                  <code>composio_adapter</code>
<a href="#pyagenity.graph.tool_node.base.ToolNode.__init__(composio_adapter)" class="headerlink" title="Permanent link">&para;</a></h10>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            ComposioAdapter (pyagenity.adapters.tools.ComposioAdapter)" href="../#pyagenity.adapters.tools.ComposioAdapter">ComposioAdapter</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional Composio adapter for external integrations and
third-party API access.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h10 id="pyagenity.graph.tool_node.base.ToolNode.__init__(langchain_adapter)" class="doc doc-heading doc-heading-parameter">                  <code>langchain_adapter</code>
<a href="#pyagenity.graph.tool_node.base.ToolNode.__init__(langchain_adapter)" class="headerlink" title="Permanent link">&para;</a></h10>            </td>
            <td>
                  <code><span title="typing.Any">Any</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional LangChain adapter for accessing LangChain tools
and integrations.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ImportError">ImportError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If MCP client is provided but required packages are not installed.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If any item in functions is not callable.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>When using MCP client functionality, ensure you have installed the required
dependencies with: <code>pip install pyagenity[mcp]</code></p>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/tool_node/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">functions</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">],</span>
    <span class="n">client</span><span class="p">:</span> <span class="n">deps</span><span class="o">.</span><span class="n">Client</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
    <span class="n">composio_adapter</span><span class="p">:</span> <span class="n">ComposioAdapter</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">langchain_adapter</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize ToolNode with functions and optional tool adapters.</span>

<span class="sd">    Args:</span>
<span class="sd">        functions: Iterable of callable functions to register as tools. Each function</span>
<span class="sd">            will be registered with its `__name__` as the tool identifier.</span>
<span class="sd">        client: Optional MCP (Model Context Protocol) client for remote tool access.</span>
<span class="sd">            Requires &#39;fastmcp&#39; and &#39;mcp&#39; packages to be installed.</span>
<span class="sd">        composio_adapter: Optional Composio adapter for external integrations and</span>
<span class="sd">            third-party API access.</span>
<span class="sd">        langchain_adapter: Optional LangChain adapter for accessing LangChain tools</span>
<span class="sd">            and integrations.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ImportError: If MCP client is provided but required packages are not installed.</span>
<span class="sd">        TypeError: If any item in functions is not callable.</span>

<span class="sd">    Note:</span>
<span class="sd">        When using MCP client functionality, ensure you have installed the required</span>
<span class="sd">        dependencies with: `pip install pyagenity[mcp]`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing ToolNode with </span><span class="si">%d</span><span class="s2"> functions&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">functions</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Read flags dynamically so tests can patch pyagenity.graph.tool_node.HAS_*</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pyagenity.graph.tool_node&quot;</span><span class="p">)</span>
        <span class="n">has_fastmcp</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s2">&quot;HAS_FASTMCP&quot;</span><span class="p">,</span> <span class="n">deps</span><span class="o">.</span><span class="n">HAS_FASTMCP</span><span class="p">)</span> <span class="k">if</span> <span class="n">mod</span> <span class="k">else</span> <span class="n">deps</span><span class="o">.</span><span class="n">HAS_FASTMCP</span>
        <span class="n">has_mcp</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s2">&quot;HAS_MCP&quot;</span><span class="p">,</span> <span class="n">deps</span><span class="o">.</span><span class="n">HAS_MCP</span><span class="p">)</span> <span class="k">if</span> <span class="n">mod</span> <span class="k">else</span> <span class="n">deps</span><span class="o">.</span><span class="n">HAS_MCP</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_fastmcp</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">has_mcp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">&quot;MCP client functionality requires &#39;fastmcp&#39; and &#39;mcp&#39; packages. &quot;</span>
                <span class="s2">&quot;Install with: pip install pyagenity[mcp]&quot;</span>
            <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;ToolNode initialized with MCP client&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span> <span class="n">deps</span><span class="o">.</span><span class="n">Client</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">client</span>  <span class="c1"># type: ignore</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_composio</span><span class="p">:</span> <span class="n">ComposioAdapter</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">composio_adapter</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_langchain</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">langchain_adapter</span>

    <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">functions</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;ToolNode only accepts callables&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">[</span><span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">mcp_tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">composio_tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">langchain_tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h9 id="pyagenity.graph.tool_node.base.ToolNode.all_tools" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">all_tools</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.tool_node.base.ToolNode.all_tools" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">all_tools</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Get all available tools from all configured providers.</p>
<p>Retrieves and combines tool definitions from local functions, MCP client,
Composio adapter, and LangChain adapter. Each tool definition includes
the function schema with parameters and descriptions.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of tool definitions in OpenAI function calling format. Each dict</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>contains 'type': 'function' and 'function' with name, description,</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>and parameters schema.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">tool_node</span><span class="o">.</span><span class="n">all_tools</span><span class="p">()</span>
<span class="c1"># Returns:</span>
<span class="c1"># [</span>
<span class="c1">#   {</span>
<span class="c1">#     &quot;type&quot;: &quot;function&quot;,</span>
<span class="c1">#     &quot;function&quot;: {</span>
<span class="c1">#       &quot;name&quot;: &quot;weather_tool&quot;,</span>
<span class="c1">#       &quot;description&quot;: &quot;Get weather information for a location&quot;,</span>
<span class="c1">#       &quot;parameters&quot;: {</span>
<span class="c1">#         &quot;type&quot;: &quot;object&quot;,</span>
<span class="c1">#         &quot;properties&quot;: {</span>
<span class="c1">#           &quot;location&quot;: {&quot;type&quot;: &quot;string&quot;}</span>
<span class="c1">#         },</span>
<span class="c1">#         &quot;required&quot;: [&quot;location&quot;]</span>
<span class="c1">#       }</span>
<span class="c1">#     }</span>
<span class="c1">#   }</span>
<span class="c1"># ]</span>
</code></pre></div>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/tool_node/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">all_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get all available tools from all configured providers.</span>

<span class="sd">    Retrieves and combines tool definitions from local functions, MCP client,</span>
<span class="sd">    Composio adapter, and LangChain adapter. Each tool definition includes</span>
<span class="sd">    the function schema with parameters and descriptions.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of tool definitions in OpenAI function calling format. Each dict</span>
<span class="sd">        contains &#39;type&#39;: &#39;function&#39; and &#39;function&#39; with name, description,</span>
<span class="sd">        and parameters schema.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        tools = await tool_node.all_tools()</span>
<span class="sd">        # Returns:</span>
<span class="sd">        # [</span>
<span class="sd">        #   {</span>
<span class="sd">        #     &quot;type&quot;: &quot;function&quot;,</span>
<span class="sd">        #     &quot;function&quot;: {</span>
<span class="sd">        #       &quot;name&quot;: &quot;weather_tool&quot;,</span>
<span class="sd">        #       &quot;description&quot;: &quot;Get weather information for a location&quot;,</span>
<span class="sd">        #       &quot;parameters&quot;: {</span>
<span class="sd">        #         &quot;type&quot;: &quot;object&quot;,</span>
<span class="sd">        #         &quot;properties&quot;: {</span>
<span class="sd">        #           &quot;location&quot;: {&quot;type&quot;: &quot;string&quot;}</span>
<span class="sd">        #         },</span>
<span class="sd">        #         &quot;required&quot;: [&quot;location&quot;]</span>
<span class="sd">        #       }</span>
<span class="sd">        #     }</span>
<span class="sd">        #   }</span>
<span class="sd">        # ]</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_tools_async</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h9 id="pyagenity.graph.tool_node.base.ToolNode.all_tools_sync" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">all_tools_sync</span>


<a href="#pyagenity.graph.tool_node.base.ToolNode.all_tools_sync" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">all_tools_sync</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Synchronously get all available tools from all configured providers.</p>
<p>This is a synchronous wrapper around the async all_tools() method.
It uses asyncio.run() to handle async operations from MCP, Composio,
and LangChain adapters.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of tool definitions in OpenAI function calling format.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>Prefer using the async <code>all_tools()</code> method when possible, especially
in async contexts, to avoid potential event loop issues.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/tool_node/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">all_tools_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Synchronously get all available tools from all configured providers.</span>

<span class="sd">    This is a synchronous wrapper around the async all_tools() method.</span>
<span class="sd">    It uses asyncio.run() to handle async operations from MCP, Composio,</span>
<span class="sd">    and LangChain adapters.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of tool definitions in OpenAI function calling format.</span>

<span class="sd">    Note:</span>
<span class="sd">        Prefer using the async `all_tools()` method when possible, especially</span>
<span class="sd">        in async contexts, to avoid potential event loop issues.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_local_tool</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_mcp_tool</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">comp</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_composio_tools</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">comp</span><span class="p">:</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
    <span class="n">lc</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_langchain_tools</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">lc</span><span class="p">:</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tools</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h9 id="pyagenity.graph.tool_node.base.ToolNode.get_local_tool" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">get_local_tool</span>


<a href="#pyagenity.graph.tool_node.base.ToolNode.get_local_tool" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_local_tool</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Generate OpenAI-compatible tool definitions for all registered local functions.</p>
<p>Inspects all registered functions in _funcs and automatically generates
tool schemas by analyzing function signatures, type annotations, and docstrings.
Excludes injectable parameters that are provided by the framework.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of tool definitions in OpenAI function calling format. Each</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>definition includes the function name, description (from docstring),</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>and complete parameter schema with types and required fields.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>For a function:
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">operation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;add&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Perform arithmetic calculation.&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;add&quot;</span> <span class="k">else</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span>
</code></pre></div></p>
<p>Returns:
<div class="highlight"><pre><span></span><code><span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
        <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;calculate&quot;</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Perform arithmetic calculation.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;integer&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;integer&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;operation&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;add&quot;</span><span class="p">},</span>
                <span class="p">},</span>
                <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">],</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">}</span>
<span class="p">]</span>
</code></pre></div></p>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>Parameters listed in INJECTABLE_PARAMS (like 'state', 'config',
'tool_call_id') are automatically excluded from the generated schema
as they are provided by the framework during execution.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/tool_node/schema.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_local_tool</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate OpenAI-compatible tool definitions for all registered local functions.</span>

<span class="sd">    Inspects all registered functions in _funcs and automatically generates</span>
<span class="sd">    tool schemas by analyzing function signatures, type annotations, and docstrings.</span>
<span class="sd">    Excludes injectable parameters that are provided by the framework.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of tool definitions in OpenAI function calling format. Each</span>
<span class="sd">        definition includes the function name, description (from docstring),</span>
<span class="sd">        and complete parameter schema with types and required fields.</span>

<span class="sd">    Example:</span>
<span class="sd">        For a function:</span>
<span class="sd">        ```python</span>
<span class="sd">        def calculate(a: int, b: int, operation: str = &quot;add&quot;) -&gt; int:</span>
<span class="sd">            &#39;&#39;&#39;Perform arithmetic calculation.&#39;&#39;&#39;</span>
<span class="sd">            return a + b if operation == &quot;add&quot; else a - b</span>
<span class="sd">        ```</span>

<span class="sd">        Returns:</span>
<span class="sd">        ```python</span>
<span class="sd">        [</span>
<span class="sd">            {</span>
<span class="sd">                &quot;type&quot;: &quot;function&quot;,</span>
<span class="sd">                &quot;function&quot;: {</span>
<span class="sd">                    &quot;name&quot;: &quot;calculate&quot;,</span>
<span class="sd">                    &quot;description&quot;: &quot;Perform arithmetic calculation.&quot;,</span>
<span class="sd">                    &quot;parameters&quot;: {</span>
<span class="sd">                        &quot;type&quot;: &quot;object&quot;,</span>
<span class="sd">                        &quot;properties&quot;: {</span>
<span class="sd">                            &quot;a&quot;: {&quot;type&quot;: &quot;integer&quot;},</span>
<span class="sd">                            &quot;b&quot;: {&quot;type&quot;: &quot;integer&quot;},</span>
<span class="sd">                            &quot;operation&quot;: {&quot;type&quot;: &quot;string&quot;, &quot;default&quot;: &quot;add&quot;},</span>
<span class="sd">                        },</span>
<span class="sd">                        &quot;required&quot;: [&quot;a&quot;, &quot;b&quot;],</span>
<span class="sd">                    },</span>
<span class="sd">                },</span>
<span class="sd">            }</span>
<span class="sd">        ]</span>
<span class="sd">        ```</span>

<span class="sd">    Note:</span>
<span class="sd">        Parameters listed in INJECTABLE_PARAMS (like &#39;state&#39;, &#39;config&#39;,</span>
<span class="sd">        &#39;tool_call_id&#39;) are automatically excluded from the generated schema</span>
<span class="sd">        as they are provided by the framework during execution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">params_schema</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="k">for</span> <span class="n">p_name</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">VAR_POSITIONAL</span><span class="p">,</span>
                <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">VAR_KEYWORD</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="n">INJECTABLE_PARAMS</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">annotation</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">annotation</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">_empty</span> <span class="k">else</span> <span class="nb">str</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="n">SchemaMixin</span><span class="o">.</span><span class="n">_annotation_to_schema</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>
            <span class="n">params_schema</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="n">p_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">prop</span>

            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="n">inspect</span><span class="o">.</span><span class="n">_empty</span><span class="p">:</span>
                <span class="n">params_schema</span><span class="p">[</span><span class="s2">&quot;required&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">params_schema</span><span class="p">[</span><span class="s2">&quot;required&quot;</span><span class="p">]:</span>
            <span class="n">params_schema</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;required&quot;</span><span class="p">)</span>

        <span class="n">description</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;No description provided.&quot;</span>

        <span class="c1"># provider = getattr(fn, &quot;_py_tool_provider&quot;, None)</span>
        <span class="c1"># tags = getattr(fn, &quot;_py_tool_tags&quot;, None)</span>
        <span class="c1"># capabilities = getattr(fn, &quot;_py_tool_capabilities&quot;, None)</span>

        <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">params_schema</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="c1"># meta: dict[str, t.Any] = {}</span>
        <span class="c1"># if provider:</span>
        <span class="c1">#     meta[&quot;provider&quot;] = provider</span>
        <span class="c1"># if tags:</span>
        <span class="c1">#     meta[&quot;tags&quot;] = tags</span>
        <span class="c1"># if capabilities:</span>
        <span class="c1">#     meta[&quot;capabilities&quot;] = capabilities</span>
        <span class="c1"># if meta:</span>
        <span class="c1">#     entry[&quot;x-pyagenity&quot;] = meta</span>

        <span class="n">tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tools</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h9 id="pyagenity.graph.tool_node.base.ToolNode.invoke" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">invoke</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.tool_node.base.ToolNode.invoke" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">invoke</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">tool_call_id</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">callback_manager</span><span class="o">=</span><span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">])</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Execute a specific tool by name with the provided arguments.</p>
<p>This method handles tool execution across all configured providers (local,
MCP, Composio, LangChain) with comprehensive error handling, event publishing,
and callback management.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h10 id="pyagenity.graph.tool_node.base.ToolNode.invoke(name)" class="doc doc-heading doc-heading-parameter">                  <code>name</code>
<a href="#pyagenity.graph.tool_node.base.ToolNode.invoke(name)" class="headerlink" title="Permanent link">&para;</a></h10>            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the tool to execute.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h10 id="pyagenity.graph.tool_node.base.ToolNode.invoke(args)" class="doc doc-heading doc-heading-parameter">                  <code>args</code>
<a href="#pyagenity.graph.tool_node.base.ToolNode.invoke(args)" class="headerlink" title="Permanent link">&para;</a></h10>            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of arguments to pass to the tool function.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h10 id="pyagenity.graph.tool_node.base.ToolNode.invoke(tool_call_id)" class="doc doc-heading doc-heading-parameter">                  <code>tool_call_id</code>
<a href="#pyagenity.graph.tool_node.base.ToolNode.invoke(tool_call_id)" class="headerlink" title="Permanent link">&para;</a></h10>            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique identifier for this tool execution, used for
tracking and result correlation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h10 id="pyagenity.graph.tool_node.base.ToolNode.invoke(config)" class="doc doc-heading doc-heading-parameter">                  <code>config</code>
<a href="#pyagenity.graph.tool_node.base.ToolNode.invoke(config)" class="headerlink" title="Permanent link">&para;</a></h10>            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration dictionary containing execution context and
user-specific settings.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h10 id="pyagenity.graph.tool_node.base.ToolNode.invoke(state)" class="doc doc-heading doc-heading-parameter">                  <code>state</code>
<a href="#pyagenity.graph.tool_node.base.ToolNode.invoke(state)" class="headerlink" title="Permanent link">&para;</a></h10>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            AgentState (pyagenity.state.AgentState)" href="../#pyagenity.state.AgentState">AgentState</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Current agent state for context-aware tool execution.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h10 id="pyagenity.graph.tool_node.base.ToolNode.invoke(callback_manager)" class="doc doc-heading doc-heading-parameter">                  <code>callback_manager</code>
<a href="#pyagenity.graph.tool_node.base.ToolNode.invoke(callback_manager)" class="headerlink" title="Permanent link">&para;</a></h10>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            CallbackManager (pyagenity.utils.CallbackManager)" href="../#pyagenity.utils.CallbackManager">CallbackManager</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Manager for executing pre/post execution callbacks.
Injected via dependency injection if not provided.</p>
              </div>
            </td>
            <td>
                  <code><span title="injectq.Inject">Inject</span>[<a class="autorefs autorefs-internal" title="            CallbackManager (pyagenity.utils.CallbackManager)" href="../#pyagenity.utils.CallbackManager">CallbackManager</a>]</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Message object containing tool execution results, either successful</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>output or error information with appropriate status indicators.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">tool_node</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weather_tool&quot;</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="s2">&quot;Paris&quot;</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;metric&quot;</span><span class="p">},</span>
    <span class="n">tool_call_id</span><span class="o">=</span><span class="s2">&quot;call_abc123&quot;</span><span class="p">,</span>
    <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;user1&quot;</span><span class="p">,</span> <span class="s2">&quot;session_id&quot;</span><span class="p">:</span> <span class="s2">&quot;session1&quot;</span><span class="p">},</span>
    <span class="n">state</span><span class="o">=</span><span class="n">current_agent_state</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># result is a Message with tool execution results</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>  <span class="c1"># Tool output or error information</span>
</code></pre></div>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>The method publishes execution events throughout the process for
monitoring and debugging purposes. Tool execution is routed based
on tool provider precedence: MCP → Composio → LangChain → Local.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/tool_node/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span>  <span class="c1"># noqa: PLR0915</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">tool_call_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
    <span class="n">callback_manager</span><span class="p">:</span> <span class="n">CallbackManager</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute a specific tool by name with the provided arguments.</span>

<span class="sd">    This method handles tool execution across all configured providers (local,</span>
<span class="sd">    MCP, Composio, LangChain) with comprehensive error handling, event publishing,</span>
<span class="sd">    and callback management.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: The name of the tool to execute.</span>
<span class="sd">        args: Dictionary of arguments to pass to the tool function.</span>
<span class="sd">        tool_call_id: Unique identifier for this tool execution, used for</span>
<span class="sd">            tracking and result correlation.</span>
<span class="sd">        config: Configuration dictionary containing execution context and</span>
<span class="sd">            user-specific settings.</span>
<span class="sd">        state: Current agent state for context-aware tool execution.</span>
<span class="sd">        callback_manager: Manager for executing pre/post execution callbacks.</span>
<span class="sd">            Injected via dependency injection if not provided.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Message object containing tool execution results, either successful</span>
<span class="sd">        output or error information with appropriate status indicators.</span>

<span class="sd">    Raises:</span>
<span class="sd">        The method handles all exceptions internally and returns error Messages</span>
<span class="sd">        rather than raising exceptions, ensuring robust execution flow.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        result = await tool_node.invoke(</span>
<span class="sd">            name=&quot;weather_tool&quot;,</span>
<span class="sd">            args={&quot;location&quot;: &quot;Paris&quot;, &quot;units&quot;: &quot;metric&quot;},</span>
<span class="sd">            tool_call_id=&quot;call_abc123&quot;,</span>
<span class="sd">            config={&quot;user_id&quot;: &quot;user1&quot;, &quot;session_id&quot;: &quot;session1&quot;},</span>
<span class="sd">            state=current_agent_state,</span>
<span class="sd">        )</span>

<span class="sd">        # result is a Message with tool execution results</span>
<span class="sd">        print(result.content)  # Tool output or error information</span>
<span class="sd">        ```</span>

<span class="sd">    Note:</span>
<span class="sd">        The method publishes execution events throughout the process for</span>
<span class="sd">        monitoring and debugging purposes. Tool execution is routed based</span>
<span class="sd">        on tool provider precedence: MCP → Composio → LangChain → Local.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Executing tool &#39;</span><span class="si">%s</span><span class="s2">&#39; with </span><span class="si">%d</span><span class="s2"> arguments&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Tool arguments: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="n">event</span> <span class="o">=</span> <span class="n">EventModel</span><span class="o">.</span><span class="n">default</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call_id</span><span class="p">,</span> <span class="s2">&quot;function_name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">},</span>
        <span class="n">content_type</span><span class="o">=</span><span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_CALL</span><span class="p">],</span>
        <span class="n">event</span><span class="o">=</span><span class="n">Event</span><span class="o">.</span><span class="n">TOOL_EXECUTION</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">node_name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="c1"># Attach structured tool call block</span>
    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">ToolCallBlock</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)]</span>
    <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcp_tools</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_mcp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mcp_execute</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="n">tool_call_id</span><span class="p">,</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">callback_manager</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="c1"># Attach tool result block mirroring the tool output</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
            <span class="p">]</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">composio_tools</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_composio&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_composio_execute</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="n">tool_call_id</span><span class="p">,</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">callback_manager</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
            <span class="p">]</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">langchain_tools</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_langchain&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_langchain_execute</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="n">tool_call_id</span><span class="p">,</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">callback_manager</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
            <span class="p">]</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_mcp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_execute</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="n">tool_call_id</span><span class="p">,</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">state</span><span class="p">,</span>
            <span class="n">callback_manager</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
            <span class="p">]</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Tool &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span>
    <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_msg</span>
    <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">ERROR</span>
    <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">ERROR</span><span class="p">]</span>
    <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Message</span><span class="o">.</span><span class="n">tool_message</span><span class="p">(</span>
        <span class="n">content</span><span class="o">=</span><span class="p">[</span>
            <span class="n">ErrorBlock</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">error_msg</span><span class="p">),</span>
            <span class="n">ToolResultBlock</span><span class="p">(</span>
                <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="n">error_msg</span><span class="p">,</span>
                <span class="n">is_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">],</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h9 id="pyagenity.graph.tool_node.base.ToolNode.stream" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">stream</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.tool_node.base.ToolNode.stream" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">stream</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">tool_call_id</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">callback_manager</span><span class="o">=</span><span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">])</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Execute a tool with streaming support, yielding incremental results.</p>
<p>Similar to invoke() but designed for tools that can provide streaming responses
or when you want to process results as they become available. Currently,
most tool providers return complete results, so this method typically yields
a single Message with the full result.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h10 id="pyagenity.graph.tool_node.base.ToolNode.stream(name)" class="doc doc-heading doc-heading-parameter">                  <code>name</code>
<a href="#pyagenity.graph.tool_node.base.ToolNode.stream(name)" class="headerlink" title="Permanent link">&para;</a></h10>            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the tool to execute.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h10 id="pyagenity.graph.tool_node.base.ToolNode.stream(args)" class="doc doc-heading doc-heading-parameter">                  <code>args</code>
<a href="#pyagenity.graph.tool_node.base.ToolNode.stream(args)" class="headerlink" title="Permanent link">&para;</a></h10>            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of arguments to pass to the tool function.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h10 id="pyagenity.graph.tool_node.base.ToolNode.stream(tool_call_id)" class="doc doc-heading doc-heading-parameter">                  <code>tool_call_id</code>
<a href="#pyagenity.graph.tool_node.base.ToolNode.stream(tool_call_id)" class="headerlink" title="Permanent link">&para;</a></h10>            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique identifier for this tool execution.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h10 id="pyagenity.graph.tool_node.base.ToolNode.stream(config)" class="doc doc-heading doc-heading-parameter">                  <code>config</code>
<a href="#pyagenity.graph.tool_node.base.ToolNode.stream(config)" class="headerlink" title="Permanent link">&para;</a></h10>            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration dictionary containing execution context.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h10 id="pyagenity.graph.tool_node.base.ToolNode.stream(state)" class="doc doc-heading doc-heading-parameter">                  <code>state</code>
<a href="#pyagenity.graph.tool_node.base.ToolNode.stream(state)" class="headerlink" title="Permanent link">&para;</a></h10>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            AgentState (pyagenity.state.AgentState)" href="../#pyagenity.state.AgentState">AgentState</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Current agent state for context-aware tool execution.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h10 id="pyagenity.graph.tool_node.base.ToolNode.stream(callback_manager)" class="doc doc-heading doc-heading-parameter">                  <code>callback_manager</code>
<a href="#pyagenity.graph.tool_node.base.ToolNode.stream(callback_manager)" class="headerlink" title="Permanent link">&para;</a></h10>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            CallbackManager (pyagenity.utils.CallbackManager)" href="../#pyagenity.utils.CallbackManager">CallbackManager</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Manager for executing pre/post execution callbacks.</p>
              </div>
            </td>
            <td>
                  <code><span title="injectq.Inject">Inject</span>[<a class="autorefs autorefs-internal" title="            CallbackManager (pyagenity.utils.CallbackManager)" href="../#pyagenity.utils.CallbackManager">CallbackManager</a>]</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Yields:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.AsyncIterator">AsyncIterator</span>[<a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.message.Message)" href="../#pyagenity.utils.message.Message">Message</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Message objects containing tool execution results or status updates.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.AsyncIterator">AsyncIterator</span>[<a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.message.Message)" href="../#pyagenity.utils.message.Message">Message</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>For most tools, this will yield a single complete result Message.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">tool_node</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;data_processor&quot;</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;dataset&quot;</span><span class="p">:</span> <span class="s2">&quot;large_data.csv&quot;</span><span class="p">},</span>
    <span class="n">tool_call_id</span><span class="o">=</span><span class="s2">&quot;call_stream123&quot;</span><span class="p">,</span>
    <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;user1&quot;</span><span class="p">},</span>
    <span class="n">state</span><span class="o">=</span><span class="n">current_state</span><span class="p">,</span>
<span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received: </span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Process each streamed result</span>
</code></pre></div>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>The streaming interface is designed for future expansion where tools
may provide true streaming responses. Currently, it provides a
consistent async iterator interface over tool results.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/tool_node/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream</span><span class="p">(</span>  <span class="c1"># noqa: PLR0915</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">tool_call_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
    <span class="n">callback_manager</span><span class="p">:</span> <span class="n">CallbackManager</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">AsyncIterator</span><span class="p">[</span><span class="n">Message</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute a tool with streaming support, yielding incremental results.</span>

<span class="sd">    Similar to invoke() but designed for tools that can provide streaming responses</span>
<span class="sd">    or when you want to process results as they become available. Currently,</span>
<span class="sd">    most tool providers return complete results, so this method typically yields</span>
<span class="sd">    a single Message with the full result.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: The name of the tool to execute.</span>
<span class="sd">        args: Dictionary of arguments to pass to the tool function.</span>
<span class="sd">        tool_call_id: Unique identifier for this tool execution.</span>
<span class="sd">        config: Configuration dictionary containing execution context.</span>
<span class="sd">        state: Current agent state for context-aware tool execution.</span>
<span class="sd">        callback_manager: Manager for executing pre/post execution callbacks.</span>

<span class="sd">    Yields:</span>
<span class="sd">        Message objects containing tool execution results or status updates.</span>
<span class="sd">        For most tools, this will yield a single complete result Message.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        async for message in tool_node.stream(</span>
<span class="sd">            name=&quot;data_processor&quot;,</span>
<span class="sd">            args={&quot;dataset&quot;: &quot;large_data.csv&quot;},</span>
<span class="sd">            tool_call_id=&quot;call_stream123&quot;,</span>
<span class="sd">            config={&quot;user_id&quot;: &quot;user1&quot;},</span>
<span class="sd">            state=current_state,</span>
<span class="sd">        ):</span>
<span class="sd">            print(f&quot;Received: {message.content}&quot;)</span>
<span class="sd">            # Process each streamed result</span>
<span class="sd">        ```</span>

<span class="sd">    Note:</span>
<span class="sd">        The streaming interface is designed for future expansion where tools</span>
<span class="sd">        may provide true streaming responses. Currently, it provides a</span>
<span class="sd">        consistent async iterator interface over tool results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Executing tool &#39;</span><span class="si">%s</span><span class="s2">&#39; with </span><span class="si">%d</span><span class="s2"> arguments&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Tool arguments: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">EventModel</span><span class="o">.</span><span class="n">default</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call_id</span><span class="p">,</span> <span class="s2">&quot;function_name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">},</span>
        <span class="n">content_type</span><span class="o">=</span><span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_CALL</span><span class="p">],</span>
        <span class="n">event</span><span class="o">=</span><span class="n">Event</span><span class="o">.</span><span class="n">TOOL_EXECUTION</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">node_name</span> <span class="o">=</span> <span class="s2">&quot;ToolNode&quot;</span>
    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">ToolCallBlock</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcp_tools</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;function_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mcp&quot;</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mcp_execute</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="n">tool_call_id</span><span class="p">,</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">callback_manager</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
            <span class="p">]</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">message</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">composio_tools</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;function_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;composio&quot;</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_composio_execute</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="n">tool_call_id</span><span class="p">,</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">callback_manager</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
            <span class="p">]</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">message</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">langchain_tools</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;function_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;langchain&quot;</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_langchain_execute</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="n">tool_call_id</span><span class="p">,</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">callback_manager</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
            <span class="p">]</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">message</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;function_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;internal&quot;</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_execute</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="n">tool_call_id</span><span class="p">,</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">state</span><span class="p">,</span>
            <span class="n">callback_manager</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ToolResultBlock</span><span class="p">(</span><span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
            <span class="p">]</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
        <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">result</span>
        <span class="k">return</span>

    <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Tool &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span>
    <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_msg</span>
    <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">ERROR</span>
    <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">ERROR</span><span class="p">]</span>
    <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

    <span class="k">yield</span> <span class="n">Message</span><span class="o">.</span><span class="n">tool_message</span><span class="p">(</span>
        <span class="n">content</span><span class="o">=</span><span class="p">[</span>
            <span class="n">ErrorBlock</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">error_msg</span><span class="p">),</span>
            <span class="n">ToolResultBlock</span><span class="p">(</span>
                <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="n">error_msg</span><span class="p">,</span>
                <span class="n">is_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">],</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>
<h6 id="pyagenity.graph.tool_node.base-functions">Functions<a href="#pyagenity.graph.tool_node.base-functions" class="headerlink" title="Permanent link">&para;</a></h6>
<h6 id="pyagenity.graph.tool_node.base-modules">Modules<a href="#pyagenity.graph.tool_node.base-modules" class="headerlink" title="Permanent link">&para;</a></h6>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="pyagenity.graph.tool_node.constants" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">constants</span>


<a href="#pyagenity.graph.tool_node.constants" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

        <p>Constants for ToolNode package.</p>
<p>This module defines constants used throughout the ToolNode implementation,
particularly parameter names that are automatically injected by the PyAgenity
framework during tool execution. These parameters are excluded from tool
schema generation since they are provided by the execution context.</p>
<p>The constants are separated into their own module to avoid circular imports
and maintain a clean public API.</p>
<p>Parameter names that are automatically injected during tool execution.</p>
<p>These parameters are provided by the PyAgenity framework and should be excluded
from tool schema generation. They represent execution context and framework
services that are available to tool functions but not provided by the user.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.tool_node.constants(tool_call_id)" class="doc doc-heading doc-heading-parameter">                  <code>tool_call_id</code>
<a href="#pyagenity.graph.tool_node.constants(tool_call_id)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique identifier for the current tool execution.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.tool_node.constants(state)" class="doc doc-heading doc-heading-parameter">                  <code>state</code>
<a href="#pyagenity.graph.tool_node.constants(state)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Current AgentState instance for context-aware execution.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.tool_node.constants(config)" class="doc doc-heading doc-heading-parameter">                  <code>config</code>
<a href="#pyagenity.graph.tool_node.constants(config)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration dictionary with execution settings.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.tool_node.constants(generated_id)" class="doc doc-heading doc-heading-parameter">                  <code>generated_id</code>
<a href="#pyagenity.graph.tool_node.constants(generated_id)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Framework-generated identifier for various purposes.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.tool_node.constants(context_manager)" class="doc doc-heading doc-heading-parameter">                  <code>context_manager</code>
<a href="#pyagenity.graph.tool_node.constants(context_manager)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>BaseContextManager instance for cross-node operations.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.tool_node.constants(publisher)" class="doc doc-heading doc-heading-parameter">                  <code>publisher</code>
<a href="#pyagenity.graph.tool_node.constants(publisher)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>BasePublisher instance for event publishing.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.tool_node.constants(checkpointer)" class="doc doc-heading doc-heading-parameter">                  <code>checkpointer</code>
<a href="#pyagenity.graph.tool_node.constants(checkpointer)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>BaseCheckpointer instance for state persistence.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h6 id="pyagenity.graph.tool_node.constants(store)" class="doc doc-heading doc-heading-parameter">                  <code>store</code>
<a href="#pyagenity.graph.tool_node.constants(store)" class="headerlink" title="Permanent link">&para;</a></h6>            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>BaseStore instance for data storage operations.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>Tool functions can declare these parameters in their signatures to receive
the corresponding services, but they should not be included in the tool
schema since they're not user-provided arguments.</p>
</details>













<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            INJECTABLE_PARAMS


  
      module-attribute
   (pyagenity.graph.tool_node.constants.INJECTABLE_PARAMS)" href="../#pyagenity.graph.tool_node.constants.INJECTABLE_PARAMS">INJECTABLE_PARAMS</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>



  <div class="doc doc-children">





<h6 id="pyagenity.graph.tool_node.constants-attributes">Attributes<a href="#pyagenity.graph.tool_node.constants-attributes" class="headerlink" title="Permanent link">&para;</a></h6>

<div class="doc doc-object doc-attribute">



<h7 id="pyagenity.graph.tool_node.constants.INJECTABLE_PARAMS" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">INJECTABLE_PARAMS</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#pyagenity.graph.tool_node.constants.INJECTABLE_PARAMS" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">INJECTABLE_PARAMS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tool_call_id&#39;</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="s1">&#39;generated_id&#39;</span><span class="p">,</span> <span class="s1">&#39;context_manager&#39;</span><span class="p">,</span> <span class="s1">&#39;publisher&#39;</span><span class="p">,</span> <span class="s1">&#39;checkpointer&#39;</span><span class="p">,</span> <span class="s1">&#39;store&#39;</span><span class="p">}</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>






  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="pyagenity.graph.tool_node.deps" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">deps</span>


<a href="#pyagenity.graph.tool_node.deps" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

        <p>Dependency flags and optional imports for ToolNode.</p>
<p>This module manages optional third-party dependencies for the ToolNode implementation,
providing clean import handling and feature flags. It isolates optional imports
to prevent ImportError cascades when optional dependencies are not installed.</p>
<p>The module handles two main optional dependency groups:
1. MCP (Model Context Protocol) support via 'fastmcp' and 'mcp' packages
2. Future extensibility for other optional tool providers</p>
<p>By centralizing optional imports here, other modules can safely import the
flags and types without triggering ImportError exceptions, allowing graceful
degradation when optional features are not available.</p>


<details class="typical-usage" open>
  <summary>Typical usage</summary>
  <div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">.deps</span><span class="w"> </span><span class="kn">import</span> <span class="n">HAS_FASTMCP</span><span class="p">,</span> <span class="n">HAS_MCP</span><span class="p">,</span> <span class="n">Client</span>

<span class="k">if</span> <span class="n">HAS_FASTMCP</span> <span class="ow">and</span> <span class="n">HAS_MCP</span><span class="p">:</span>
    <span class="c1"># Use MCP functionality</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Graceful fallback or error message</span>
    <span class="n">client</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>
</details>        <p>FastMCP integration support.</p>


<details class="has_fastmcp" open>
  <summary>Boolean flag indicating whether FastMCP is available.</summary>
  <p>True if 'fastmcp' package is installed and imports successfully.</p>
</details>

<details class="client" open>
  <summary>FastMCP Client class for connecting to MCP servers.</summary>
  <p>None if FastMCP is not available.</p>
</details>

<details class="calltoolresult" open>
  <summary>Result type for MCP tool executions.</summary>
  <p>None if FastMCP is not available.</p>
</details>













<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            HAS_FASTMCP


  
      module-attribute
   (pyagenity.graph.tool_node.deps.HAS_FASTMCP)" href="../#pyagenity.graph.tool_node.deps.HAS_FASTMCP">HAS_FASTMCP</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            HAS_MCP


  
      module-attribute
   (pyagenity.graph.tool_node.deps.HAS_MCP)" href="../#pyagenity.graph.tool_node.deps.HAS_MCP">HAS_MCP</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>



  <div class="doc doc-children">





<h6 id="pyagenity.graph.tool_node.deps-attributes">Attributes<a href="#pyagenity.graph.tool_node.deps-attributes" class="headerlink" title="Permanent link">&para;</a></h6>

<div class="doc doc-object doc-attribute">



<h7 id="pyagenity.graph.tool_node.deps.HAS_FASTMCP" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">HAS_FASTMCP</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#pyagenity.graph.tool_node.deps.HAS_FASTMCP" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">HAS_FASTMCP</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="pyagenity.graph.tool_node.deps.HAS_MCP" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">HAS_MCP</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#pyagenity.graph.tool_node.deps.HAS_MCP" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">HAS_MCP</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="pyagenity.graph.tool_node.deps.__all__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">__all__</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#pyagenity.graph.tool_node.deps.__all__" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;HAS_FASTMCP&#39;</span><span class="p">,</span> <span class="s1">&#39;HAS_MCP&#39;</span><span class="p">,</span> <span class="s1">&#39;CallToolResult&#39;</span><span class="p">,</span> <span class="s1">&#39;Client&#39;</span><span class="p">,</span> <span class="s1">&#39;ContentBlock&#39;</span><span class="p">,</span> <span class="s1">&#39;Tool&#39;</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>






  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="pyagenity.graph.tool_node.executors" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">executors</span>


<a href="#pyagenity.graph.tool_node.executors" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

        <p>Executors for different tool providers and local functions.</p>










<p><span class="doc-section-title">Classes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            ComposioMixin (pyagenity.graph.tool_node.executors.ComposioMixin)" href="../#pyagenity.graph.tool_node.executors.ComposioMixin">ComposioMixin</a></code></td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            KwargsResolverMixin (pyagenity.graph.tool_node.executors.KwargsResolverMixin)" href="../#pyagenity.graph.tool_node.executors.KwargsResolverMixin">KwargsResolverMixin</a></code></td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            LangChainMixin (pyagenity.graph.tool_node.executors.LangChainMixin)" href="../#pyagenity.graph.tool_node.executors.LangChainMixin">LangChainMixin</a></code></td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            LocalExecMixin (pyagenity.graph.tool_node.executors.LocalExecMixin)" href="../#pyagenity.graph.tool_node.executors.LocalExecMixin">LocalExecMixin</a></code></td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            MCPMixin (pyagenity.graph.tool_node.executors.MCPMixin)" href="../#pyagenity.graph.tool_node.executors.MCPMixin">MCPMixin</a></code></td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>






<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            logger


  
      module-attribute
   (pyagenity.graph.tool_node.executors.logger)" href="../#pyagenity.graph.tool_node.executors.logger">logger</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>



  <div class="doc doc-children">





<h6 id="pyagenity.graph.tool_node.executors-attributes">Attributes<a href="#pyagenity.graph.tool_node.executors-attributes" class="headerlink" title="Permanent link">&para;</a></h6>

<div class="doc doc-object doc-attribute">



<h7 id="pyagenity.graph.tool_node.executors.logger" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">logger</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#pyagenity.graph.tool_node.executors.logger" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<h6 id="pyagenity.graph.tool_node.executors-classes">Classes<a href="#pyagenity.graph.tool_node.executors-classes" class="headerlink" title="Permanent link">&para;</a></h6>

<div class="doc doc-object doc-class">



<h7 id="pyagenity.graph.tool_node.executors.ComposioMixin" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">ComposioMixin</span>


<a href="#pyagenity.graph.tool_node.executors.ComposioMixin" class="headerlink" title="Permanent link">&para;</a></h7>


    <div class="doc doc-contents ">















<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            composio_tools


  
      instance-attribute
   (pyagenity.graph.tool_node.executors.ComposioMixin.composio_tools)" href="../#pyagenity.graph.tool_node.executors.ComposioMixin.composio_tools">composio_tools</a></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>pyagenity/graph/tool_node/executors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ComposioMixin</span><span class="p">:</span>
    <span class="n">_composio</span><span class="p">:</span> <span class="n">ComposioAdapter</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">composio_tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_get_composio_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
        <span class="n">tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_composio</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tools</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_composio</span><span class="o">.</span><span class="n">list_raw_tools_for_llm</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">tdef</span> <span class="ow">in</span> <span class="n">raw</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="n">tdef</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">composio_tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tdef</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># pragma: no cover - network/optional</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to fetch Composio tools: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_composio_execute</span><span class="p">(</span>  <span class="c1"># noqa: PLR0915</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">tool_call_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span>
        <span class="n">callback_mgr</span><span class="p">:</span> <span class="n">CallbackManager</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Message</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">CallbackContext</span><span class="p">(</span>
            <span class="n">invocation_type</span><span class="o">=</span><span class="n">InvocationType</span><span class="o">.</span><span class="n">TOOL</span><span class="p">,</span>
            <span class="n">node_name</span><span class="o">=</span><span class="s2">&quot;ToolNode&quot;</span><span class="p">,</span>
            <span class="n">function_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
                <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span>
                <span class="s2">&quot;composio&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;function_name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&quot;function_argument&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call_id</span><span class="p">}</span>

        <span class="n">event</span> <span class="o">=</span> <span class="n">EventModel</span><span class="o">.</span><span class="n">default</span><span class="p">(</span>
            <span class="n">base_config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
                <span class="s2">&quot;function_name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;is_composio&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">content_type</span><span class="o">=</span><span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_CALL</span><span class="p">],</span>
            <span class="n">event</span><span class="o">=</span><span class="n">Event</span><span class="o">.</span><span class="n">TOOL_EXECUTION</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">PROGRESS</span>
        <span class="n">event</span><span class="o">.</span><span class="n">node_name</span> <span class="o">=</span> <span class="s2">&quot;ToolNode&quot;</span>
        <span class="n">event</span><span class="o">.</span><span class="n">sequence_id</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="n">input_data</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">args</span><span class="p">}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">safe_serialize</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">obj</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span><span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">obj</span><span class="p">}</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">OverflowError</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;model_dump&quot;</span><span class="p">):</span>
                    <span class="n">dumped</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dumped</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dumped</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;resource&quot;</span><span class="p">:</span>
                        <span class="n">resource</span> <span class="o">=</span> <span class="n">dumped</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resource&quot;</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;uri&quot;</span> <span class="ow">in</span> <span class="n">resource</span><span class="p">:</span>
                            <span class="n">resource</span><span class="p">[</span><span class="s2">&quot;uri&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="p">[</span><span class="s2">&quot;uri&quot;</span><span class="p">])</span>
                            <span class="n">dumped</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resource</span>
                    <span class="k">return</span> <span class="n">dumped</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;fallback&quot;</span><span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">input_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">callback_mgr</span><span class="o">.</span><span class="n">execute_before_invoke</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">UPDATE</span>
            <span class="n">event</span><span class="o">.</span><span class="n">sequence_id</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;before_invoke_complete Invoke Composio&quot;</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

            <span class="n">comp_conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;composio&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">comp_conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">)</span>
            <span class="n">connected_account_id</span> <span class="o">=</span> <span class="n">comp_conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;connected_account_id&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;connected_account_id&quot;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_composio</span><span class="p">:</span>
                <span class="n">error_result</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="n">tool_message</span><span class="p">(</span>
                    <span class="n">content</span><span class="o">=</span><span class="p">[</span>
                        <span class="n">ErrorBlock</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Composio adapter not configured&quot;</span><span class="p">),</span>
                        <span class="n">ToolResultBlock</span><span class="p">(</span>
                            <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                            <span class="n">output</span><span class="o">=</span><span class="s2">&quot;Composio adapter not configured&quot;</span><span class="p">,</span>
                            <span class="n">status</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">,</span>
                            <span class="n">is_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">],</span>
                    <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">ERROR</span>
                <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Composio adapter not configured&quot;</span>
                <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">error_result</span>

            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_composio</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">slug</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">arguments</span><span class="o">=</span><span class="n">input_data</span><span class="p">,</span>
                <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
                <span class="n">connected_account_id</span><span class="o">=</span><span class="n">connected_account_id</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">successful</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;successful&quot;</span><span class="p">))</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>

            <span class="n">result_blocks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">error</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">successful</span><span class="p">:</span>
                <span class="n">result_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span>
                        <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                        <span class="n">output</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error</span><span class="p">},</span>
                        <span class="n">status</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">,</span>
                        <span class="n">is_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">result_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ErrorBlock</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">error</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">safe_serialize</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">safe_serialize</span><span class="p">(</span><span class="n">payload</span><span class="p">)]</span>
                <span class="n">result_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span>
                        <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                        <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">,</span>
                        <span class="n">status</span><span class="o">=</span><span class="s2">&quot;completed&quot;</span> <span class="k">if</span> <span class="n">successful</span> <span class="k">else</span> <span class="s2">&quot;failed&quot;</span><span class="p">,</span>
                        <span class="n">is_error</span><span class="o">=</span><span class="ow">not</span> <span class="n">successful</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="n">tool_message</span><span class="p">(</span>
                <span class="n">content</span><span class="o">=</span><span class="n">result_blocks</span><span class="p">,</span>
                <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">res_msg</span> <span class="o">=</span> <span class="k">await</span> <span class="n">callback_mgr</span><span class="o">.</span><span class="n">execute_after_invoke</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Composio tool execution complete&quot;</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res_msg</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># pragma: no cover - error path</span>
            <span class="n">recovery_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">callback_mgr</span><span class="o">.</span><span class="n">execute_on_error</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recovery_result</span><span class="p">,</span> <span class="n">Message</span><span class="p">):</span>
                <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
                <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recovery_result</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
                <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Composio tool execution complete, with recovery&quot;</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
                <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">recovery_result</span>

            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Composio tool execution complete, with error&quot;</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">ERROR</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Message</span><span class="o">.</span><span class="n">tool_message</span><span class="p">(</span>
                <span class="n">content</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span>
                        <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                        <span class="n">output</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Composio execution error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">status</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">,</span>
                        <span class="n">is_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">ErrorBlock</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Composio execution error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="p">],</span>
                <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">,</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">





<h8 id="pyagenity.graph.tool_node.executors.ComposioMixin-attributes">Attributes<a href="#pyagenity.graph.tool_node.executors.ComposioMixin-attributes" class="headerlink" title="Permanent link">&para;</a></h8>

<div class="doc doc-object doc-attribute">



<h9 id="pyagenity.graph.tool_node.executors.ComposioMixin.composio_tools" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">composio_tools</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.tool_node.executors.ComposioMixin.composio_tools" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">composio_tools</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>






  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h7 id="pyagenity.graph.tool_node.executors.KwargsResolverMixin" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">KwargsResolverMixin</span>


<a href="#pyagenity.graph.tool_node.executors.KwargsResolverMixin" class="headerlink" title="Permanent link">&para;</a></h7>


    <div class="doc doc-contents ">














              <details class="quote">
                <summary>Source code in <code>pyagenity/graph/tool_node/executors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">KwargsResolverMixin</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_should_skip_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">:</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">param</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">VAR_POSITIONAL</span><span class="p">,</span>
            <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">VAR_KEYWORD</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_injectable_parameter</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">p_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">param</span><span class="p">:</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="p">,</span>
        <span class="n">injectable_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">dependency_container</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="n">injectable_params</span><span class="p">:</span>
            <span class="n">injectable_value</span> <span class="o">=</span> <span class="n">injectable_params</span><span class="p">[</span><span class="n">p_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">injectable_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">injectable_value</span>

        <span class="k">if</span> <span class="n">dependency_container</span> <span class="ow">and</span> <span class="n">dependency_container</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">p_name</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">dependency_container</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="n">inspect</span><span class="o">.</span><span class="n">_empty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Required injectable parameter &#39;</span><span class="si">{</span><span class="n">p_name</span><span class="si">}</span><span class="s2">&#39; not found&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_parameter_value</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">p_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">param</span><span class="p">:</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="p">,</span>
        <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">injectable_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">dependency_container</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="n">injectable_params</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_injectable_parameter</span><span class="p">(</span>
                <span class="n">p_name</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">injectable_params</span><span class="p">,</span> <span class="n">dependency_container</span>
            <span class="p">)</span>

        <span class="n">value_sources</span> <span class="o">=</span> <span class="p">[</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p_name</span><span class="p">),</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">dependency_container</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dependency_container</span> <span class="ow">and</span> <span class="n">dependency_container</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">p_name</span><span class="p">)</span>
                <span class="k">else</span> <span class="kc">None</span>
            <span class="p">),</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">value_sources</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">source</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span>

        <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">_empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required parameter &#39;</span><span class="si">{</span><span class="n">p_name</span><span class="si">}</span><span class="s2">&#39; for function&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_kwargs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sig</span><span class="p">:</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Signature</span><span class="p">,</span>
        <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">injectable_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">dependency_container</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">p_name</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_skip_parameter</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_parameter_value</span><span class="p">(</span>
                <span class="n">p_name</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">injectable_params</span><span class="p">,</span> <span class="n">dependency_container</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">p_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">kwargs</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h7 id="pyagenity.graph.tool_node.executors.LangChainMixin" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">LangChainMixin</span>


<a href="#pyagenity.graph.tool_node.executors.LangChainMixin" class="headerlink" title="Permanent link">&para;</a></h7>


    <div class="doc doc-contents ">















<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            langchain_tools


  
      instance-attribute
   (pyagenity.graph.tool_node.executors.LangChainMixin.langchain_tools)" href="../#pyagenity.graph.tool_node.executors.LangChainMixin.langchain_tools">langchain_tools</a></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>pyagenity/graph/tool_node/executors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LangChainMixin</span><span class="p">:</span>
    <span class="n">_langchain</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">langchain_tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_get_langchain_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
        <span class="n">tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_langchain</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tools</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_langchain</span><span class="o">.</span><span class="n">list_tools_for_llm</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">tdef</span> <span class="ow">in</span> <span class="n">raw</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="n">tdef</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">langchain_tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tdef</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># pragma: no cover - optional</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to fetch LangChain tools: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_langchain_execute</span><span class="p">(</span>  <span class="c1"># noqa: PLR0915</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">tool_call_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span>
        <span class="n">callback_mgr</span><span class="p">:</span> <span class="n">CallbackManager</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Message</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">CallbackContext</span><span class="p">(</span>
            <span class="n">invocation_type</span><span class="o">=</span><span class="n">InvocationType</span><span class="o">.</span><span class="n">TOOL</span><span class="p">,</span>
            <span class="n">node_name</span><span class="o">=</span><span class="s2">&quot;ToolNode&quot;</span><span class="p">,</span>
            <span class="n">function_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
                <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span>
                <span class="s2">&quot;langchain&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;function_name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&quot;function_argument&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call_id</span><span class="p">}</span>

        <span class="n">event</span> <span class="o">=</span> <span class="n">EventModel</span><span class="o">.</span><span class="n">default</span><span class="p">(</span>
            <span class="n">base_config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
                <span class="s2">&quot;function_name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;is_langchain&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">content_type</span><span class="o">=</span><span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_CALL</span><span class="p">],</span>
            <span class="n">event</span><span class="o">=</span><span class="n">Event</span><span class="o">.</span><span class="n">TOOL_EXECUTION</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">PROGRESS</span>
        <span class="n">event</span><span class="o">.</span><span class="n">node_name</span> <span class="o">=</span> <span class="s2">&quot;ToolNode&quot;</span>
        <span class="n">event</span><span class="o">.</span><span class="n">sequence_id</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="n">input_data</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">args</span><span class="p">}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">safe_serialize</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">obj</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span><span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">obj</span><span class="p">}</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">OverflowError</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;model_dump&quot;</span><span class="p">):</span>
                    <span class="n">dumped</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dumped</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dumped</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;resource&quot;</span><span class="p">:</span>
                        <span class="n">resource</span> <span class="o">=</span> <span class="n">dumped</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resource&quot;</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;uri&quot;</span> <span class="ow">in</span> <span class="n">resource</span><span class="p">:</span>
                            <span class="n">resource</span><span class="p">[</span><span class="s2">&quot;uri&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="p">[</span><span class="s2">&quot;uri&quot;</span><span class="p">])</span>
                            <span class="n">dumped</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resource</span>
                    <span class="k">return</span> <span class="n">dumped</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;fallback&quot;</span><span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">input_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">callback_mgr</span><span class="o">.</span><span class="n">execute_before_invoke</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">UPDATE</span>
            <span class="n">event</span><span class="o">.</span><span class="n">sequence_id</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;before_invoke_complete Invoke LangChain&quot;</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_langchain</span><span class="p">:</span>
                <span class="n">error_result</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="n">tool_message</span><span class="p">(</span>
                    <span class="n">content</span><span class="o">=</span><span class="p">[</span>
                        <span class="n">ErrorBlock</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;LangChain adapter not configured&quot;</span><span class="p">),</span>
                        <span class="n">ToolResultBlock</span><span class="p">(</span>
                            <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                            <span class="n">output</span><span class="o">=</span><span class="s2">&quot;LangChain adapter not configured&quot;</span><span class="p">,</span>
                            <span class="n">status</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">,</span>
                            <span class="n">is_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">],</span>
                    <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">ERROR</span>
                <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;LangChain adapter not configured&quot;</span>
                <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">error_result</span>

            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_langchain</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="n">input_data</span><span class="p">)</span>
            <span class="n">successful</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;successful&quot;</span><span class="p">))</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>

            <span class="n">result_blocks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">error</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">successful</span><span class="p">:</span>
                <span class="n">result_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span>
                        <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                        <span class="n">output</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error</span><span class="p">},</span>
                        <span class="n">status</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">,</span>
                        <span class="n">is_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">result_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ErrorBlock</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">error</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">safe_serialize</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">safe_serialize</span><span class="p">(</span><span class="n">payload</span><span class="p">)]</span>
                <span class="n">result_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span>
                        <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                        <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">,</span>
                        <span class="n">status</span><span class="o">=</span><span class="s2">&quot;completed&quot;</span> <span class="k">if</span> <span class="n">successful</span> <span class="k">else</span> <span class="s2">&quot;failed&quot;</span><span class="p">,</span>
                        <span class="n">is_error</span><span class="o">=</span><span class="ow">not</span> <span class="n">successful</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="n">tool_message</span><span class="p">(</span>
                <span class="n">content</span><span class="o">=</span><span class="n">result_blocks</span><span class="p">,</span>
                <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">res_msg</span> <span class="o">=</span> <span class="k">await</span> <span class="n">callback_mgr</span><span class="o">.</span><span class="n">execute_after_invoke</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;LangChain tool execution complete&quot;</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res_msg</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># pragma: no cover - error path</span>
            <span class="n">recovery_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">callback_mgr</span><span class="o">.</span><span class="n">execute_on_error</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recovery_result</span><span class="p">,</span> <span class="n">Message</span><span class="p">):</span>
                <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
                <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recovery_result</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
                <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;LangChain tool execution complete, with recovery&quot;</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
                <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">recovery_result</span>

            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;LangChain tool execution complete, with error&quot;</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">ERROR</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Message</span><span class="o">.</span><span class="n">tool_message</span><span class="p">(</span>
                <span class="n">content</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span>
                        <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                        <span class="n">output</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;LangChain execution error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">status</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">,</span>
                        <span class="n">is_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">ErrorBlock</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;LangChain execution error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="p">],</span>
                <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">,</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">





<h8 id="pyagenity.graph.tool_node.executors.LangChainMixin-attributes">Attributes<a href="#pyagenity.graph.tool_node.executors.LangChainMixin-attributes" class="headerlink" title="Permanent link">&para;</a></h8>

<div class="doc doc-object doc-attribute">



<h9 id="pyagenity.graph.tool_node.executors.LangChainMixin.langchain_tools" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">langchain_tools</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.tool_node.executors.LangChainMixin.langchain_tools" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">langchain_tools</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>






  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h7 id="pyagenity.graph.tool_node.executors.LocalExecMixin" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">LocalExecMixin</span>


<a href="#pyagenity.graph.tool_node.executors.LocalExecMixin" class="headerlink" title="Permanent link">&para;</a></h7>


    <div class="doc doc-contents ">














              <details class="quote">
                <summary>Source code in <code>pyagenity/graph/tool_node/executors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LocalExecMixin</span><span class="p">:</span>
    <span class="n">_funcs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_input_data_tool</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fn</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">default_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">VAR_POSITIONAL</span><span class="p">,</span>
                <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">VAR_KEYWORD</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="s2">&quot;tool_call_id&quot;</span><span class="p">]:</span>
                <span class="n">input_data</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_data</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="n">INJECTABLE_PARAMS</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">param</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">_empty</span>
                <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="s2">&quot;__class__&quot;</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;Inject&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">default</span><span class="p">)):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="s2">&quot;Skipping injectable parameter &#39;</span><span class="si">%s</span><span class="s2">&#39; with Inject syntax&quot;</span><span class="p">,</span>
                            <span class="n">param_name</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">continue</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c1"># pragma: no cover - defensive</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Inject detection failed for &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="n">input_data</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">param</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required parameter &#39;</span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2">&#39; for function &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">input_data</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_internal_execute</span><span class="p">(</span>  <span class="c1"># noqa: PLR0915</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">tool_call_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
        <span class="n">callback_mgr</span><span class="p">:</span> <span class="n">CallbackManager</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Message</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">CallbackContext</span><span class="p">(</span>
            <span class="n">invocation_type</span><span class="o">=</span><span class="n">InvocationType</span><span class="o">.</span><span class="n">TOOL</span><span class="p">,</span>
            <span class="n">node_name</span><span class="o">=</span><span class="s2">&quot;ToolNode&quot;</span><span class="p">,</span>
            <span class="n">function_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call_id</span><span class="p">,</span> <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_input_data_tool</span><span class="p">(</span>
            <span class="n">fn</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">,</span>
                <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;function_name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;function_argument&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
            <span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call_id</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">event</span> <span class="o">=</span> <span class="n">EventModel</span><span class="o">.</span><span class="n">default</span><span class="p">(</span>
            <span class="n">base_config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
                <span class="s2">&quot;function_name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;is_mcp&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">content_type</span><span class="o">=</span><span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_CALL</span><span class="p">],</span>
            <span class="n">event</span><span class="o">=</span><span class="n">Event</span><span class="o">.</span><span class="n">TOOL_EXECUTION</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">PROGRESS</span>
        <span class="n">event</span><span class="o">.</span><span class="n">node_name</span> <span class="o">=</span> <span class="s2">&quot;ToolNode&quot;</span>
        <span class="n">event</span><span class="o">.</span><span class="n">sequence_id</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">safe_serialize</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">obj</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span><span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">obj</span><span class="p">}</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">OverflowError</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;model_dump&quot;</span><span class="p">):</span>
                    <span class="n">dumped</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dumped</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dumped</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;resource&quot;</span><span class="p">:</span>
                        <span class="n">resource</span> <span class="o">=</span> <span class="n">dumped</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resource&quot;</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;uri&quot;</span> <span class="ow">in</span> <span class="n">resource</span><span class="p">:</span>
                            <span class="n">resource</span><span class="p">[</span><span class="s2">&quot;uri&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="p">[</span><span class="s2">&quot;uri&quot;</span><span class="p">])</span>
                            <span class="n">dumped</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resource</span>
                    <span class="k">return</span> <span class="n">dumped</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;fallback&quot;</span><span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">input_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">callback_mgr</span><span class="o">.</span><span class="n">execute_before_invoke</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>

            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">UPDATE</span>
            <span class="n">event</span><span class="o">.</span><span class="n">sequence_id</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;before_invoke_complete Invoke internal&quot;</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_sync_or_async</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">input_data</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">callback_mgr</span><span class="o">.</span><span class="n">execute_after_invoke</span><span class="p">(</span>
                <span class="n">context</span><span class="p">,</span>
                <span class="n">input_data</span><span class="p">,</span>
                <span class="n">result</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Message</span><span class="p">):</span>
                <span class="n">meta_data</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">meta_data</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">meta</span>

                <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
                <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
                <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Internal tool execution complete&quot;</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
                <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">result</span>

            <span class="n">result_blocks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">result_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span>
                        <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                        <span class="n">output</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
                        <span class="n">status</span><span class="o">=</span><span class="s2">&quot;completed&quot;</span><span class="p">,</span>
                        <span class="n">is_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">result_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span>
                        <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                        <span class="n">output</span><span class="o">=</span><span class="p">[</span><span class="n">safe_serialize</span><span class="p">(</span><span class="n">result</span><span class="p">)],</span>
                        <span class="n">status</span><span class="o">=</span><span class="s2">&quot;completed&quot;</span><span class="p">,</span>
                        <span class="n">is_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;model_dump&quot;</span><span class="p">):</span>
                <span class="n">result_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span>
                        <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                        <span class="n">output</span><span class="o">=</span><span class="p">[</span><span class="n">safe_serialize</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())],</span>
                        <span class="n">status</span><span class="o">=</span><span class="s2">&quot;completed&quot;</span><span class="p">,</span>
                        <span class="n">is_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;__dict__&quot;</span><span class="p">):</span>
                <span class="n">result_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span>
                        <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                        <span class="n">output</span><span class="o">=</span><span class="p">[</span><span class="n">safe_serialize</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)],</span>
                        <span class="n">status</span><span class="o">=</span><span class="s2">&quot;completed&quot;</span><span class="p">,</span>
                        <span class="n">is_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">safe_serialize</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span>
                <span class="n">result_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span>
                        <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                        <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">,</span>
                        <span class="n">status</span><span class="o">=</span><span class="s2">&quot;completed&quot;</span><span class="p">,</span>
                        <span class="n">is_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span>
                        <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                        <span class="n">output</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">),</span>
                        <span class="n">status</span><span class="o">=</span><span class="s2">&quot;completed&quot;</span><span class="p">,</span>
                        <span class="n">is_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="n">tool_message</span><span class="p">(</span>
                <span class="n">content</span><span class="o">=</span><span class="n">result_blocks</span><span class="p">,</span>
                <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Internal tool execution complete&quot;</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">msg</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># pragma: no cover - error path</span>
            <span class="n">recovery_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">callback_mgr</span><span class="o">.</span><span class="n">execute_on_error</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recovery_result</span><span class="p">,</span> <span class="n">Message</span><span class="p">):</span>
                <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
                <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recovery_result</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
                <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Internal tool execution complete, with recovery&quot;</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
                <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">recovery_result</span>

            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Internal tool execution complete, with error&quot;</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">ERROR</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">Message</span><span class="o">.</span><span class="n">tool_message</span><span class="p">(</span>
                <span class="n">content</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span>
                        <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                        <span class="n">output</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Internal execution error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">status</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">,</span>
                        <span class="n">is_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">ErrorBlock</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Internal execution error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="p">],</span>
                <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">,</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h7 id="pyagenity.graph.tool_node.executors.MCPMixin" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">MCPMixin</span>


<a href="#pyagenity.graph.tool_node.executors.MCPMixin" class="headerlink" title="Permanent link">&para;</a></h7>


    <div class="doc doc-contents ">















<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            mcp_tools


  
      instance-attribute
   (pyagenity.graph.tool_node.executors.MCPMixin.mcp_tools)" href="../#pyagenity.graph.tool_node.executors.MCPMixin.mcp_tools">mcp_tools</a></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>pyagenity/graph/tool_node/executors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MCPMixin</span><span class="p">:</span>
    <span class="n">_client</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="c1"># The concrete ToolNode defines this</span>
    <span class="n">mcp_tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>  <span class="c1"># type: ignore[assignment]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_serialize_result</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tool_call_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">res</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">ContentBlock</span><span class="p">]:</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">safe_serialize</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">obj</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span><span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">obj</span><span class="p">}</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">OverflowError</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;model_dump&quot;</span><span class="p">):</span>
                    <span class="n">dumped</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dumped</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dumped</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;resource&quot;</span><span class="p">:</span>
                        <span class="n">resource</span> <span class="o">=</span> <span class="n">dumped</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resource&quot;</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;uri&quot;</span> <span class="ow">in</span> <span class="n">resource</span><span class="p">:</span>
                            <span class="n">resource</span><span class="p">[</span><span class="s2">&quot;uri&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">resource</span><span class="p">[</span><span class="s2">&quot;uri&quot;</span><span class="p">])</span>
                            <span class="n">dumped</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resource</span>
                    <span class="k">return</span> <span class="n">dumped</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;fallback&quot;</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s2">&quot;structured_content&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">safe_serialize</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">source</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">safe_serialize</span><span class="p">(</span><span class="n">source</span><span class="p">)]</span>

                <span class="k">return</span> <span class="p">[</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span>
                        <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                        <span class="n">output</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
                        <span class="n">is_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">status</span><span class="o">=</span><span class="s2">&quot;completed&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># pragma: no cover - defensive</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Serialization failure: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="n">ToolResultBlock</span><span class="p">(</span>
                <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">),</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;fallback&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">],</span>
                <span class="n">is_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s2">&quot;completed&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_get_mcp_tool</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
        <span class="n">tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">ping</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">tools</span>
                <span class="n">mcp_tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">list_tools</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mcp_tools</span><span class="p">:</span>
                    <span class="c1"># attribute provided by concrete ToolNode</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mcp_tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
                    <span class="n">tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">inputSchema</span><span class="p">,</span>
                            <span class="p">},</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_mcp_execute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">tool_call_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span>
        <span class="n">callback_mgr</span><span class="p">:</span> <span class="n">CallbackManager</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Message</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">CallbackContext</span><span class="p">(</span>
            <span class="n">invocation_type</span><span class="o">=</span><span class="n">InvocationType</span><span class="o">.</span><span class="n">MCP</span><span class="p">,</span>
            <span class="n">node_name</span><span class="o">=</span><span class="s2">&quot;ToolNode&quot;</span><span class="p">,</span>
            <span class="n">function_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
                <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span>
                <span class="s2">&quot;mcp_client&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">),</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;function_name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;function_argument&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
            <span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call_id</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">event</span> <span class="o">=</span> <span class="n">EventModel</span><span class="o">.</span><span class="n">default</span><span class="p">(</span>
            <span class="n">base_config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call_id</span><span class="p">,</span>
                <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
                <span class="s2">&quot;function_name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;is_mcp&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">content_type</span><span class="o">=</span><span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_CALL</span><span class="p">],</span>
            <span class="n">event</span><span class="o">=</span><span class="n">Event</span><span class="o">.</span><span class="n">TOOL_EXECUTION</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">PROGRESS</span>
        <span class="n">event</span><span class="o">.</span><span class="n">node_name</span> <span class="o">=</span> <span class="s2">&quot;ToolNode&quot;</span>
        <span class="n">event</span><span class="o">.</span><span class="n">sequence_id</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="n">input_data</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">args</span><span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">input_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">callback_mgr</span><span class="o">.</span><span class="n">execute_before_invoke</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">UPDATE</span>
            <span class="n">event</span><span class="o">.</span><span class="n">sequence_id</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;before_invoke_complete Invoke MCP&quot;</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span>
                <span class="n">error_result</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="n">tool_message</span><span class="p">(</span>
                    <span class="n">content</span><span class="o">=</span><span class="p">[</span>
                        <span class="n">ErrorBlock</span><span class="p">(</span>
                            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No MCP client configured&quot;</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">ToolResultBlock</span><span class="p">(</span>
                            <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                            <span class="n">output</span><span class="o">=</span><span class="s2">&quot;No MCP client configured&quot;</span><span class="p">,</span>
                            <span class="n">is_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">status</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">],</span>
                    <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">callback_mgr</span><span class="o">.</span><span class="n">execute_after_invoke</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">error_result</span><span class="p">)</span>
                <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">ERROR</span>
                <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;No MCP client configured&quot;</span>
                <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">res</span>

            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">ping</span><span class="p">():</span>
                    <span class="n">error_result</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="n">tool_message</span><span class="p">(</span>
                        <span class="n">content</span><span class="o">=</span><span class="p">[</span>
                            <span class="n">ErrorBlock</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;MCP Server not available. Ping failed.&quot;</span><span class="p">),</span>
                            <span class="n">ToolResultBlock</span><span class="p">(</span>
                                <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                                <span class="n">output</span><span class="o">=</span><span class="s2">&quot;MCP Server not available. Ping failed.&quot;</span><span class="p">,</span>
                                <span class="n">is_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">status</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">,</span>
                            <span class="p">),</span>
                        <span class="p">],</span>
                        <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">ERROR</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;MCP server not available, ping failed&quot;</span>
                    <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="n">callback_mgr</span><span class="o">.</span><span class="n">execute_after_invoke</span><span class="p">(</span>
                        <span class="n">context</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">error_result</span>
                    <span class="p">)</span>

                <span class="n">res</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">call_tool</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>

                <span class="n">final_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serialize_result</span><span class="p">(</span><span class="n">tool_call_id</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>

                <span class="n">result</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="n">tool_message</span><span class="p">(</span>
                    <span class="n">content</span><span class="o">=</span><span class="n">final_res</span><span class="p">,</span>
                    <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">callback_mgr</span><span class="o">.</span><span class="n">execute_after_invoke</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
                <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
                <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
                <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;MCP tool execution complete&quot;</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
                <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">res</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># pragma: no cover - error path</span>
            <span class="n">recovery_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">callback_mgr</span><span class="o">.</span><span class="n">execute_on_error</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recovery_result</span><span class="p">,</span> <span class="n">Message</span><span class="p">):</span>
                <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
                <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recovery_result</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
                <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;MCP tool execution complete, with recovery&quot;</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
                <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">recovery_result</span>

            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;MCP tool execution complete, with recovery&quot;</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TOOL_RESULT</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">ERROR</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">Message</span><span class="o">.</span><span class="n">tool_message</span><span class="p">(</span>
                <span class="n">content</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">ToolResultBlock</span><span class="p">(</span>
                        <span class="n">call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
                        <span class="n">output</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;MCP execution error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">is_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">status</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">ErrorBlock</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;MCP execution error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="p">],</span>
                <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">,</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">





<h8 id="pyagenity.graph.tool_node.executors.MCPMixin-attributes">Attributes<a href="#pyagenity.graph.tool_node.executors.MCPMixin-attributes" class="headerlink" title="Permanent link">&para;</a></h8>

<div class="doc doc-object doc-attribute">



<h9 id="pyagenity.graph.tool_node.executors.MCPMixin.mcp_tools" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">mcp_tools</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.tool_node.executors.MCPMixin.mcp_tools" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">mcp_tools</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>






  </div>

    </div>

</div>
<h6 id="pyagenity.graph.tool_node.executors-functions">Functions<a href="#pyagenity.graph.tool_node.executors-functions" class="headerlink" title="Permanent link">&para;</a></h6>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="pyagenity.graph.tool_node.schema" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">schema</span>


<a href="#pyagenity.graph.tool_node.schema" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

        <p>Schema utilities and local tool description building for ToolNode.</p>
<p>This module provides the SchemaMixin class which handles automatic schema generation
for local Python functions, converting their type annotations and signatures into
OpenAI-compatible function schemas. It supports various Python types including
primitives, Optional types, List types, and Literal enums.</p>
<p>The schema generation process inspects function signatures and converts them to
JSON Schema format suitable for use with language models and function calling APIs.</p>










<p><span class="doc-section-title">Classes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            SchemaMixin (pyagenity.graph.tool_node.schema.SchemaMixin)" href="../#pyagenity.graph.tool_node.schema.SchemaMixin">SchemaMixin</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Mixin providing schema generation and local tool description building.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







  <div class="doc doc-children">





<h6 id="pyagenity.graph.tool_node.schema-attributes">Attributes<a href="#pyagenity.graph.tool_node.schema-attributes" class="headerlink" title="Permanent link">&para;</a></h6>

<h6 id="pyagenity.graph.tool_node.schema-classes">Classes<a href="#pyagenity.graph.tool_node.schema-classes" class="headerlink" title="Permanent link">&para;</a></h6>

<div class="doc doc-object doc-class">



<h7 id="pyagenity.graph.tool_node.schema.SchemaMixin" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">SchemaMixin</span>


<a href="#pyagenity.graph.tool_node.schema.SchemaMixin" class="headerlink" title="Permanent link">&para;</a></h7>


    <div class="doc doc-contents ">


        <p>Mixin providing schema generation and local tool description building.</p>
<p>This mixin provides functionality to automatically generate JSON Schema definitions
from Python function signatures. It handles type annotation conversion, parameter
analysis, and OpenAI-compatible function schema generation for local tools.</p>
<p>The mixin is designed to be used with ToolNode to automatically generate tool
schemas without requiring manual schema definition for Python functions.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.tool_node.schema.SchemaMixin._funcs">_funcs</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Callable">Callable</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping function names to callable functions. This
attribute is expected to be provided by the mixing class.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>












<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            get_local_tool (pyagenity.graph.tool_node.schema.SchemaMixin.get_local_tool)" href="../#pyagenity.graph.tool_node.schema.SchemaMixin.get_local_tool">get_local_tool</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Generate OpenAI-compatible tool definitions for all registered local functions.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>



              <details class="quote">
                <summary>Source code in <code>pyagenity/graph/tool_node/schema.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SchemaMixin</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mixin providing schema generation and local tool description building.</span>

<span class="sd">    This mixin provides functionality to automatically generate JSON Schema definitions</span>
<span class="sd">    from Python function signatures. It handles type annotation conversion, parameter</span>
<span class="sd">    analysis, and OpenAI-compatible function schema generation for local tools.</span>

<span class="sd">    The mixin is designed to be used with ToolNode to automatically generate tool</span>
<span class="sd">    schemas without requiring manual schema definition for Python functions.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        _funcs: Dictionary mapping function names to callable functions. This</span>
<span class="sd">            attribute is expected to be provided by the mixing class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_funcs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_optional_annotation</span><span class="p">(</span><span class="n">annotation</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle Optional type annotations and convert them to appropriate schemas.</span>

<span class="sd">        Processes Optional[T] type annotations (Union[T, None]) and generates</span>
<span class="sd">        schema for the non-None type. This method handles the common pattern</span>
<span class="sd">        of optional parameters in function signatures.</span>

<span class="sd">        Args:</span>
<span class="sd">            annotation: The type annotation to process, potentially an Optional type.</span>
<span class="sd">            default: The default value for the parameter, used for schema generation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary containing the JSON schema for the non-None type if the</span>
<span class="sd">            annotation is Optional, None otherwise.</span>

<span class="sd">        Example:</span>
<span class="sd">            Optional[str] -&gt; {&quot;type&quot;: &quot;string&quot;}</span>
<span class="sd">            Optional[int] -&gt; {&quot;type&quot;: &quot;integer&quot;}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="s2">&quot;__args__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">a</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
            <span class="n">non_none</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">non_none</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">SchemaMixin</span><span class="o">.</span><span class="n">_annotation_to_schema</span><span class="p">(</span><span class="n">non_none</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">default</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_complex_annotation</span><span class="p">(</span><span class="n">annotation</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle complex type annotations like List, Literal, and generic types.</span>

<span class="sd">        Processes generic type annotations that aren&#39;t simple primitive types,</span>
<span class="sd">        including container types like List and special types like Literal enums.</span>
<span class="sd">        Falls back to string type for unrecognized complex types.</span>

<span class="sd">        Args:</span>
<span class="sd">            annotation: The complex type annotation to process (e.g., List[str],</span>
<span class="sd">                Literal[&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary containing the appropriate JSON schema for the complex type.</span>
<span class="sd">            For List types, returns array schema with item type.</span>
<span class="sd">            For Literal types, returns enum schema with allowed values.</span>
<span class="sd">            For unknown types, returns string type as fallback.</span>

<span class="sd">        Example:</span>
<span class="sd">            List[str] -&gt; {&quot;type&quot;: &quot;array&quot;, &quot;items&quot;: {&quot;type&quot;: &quot;string&quot;}}</span>
<span class="sd">            Literal[&quot;red&quot;, &quot;green&quot;] -&gt; {&quot;type&quot;: &quot;string&quot;, &quot;enum&quot;: [&quot;red&quot;, &quot;green&quot;]}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="s2">&quot;__origin__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">item_type</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="s2">&quot;__args__&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">item_schema</span> <span class="o">=</span> <span class="n">SchemaMixin</span><span class="o">.</span><span class="n">_annotation_to_schema</span><span class="p">(</span><span class="n">item_type</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="n">item_schema</span><span class="p">}</span>

        <span class="n">Literal</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s2">&quot;Literal&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Literal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">Literal</span><span class="p">:</span>
            <span class="n">literals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="s2">&quot;__args__&quot;</span><span class="p">,</span> <span class="p">()))</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">literal</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">literal</span> <span class="ow">in</span> <span class="n">literals</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;enum&quot;</span><span class="p">:</span> <span class="n">literals</span><span class="p">}</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;enum&quot;</span><span class="p">:</span> <span class="n">literals</span><span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_annotation_to_schema</span><span class="p">(</span><span class="n">annotation</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert a Python type annotation to JSON Schema format.</span>

<span class="sd">        Main entry point for type annotation conversion. Handles both simple</span>
<span class="sd">        and complex types by delegating to appropriate helper methods.</span>
<span class="sd">        Includes default value handling when present.</span>

<span class="sd">        Args:</span>
<span class="sd">            annotation: The Python type annotation to convert (e.g., str, int,</span>
<span class="sd">                Optional[str], List[int]).</span>
<span class="sd">            default: The default value for the parameter, included in schema</span>
<span class="sd">                if not inspect._empty.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary containing the JSON schema representation of the type</span>
<span class="sd">            annotation, including default values where applicable.</span>

<span class="sd">        Example:</span>
<span class="sd">            str -&gt; {&quot;type&quot;: &quot;string&quot;}</span>
<span class="sd">            int -&gt; {&quot;type&quot;: &quot;integer&quot;}</span>
<span class="sd">            str with default &quot;hello&quot; -&gt; {&quot;type&quot;: &quot;string&quot;, &quot;default&quot;: &quot;hello&quot;}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">SchemaMixin</span><span class="o">.</span><span class="n">_handle_optional_annotation</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">schema</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">schema</span>

        <span class="n">primitive_mappings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nb">str</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
            <span class="nb">int</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;integer&quot;</span><span class="p">},</span>
            <span class="nb">float</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;number&quot;</span><span class="p">},</span>
            <span class="nb">bool</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span><span class="p">},</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">primitive_mappings</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="n">primitive_mappings</span><span class="p">[</span><span class="n">annotation</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="n">SchemaMixin</span><span class="o">.</span><span class="n">_handle_complex_annotation</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">_empty</span><span class="p">:</span>
            <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">default</span>

        <span class="k">return</span> <span class="n">schema</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_local_tool</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate OpenAI-compatible tool definitions for all registered local functions.</span>

<span class="sd">        Inspects all registered functions in _funcs and automatically generates</span>
<span class="sd">        tool schemas by analyzing function signatures, type annotations, and docstrings.</span>
<span class="sd">        Excludes injectable parameters that are provided by the framework.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of tool definitions in OpenAI function calling format. Each</span>
<span class="sd">            definition includes the function name, description (from docstring),</span>
<span class="sd">            and complete parameter schema with types and required fields.</span>

<span class="sd">        Example:</span>
<span class="sd">            For a function:</span>
<span class="sd">            ```python</span>
<span class="sd">            def calculate(a: int, b: int, operation: str = &quot;add&quot;) -&gt; int:</span>
<span class="sd">                &#39;&#39;&#39;Perform arithmetic calculation.&#39;&#39;&#39;</span>
<span class="sd">                return a + b if operation == &quot;add&quot; else a - b</span>
<span class="sd">            ```</span>

<span class="sd">            Returns:</span>
<span class="sd">            ```python</span>
<span class="sd">            [</span>
<span class="sd">                {</span>
<span class="sd">                    &quot;type&quot;: &quot;function&quot;,</span>
<span class="sd">                    &quot;function&quot;: {</span>
<span class="sd">                        &quot;name&quot;: &quot;calculate&quot;,</span>
<span class="sd">                        &quot;description&quot;: &quot;Perform arithmetic calculation.&quot;,</span>
<span class="sd">                        &quot;parameters&quot;: {</span>
<span class="sd">                            &quot;type&quot;: &quot;object&quot;,</span>
<span class="sd">                            &quot;properties&quot;: {</span>
<span class="sd">                                &quot;a&quot;: {&quot;type&quot;: &quot;integer&quot;},</span>
<span class="sd">                                &quot;b&quot;: {&quot;type&quot;: &quot;integer&quot;},</span>
<span class="sd">                                &quot;operation&quot;: {&quot;type&quot;: &quot;string&quot;, &quot;default&quot;: &quot;add&quot;},</span>
<span class="sd">                            },</span>
<span class="sd">                            &quot;required&quot;: [&quot;a&quot;, &quot;b&quot;],</span>
<span class="sd">                        },</span>
<span class="sd">                    },</span>
<span class="sd">                }</span>
<span class="sd">            ]</span>
<span class="sd">            ```</span>

<span class="sd">        Note:</span>
<span class="sd">            Parameters listed in INJECTABLE_PARAMS (like &#39;state&#39;, &#39;config&#39;,</span>
<span class="sd">            &#39;tool_call_id&#39;) are automatically excluded from the generated schema</span>
<span class="sd">            as they are provided by the framework during execution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="n">params_schema</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[]}</span>

            <span class="k">for</span> <span class="n">p_name</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">VAR_POSITIONAL</span><span class="p">,</span>
                    <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">VAR_KEYWORD</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="n">INJECTABLE_PARAMS</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">annotation</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">annotation</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">_empty</span> <span class="k">else</span> <span class="nb">str</span>
                <span class="n">prop</span> <span class="o">=</span> <span class="n">SchemaMixin</span><span class="o">.</span><span class="n">_annotation_to_schema</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>
                <span class="n">params_schema</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="n">p_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">prop</span>

                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="n">inspect</span><span class="o">.</span><span class="n">_empty</span><span class="p">:</span>
                    <span class="n">params_schema</span><span class="p">[</span><span class="s2">&quot;required&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">params_schema</span><span class="p">[</span><span class="s2">&quot;required&quot;</span><span class="p">]:</span>
                <span class="n">params_schema</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;required&quot;</span><span class="p">)</span>

            <span class="n">description</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;No description provided.&quot;</span>

            <span class="c1"># provider = getattr(fn, &quot;_py_tool_provider&quot;, None)</span>
            <span class="c1"># tags = getattr(fn, &quot;_py_tool_tags&quot;, None)</span>
            <span class="c1"># capabilities = getattr(fn, &quot;_py_tool_capabilities&quot;, None)</span>

            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
                <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
                    <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">params_schema</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">}</span>
            <span class="c1"># meta: dict[str, t.Any] = {}</span>
            <span class="c1"># if provider:</span>
            <span class="c1">#     meta[&quot;provider&quot;] = provider</span>
            <span class="c1"># if tags:</span>
            <span class="c1">#     meta[&quot;tags&quot;] = tags</span>
            <span class="c1"># if capabilities:</span>
            <span class="c1">#     meta[&quot;capabilities&quot;] = capabilities</span>
            <span class="c1"># if meta:</span>
            <span class="c1">#     entry[&quot;x-pyagenity&quot;] = meta</span>

            <span class="n">tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tools</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">








<h8 id="pyagenity.graph.tool_node.schema.SchemaMixin-functions">Functions<a href="#pyagenity.graph.tool_node.schema.SchemaMixin-functions" class="headerlink" title="Permanent link">&para;</a></h8>

<div class="doc doc-object doc-function">


<h9 id="pyagenity.graph.tool_node.schema.SchemaMixin.get_local_tool" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">get_local_tool</span>


<a href="#pyagenity.graph.tool_node.schema.SchemaMixin.get_local_tool" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_local_tool</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Generate OpenAI-compatible tool definitions for all registered local functions.</p>
<p>Inspects all registered functions in _funcs and automatically generates
tool schemas by analyzing function signatures, type annotations, and docstrings.
Excludes injectable parameters that are provided by the framework.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of tool definitions in OpenAI function calling format. Each</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>definition includes the function name, description (from docstring),</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>and complete parameter schema with types and required fields.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>For a function:
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">operation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;add&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Perform arithmetic calculation.&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;add&quot;</span> <span class="k">else</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span>
</code></pre></div></p>
<p>Returns:
<div class="highlight"><pre><span></span><code><span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
        <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;calculate&quot;</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Perform arithmetic calculation.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;integer&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;integer&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;operation&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;add&quot;</span><span class="p">},</span>
                <span class="p">},</span>
                <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">],</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">}</span>
<span class="p">]</span>
</code></pre></div></p>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>Parameters listed in INJECTABLE_PARAMS (like 'state', 'config',
'tool_call_id') are automatically excluded from the generated schema
as they are provided by the framework during execution.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/tool_node/schema.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_local_tool</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate OpenAI-compatible tool definitions for all registered local functions.</span>

<span class="sd">    Inspects all registered functions in _funcs and automatically generates</span>
<span class="sd">    tool schemas by analyzing function signatures, type annotations, and docstrings.</span>
<span class="sd">    Excludes injectable parameters that are provided by the framework.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of tool definitions in OpenAI function calling format. Each</span>
<span class="sd">        definition includes the function name, description (from docstring),</span>
<span class="sd">        and complete parameter schema with types and required fields.</span>

<span class="sd">    Example:</span>
<span class="sd">        For a function:</span>
<span class="sd">        ```python</span>
<span class="sd">        def calculate(a: int, b: int, operation: str = &quot;add&quot;) -&gt; int:</span>
<span class="sd">            &#39;&#39;&#39;Perform arithmetic calculation.&#39;&#39;&#39;</span>
<span class="sd">            return a + b if operation == &quot;add&quot; else a - b</span>
<span class="sd">        ```</span>

<span class="sd">        Returns:</span>
<span class="sd">        ```python</span>
<span class="sd">        [</span>
<span class="sd">            {</span>
<span class="sd">                &quot;type&quot;: &quot;function&quot;,</span>
<span class="sd">                &quot;function&quot;: {</span>
<span class="sd">                    &quot;name&quot;: &quot;calculate&quot;,</span>
<span class="sd">                    &quot;description&quot;: &quot;Perform arithmetic calculation.&quot;,</span>
<span class="sd">                    &quot;parameters&quot;: {</span>
<span class="sd">                        &quot;type&quot;: &quot;object&quot;,</span>
<span class="sd">                        &quot;properties&quot;: {</span>
<span class="sd">                            &quot;a&quot;: {&quot;type&quot;: &quot;integer&quot;},</span>
<span class="sd">                            &quot;b&quot;: {&quot;type&quot;: &quot;integer&quot;},</span>
<span class="sd">                            &quot;operation&quot;: {&quot;type&quot;: &quot;string&quot;, &quot;default&quot;: &quot;add&quot;},</span>
<span class="sd">                        },</span>
<span class="sd">                        &quot;required&quot;: [&quot;a&quot;, &quot;b&quot;],</span>
<span class="sd">                    },</span>
<span class="sd">                },</span>
<span class="sd">            }</span>
<span class="sd">        ]</span>
<span class="sd">        ```</span>

<span class="sd">    Note:</span>
<span class="sd">        Parameters listed in INJECTABLE_PARAMS (like &#39;state&#39;, &#39;config&#39;,</span>
<span class="sd">        &#39;tool_call_id&#39;) are automatically excluded from the generated schema</span>
<span class="sd">        as they are provided by the framework during execution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">params_schema</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="k">for</span> <span class="n">p_name</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">VAR_POSITIONAL</span><span class="p">,</span>
                <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">VAR_KEYWORD</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="n">INJECTABLE_PARAMS</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">annotation</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">annotation</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">_empty</span> <span class="k">else</span> <span class="nb">str</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="n">SchemaMixin</span><span class="o">.</span><span class="n">_annotation_to_schema</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>
            <span class="n">params_schema</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="n">p_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">prop</span>

            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="n">inspect</span><span class="o">.</span><span class="n">_empty</span><span class="p">:</span>
                <span class="n">params_schema</span><span class="p">[</span><span class="s2">&quot;required&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">params_schema</span><span class="p">[</span><span class="s2">&quot;required&quot;</span><span class="p">]:</span>
            <span class="n">params_schema</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;required&quot;</span><span class="p">)</span>

        <span class="n">description</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;No description provided.&quot;</span>

        <span class="c1"># provider = getattr(fn, &quot;_py_tool_provider&quot;, None)</span>
        <span class="c1"># tags = getattr(fn, &quot;_py_tool_tags&quot;, None)</span>
        <span class="c1"># capabilities = getattr(fn, &quot;_py_tool_capabilities&quot;, None)</span>

        <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">params_schema</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="c1"># meta: dict[str, t.Any] = {}</span>
        <span class="c1"># if provider:</span>
        <span class="c1">#     meta[&quot;provider&quot;] = provider</span>
        <span class="c1"># if tags:</span>
        <span class="c1">#     meta[&quot;tags&quot;] = tags</span>
        <span class="c1"># if capabilities:</span>
        <span class="c1">#     meta[&quot;capabilities&quot;] = capabilities</span>
        <span class="c1"># if meta:</span>
        <span class="c1">#     entry[&quot;x-pyagenity&quot;] = meta</span>

        <span class="n">tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tools</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="pyagenity.graph.utils" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">utils</span>


<a href="#pyagenity.graph.utils" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">






<p><span class="doc-section-title">Modules:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            handler_mixins (pyagenity.graph.utils.handler_mixins)" href="../#pyagenity.graph.utils.handler_mixins">handler_mixins</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Shared mixins for graph and node handler classes.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            invoke_handler (pyagenity.graph.utils.invoke_handler)" href="../#pyagenity.graph.utils.invoke_handler">invoke_handler</a></code></td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            invoke_node_handler (pyagenity.graph.utils.invoke_node_handler)" href="../#pyagenity.graph.utils.invoke_node_handler">invoke_node_handler</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>InvokeNodeHandler utilities for PyAgenity agent graph execution.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            stream_handler (pyagenity.graph.utils.stream_handler)" href="../#pyagenity.graph.utils.stream_handler">stream_handler</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Streaming graph execution handler for PyAgenity workflows.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            stream_node_handler (pyagenity.graph.utils.stream_node_handler)" href="../#pyagenity.graph.utils.stream_node_handler">stream_node_handler</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Streaming node handler for PyAgenity graph workflows.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            stream_utils (pyagenity.graph.utils.stream_utils)" href="../#pyagenity.graph.utils.stream_utils">stream_utils</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Streaming utility functions for PyAgenity graph workflows.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            utils (pyagenity.graph.utils.utils)" href="../#pyagenity.graph.utils.utils">utils</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Core utility functions for graph execution and state management.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>











  <div class="doc doc-children">









<h4 id="pyagenity.graph.utils-modules">Modules<a href="#pyagenity.graph.utils-modules" class="headerlink" title="Permanent link">&para;</a></h4>

<div class="doc doc-object doc-module">



<h5 id="pyagenity.graph.utils.handler_mixins" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">handler_mixins</span>


<a href="#pyagenity.graph.utils.handler_mixins" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

        <p>Shared mixins for graph and node handler classes.</p>
<p>This module provides lightweight mixins that add common functionality to handler
classes without changing their core runtime behavior. The mixins follow the
composition pattern to keep responsibilities explicit and allow handlers to
inherit only the capabilities they need.</p>
<p>The mixins provide structured logging, configuration management, and other
cross-cutting concerns that are commonly needed across different handler types.
By using mixins, the core handler logic remains focused while gaining these
shared capabilities.</p>


<details class="typical-usage" open>
  <summary>Typical usage</summary>
  <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MyHandler</span><span class="p">(</span><span class="n">BaseLoggingMixin</span><span class="p">,</span> <span class="n">InterruptConfigMixin</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_interrupts</span><span class="p">([</span><span class="s2">&quot;node1&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;node2&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_start</span><span class="p">(</span><span class="s2">&quot;Handler initialized&quot;</span><span class="p">)</span>
</code></pre></div>
</details>









<p><span class="doc-section-title">Classes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            BaseLoggingMixin (pyagenity.graph.utils.handler_mixins.BaseLoggingMixin)" href="../#pyagenity.graph.utils.handler_mixins.BaseLoggingMixin">BaseLoggingMixin</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Provides structured logging helpers for handler classes.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            InterruptConfigMixin (pyagenity.graph.utils.handler_mixins.InterruptConfigMixin)" href="../#pyagenity.graph.utils.handler_mixins.InterruptConfigMixin">InterruptConfigMixin</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Manages interrupt configuration for graph-level execution handlers.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







  <div class="doc doc-children">







<h6 id="pyagenity.graph.utils.handler_mixins-classes">Classes<a href="#pyagenity.graph.utils.handler_mixins-classes" class="headerlink" title="Permanent link">&para;</a></h6>

<div class="doc doc-object doc-class">



<h7 id="pyagenity.graph.utils.handler_mixins.BaseLoggingMixin" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">BaseLoggingMixin</span>


<a href="#pyagenity.graph.utils.handler_mixins.BaseLoggingMixin" class="headerlink" title="Permanent link">&para;</a></h7>


    <div class="doc doc-contents ">


        <p>Provides structured logging helpers for handler classes.</p>
<p>This mixin adds consistent logging capabilities to handler classes without
requiring them to manage logger instances directly. It automatically creates
loggers based on the module name and provides convenience methods for
common logging operations.</p>
<p>The mixin is designed to be lightweight and non-intrusive, adding only
logging functionality without affecting the core behavior of the handler.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="pyagenity.graph.utils.handler_mixins.BaseLoggingMixin._logger">_logger</span></code></td>
            <td>
                  <code><span title="logging.Logger">Logger</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Cached logger instance for the handler class.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MyHandler</span><span class="p">(</span><span class="n">BaseLoggingMixin</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_start</span><span class="p">(</span><span class="s2">&quot;Processing started&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Do work</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_debug</span><span class="p">(</span><span class="s2">&quot;Work completed successfully&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="s2">&quot;Processing failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</code></pre></div>
</details>












              <details class="quote">
                <summary>Source code in <code>pyagenity/graph/utils/handler_mixins.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BaseLoggingMixin</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provides structured logging helpers for handler classes.</span>

<span class="sd">    This mixin adds consistent logging capabilities to handler classes without</span>
<span class="sd">    requiring them to manage logger instances directly. It automatically creates</span>
<span class="sd">    loggers based on the module name and provides convenience methods for</span>
<span class="sd">    common logging operations.</span>

<span class="sd">    The mixin is designed to be lightweight and non-intrusive, adding only</span>
<span class="sd">    logging functionality without affecting the core behavior of the handler.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        _logger: Cached logger instance for the handler class.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        class MyHandler(BaseLoggingMixin):</span>
<span class="sd">            def process(self):</span>
<span class="sd">                self._log_start(&quot;Processing started&quot;)</span>
<span class="sd">                try:</span>
<span class="sd">                    # Do work</span>
<span class="sd">                    self._log_debug(&quot;Work completed successfully&quot;)</span>
<span class="sd">                except Exception as e:</span>
<span class="sd">                    self._log_error(&quot;Processing failed: %s&quot;, e)</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get or create a logger instance for this handler.</span>

<span class="sd">        Creates a logger using the handler&#39;s module name, providing consistent</span>
<span class="sd">        logging across different handler instances while maintaining proper</span>
<span class="sd">        logger hierarchy and configuration.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Logger instance configured for this handler&#39;s module.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;__module__&quot;</span><span class="p">,</span> <span class="vm">__name__</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_log_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log an informational message for process start/initialization.</span>

<span class="sd">        Args:</span>
<span class="sd">            msg: Log message format string.</span>
<span class="sd">            *args: Arguments for message formatting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_log_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log a debug message for detailed execution information.</span>

<span class="sd">        Args:</span>
<span class="sd">            msg: Log message format string.</span>
<span class="sd">            *args: Arguments for message formatting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_log_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log an error message for exceptional conditions.</span>

<span class="sd">        Args:</span>
<span class="sd">            msg: Log message format string.</span>
<span class="sd">            *args: Arguments for message formatting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h7 id="pyagenity.graph.utils.handler_mixins.InterruptConfigMixin" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">InterruptConfigMixin</span>


<a href="#pyagenity.graph.utils.handler_mixins.InterruptConfigMixin" class="headerlink" title="Permanent link">&para;</a></h7>


    <div class="doc doc-contents ">


        <p>Manages interrupt configuration for graph-level execution handlers.</p>
<p>This mixin provides functionality to store and manage interrupt points
configuration for graph execution. Interrupts allow graph execution to be
paused before or after specific nodes for debugging, human intervention,
or checkpoint creation.</p>
<p>The mixin maintains separate lists for "before" and "after" interrupts,
allowing fine-grained control over when graph execution should pause.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            interrupt_before


  
      instance-attribute
   (pyagenity.graph.utils.handler_mixins.InterruptConfigMixin.interrupt_before)" href="../#pyagenity.graph.utils.handler_mixins.InterruptConfigMixin.interrupt_before">interrupt_before</a></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of node names where execution should pause
before node execution begins.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            interrupt_after


  
      instance-attribute
   (pyagenity.graph.utils.handler_mixins.InterruptConfigMixin.interrupt_after)" href="../#pyagenity.graph.utils.handler_mixins.InterruptConfigMixin.interrupt_after">interrupt_after</a></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of node names where execution should pause
after node execution completes.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GraphHandler</span><span class="p">(</span><span class="n">InterruptConfigMixin</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_interrupts</span><span class="p">(</span>
            <span class="n">interrupt_before</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;approval_node&quot;</span><span class="p">],</span> <span class="n">interrupt_after</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;data_processing&quot;</span><span class="p">]</span>
        <span class="p">)</span>
</code></pre></div>
</details>












              <details class="quote">
                <summary>Source code in <code>pyagenity/graph/utils/handler_mixins.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">InterruptConfigMixin</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Manages interrupt configuration for graph-level execution handlers.</span>

<span class="sd">    This mixin provides functionality to store and manage interrupt points</span>
<span class="sd">    configuration for graph execution. Interrupts allow graph execution to be</span>
<span class="sd">    paused before or after specific nodes for debugging, human intervention,</span>
<span class="sd">    or checkpoint creation.</span>

<span class="sd">    The mixin maintains separate lists for &quot;before&quot; and &quot;after&quot; interrupts,</span>
<span class="sd">    allowing fine-grained control over when graph execution should pause.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        interrupt_before: List of node names where execution should pause</span>
<span class="sd">            before node execution begins.</span>
<span class="sd">        interrupt_after: List of node names where execution should pause</span>
<span class="sd">            after node execution completes.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        class GraphHandler(InterruptConfigMixin):</span>
<span class="sd">            def __init__(self):</span>
<span class="sd">                self._set_interrupts(</span>
<span class="sd">                    interrupt_before=[&quot;approval_node&quot;], interrupt_after=[&quot;data_processing&quot;]</span>
<span class="sd">                )</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">interrupt_before</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">interrupt_after</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_interrupts</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">interrupt_before</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">interrupt_after</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Configure interrupt points for graph execution control.</span>

<span class="sd">        Sets up the interrupt configuration for this handler, defining which</span>
<span class="sd">        nodes should trigger execution pauses. This method normalizes None</span>
<span class="sd">        values to empty lists for consistent handling.</span>

<span class="sd">        Args:</span>
<span class="sd">            interrupt_before: List of node names where execution should be</span>
<span class="sd">                interrupted before the node begins execution. Pass None to</span>
<span class="sd">                disable before-interrupts.</span>
<span class="sd">            interrupt_after: List of node names where execution should be</span>
<span class="sd">                interrupted after the node completes execution. Pass None to</span>
<span class="sd">                disable after-interrupts.</span>

<span class="sd">        Note:</span>
<span class="sd">            This method should be called during handler initialization to</span>
<span class="sd">            establish the interrupt configuration before graph execution begins.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interrupt_before</span> <span class="o">=</span> <span class="n">interrupt_before</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interrupt_after</span> <span class="o">=</span> <span class="n">interrupt_after</span> <span class="ow">or</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">





<h8 id="pyagenity.graph.utils.handler_mixins.InterruptConfigMixin-attributes">Attributes<a href="#pyagenity.graph.utils.handler_mixins.InterruptConfigMixin-attributes" class="headerlink" title="Permanent link">&para;</a></h8>

<div class="doc doc-object doc-attribute">



<h9 id="pyagenity.graph.utils.handler_mixins.InterruptConfigMixin.interrupt_after" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">interrupt_after</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.utils.handler_mixins.InterruptConfigMixin.interrupt_after" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">interrupt_after</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h9 id="pyagenity.graph.utils.handler_mixins.InterruptConfigMixin.interrupt_before" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">interrupt_before</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.utils.handler_mixins.InterruptConfigMixin.interrupt_before" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">interrupt_before</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>






  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="pyagenity.graph.utils.invoke_handler" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">invoke_handler</span>


<a href="#pyagenity.graph.utils.invoke_handler" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">










<p><span class="doc-section-title">Classes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            InvokeHandler (pyagenity.graph.utils.invoke_handler.InvokeHandler)" href="../#pyagenity.graph.utils.invoke_handler.InvokeHandler">InvokeHandler</a></code></td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>






<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            StateT


  
      module-attribute
   (pyagenity.graph.utils.invoke_handler.StateT)" href="../#pyagenity.graph.utils.invoke_handler.StateT">StateT</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            logger


  
      module-attribute
   (pyagenity.graph.utils.invoke_handler.logger)" href="../#pyagenity.graph.utils.invoke_handler.logger">logger</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>



  <div class="doc doc-children">





<h6 id="pyagenity.graph.utils.invoke_handler-attributes">Attributes<a href="#pyagenity.graph.utils.invoke_handler-attributes" class="headerlink" title="Permanent link">&para;</a></h6>

<div class="doc doc-object doc-attribute">



<h7 id="pyagenity.graph.utils.invoke_handler.StateT" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">StateT</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#pyagenity.graph.utils.invoke_handler.StateT" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">StateT</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;StateT&#39;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">AgentState</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="pyagenity.graph.utils.invoke_handler.logger" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">logger</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#pyagenity.graph.utils.invoke_handler.logger" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<h6 id="pyagenity.graph.utils.invoke_handler-classes">Classes<a href="#pyagenity.graph.utils.invoke_handler-classes" class="headerlink" title="Permanent link">&para;</a></h6>

<div class="doc doc-object doc-class">



<h7 id="pyagenity.graph.utils.invoke_handler.InvokeHandler" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">InvokeHandler</span>


<a href="#pyagenity.graph.utils.invoke_handler.InvokeHandler" class="headerlink" title="Permanent link">&para;</a></h7>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            BaseLoggingMixin (pyagenity.graph.utils.handler_mixins.BaseLoggingMixin)" href="../#pyagenity.graph.utils.handler_mixins.BaseLoggingMixin">BaseLoggingMixin</a></code>, <code><a class="autorefs autorefs-internal" title="            InterruptConfigMixin (pyagenity.graph.utils.handler_mixins.InterruptConfigMixin)" href="../#pyagenity.graph.utils.handler_mixins.InterruptConfigMixin">InterruptConfigMixin</a></code></p>













<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            __init__ (pyagenity.graph.utils.invoke_handler.InvokeHandler.__init__)" href="../#pyagenity.graph.utils.invoke_handler.InvokeHandler.__init__">__init__</a></code></td>
              <td>
                <div class="doc-md-description">
                  
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            invoke


  
      async
   (pyagenity.graph.utils.invoke_handler.InvokeHandler.invoke)" href="../#pyagenity.graph.utils.invoke_handler.InvokeHandler.invoke">invoke</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Execute the graph asynchronously with event publishing.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>




<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            edges


  
      instance-attribute
   (pyagenity.graph.utils.invoke_handler.InvokeHandler.edges)" href="../#pyagenity.graph.utils.invoke_handler.InvokeHandler.edges">edges</a></code></td>
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="            Edge (pyagenity.graph.edge.Edge)" href="../#pyagenity.graph.edge.Edge">Edge</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            interrupt_after


  
      instance-attribute
   (pyagenity.graph.utils.invoke_handler.InvokeHandler.interrupt_after)" href="../#pyagenity.graph.utils.invoke_handler.InvokeHandler.interrupt_after">interrupt_after</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            interrupt_before


  
      instance-attribute
   (pyagenity.graph.utils.invoke_handler.InvokeHandler.interrupt_before)" href="../#pyagenity.graph.utils.invoke_handler.InvokeHandler.interrupt_before">interrupt_before</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            nodes


  
      instance-attribute
   (pyagenity.graph.utils.invoke_handler.InvokeHandler.nodes)" href="../#pyagenity.graph.utils.invoke_handler.InvokeHandler.nodes">nodes</a></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <a class="autorefs autorefs-internal" title="            Node (pyagenity.graph.node.Node)" href="../#pyagenity.graph.node.Node">Node</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>pyagenity/graph/utils/invoke_handler.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">InvokeHandler</span><span class="p">[</span><span class="n">StateT</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">](</span>
    <span class="n">BaseLoggingMixin</span><span class="p">,</span>
    <span class="n">InterruptConfigMixin</span><span class="p">,</span>
<span class="p">):</span>
    <span class="nd">@inject</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Node</span><span class="p">],</span>
        <span class="n">edges</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Edge</span><span class="p">],</span>
        <span class="n">interrupt_before</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">interrupt_after</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Node</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">edges</span>
        <span class="c1"># Keep existing attributes for backward-compatibility</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interrupt_before</span> <span class="o">=</span> <span class="n">interrupt_before</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interrupt_after</span> <span class="o">=</span> <span class="n">interrupt_after</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="c1"># And set via mixin for a single source of truth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_interrupts</span><span class="p">(</span><span class="n">interrupt_before</span><span class="p">,</span> <span class="n">interrupt_after</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_check_interrupted</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">StateT</span><span class="p">,</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">is_interrupted</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Resuming from interrupted state at node &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span>
            <span class="p">)</span>
            <span class="c1"># This is a resume case - clear interrupt and merge input data</span>
            <span class="k">if</span> <span class="n">input_data</span><span class="p">:</span>
                <span class="n">config</span><span class="p">[</span><span class="s2">&quot;resume_data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_data</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Added resume data with </span><span class="si">%d</span><span class="s2"> keys&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">))</span>
            <span class="n">state</span><span class="o">.</span><span class="n">clear_interrupt</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">input_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">:</span>
            <span class="c1"># This is a fresh execution - validate input data</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;Input data must contain &#39;messages&#39; for new execution.&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Starting fresh execution with </span><span class="si">%d</span><span class="s2"> messages&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">config</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_check_and_handle_interrupt</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">current_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">interrupt_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">StateT</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check for interrupts and save state if needed. Returns True if interrupted.&quot;&quot;&quot;</span>
        <span class="n">interrupt_nodes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interrupt_before</span> <span class="k">if</span> <span class="n">interrupt_type</span> <span class="o">==</span> <span class="s2">&quot;before&quot;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">interrupt_after</span>
        <span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">current_node</span> <span class="ow">in</span> <span class="n">interrupt_nodes</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ExecutionStatus</span><span class="o">.</span><span class="n">INTERRUPTED_BEFORE</span>
                <span class="k">if</span> <span class="n">interrupt_type</span> <span class="o">==</span> <span class="s2">&quot;before&quot;</span>
                <span class="k">else</span> <span class="n">ExecutionStatus</span><span class="o">.</span><span class="n">INTERRUPTED_AFTER</span>
            <span class="p">)</span>
            <span class="n">state</span><span class="o">.</span><span class="n">set_interrupt</span><span class="p">(</span>
                <span class="n">current_node</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;interrupt_</span><span class="si">{</span><span class="n">interrupt_type</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">current_node</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">status</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Save state and interrupt</span>
            <span class="k">await</span> <span class="n">sync_data</span><span class="p">(</span>
                <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
                <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; interrupted&quot;</span><span class="p">,</span> <span class="n">current_node</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;No interrupts found for node &#39;</span><span class="si">%s</span><span class="s2">&#39;, continuing execution&quot;</span><span class="p">,</span>
            <span class="n">current_node</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_check_stop_requested</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">StateT</span><span class="p">,</span>
        <span class="n">current_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">event</span><span class="p">:</span> <span class="n">EventModel</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Message</span><span class="p">],</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if a stop has been requested externally.&quot;&quot;&quot;</span>
        <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">reload_state</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

        <span class="c1"># Check if a stop was requested externally (e.g., frontend)</span>
        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">is_stopped_requested</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Stop requested for thread &#39;</span><span class="si">%s</span><span class="s2">&#39; at node &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;thread_id&quot;</span><span class="p">),</span>
                <span class="n">current_node</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">state</span><span class="o">.</span><span class="n">set_interrupt</span><span class="p">(</span>
                <span class="n">current_node</span><span class="p">,</span>
                <span class="s2">&quot;stop_requested&quot;</span><span class="p">,</span>
                <span class="n">ExecutionStatus</span><span class="o">.</span><span class="n">INTERRUPTED_AFTER</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;stop&quot;</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span><span class="p">:</span> <span class="s2">&quot;requested via is_stopped_requested&quot;</span><span class="p">},</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">sync_data</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">INTERRUPTED</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;interrupted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Stop&quot;</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Graph execution stopped by request&quot;</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_execute_graph</span><span class="p">(</span>  <span class="c1"># noqa: PLR0912, PLR0915</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">StateT</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">StateT</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">Message</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the entire graph with support for interrupts and resuming.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Starting graph execution from node &#39;</span><span class="si">%s</span><span class="s2">&#39; at step </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span><span class="p">,</span>
            <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">step</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DEBUG: Current node value: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DEBUG: END constant value: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">END</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DEBUG: Are they equal? </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span> <span class="o">==</span> <span class="n">END</span><span class="p">)</span>
        <span class="n">messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Message</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">max_steps</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;recursion_limit&quot;</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Max steps limit set to </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">)</span>

        <span class="c1"># get the last message from state as that is human message</span>
        <span class="n">last_human_message</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">context</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">last_human_message</span> <span class="ow">and</span> <span class="n">last_human_message</span><span class="o">.</span><span class="n">role</span> <span class="o">!=</span> <span class="s2">&quot;user&quot;</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">)</span> <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;user&quot;</span><span class="p">]</span>
            <span class="n">last_human_message</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">msg</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">last_human_message</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Last human message: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">last_human_message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_human_message</span><span class="p">)</span>

        <span class="c1"># Get current execution info from state</span>
        <span class="n">current_node</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">step</span>

        <span class="c1"># Create event for graph execution</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">EventModel</span><span class="o">.</span><span class="n">default</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()},</span>
            <span class="n">event</span><span class="o">=</span><span class="n">Event</span><span class="o">.</span><span class="n">GRAPH_EXECUTION</span><span class="p">,</span>
            <span class="n">content_type</span><span class="o">=</span><span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">STATE</span><span class="p">],</span>
            <span class="n">node_name</span><span class="o">=</span><span class="n">current_node</span><span class="p">,</span>
            <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;current_node&quot;</span><span class="p">:</span> <span class="n">current_node</span><span class="p">,</span>
                <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="n">step</span><span class="p">,</span>
                <span class="s2">&quot;max_steps&quot;</span><span class="p">:</span> <span class="n">max_steps</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">current_node</span> <span class="o">!=</span> <span class="n">END</span> <span class="ow">and</span> <span class="n">step</span> <span class="o">&lt;</span> <span class="n">max_steps</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Executing step </span><span class="si">%d</span><span class="s2"> at node &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">current_node</span><span class="p">)</span>
                <span class="c1"># Reload state in each iteration to get latest (in case of external updates)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_stop_requested</span><span class="p">(</span>
                    <span class="n">state</span><span class="p">,</span>
                    <span class="n">current_node</span><span class="p">,</span>
                    <span class="n">event</span><span class="p">,</span>
                    <span class="n">messages</span><span class="p">,</span>
                    <span class="n">config</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">messages</span>

                <span class="c1"># Update execution metadata</span>
                <span class="n">state</span><span class="o">.</span><span class="n">set_current_node</span><span class="p">(</span><span class="n">current_node</span><span class="p">)</span>
                <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">step</span>
                <span class="k">await</span> <span class="n">call_realtime_sync</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
                <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
                <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step</span>
                <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;current_node&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_node</span>
                <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">PROGRESS</span>
                <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

                <span class="c1"># Check for interrupt_before</span>
                <span class="k">if</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_and_handle_interrupt</span><span class="p">(</span>
                    <span class="n">current_node</span><span class="p">,</span>
                    <span class="s2">&quot;before&quot;</span><span class="p">,</span>
                    <span class="n">state</span><span class="p">,</span>
                    <span class="n">config</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Graph execution interrupted before node &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">current_node</span><span class="p">)</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">INTERRUPTED</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;interrupted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Before&quot;</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Graph execution interrupted before node execution&quot;</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;interrupted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Before&quot;</span>
                    <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">messages</span>

                <span class="c1"># Execute current node</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Executing node &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">current_node</span><span class="p">)</span>
                <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">current_node</span><span class="p">]</span>

                <span class="c1"># Publish node invocation event</span>

                <span class="c1">###############################################</span>
                <span class="c1">##### Node Execution Started ##################</span>
                <span class="c1">###############################################</span>

                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">node</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

                <span class="c1">###############################################</span>
                <span class="c1">##### Node Execution Finished #################</span>
                <span class="c1">###############################################</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; execution completed&quot;</span><span class="p">,</span> <span class="n">current_node</span><span class="p">)</span>

                <span class="n">next_node</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># Process result and get next node</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="c1"># If result is a list of Message, append to messages</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; returned </span><span class="si">%d</span><span class="s2"> messages, total messages now </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">current_node</span><span class="p">,</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">),</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="c1"># Add messages to state context so they&#39;re visible to subsequent nodes</span>
                    <span class="n">state</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">add_messages</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

                <span class="c1"># No state change beyond adding messages, just advance to next node</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
                    <span class="n">next_node</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;next_node&quot;</span><span class="p">)</span>
                    <span class="n">new_messages</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="k">if</span> <span class="n">new_messages</span><span class="p">:</span>
                        <span class="n">messages</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_messages</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; returned </span><span class="si">%d</span><span class="s2"> messages, total messages now </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">current_node</span><span class="p">,</span>
                            <span class="nb">len</span><span class="p">(</span><span class="n">new_messages</span><span class="p">),</span>
                            <span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">),</span>
                        <span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Node result processed, next_node=</span><span class="si">%s</span><span class="s2">, total_messages=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">next_node</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">),</span>
                <span class="p">)</span>

                <span class="c1"># Check stop again after node execution</span>
                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_stop_requested</span><span class="p">(</span>
                    <span class="n">state</span><span class="p">,</span>
                    <span class="n">current_node</span><span class="p">,</span>
                    <span class="n">event</span><span class="p">,</span>
                    <span class="n">messages</span><span class="p">,</span>
                    <span class="n">config</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">messages</span>

                <span class="c1"># Call realtime sync after node execution (if state/messages changed)</span>
                <span class="k">await</span> <span class="n">call_realtime_sync</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
                <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">UPDATE</span>
                <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
                <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">]</span> <span class="k">if</span> <span class="n">messages</span> <span class="k">else</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">messages</span><span class="p">:</span>
                    <span class="n">lm</span> <span class="o">=</span> <span class="n">messages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lm</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">lm</span><span class="o">.</span><span class="n">content</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lm</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">content</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">STATE</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
                <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

                <span class="c1"># Check for interrupt_after</span>
                <span class="k">if</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_and_handle_interrupt</span><span class="p">(</span>
                    <span class="n">current_node</span><span class="p">,</span>
                    <span class="s2">&quot;after&quot;</span><span class="p">,</span>
                    <span class="n">state</span><span class="p">,</span>
                    <span class="n">config</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Graph execution interrupted after node &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">current_node</span><span class="p">)</span>
                    <span class="c1"># For interrupt_after, advance to next node before pausing</span>
                    <span class="k">if</span> <span class="n">next_node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">next_node</span> <span class="o">=</span> <span class="n">get_next_node</span><span class="p">(</span><span class="n">current_node</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span>
                    <span class="n">state</span><span class="o">.</span><span class="n">set_current_node</span><span class="p">(</span><span class="n">next_node</span><span class="p">)</span>

                    <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">INTERRUPTED</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;interrupted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;After&quot;</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;interrupted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;After&quot;</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
                    <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">messages</span>

                <span class="c1"># Get next node (only if no explicit navigation from Command)</span>
                <span class="k">if</span> <span class="n">next_node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">current_node</span> <span class="o">=</span> <span class="n">get_next_node</span><span class="p">(</span><span class="n">current_node</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Next node determined by graph logic: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">current_node</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">current_node</span> <span class="o">=</span> <span class="n">next_node</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Next node determined by command: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">current_node</span><span class="p">)</span>

                <span class="c1"># Check if we&#39;ve reached the end after determining next node</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Checking if current_node &#39;</span><span class="si">%s</span><span class="s2">&#39; == END &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">current_node</span><span class="p">,</span> <span class="n">END</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">current_node</span> <span class="o">==</span> <span class="n">END</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Graph execution reached END node, completing&quot;</span><span class="p">)</span>
                    <span class="k">break</span>

                <span class="c1"># Advance step after successful node execution</span>
                <span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">state</span><span class="o">.</span><span class="n">advance_step</span><span class="p">()</span>
                <span class="k">await</span> <span class="n">call_realtime_sync</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
                <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">UPDATE</span>

                <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;State_Updated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;State Updated&quot;</span>
                <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
                <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">step</span> <span class="o">&gt;=</span> <span class="n">max_steps</span><span class="p">:</span>
                    <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;Graph execution exceeded maximum steps&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                    <span class="n">state</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">call_realtime_sync</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">ERROR</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_msg</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;current_node&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_node</span>

                    <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">GraphRecursionError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Graph execution exceeded recursion limit: </span><span class="si">{</span><span class="n">max_steps</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># Execution completed successfully</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Graph execution completed successfully at node &#39;</span><span class="si">%s</span><span class="s2">&#39; after </span><span class="si">%d</span><span class="s2"> steps&quot;</span><span class="p">,</span>
                <span class="n">current_node</span><span class="p">,</span>
                <span class="n">step</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">state</span><span class="o">.</span><span class="n">complete</span><span class="p">()</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_data</span><span class="p">(</span>
                <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
                <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                <span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">]</span> <span class="k">if</span> <span class="n">messages</span> <span class="k">else</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">messages</span><span class="p">:</span>
                <span class="n">fm</span> <span class="o">=</span> <span class="n">messages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">fm</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">fm</span><span class="o">.</span><span class="n">content</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="n">fm</span><span class="o">.</span><span class="n">content</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">STATE</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Graph execution completed&quot;</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;current_node&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_node</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_context_trimmed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>

            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">messages</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Handle execution errors</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Graph execution failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">state</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

            <span class="c1"># Publish error event</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">ERROR</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

            <span class="k">await</span> <span class="n">sync_data</span><span class="p">(</span>
                <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
                <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                <span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">default_state</span><span class="p">:</span> <span class="n">StateT</span><span class="p">,</span>
        <span class="n">response_granularity</span><span class="p">:</span> <span class="n">ResponseGranularity</span> <span class="o">=</span> <span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the graph asynchronously with event publishing.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Starting asynchronous graph execution with </span><span class="si">%d</span><span class="s2"> input keys, granularity=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="k">if</span> <span class="n">input_data</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">response_granularity</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="n">input_data</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="c1"># Load or initialize state</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading or creating state from input data&quot;</span><span class="p">)</span>
        <span class="n">new_state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">load_or_create_state</span><span class="p">(</span>
            <span class="n">input_data</span><span class="p">,</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">default_state</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">StateT</span> <span class="o">=</span> <span class="n">new_state</span>  <span class="c1"># type: ignore[assignment]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;State loaded: interrupted=</span><span class="si">%s</span><span class="s2">, current_node=</span><span class="si">%s</span><span class="s2">, step=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">state</span><span class="o">.</span><span class="n">is_interrupted</span><span class="p">(),</span>
            <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span><span class="p">,</span>
            <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">step</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Event publishing logic</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">EventModel</span><span class="o">.</span><span class="n">default</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()},</span>
            <span class="n">event</span><span class="o">=</span><span class="n">Event</span><span class="o">.</span><span class="n">GRAPH_EXECUTION</span><span class="p">,</span>
            <span class="n">content_type</span><span class="o">=</span><span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">STATE</span><span class="p">],</span>
            <span class="n">node_name</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span><span class="p">,</span>
            <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;current_node&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span><span class="p">,</span>
                <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">step</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">START</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="c1"># Check if this is a resume case</span>
        <span class="n">config</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_interrupted</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">UPDATE</span>
        <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Graph invoked&quot;</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Beginning graph execution&quot;</span><span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">PROGRESS</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Graph execution started&quot;</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

            <span class="n">final_state</span><span class="p">,</span> <span class="n">messages</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_graph</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Graph execution completed with </span><span class="si">%d</span><span class="s2"> final messages&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">))</span>

            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Graph execution completed&quot;</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_state</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">]</span> <span class="k">if</span> <span class="n">messages</span> <span class="k">else</span> <span class="p">[]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

            <span class="k">return</span> <span class="k">await</span> <span class="n">parse_response</span><span class="p">(</span>
                <span class="n">final_state</span><span class="p">,</span>
                <span class="n">messages</span><span class="p">,</span>
                <span class="n">response_granularity</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Graph execution failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">ERROR</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Graph execution failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">





<h8 id="pyagenity.graph.utils.invoke_handler.InvokeHandler-attributes">Attributes<a href="#pyagenity.graph.utils.invoke_handler.InvokeHandler-attributes" class="headerlink" title="Permanent link">&para;</a></h8>

<div class="doc doc-object doc-attribute">



<h9 id="pyagenity.graph.utils.invoke_handler.InvokeHandler.edges" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">edges</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.utils.invoke_handler.InvokeHandler.edges" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">edges</span> <span class="o">=</span> <span class="n">edges</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h9 id="pyagenity.graph.utils.invoke_handler.InvokeHandler.interrupt_after" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">interrupt_after</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.utils.invoke_handler.InvokeHandler.interrupt_after" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">interrupt_after</span> <span class="o">=</span> <span class="n">interrupt_after</span> <span class="ow">or</span> <span class="p">[]</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h9 id="pyagenity.graph.utils.invoke_handler.InvokeHandler.interrupt_before" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">interrupt_before</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.utils.invoke_handler.InvokeHandler.interrupt_before" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">interrupt_before</span> <span class="o">=</span> <span class="n">interrupt_before</span> <span class="ow">or</span> <span class="p">[]</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h9 id="pyagenity.graph.utils.invoke_handler.InvokeHandler.nodes" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">nodes</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.utils.invoke_handler.InvokeHandler.nodes" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">nodes</span> <span class="o">=</span> <span class="n">nodes</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>


<h8 id="pyagenity.graph.utils.invoke_handler.InvokeHandler-functions">Functions<a href="#pyagenity.graph.utils.invoke_handler.InvokeHandler-functions" class="headerlink" title="Permanent link">&para;</a></h8>

<div class="doc doc-object doc-function">


<h9 id="pyagenity.graph.utils.invoke_handler.InvokeHandler.__init__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">__init__</span>


<a href="#pyagenity.graph.utils.invoke_handler.InvokeHandler.__init__" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">__init__</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">interrupt_before</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interrupt_after</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/utils/invoke_handler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@inject</span>
<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Node</span><span class="p">],</span>
    <span class="n">edges</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Edge</span><span class="p">],</span>
    <span class="n">interrupt_before</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">interrupt_after</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Node</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodes</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">edges</span>
    <span class="c1"># Keep existing attributes for backward-compatibility</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">interrupt_before</span> <span class="o">=</span> <span class="n">interrupt_before</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">interrupt_after</span> <span class="o">=</span> <span class="n">interrupt_after</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="c1"># And set via mixin for a single source of truth</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_set_interrupts</span><span class="p">(</span><span class="n">interrupt_before</span><span class="p">,</span> <span class="n">interrupt_after</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h9 id="pyagenity.graph.utils.invoke_handler.InvokeHandler.invoke" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">invoke</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.utils.invoke_handler.InvokeHandler.invoke" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">invoke</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">default_state</span><span class="p">,</span> <span class="n">response_granularity</span><span class="o">=</span><span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Execute the graph asynchronously with event publishing.</p>


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/utils/invoke_handler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">default_state</span><span class="p">:</span> <span class="n">StateT</span><span class="p">,</span>
    <span class="n">response_granularity</span><span class="p">:</span> <span class="n">ResponseGranularity</span> <span class="o">=</span> <span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the graph asynchronously with event publishing.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Starting asynchronous graph execution with </span><span class="si">%d</span><span class="s2"> input keys, granularity=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="k">if</span> <span class="n">input_data</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">response_granularity</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">input_data</span> <span class="o">=</span> <span class="n">input_data</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="c1"># Load or initialize state</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading or creating state from input data&quot;</span><span class="p">)</span>
    <span class="n">new_state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">load_or_create_state</span><span class="p">(</span>
        <span class="n">input_data</span><span class="p">,</span>
        <span class="n">config</span><span class="p">,</span>
        <span class="n">default_state</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">StateT</span> <span class="o">=</span> <span class="n">new_state</span>  <span class="c1"># type: ignore[assignment]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;State loaded: interrupted=</span><span class="si">%s</span><span class="s2">, current_node=</span><span class="si">%s</span><span class="s2">, step=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">state</span><span class="o">.</span><span class="n">is_interrupted</span><span class="p">(),</span>
        <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span><span class="p">,</span>
        <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">step</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Event publishing logic</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">EventModel</span><span class="o">.</span><span class="n">default</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()},</span>
        <span class="n">event</span><span class="o">=</span><span class="n">Event</span><span class="o">.</span><span class="n">GRAPH_EXECUTION</span><span class="p">,</span>
        <span class="n">content_type</span><span class="o">=</span><span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">STATE</span><span class="p">],</span>
        <span class="n">node_name</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span><span class="p">,</span>
        <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;current_node&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span><span class="p">,</span>
            <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">step</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">START</span>
    <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

    <span class="c1"># Check if this is a resume case</span>
    <span class="n">config</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_interrupted</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

    <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">UPDATE</span>
    <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Graph invoked&quot;</span>
    <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Beginning graph execution&quot;</span><span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">PROGRESS</span>
        <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Graph execution started&quot;</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="n">final_state</span><span class="p">,</span> <span class="n">messages</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_graph</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Graph execution completed with </span><span class="si">%d</span><span class="s2"> final messages&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">))</span>

        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
        <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Graph execution completed&quot;</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_state</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">]</span> <span class="k">if</span> <span class="n">messages</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="k">return</span> <span class="k">await</span> <span class="n">parse_response</span><span class="p">(</span>
            <span class="n">final_state</span><span class="p">,</span>
            <span class="n">messages</span><span class="p">,</span>
            <span class="n">response_granularity</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Graph execution failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">ERROR</span>
        <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Graph execution failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>
<h6 id="pyagenity.graph.utils.invoke_handler-functions">Functions<a href="#pyagenity.graph.utils.invoke_handler-functions" class="headerlink" title="Permanent link">&para;</a></h6>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="pyagenity.graph.utils.invoke_node_handler" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">invoke_node_handler</span>


<a href="#pyagenity.graph.utils.invoke_node_handler" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

        <p>InvokeNodeHandler utilities for PyAgenity agent graph execution.</p>
<p>This module provides the InvokeNodeHandler class, which manages the invocation of node functions
and tool nodes within the agent graph. It supports dependency injection, callback hooks,
event publishing, and error recovery for both regular and tool-based nodes.</p>


<p><span class="doc-section-title">Classes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            InvokeNodeHandler (pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler)" href="../#pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler">InvokeNodeHandler</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Handles execution of node functions and tool nodes with DI and callbacks.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="usage" open>
  <summary>Usage</summary>
  <p>handler = InvokeNodeHandler(name, func, publisher)
result = await handler.invoke(config, state)</p>
</details>













<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            logger


  
      module-attribute
   (pyagenity.graph.utils.invoke_node_handler.logger)" href="../#pyagenity.graph.utils.invoke_node_handler.logger">logger</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>



  <div class="doc doc-children">





<h6 id="pyagenity.graph.utils.invoke_node_handler-attributes">Attributes<a href="#pyagenity.graph.utils.invoke_node_handler-attributes" class="headerlink" title="Permanent link">&para;</a></h6>

<div class="doc doc-object doc-attribute">



<h7 id="pyagenity.graph.utils.invoke_node_handler.logger" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">logger</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#pyagenity.graph.utils.invoke_node_handler.logger" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<h6 id="pyagenity.graph.utils.invoke_node_handler-classes">Classes<a href="#pyagenity.graph.utils.invoke_node_handler-classes" class="headerlink" title="Permanent link">&para;</a></h6>

<div class="doc doc-object doc-class">



<h7 id="pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">InvokeNodeHandler</span>


<a href="#pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler" class="headerlink" title="Permanent link">&para;</a></h7>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            BaseLoggingMixin (pyagenity.graph.utils.handler_mixins.BaseLoggingMixin)" href="../#pyagenity.graph.utils.handler_mixins.BaseLoggingMixin">BaseLoggingMixin</a></code></p>


        <p>Handles invocation of node functions and tool nodes in the agent graph.</p>
<p>Supports dependency injection, callback hooks, event publishing, and error recovery.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler(name)" class="doc doc-heading doc-heading-parameter">                  <code>name</code>
<a href="#pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler(name)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the node.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler(func)" class="doc doc-heading doc-heading-parameter">                  <code>func</code>
<a href="#pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler(func)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="collections.abc.Callable">Callable</span> | <a class="autorefs autorefs-internal" title="            ToolNode (pyagenity.graph.tool_node.ToolNode)" href="../#pyagenity.graph.tool_node.ToolNode">ToolNode</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The function or ToolNode to execute.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler(publisher)" class="doc doc-heading doc-heading-parameter">                  <code>publisher</code>
<a href="#pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler(publisher)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            BasePublisher (pyagenity.publisher.BasePublisher)" href="../#pyagenity.publisher.BasePublisher">BasePublisher</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Event publisher for execution events.</p>
              </div>
            </td>
            <td>
                  <code><span title="injectq.Inject">Inject</span>[<a class="autorefs autorefs-internal" title="            BasePublisher (pyagenity.publisher.BasePublisher)" href="../#pyagenity.publisher.BasePublisher">BasePublisher</a>]</code>
            </td>
          </tr>
      </tbody>
    </table>












<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            __init__ (pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler.__init__)" href="../#pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler.__init__">__init__</a></code></td>
              <td>
                <div class="doc-md-description">
                  
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            clear_signature_cache


  
      classmethod
   (pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler.clear_signature_cache)" href="../#pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler.clear_signature_cache">clear_signature_cache</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Clear the function signature cache. Useful for testing or memory management.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            invoke


  
      async
   (pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler.invoke)" href="../#pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler.invoke">invoke</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Execute the node function or ToolNode with dependency injection and callback hooks.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>




<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            func


  
      instance-attribute
   (pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler.func)" href="../#pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler.func">func</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            name


  
      instance-attribute
   (pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler.name)" href="../#pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler.name">name</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            publisher


  
      instance-attribute
   (pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler.publisher)" href="../#pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler.publisher">publisher</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>pyagenity/graph/utils/invoke_node_handler.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">InvokeNodeHandler</span><span class="p">(</span><span class="n">BaseLoggingMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles invocation of node functions and tool nodes in the agent graph.</span>

<span class="sd">    Supports dependency injection, callback hooks, event publishing, and error recovery.</span>

<span class="sd">    Args:</span>
<span class="sd">        name (str): Name of the node.</span>
<span class="sd">        func (Callable | ToolNode): The function or ToolNode to execute.</span>
<span class="sd">        publisher (BasePublisher, optional): Event publisher for execution events.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Class-level cache for function signatures to avoid repeated inspection</span>
    <span class="n">_signature_cache</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Signature</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_signature_cache</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear the function signature cache. Useful for testing or memory management.&quot;&quot;&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_signature_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">func</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="s2">&quot;ToolNode&quot;</span><span class="p">],</span>
        <span class="n">publisher</span><span class="p">:</span> <span class="n">BasePublisher</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">BasePublisher</span><span class="p">],</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">publisher</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_single_tool</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tool_call</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Message</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute a single tool call using the ToolNode.</span>

<span class="sd">        Args:</span>
<span class="sd">            tool_call (dict): Tool call specification.</span>
<span class="sd">            state (AgentState): Current agent state.</span>
<span class="sd">            config (dict): Node configuration.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Message: Resulting message from tool execution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">function_name</span> <span class="o">=</span> <span class="n">tool_call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">function_args</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">tool_call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;arguments&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="n">tool_call_id</span> <span class="o">=</span> <span class="n">tool_call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; executing tool &#39;</span><span class="si">%s</span><span class="s2">&#39; with </span><span class="si">%d</span><span class="s2"> arguments&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">function_name</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">function_args</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Tool arguments: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">function_args</span><span class="p">)</span>

        <span class="c1"># Execute the tool function with injectable parameters</span>
        <span class="n">tool_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="n">function_name</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
            <span class="n">function_args</span><span class="p">,</span>
            <span class="n">tool_call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; tool execution completed successfully&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tool_result</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_call_tools</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">last_message</span><span class="p">:</span> <span class="n">Message</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="s2">&quot;AgentState&quot;</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Message</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute all tool calls present in the last message.</span>

<span class="sd">        Args:</span>
<span class="sd">            last_message (Message): The last message containing tool calls.</span>
<span class="sd">            state (AgentState): Current agent state.</span>
<span class="sd">            config (dict): Node configuration.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[Message]: List of messages from tool executions.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NodeError: If no tool calls are present.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; calling tools from message&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">result</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Message</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="n">last_message</span><span class="p">,</span> <span class="s2">&quot;tools_calls&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">last_message</span><span class="o">.</span><span class="n">tools_calls</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">last_message</span><span class="o">.</span><span class="n">tools_calls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">):</span>
            <span class="c1"># Execute the first tool call for now</span>
            <span class="n">tool_call</span> <span class="o">=</span> <span class="n">last_message</span><span class="o">.</span><span class="n">tools_calls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">tool_call</span> <span class="ow">in</span> <span class="n">last_message</span><span class="o">.</span><span class="n">tools_calls</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_single_tool</span><span class="p">(</span>
                    <span class="n">tool_call</span><span class="p">,</span>
                    <span class="n">state</span><span class="p">,</span>
                    <span class="n">config</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># No tool calls to execute, return available tools</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39;: No tool calls to execute&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">NodeError</span><span class="p">(</span><span class="s2">&quot;No tool calls to execute&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_cached_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Signature</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get cached signature for a function, computing it if not cached.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signature_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signature_cache</span><span class="p">[</span><span class="n">func</span><span class="p">]</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signature_cache</span><span class="p">[</span><span class="n">func</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_input_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="s2">&quot;AgentState&quot;</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare input data for function invocation, handling injectable parameters.</span>
<span class="sd">        Uses cached function signature to avoid repeated inspection overhead.</span>

<span class="sd">        Args:</span>
<span class="sd">            state (AgentState): Current agent state.</span>
<span class="sd">            config (dict): Node configuration.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Input data for function call.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If required parameters are missing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Use cached signature inspection for performance</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cached_signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">)</span>  <span class="c1"># type: ignore Tool node won&#39;t come here</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">default_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">,</span>
            <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># # Get injectable parameters to determine which ones to exclude from manual passing</span>
        <span class="c1"># # Prepare function arguments (excluding injectable parameters)</span>
        <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Skip *args/**kwargs</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">VAR_POSITIONAL</span><span class="p">,</span>
                <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">VAR_KEYWORD</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># check its state, config</span>
            <span class="k">if</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">]:</span>
                <span class="n">input_data</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_data</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span>
            <span class="c1"># Include regular function arguments</span>
            <span class="k">elif</span> <span class="n">param</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Missing required parameter &#39;</span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2">&#39; for function &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">input_data</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_call_normal_node</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="s2">&quot;AgentState&quot;</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">callback_mgr</span><span class="p">:</span> <span class="n">CallbackManager</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute a regular node function with callback hooks and event publishing.</span>

<span class="sd">        Args:</span>
<span class="sd">            state (AgentState): Current agent state.</span>
<span class="sd">            config (dict): Node configuration.</span>
<span class="sd">            callback_mgr (CallbackManager): Callback manager for hooks.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Result containing new state, messages, and next node.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If function execution fails and cannot be recovered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; calling normal function&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">result</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; is a regular function, executing with callbacks&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="c1"># This is a regular function - likely AI function</span>
        <span class="c1"># Create callback context for AI invocation</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">CallbackContext</span><span class="p">(</span>
            <span class="n">invocation_type</span><span class="o">=</span><span class="n">InvocationType</span><span class="o">.</span><span class="n">AI</span><span class="p">,</span>
            <span class="n">node_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">function_name</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">)),</span>
            <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># Event publishing logic (similar to stream_node_handler)</span>

        <span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_input_data</span><span class="p">(</span>
            <span class="n">state</span><span class="p">,</span>
            <span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">last_message</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">context</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">event</span> <span class="o">=</span> <span class="n">EventModel</span><span class="o">.</span><span class="n">default</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()},</span>
            <span class="n">event</span><span class="o">=</span><span class="n">Event</span><span class="o">.</span><span class="n">NODE_EXECUTION</span><span class="p">,</span>
            <span class="n">content_type</span><span class="o">=</span><span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">STATE</span><span class="p">],</span>
            <span class="n">node_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;node&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;function_name&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">)),</span>
                <span class="s2">&quot;last_message&quot;</span><span class="p">:</span> <span class="n">last_message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">last_message</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; executing before_invoke callbacks&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="c1"># Execute before_invoke callbacks</span>
            <span class="n">input_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">callback_mgr</span><span class="o">.</span><span class="n">execute_before_invoke</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; executing function&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">PROGRESS</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Function execution started&quot;</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

            <span class="c1"># Execute the actual function</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_sync_or_async</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
                <span class="o">**</span><span class="n">input_data</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; function execution completed&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; executing after_invoke callbacks&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="c1"># Execute after_invoke callbacks</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">callback_mgr</span><span class="o">.</span><span class="n">execute_after_invoke</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

            <span class="c1"># Process result and publish END event</span>
            <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">new_state</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">next_node</span> <span class="o">=</span> <span class="k">await</span> <span class="n">process_node_result</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">messages</span><span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_state</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Function execution completed&quot;</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">]</span> <span class="k">if</span> <span class="n">messages</span> <span class="k">else</span> <span class="p">[]</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;next_node&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_node</span>
            <span class="c1"># mirror simple content + structured blocks for the last message</span>
            <span class="k">if</span> <span class="n">messages</span><span class="p">:</span>
                <span class="n">last</span> <span class="o">=</span> <span class="n">messages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">last</span><span class="o">.</span><span class="n">content</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="n">content</span>

            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">new_state</span><span class="p">,</span>
                <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span>
                <span class="s2">&quot;next_node&quot;</span><span class="p">:</span> <span class="n">next_node</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; execution failed, executing error callbacks: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span>
            <span class="p">)</span>
            <span class="c1"># Execute error callbacks</span>
            <span class="n">recovery_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">callback_mgr</span><span class="o">.</span><span class="n">execute_on_error</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">recovery_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; recovered from error using callback result&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># Use recovery result instead of raising the error</span>
                <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
                <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Function execution recovered from error&quot;</span>
                <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recovery_result</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">STATE</span><span class="p">]</span>
                <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">,</span>
                    <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">recovery_result</span><span class="p">],</span>
                    <span class="s2">&quot;next_node&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="c1"># Re-raise the original error</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; could not recover from error&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">ERROR</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Function execution failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">STATE</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
        <span class="n">callback_mgr</span><span class="p">:</span> <span class="n">CallbackManager</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">Message</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute the node function or ToolNode with dependency injection and callback hooks.</span>

<span class="sd">        Args:</span>
<span class="sd">            config (dict): Node configuration.</span>
<span class="sd">            state (AgentState): Current agent state.</span>
<span class="sd">            callback_mgr (CallbackManager, optional): Callback manager for hooks.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict | list[Message]: Result of node execution (regular node or tool node).</span>

<span class="sd">        Raises:</span>
<span class="sd">            NodeError: If execution fails or context is missing for tool nodes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Executing node &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; execution with state context size=</span><span class="si">%d</span><span class="s2">, config keys=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">)</span> <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">context</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">config</span> <span class="k">else</span> <span class="p">[],</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">ToolNode</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; is a ToolNode, executing tool calls&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="c1"># This is tool execution - handled separately in ToolNode</span>
                <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">context</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">last_message</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; processing tool calls from last message&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_tools</span><span class="p">(</span>
                        <span class="n">last_message</span><span class="p">,</span>
                        <span class="n">state</span><span class="p">,</span>
                        <span class="n">config</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># No context, return available tools</span>
                    <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;No context available for tool execution&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">NodeError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_normal_node</span><span class="p">(</span>
                    <span class="n">state</span><span class="p">,</span>
                    <span class="n">config</span><span class="p">,</span>
                    <span class="n">callback_mgr</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; execution completed successfully&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># This is the final catch-all for node execution errors</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; execution failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">NodeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">





<h8 id="pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler-attributes">Attributes<a href="#pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler-attributes" class="headerlink" title="Permanent link">&para;</a></h8>

<div class="doc doc-object doc-attribute">



<h9 id="pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler.func" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">func</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler.func" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h9 id="pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler.name" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">name</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler.name" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h9 id="pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler.publisher" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">publisher</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler.publisher" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">publisher</span> <span class="o">=</span> <span class="n">publisher</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>


<h8 id="pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler-functions">Functions<a href="#pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler-functions" class="headerlink" title="Permanent link">&para;</a></h8>

<div class="doc doc-object doc-function">


<h9 id="pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler.__init__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">__init__</span>


<a href="#pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler.__init__" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">publisher</span><span class="o">=</span><span class="n">Inject</span><span class="p">[</span><span class="n">BasePublisher</span><span class="p">])</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/utils/invoke_node_handler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">func</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="s2">&quot;ToolNode&quot;</span><span class="p">],</span>
    <span class="n">publisher</span><span class="p">:</span> <span class="n">BasePublisher</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">BasePublisher</span><span class="p">],</span>
<span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">publisher</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h9 id="pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler.clear_signature_cache" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">clear_signature_cache</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler.clear_signature_cache" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">clear_signature_cache</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Clear the function signature cache. Useful for testing or memory management.</p>


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/utils/invoke_node_handler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">clear_signature_cache</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clear the function signature cache. Useful for testing or memory management.&quot;&quot;&quot;</span>
    <span class="bp">cls</span><span class="o">.</span><span class="n">_signature_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h9 id="pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler.invoke" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">invoke</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler.invoke" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">invoke</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">callback_mgr</span><span class="o">=</span><span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">])</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Execute the node function or ToolNode with dependency injection and callback hooks.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h10 id="pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler.invoke(config)" class="doc doc-heading doc-heading-parameter">                  <code>config</code>
<a href="#pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler.invoke(config)" class="headerlink" title="Permanent link">&para;</a></h10>            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Node configuration.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h10 id="pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler.invoke(state)" class="doc doc-heading doc-heading-parameter">                  <code>state</code>
<a href="#pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler.invoke(state)" class="headerlink" title="Permanent link">&para;</a></h10>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            AgentState (pyagenity.state.AgentState)" href="../#pyagenity.state.AgentState">AgentState</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Current agent state.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h10 id="pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler.invoke(callback_mgr)" class="doc doc-heading doc-heading-parameter">                  <code>callback_mgr</code>
<a href="#pyagenity.graph.utils.invoke_node_handler.InvokeNodeHandler.invoke(callback_mgr)" class="headerlink" title="Permanent link">&para;</a></h10>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            CallbackManager (pyagenity.utils.CallbackManager)" href="../#pyagenity.utils.CallbackManager">CallbackManager</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Callback manager for hooks.</p>
              </div>
            </td>
            <td>
                  <code><span title="injectq.Inject">Inject</span>[<a class="autorefs autorefs-internal" title="            CallbackManager (pyagenity.utils.CallbackManager)" href="../#pyagenity.utils.CallbackManager">CallbackManager</a>]</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | <span title="list">list</span>[<a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.Message)" href="../#pyagenity.utils.Message">Message</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dict | list[Message]: Result of node execution (regular node or tool node).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="            NodeError (pyagenity.exceptions.NodeError)" href="../#pyagenity.exceptions.NodeError">NodeError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If execution fails or context is missing for tool nodes.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/utils/invoke_node_handler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
    <span class="n">callback_mgr</span><span class="p">:</span> <span class="n">CallbackManager</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">Message</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute the node function or ToolNode with dependency injection and callback hooks.</span>

<span class="sd">    Args:</span>
<span class="sd">        config (dict): Node configuration.</span>
<span class="sd">        state (AgentState): Current agent state.</span>
<span class="sd">        callback_mgr (CallbackManager, optional): Callback manager for hooks.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict | list[Message]: Result of node execution (regular node or tool node).</span>

<span class="sd">    Raises:</span>
<span class="sd">        NodeError: If execution fails or context is missing for tool nodes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Executing node &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; execution with state context size=</span><span class="si">%d</span><span class="s2">, config keys=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">)</span> <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">context</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nb">list</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">config</span> <span class="k">else</span> <span class="p">[],</span>
    <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">ToolNode</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; is a ToolNode, executing tool calls&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="c1"># This is tool execution - handled separately in ToolNode</span>
            <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">context</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">last_message</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; processing tool calls from last message&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_tools</span><span class="p">(</span>
                    <span class="n">last_message</span><span class="p">,</span>
                    <span class="n">state</span><span class="p">,</span>
                    <span class="n">config</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># No context, return available tools</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;No context available for tool execution&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">NodeError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_normal_node</span><span class="p">(</span>
                <span class="n">state</span><span class="p">,</span>
                <span class="n">config</span><span class="p">,</span>
                <span class="n">callback_mgr</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; execution completed successfully&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># This is the final catch-all for node execution errors</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; execution failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">NodeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>
<h6 id="pyagenity.graph.utils.invoke_node_handler-functions">Functions<a href="#pyagenity.graph.utils.invoke_node_handler-functions" class="headerlink" title="Permanent link">&para;</a></h6>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="pyagenity.graph.utils.stream_handler" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">stream_handler</span>


<a href="#pyagenity.graph.utils.stream_handler" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

        <p>Streaming graph execution handler for PyAgenity workflows.</p>
<p>This module provides the StreamHandler class, which manages the execution of graph workflows
with support for streaming output, interrupts, state persistence, and event publishing.
It enables incremental result processing, pause/resume capabilities, and robust error handling
for agent workflows that require real-time or chunked responses.</p>










<p><span class="doc-section-title">Classes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            StreamHandler (pyagenity.graph.utils.stream_handler.StreamHandler)" href="../#pyagenity.graph.utils.stream_handler.StreamHandler">StreamHandler</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Handles streaming execution for graph workflows in PyAgenity.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>






<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            StateT


  
      module-attribute
   (pyagenity.graph.utils.stream_handler.StateT)" href="../#pyagenity.graph.utils.stream_handler.StateT">StateT</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            logger


  
      module-attribute
   (pyagenity.graph.utils.stream_handler.logger)" href="../#pyagenity.graph.utils.stream_handler.logger">logger</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>



  <div class="doc doc-children">





<h6 id="pyagenity.graph.utils.stream_handler-attributes">Attributes<a href="#pyagenity.graph.utils.stream_handler-attributes" class="headerlink" title="Permanent link">&para;</a></h6>

<div class="doc doc-object doc-attribute">



<h7 id="pyagenity.graph.utils.stream_handler.StateT" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">StateT</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#pyagenity.graph.utils.stream_handler.StateT" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">StateT</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;StateT&#39;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">AgentState</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="pyagenity.graph.utils.stream_handler.logger" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">logger</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#pyagenity.graph.utils.stream_handler.logger" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<h6 id="pyagenity.graph.utils.stream_handler-classes">Classes<a href="#pyagenity.graph.utils.stream_handler-classes" class="headerlink" title="Permanent link">&para;</a></h6>

<div class="doc doc-object doc-class">



<h7 id="pyagenity.graph.utils.stream_handler.StreamHandler" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">StreamHandler</span>


<a href="#pyagenity.graph.utils.stream_handler.StreamHandler" class="headerlink" title="Permanent link">&para;</a></h7>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            BaseLoggingMixin (pyagenity.graph.utils.handler_mixins.BaseLoggingMixin)" href="../#pyagenity.graph.utils.handler_mixins.BaseLoggingMixin">BaseLoggingMixin</a></code>, <code><a class="autorefs autorefs-internal" title="            InterruptConfigMixin (pyagenity.graph.utils.handler_mixins.InterruptConfigMixin)" href="../#pyagenity.graph.utils.handler_mixins.InterruptConfigMixin">InterruptConfigMixin</a></code></p>


        <p>Handles streaming execution for graph workflows in PyAgenity.</p>
<p>StreamHandler manages the execution of agent workflows as directed graphs,
supporting streaming output, pause/resume via interrupts, state persistence,
and event publishing for monitoring and debugging. It enables incremental
result processing and robust error handling for complex agent workflows.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            nodes


  
      instance-attribute
   (pyagenity.graph.utils.stream_handler.StreamHandler.nodes)" href="../#pyagenity.graph.utils.stream_handler.StreamHandler.nodes">nodes</a></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <a class="autorefs autorefs-internal" title="            Node (pyagenity.graph.node.Node)" href="../#pyagenity.graph.node.Node">Node</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping node names to Node instances.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            edges


  
      instance-attribute
   (pyagenity.graph.utils.stream_handler.StreamHandler.edges)" href="../#pyagenity.graph.utils.stream_handler.StreamHandler.edges">edges</a></code></td>
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="            Edge (pyagenity.graph.edge.Edge)" href="../#pyagenity.graph.edge.Edge">Edge</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of Edge instances defining graph connections and routing.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            interrupt_before


  
      instance-attribute
   (pyagenity.graph.utils.stream_handler.StreamHandler.interrupt_before)" href="../#pyagenity.graph.utils.stream_handler.StreamHandler.interrupt_before">interrupt_before</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of node names where execution should pause before execution.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            interrupt_after


  
      instance-attribute
   (pyagenity.graph.utils.stream_handler.StreamHandler.interrupt_after)" href="../#pyagenity.graph.utils.stream_handler.StreamHandler.interrupt_after">interrupt_after</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of node names where execution should pause after execution.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="n">handler</span> <span class="o">=</span> <span class="n">StreamHandler</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">edges</span><span class="p">)</span>
<span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">handler</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
</code></pre></div>
</details>











<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            __init__ (pyagenity.graph.utils.stream_handler.StreamHandler.__init__)" href="../#pyagenity.graph.utils.stream_handler.StreamHandler.__init__">__init__</a></code></td>
              <td>
                <div class="doc-md-description">
                  
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            stream


  
      async
   (pyagenity.graph.utils.stream_handler.StreamHandler.stream)" href="../#pyagenity.graph.utils.stream_handler.StreamHandler.stream">stream</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Execute the graph asynchronously with streaming output.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>



              <details class="quote">
                <summary>Source code in <code>pyagenity/graph/utils/stream_handler.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">StreamHandler</span><span class="p">[</span><span class="n">StateT</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">](</span>
    <span class="n">BaseLoggingMixin</span><span class="p">,</span>
    <span class="n">InterruptConfigMixin</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handles streaming execution for graph workflows in PyAgenity.</span>

<span class="sd">    StreamHandler manages the execution of agent workflows as directed graphs,</span>
<span class="sd">    supporting streaming output, pause/resume via interrupts, state persistence,</span>
<span class="sd">    and event publishing for monitoring and debugging. It enables incremental</span>
<span class="sd">    result processing and robust error handling for complex agent workflows.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        nodes: Dictionary mapping node names to Node instances.</span>
<span class="sd">        edges: List of Edge instances defining graph connections and routing.</span>
<span class="sd">        interrupt_before: List of node names where execution should pause before execution.</span>
<span class="sd">        interrupt_after: List of node names where execution should pause after execution.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        handler = StreamHandler(nodes, edges)</span>
<span class="sd">        async for chunk in handler.stream(input_data, config, state):</span>
<span class="sd">            print(chunk)</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@inject</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Node</span><span class="p">],</span>
        <span class="n">edges</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Edge</span><span class="p">],</span>
        <span class="n">interrupt_before</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">interrupt_after</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Node</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">edges</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interrupt_before</span> <span class="o">=</span> <span class="n">interrupt_before</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interrupt_after</span> <span class="o">=</span> <span class="n">interrupt_after</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_interrupts</span><span class="p">(</span><span class="n">interrupt_before</span><span class="p">,</span> <span class="n">interrupt_after</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_check_interrupted</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">StateT</span><span class="p">,</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">is_interrupted</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Resuming from interrupted state at node &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span>
            <span class="p">)</span>
            <span class="c1"># This is a resume case - clear interrupt and merge input data</span>
            <span class="k">if</span> <span class="n">input_data</span><span class="p">:</span>
                <span class="n">config</span><span class="p">[</span><span class="s2">&quot;resume_data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_data</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Added resume data with </span><span class="si">%d</span><span class="s2"> keys&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">))</span>
            <span class="n">state</span><span class="o">.</span><span class="n">clear_interrupt</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">input_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">:</span>
            <span class="c1"># This is a fresh execution - validate input data</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;Input data must contain &#39;messages&#39; for new execution.&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Starting fresh execution with </span><span class="si">%d</span><span class="s2"> messages&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">config</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_check_and_handle_interrupt</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">current_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">interrupt_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">StateT</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check for interrupts and save state if needed. Returns True if interrupted.&quot;&quot;&quot;</span>
        <span class="n">interrupt_nodes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interrupt_before</span> <span class="k">if</span> <span class="n">interrupt_type</span> <span class="o">==</span> <span class="s2">&quot;before&quot;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">interrupt_after</span>
        <span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">current_node</span> <span class="ow">in</span> <span class="n">interrupt_nodes</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ExecutionStatus</span><span class="o">.</span><span class="n">INTERRUPTED_BEFORE</span>
                <span class="k">if</span> <span class="n">interrupt_type</span> <span class="o">==</span> <span class="s2">&quot;before&quot;</span>
                <span class="k">else</span> <span class="n">ExecutionStatus</span><span class="o">.</span><span class="n">INTERRUPTED_AFTER</span>
            <span class="p">)</span>
            <span class="n">state</span><span class="o">.</span><span class="n">set_interrupt</span><span class="p">(</span>
                <span class="n">current_node</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;interrupt_</span><span class="si">{</span><span class="n">interrupt_type</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">current_node</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">status</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Save state and interrupt</span>
            <span class="k">await</span> <span class="n">sync_data</span><span class="p">(</span>
                <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
                <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; interrupted&quot;</span><span class="p">,</span> <span class="n">current_node</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;No interrupts found for node &#39;</span><span class="si">%s</span><span class="s2">&#39;, continuing execution&quot;</span><span class="p">,</span>
            <span class="n">current_node</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_check_stop_requested</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">StateT</span><span class="p">,</span>
        <span class="n">current_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">event</span><span class="p">:</span> <span class="n">EventModel</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Message</span><span class="p">],</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if a stop has been requested externally.&quot;&quot;&quot;</span>
        <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">reload_state</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

        <span class="c1"># Check if a stop was requested externally (e.g., frontend)</span>
        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">is_stopped_requested</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Stop requested for thread &#39;</span><span class="si">%s</span><span class="s2">&#39; at node &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;thread_id&quot;</span><span class="p">),</span>
                <span class="n">current_node</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">state</span><span class="o">.</span><span class="n">set_interrupt</span><span class="p">(</span>
                <span class="n">current_node</span><span class="p">,</span>
                <span class="s2">&quot;stop_requested&quot;</span><span class="p">,</span>
                <span class="n">ExecutionStatus</span><span class="o">.</span><span class="n">INTERRUPTED_AFTER</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;stop&quot;</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span><span class="p">:</span> <span class="s2">&quot;requested via is_stopped_requested&quot;</span><span class="p">},</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">sync_data</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">INTERRUPTED</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;interrupted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Stop&quot;</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Graph execution stopped by request&quot;</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_execute_graph</span><span class="p">(</span>  <span class="c1"># noqa: PLR0912, PLR0915</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">StateT</span><span class="p">,</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterable</span><span class="p">[</span><span class="n">Message</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute the entire graph with support for interrupts and resuming.</span>

<span class="sd">        Why so many chunks are yielded?</span>
<span class="sd">        We allow user to set response type, if they want low granularity</span>
<span class="sd">        Only few chunks like Message will be sent to user</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Starting graph execution from node &#39;</span><span class="si">%s</span><span class="s2">&#39; at step </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span><span class="p">,</span>
            <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">step</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Message</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">messages_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">max_steps</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;recursion_limit&quot;</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Max steps limit set to </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">)</span>

        <span class="n">last_human_messages</span> <span class="o">=</span> <span class="n">input_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="c1"># Stream initial input messages (e.g., human messages) so callers see full conversation</span>
        <span class="c1"># Only emit when present and avoid duplicates by tracking message_ids and existing context</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">last_human_messages</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">message_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">messages_ids</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                <span class="n">messages_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">m</span>

        <span class="c1"># Get current execution info from state</span>
        <span class="n">current_node</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">step</span>

        <span class="c1"># Create event for graph execution</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">EventModel</span><span class="o">.</span><span class="n">default</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;execution_meta&quot;</span><span class="p">})},</span>
            <span class="n">content_type</span><span class="o">=</span><span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">STATE</span><span class="p">],</span>
            <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="n">step</span><span class="p">,</span> <span class="s2">&quot;current_node&quot;</span><span class="p">:</span> <span class="n">current_node</span><span class="p">},</span>
            <span class="n">event</span><span class="o">=</span><span class="n">Event</span><span class="o">.</span><span class="n">GRAPH_EXECUTION</span><span class="p">,</span>
            <span class="n">node_name</span><span class="o">=</span><span class="n">current_node</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">current_node</span> <span class="o">!=</span> <span class="n">END</span> <span class="ow">and</span> <span class="n">step</span> <span class="o">&lt;</span> <span class="n">max_steps</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Executing step </span><span class="si">%d</span><span class="s2"> at node &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">current_node</span><span class="p">)</span>

                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_stop_requested</span><span class="p">(</span>
                    <span class="n">state</span><span class="p">,</span>
                    <span class="n">current_node</span><span class="p">,</span>
                    <span class="n">event</span><span class="p">,</span>
                    <span class="n">messages</span><span class="p">,</span>
                    <span class="n">config</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
                    <span class="k">return</span>

                <span class="c1"># Update execution metadata</span>
                <span class="n">state</span><span class="o">.</span><span class="n">set_current_node</span><span class="p">(</span><span class="n">current_node</span><span class="p">)</span>
                <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">step</span>
                <span class="k">await</span> <span class="n">call_realtime_sync</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

                <span class="c1"># Update event with current step info</span>
                <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step</span>
                <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;current_node&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_node</span>
                <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">PROGRESS</span>
                <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Executing step </span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2"> at node &#39;</span><span class="si">{</span><span class="n">current_node</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

                <span class="c1"># Check for interrupt_before</span>
                <span class="k">if</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_and_handle_interrupt</span><span class="p">(</span>
                    <span class="n">current_node</span><span class="p">,</span>
                    <span class="s2">&quot;before&quot;</span><span class="p">,</span>
                    <span class="n">state</span><span class="p">,</span>
                    <span class="n">config</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Graph execution interrupted before node &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">current_node</span><span class="p">)</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">INTERRUPTED</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Graph execution interrupted before node execution&quot;</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;interrupted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Before&quot;</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;interrupted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Before&quot;</span>
                    <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="c1"># Execute current node</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Executing node &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">current_node</span><span class="p">)</span>
                <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">current_node</span><span class="p">]</span>

                <span class="c1"># Node execution</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; execution completed&quot;</span><span class="p">,</span> <span class="n">current_node</span><span class="p">)</span>

                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_stop_requested</span><span class="p">(</span>
                    <span class="n">state</span><span class="p">,</span>
                    <span class="n">current_node</span><span class="p">,</span>
                    <span class="n">event</span><span class="p">,</span>
                    <span class="n">messages</span><span class="p">,</span>
                    <span class="n">config</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
                    <span class="k">return</span>

                <span class="c1"># Process result and get next node</span>
                <span class="n">next_node</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">async</span> <span class="k">for</span> <span class="n">rs</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="c1"># Allow stop to break inner result loop as well</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">Message</span><span class="p">)</span> <span class="ow">and</span> <span class="n">rs</span><span class="o">.</span><span class="n">delta</span><span class="p">:</span>
                        <span class="c1"># Yield delta messages immediately for streaming</span>
                        <span class="k">yield</span> <span class="n">rs</span>

                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">Message</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rs</span><span class="o">.</span><span class="n">delta</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">rs</span>

                        <span class="k">if</span> <span class="n">rs</span><span class="o">.</span><span class="n">message_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">messages_ids</span><span class="p">:</span>
                            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span>
                            <span class="n">messages_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;is_non_streaming&quot;</span> <span class="ow">in</span> <span class="n">rs</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">rs</span><span class="p">[</span><span class="s2">&quot;is_non_streaming&quot;</span><span class="p">]:</span>
                            <span class="n">state</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
                            <span class="n">new_messages</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="p">[])</span>
                            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">new_messages</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">message_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">messages_ids</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">m</span><span class="o">.</span><span class="n">delta</span><span class="p">:</span>
                                    <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                                    <span class="n">messages_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span>
                                <span class="k">yield</span> <span class="n">m</span>
                            <span class="n">next_node</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;next_node&quot;</span><span class="p">,</span> <span class="n">next_node</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Streaming path completed: ensure any collected messages are persisted</span>
                            <span class="n">new_messages</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="p">[])</span>
                            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">new_messages</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">message_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">messages_ids</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">m</span><span class="o">.</span><span class="n">delta</span><span class="p">:</span>
                                    <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                                    <span class="n">messages_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span>
                                    <span class="k">yield</span> <span class="n">m</span>
                            <span class="n">next_node</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;next_node&quot;</span><span class="p">,</span> <span class="n">next_node</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Process as node result (non-streaming path)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">state</span><span class="p">,</span> <span class="n">new_messages</span><span class="p">,</span> <span class="n">next_node</span> <span class="o">=</span> <span class="k">await</span> <span class="n">process_node_result</span><span class="p">(</span>
                                <span class="n">rs</span><span class="p">,</span>
                                <span class="n">state</span><span class="p">,</span>
                                <span class="p">[],</span>
                            <span class="p">)</span>
                            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">new_messages</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">message_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">messages_ids</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">m</span><span class="o">.</span><span class="n">delta</span><span class="p">:</span>
                                    <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                                    <span class="n">messages_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span>
                                    <span class="n">state</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">add_messages</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="p">[</span><span class="n">m</span><span class="p">])</span>
                                    <span class="k">yield</span> <span class="n">m</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to process node result: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Node result processed, next_node=</span><span class="si">%s</span><span class="s2">, total_messages=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">next_node</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">),</span>
                <span class="p">)</span>

                <span class="c1"># Add collected messages to state context</span>
                <span class="k">if</span> <span class="n">messages</span><span class="p">:</span>
                    <span class="n">state</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">add_messages</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">messages</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Added </span><span class="si">%d</span><span class="s2"> messages to state context&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">))</span>

                <span class="c1"># Call realtime sync after node execution</span>
                <span class="k">await</span> <span class="n">call_realtime_sync</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
                <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">UPDATE</span>
                <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
                <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">]</span> <span class="k">if</span> <span class="n">messages</span> <span class="k">else</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">messages</span><span class="p">:</span>
                    <span class="n">lm</span> <span class="o">=</span> <span class="n">messages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lm</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">lm</span><span class="o">.</span><span class="n">content</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lm</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">content</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">STATE</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
                <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

                <span class="c1"># Check for interrupt_after</span>
                <span class="k">if</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_and_handle_interrupt</span><span class="p">(</span>
                    <span class="n">current_node</span><span class="p">,</span>
                    <span class="s2">&quot;after&quot;</span><span class="p">,</span>
                    <span class="n">state</span><span class="p">,</span>
                    <span class="n">config</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Graph execution interrupted after node &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">current_node</span><span class="p">)</span>
                    <span class="c1"># For interrupt_after, advance to next node before pausing</span>
                    <span class="k">if</span> <span class="n">next_node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">next_node</span> <span class="o">=</span> <span class="n">get_next_node</span><span class="p">(</span><span class="n">current_node</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span>
                    <span class="n">state</span><span class="o">.</span><span class="n">set_current_node</span><span class="p">(</span><span class="n">next_node</span><span class="p">)</span>

                    <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">INTERRUPTED</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;interrupted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;After&quot;</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;interrupted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;After&quot;</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
                    <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="c1"># Get next node</span>
                <span class="k">if</span> <span class="n">next_node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">current_node</span> <span class="o">=</span> <span class="n">get_next_node</span><span class="p">(</span><span class="n">current_node</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Next node determined by graph logic: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">current_node</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">current_node</span> <span class="o">=</span> <span class="n">next_node</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Next node determined by command: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">current_node</span><span class="p">)</span>

                <span class="c1"># Advance step after successful node execution</span>
                <span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">state</span><span class="o">.</span><span class="n">advance_step</span><span class="p">()</span>
                <span class="k">await</span> <span class="n">call_realtime_sync</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

                <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">UPDATE</span>
                <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;State_Updated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;State Updated&quot;</span>
                <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
                <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">step</span> <span class="o">&gt;=</span> <span class="n">max_steps</span><span class="p">:</span>
                    <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;Graph execution exceeded maximum steps&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                    <span class="n">state</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">call_realtime_sync</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

                    <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">ERROR</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_msg</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;current_node&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_node</span>
                    <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

                    <span class="k">yield</span> <span class="n">Message</span><span class="p">(</span>
                        <span class="n">role</span><span class="o">=</span><span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="p">[</span><span class="n">ErrorBlock</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">error_msg</span><span class="p">)],</span>  <span class="c1"># type: ignore</span>
                    <span class="p">)</span>

                    <span class="k">raise</span> <span class="n">GraphRecursionError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Graph execution exceeded recursion limit: </span><span class="si">{</span><span class="n">max_steps</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># Execution completed successfully</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Graph execution completed successfully at node &#39;</span><span class="si">%s</span><span class="s2">&#39; after </span><span class="si">%d</span><span class="s2"> steps&quot;</span><span class="p">,</span>
                <span class="n">current_node</span><span class="p">,</span>
                <span class="n">step</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">state</span><span class="o">.</span><span class="n">complete</span><span class="p">()</span>
            <span class="n">is_context_trimmed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_data</span><span class="p">(</span>
                <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
                <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                <span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Create completion event</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">]</span> <span class="k">if</span> <span class="n">messages</span> <span class="k">else</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">messages</span><span class="p">:</span>
                <span class="n">fm</span> <span class="o">=</span> <span class="n">messages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">fm</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">fm</span><span class="o">.</span><span class="n">content</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="n">fm</span><span class="o">.</span><span class="n">content</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">STATE</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">]</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Graph execution completed&quot;</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;current_node&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_node</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_context_trimmed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_context_trimmed</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Handle execution errors</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Graph execution failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">state</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

            <span class="c1"># Publish error event</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">ERROR</span>
            <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

            <span class="k">await</span> <span class="n">sync_data</span><span class="p">(</span>
                <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
                <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                <span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">default_state</span><span class="p">:</span> <span class="n">StateT</span><span class="p">,</span>
        <span class="n">response_granularity</span><span class="p">:</span> <span class="n">ResponseGranularity</span> <span class="o">=</span> <span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="n">Message</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the graph asynchronously with streaming output.</span>

<span class="sd">        Runs the graph workflow from start to finish, yielding incremental results</span>
<span class="sd">        as they become available. Automatically detects whether to start a fresh</span>
<span class="sd">        execution or resume from an interrupted state, supporting pause/resume</span>
<span class="sd">        and checkpointing.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_data: Input dictionary for graph execution. For new executions,</span>
<span class="sd">                should contain &#39;messages&#39; key with initial messages. For resumed</span>
<span class="sd">                executions, can contain additional data to merge.</span>
<span class="sd">            config: Configuration dictionary containing execution settings and context.</span>
<span class="sd">            default_state: Initial or template AgentState for workflow execution.</span>
<span class="sd">            response_granularity: Level of detail in the response (LOW, PARTIAL, FULL).</span>

<span class="sd">        Yields:</span>
<span class="sd">            Message objects representing incremental results from graph execution.</span>
<span class="sd">            The exact type and frequency of yields depends on node implementations</span>
<span class="sd">            and workflow configuration.</span>

<span class="sd">        Raises:</span>
<span class="sd">            GraphRecursionError: If execution exceeds recursion limit.</span>
<span class="sd">            ValueError: If input_data is invalid for new execution.</span>
<span class="sd">            Various exceptions: Depending on node execution failures.</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            async for chunk in handler.stream(input_data, config, state):</span>
<span class="sd">                print(chunk)</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Starting asynchronous graph execution with </span><span class="si">%d</span><span class="s2"> input keys, granularity=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="k">if</span> <span class="n">input_data</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">response_granularity</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="n">input_data</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Load or initialize state</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading or creating state from input data&quot;</span><span class="p">)</span>
        <span class="n">new_state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">load_or_create_state</span><span class="p">(</span>
            <span class="n">input_data</span><span class="p">,</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">default_state</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">StateT</span> <span class="o">=</span> <span class="n">new_state</span>  <span class="c1"># type: ignore[assignment]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;State loaded: interrupted=</span><span class="si">%s</span><span class="s2">, current_node=</span><span class="si">%s</span><span class="s2">, step=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">state</span><span class="o">.</span><span class="n">is_interrupted</span><span class="p">(),</span>
            <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span><span class="p">,</span>
            <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">step</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">cfg</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;user&quot;</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">:</span>
            <span class="c1"># This will be available when you are calling</span>
            <span class="c1"># vi pyagenity api</span>
            <span class="k">del</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span>

        <span class="n">event</span> <span class="o">=</span> <span class="n">EventModel</span><span class="o">.</span><span class="n">default</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">},</span>
            <span class="n">content_type</span><span class="o">=</span><span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">STATE</span><span class="p">],</span>
            <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;is_interrupted&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">is_interrupted</span><span class="p">(),</span>
                <span class="s2">&quot;current_node&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span><span class="p">,</span>
                <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">step</span><span class="p">,</span>
                <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">cfg</span><span class="p">,</span>
                <span class="s2">&quot;response_granularity&quot;</span><span class="p">:</span> <span class="n">response_granularity</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># Publish graph initialization event</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="c1"># Check if this is a resume case</span>
        <span class="n">config</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_interrupted</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

        <span class="c1"># Now start Execution</span>
        <span class="c1"># Execute graph</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Beginning graph execution&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_graph</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">chunk</span>

        <span class="c1"># Publish graph completion event</span>
        <span class="n">time_taken</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Graph execution finished in </span><span class="si">%.2f</span><span class="s2"> seconds&quot;</span><span class="p">,</span> <span class="n">time_taken</span><span class="p">)</span>

        <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
        <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;time_taken&quot;</span><span class="p">:</span> <span class="n">time_taken</span><span class="p">,</span>
                <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(),</span>
                <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">step</span><span class="p">,</span>
                <span class="s2">&quot;current_node&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span><span class="p">,</span>
                <span class="s2">&quot;is_interrupted&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">is_interrupted</span><span class="p">(),</span>
                <span class="s2">&quot;total_messages&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">)</span> <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">context</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">





<h8 id="pyagenity.graph.utils.stream_handler.StreamHandler-attributes">Attributes<a href="#pyagenity.graph.utils.stream_handler.StreamHandler-attributes" class="headerlink" title="Permanent link">&para;</a></h8>

<div class="doc doc-object doc-attribute">



<h9 id="pyagenity.graph.utils.stream_handler.StreamHandler.edges" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">edges</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.utils.stream_handler.StreamHandler.edges" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">edges</span> <span class="o">=</span> <span class="n">edges</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h9 id="pyagenity.graph.utils.stream_handler.StreamHandler.interrupt_after" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">interrupt_after</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.utils.stream_handler.StreamHandler.interrupt_after" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">interrupt_after</span> <span class="o">=</span> <span class="n">interrupt_after</span> <span class="ow">or</span> <span class="p">[]</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h9 id="pyagenity.graph.utils.stream_handler.StreamHandler.interrupt_before" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">interrupt_before</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.utils.stream_handler.StreamHandler.interrupt_before" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">interrupt_before</span> <span class="o">=</span> <span class="n">interrupt_before</span> <span class="ow">or</span> <span class="p">[]</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h9 id="pyagenity.graph.utils.stream_handler.StreamHandler.nodes" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">nodes</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.utils.stream_handler.StreamHandler.nodes" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">nodes</span> <span class="o">=</span> <span class="n">nodes</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>


<h8 id="pyagenity.graph.utils.stream_handler.StreamHandler-functions">Functions<a href="#pyagenity.graph.utils.stream_handler.StreamHandler-functions" class="headerlink" title="Permanent link">&para;</a></h8>

<div class="doc doc-object doc-function">


<h9 id="pyagenity.graph.utils.stream_handler.StreamHandler.__init__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">__init__</span>


<a href="#pyagenity.graph.utils.stream_handler.StreamHandler.__init__" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">__init__</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">interrupt_before</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interrupt_after</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/utils/stream_handler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@inject</span>
<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Node</span><span class="p">],</span>
    <span class="n">edges</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Edge</span><span class="p">],</span>
    <span class="n">interrupt_before</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">interrupt_after</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Node</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodes</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">edges</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">interrupt_before</span> <span class="o">=</span> <span class="n">interrupt_before</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">interrupt_after</span> <span class="o">=</span> <span class="n">interrupt_after</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_set_interrupts</span><span class="p">(</span><span class="n">interrupt_before</span><span class="p">,</span> <span class="n">interrupt_after</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h9 id="pyagenity.graph.utils.stream_handler.StreamHandler.stream" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">stream</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.utils.stream_handler.StreamHandler.stream" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">stream</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">default_state</span><span class="p">,</span> <span class="n">response_granularity</span><span class="o">=</span><span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Execute the graph asynchronously with streaming output.</p>
<p>Runs the graph workflow from start to finish, yielding incremental results
as they become available. Automatically detects whether to start a fresh
execution or resume from an interrupted state, supporting pause/resume
and checkpointing.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h10 id="pyagenity.graph.utils.stream_handler.StreamHandler.stream(input_data)" class="doc doc-heading doc-heading-parameter">                  <code>input_data</code>
<a href="#pyagenity.graph.utils.stream_handler.StreamHandler.stream(input_data)" class="headerlink" title="Permanent link">&para;</a></h10>            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input dictionary for graph execution. For new executions,
should contain 'messages' key with initial messages. For resumed
executions, can contain additional data to merge.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h10 id="pyagenity.graph.utils.stream_handler.StreamHandler.stream(config)" class="doc doc-heading doc-heading-parameter">                  <code>config</code>
<a href="#pyagenity.graph.utils.stream_handler.StreamHandler.stream(config)" class="headerlink" title="Permanent link">&para;</a></h10>            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration dictionary containing execution settings and context.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h10 id="pyagenity.graph.utils.stream_handler.StreamHandler.stream(default_state)" class="doc doc-heading doc-heading-parameter">                  <code>default_state</code>
<a href="#pyagenity.graph.utils.stream_handler.StreamHandler.stream(default_state)" class="headerlink" title="Permanent link">&para;</a></h10>            </td>
            <td>
                  <code><span title="pyagenity.graph.utils.stream_handler.StreamHandler[StateT]">StateT</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial or template AgentState for workflow execution.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h10 id="pyagenity.graph.utils.stream_handler.StreamHandler.stream(response_granularity)" class="doc doc-heading doc-heading-parameter">                  <code>response_granularity</code>
<a href="#pyagenity.graph.utils.stream_handler.StreamHandler.stream(response_granularity)" class="headerlink" title="Permanent link">&para;</a></h10>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            ResponseGranularity (pyagenity.utils.ResponseGranularity)" href="../#pyagenity.utils.ResponseGranularity">ResponseGranularity</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Level of detail in the response (LOW, PARTIAL, FULL).</p>
              </div>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            LOW


  
      class-attribute
      instance-attribute
   (pyagenity.utils.ResponseGranularity.LOW)" href="../#pyagenity.utils.ResponseGranularity.LOW">LOW</a></code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Yields:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="collections.abc.AsyncGenerator">AsyncGenerator</span>[<a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.Message)" href="../#pyagenity.utils.Message">Message</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Message objects representing incremental results from graph execution.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="collections.abc.AsyncGenerator">AsyncGenerator</span>[<a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.Message)" href="../#pyagenity.utils.Message">Message</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The exact type and frequency of yields depends on node implementations</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="collections.abc.AsyncGenerator">AsyncGenerator</span>[<a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.Message)" href="../#pyagenity.utils.Message">Message</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>and workflow configuration.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="            GraphRecursionError (pyagenity.exceptions.GraphRecursionError)" href="../#pyagenity.exceptions.GraphRecursionError">GraphRecursionError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If execution exceeds recursion limit.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If input_data is invalid for new execution.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code>Various exceptions</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Depending on node execution failures.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">handler</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
</code></pre></div>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/utils/stream_handler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">default_state</span><span class="p">:</span> <span class="n">StateT</span><span class="p">,</span>
    <span class="n">response_granularity</span><span class="p">:</span> <span class="n">ResponseGranularity</span> <span class="o">=</span> <span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="n">Message</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the graph asynchronously with streaming output.</span>

<span class="sd">    Runs the graph workflow from start to finish, yielding incremental results</span>
<span class="sd">    as they become available. Automatically detects whether to start a fresh</span>
<span class="sd">    execution or resume from an interrupted state, supporting pause/resume</span>
<span class="sd">    and checkpointing.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_data: Input dictionary for graph execution. For new executions,</span>
<span class="sd">            should contain &#39;messages&#39; key with initial messages. For resumed</span>
<span class="sd">            executions, can contain additional data to merge.</span>
<span class="sd">        config: Configuration dictionary containing execution settings and context.</span>
<span class="sd">        default_state: Initial or template AgentState for workflow execution.</span>
<span class="sd">        response_granularity: Level of detail in the response (LOW, PARTIAL, FULL).</span>

<span class="sd">    Yields:</span>
<span class="sd">        Message objects representing incremental results from graph execution.</span>
<span class="sd">        The exact type and frequency of yields depends on node implementations</span>
<span class="sd">        and workflow configuration.</span>

<span class="sd">    Raises:</span>
<span class="sd">        GraphRecursionError: If execution exceeds recursion limit.</span>
<span class="sd">        ValueError: If input_data is invalid for new execution.</span>
<span class="sd">        Various exceptions: Depending on node execution failures.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        async for chunk in handler.stream(input_data, config, state):</span>
<span class="sd">            print(chunk)</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Starting asynchronous graph execution with </span><span class="si">%d</span><span class="s2"> input keys, granularity=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="k">if</span> <span class="n">input_data</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">response_granularity</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">input_data</span> <span class="o">=</span> <span class="n">input_data</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># Load or initialize state</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading or creating state from input data&quot;</span><span class="p">)</span>
    <span class="n">new_state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">load_or_create_state</span><span class="p">(</span>
        <span class="n">input_data</span><span class="p">,</span>
        <span class="n">config</span><span class="p">,</span>
        <span class="n">default_state</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">StateT</span> <span class="o">=</span> <span class="n">new_state</span>  <span class="c1"># type: ignore[assignment]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;State loaded: interrupted=</span><span class="si">%s</span><span class="s2">, current_node=</span><span class="si">%s</span><span class="s2">, step=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">state</span><span class="o">.</span><span class="n">is_interrupted</span><span class="p">(),</span>
        <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span><span class="p">,</span>
        <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">step</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">cfg</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="s2">&quot;user&quot;</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">:</span>
        <span class="c1"># This will be available when you are calling</span>
        <span class="c1"># vi pyagenity api</span>
        <span class="k">del</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span>

    <span class="n">event</span> <span class="o">=</span> <span class="n">EventModel</span><span class="o">.</span><span class="n">default</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">},</span>
        <span class="n">content_type</span><span class="o">=</span><span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">STATE</span><span class="p">],</span>
        <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;is_interrupted&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">is_interrupted</span><span class="p">(),</span>
            <span class="s2">&quot;current_node&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span><span class="p">,</span>
            <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">step</span><span class="p">,</span>
            <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">cfg</span><span class="p">,</span>
            <span class="s2">&quot;response_granularity&quot;</span><span class="p">:</span> <span class="n">response_granularity</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="c1"># Publish graph initialization event</span>
    <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

    <span class="c1"># Check if this is a resume case</span>
    <span class="n">config</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_interrupted</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

    <span class="c1"># Now start Execution</span>
    <span class="c1"># Execute graph</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Beginning graph execution&quot;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_graph</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">chunk</span>

    <span class="c1"># Publish graph completion event</span>
    <span class="n">time_taken</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Graph execution finished in </span><span class="si">%.2f</span><span class="s2"> seconds&quot;</span><span class="p">,</span> <span class="n">time_taken</span><span class="p">)</span>

    <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
    <span class="n">event</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;time_taken&quot;</span><span class="p">:</span> <span class="n">time_taken</span><span class="p">,</span>
            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(),</span>
            <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">step</span><span class="p">,</span>
            <span class="s2">&quot;current_node&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span><span class="p">,</span>
            <span class="s2">&quot;is_interrupted&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">is_interrupted</span><span class="p">(),</span>
            <span class="s2">&quot;total_messages&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">)</span> <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">context</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>
<h6 id="pyagenity.graph.utils.stream_handler-functions">Functions<a href="#pyagenity.graph.utils.stream_handler-functions" class="headerlink" title="Permanent link">&para;</a></h6>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="pyagenity.graph.utils.stream_node_handler" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">stream_node_handler</span>


<a href="#pyagenity.graph.utils.stream_node_handler" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

        <p>Streaming node handler for PyAgenity graph workflows.</p>
<p>This module provides the StreamNodeHandler class, which manages the execution of graph nodes
that support streaming output. It handles both regular function nodes and ToolNode instances,
enabling incremental result processing, dependency injection, callback management, and
event publishing.</p>
<p>StreamNodeHandler is a key component for enabling real-time, chunked, or incremental responses
in agent workflows, supporting both synchronous and asynchronous execution patterns.</p>










<p><span class="doc-section-title">Classes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            StreamNodeHandler (pyagenity.graph.utils.stream_node_handler.StreamNodeHandler)" href="../#pyagenity.graph.utils.stream_node_handler.StreamNodeHandler">StreamNodeHandler</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Handles streaming execution for graph nodes in PyAgenity workflows.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>






<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            logger


  
      module-attribute
   (pyagenity.graph.utils.stream_node_handler.logger)" href="../#pyagenity.graph.utils.stream_node_handler.logger">logger</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>



  <div class="doc doc-children">





<h6 id="pyagenity.graph.utils.stream_node_handler-attributes">Attributes<a href="#pyagenity.graph.utils.stream_node_handler-attributes" class="headerlink" title="Permanent link">&para;</a></h6>

<div class="doc doc-object doc-attribute">



<h7 id="pyagenity.graph.utils.stream_node_handler.logger" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">logger</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#pyagenity.graph.utils.stream_node_handler.logger" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<h6 id="pyagenity.graph.utils.stream_node_handler-classes">Classes<a href="#pyagenity.graph.utils.stream_node_handler-classes" class="headerlink" title="Permanent link">&para;</a></h6>

<div class="doc doc-object doc-class">



<h7 id="pyagenity.graph.utils.stream_node_handler.StreamNodeHandler" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">StreamNodeHandler</span>


<a href="#pyagenity.graph.utils.stream_node_handler.StreamNodeHandler" class="headerlink" title="Permanent link">&para;</a></h7>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            BaseLoggingMixin (pyagenity.graph.utils.handler_mixins.BaseLoggingMixin)" href="../#pyagenity.graph.utils.handler_mixins.BaseLoggingMixin">BaseLoggingMixin</a></code></p>


        <p>Handles streaming execution for graph nodes in PyAgenity workflows.</p>
<p>StreamNodeHandler manages the execution of nodes that can produce streaming output,
including both regular function nodes and ToolNode instances. It supports dependency
injection, callback management, event publishing, and incremental result processing.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            name


  
      instance-attribute
   (pyagenity.graph.utils.stream_node_handler.StreamNodeHandler.name)" href="../#pyagenity.graph.utils.stream_node_handler.StreamNodeHandler.name">name</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique identifier for the node within the graph.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            func


  
      instance-attribute
   (pyagenity.graph.utils.stream_node_handler.StreamNodeHandler.func)" href="../#pyagenity.graph.utils.stream_node_handler.StreamNodeHandler.func">func</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The function or ToolNode to execute. Determines streaming behavior.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="n">handler</span> <span class="o">=</span> <span class="n">StreamNodeHandler</span><span class="p">(</span><span class="s2">&quot;process&quot;</span><span class="p">,</span> <span class="n">process_function</span><span class="p">)</span>
<span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">handler</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
</code></pre></div>
</details>











<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            __init__ (pyagenity.graph.utils.stream_node_handler.StreamNodeHandler.__init__)" href="../#pyagenity.graph.utils.stream_node_handler.StreamNodeHandler.__init__">__init__</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Initialize a new StreamNodeHandler instance.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            stream


  
      async
   (pyagenity.graph.utils.stream_node_handler.StreamNodeHandler.stream)" href="../#pyagenity.graph.utils.stream_node_handler.StreamNodeHandler.stream">stream</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Execute the node function with streaming output and callback support.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>



              <details class="quote">
                <summary>Source code in <code>pyagenity/graph/utils/stream_node_handler.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">StreamNodeHandler</span><span class="p">(</span><span class="n">BaseLoggingMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handles streaming execution for graph nodes in PyAgenity workflows.</span>

<span class="sd">    StreamNodeHandler manages the execution of nodes that can produce streaming output,</span>
<span class="sd">    including both regular function nodes and ToolNode instances. It supports dependency</span>
<span class="sd">    injection, callback management, event publishing, and incremental result processing.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        name: Unique identifier for the node within the graph.</span>
<span class="sd">        func: The function or ToolNode to execute. Determines streaming behavior.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        handler = StreamNodeHandler(&quot;process&quot;, process_function)</span>
<span class="sd">        async for chunk in handler.stream(config, state):</span>
<span class="sd">            print(chunk)</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">func</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="s2">&quot;ToolNode&quot;</span><span class="p">],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a new StreamNodeHandler instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: Unique identifier for the node within the graph.</span>
<span class="sd">            func: The function or ToolNode to execute. Determines streaming behavior.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_single_tool</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tool_call</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterable</span><span class="p">[</span><span class="n">Message</span><span class="p">]:</span>
        <span class="n">function_name</span> <span class="o">=</span> <span class="n">tool_call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">function_args</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">tool_call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;arguments&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="n">tool_call_id</span> <span class="o">=</span> <span class="n">tool_call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; executing tool &#39;</span><span class="si">%s</span><span class="s2">&#39; with </span><span class="si">%d</span><span class="s2"> arguments&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">function_name</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">function_args</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Tool arguments: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">function_args</span><span class="p">)</span>

        <span class="c1"># Execute the tool function with injectable parameters</span>
        <span class="n">tool_result_gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="n">function_name</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
            <span class="n">function_args</span><span class="p">,</span>
            <span class="n">tool_call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; tool execution completed successfully&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">tool_result_gen</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Message</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">result</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_call_tools</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">last_message</span><span class="p">:</span> <span class="n">Message</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="s2">&quot;AgentState&quot;</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterable</span><span class="p">[</span><span class="n">Message</span><span class="p">]:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; calling tools from message&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="n">last_message</span><span class="p">,</span> <span class="s2">&quot;tools_calls&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">last_message</span><span class="o">.</span><span class="n">tools_calls</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">last_message</span><span class="o">.</span><span class="n">tools_calls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">):</span>
            <span class="c1"># Execute tool calls</span>
            <span class="k">for</span> <span class="n">tool_call</span> <span class="ow">in</span> <span class="n">last_message</span><span class="o">.</span><span class="n">tools_calls</span><span class="p">:</span>
                <span class="n">result_gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_single_tool</span><span class="p">(</span>
                    <span class="n">tool_call</span><span class="p">,</span>
                    <span class="n">state</span><span class="p">,</span>
                    <span class="n">config</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">async</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">result_gen</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Message</span><span class="p">):</span>
                        <span class="k">yield</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># No tool calls to execute, return available tools</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39;: No tool calls to execute&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">NodeError</span><span class="p">(</span><span class="s2">&quot;No tool calls to execute&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_input_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="s2">&quot;AgentState&quot;</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">)</span>  <span class="c1"># type: ignore Tool node won&#39;t come here</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">default_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">,</span>
            <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># # Get injectable parameters to determine which ones to exclude from manual passing</span>
        <span class="c1"># # Prepare function arguments (excluding injectable parameters)</span>
        <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Skip *args/**kwargs</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">VAR_POSITIONAL</span><span class="p">,</span>
                <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">VAR_KEYWORD</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># check its state, config</span>
            <span class="k">if</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">]:</span>
                <span class="n">input_data</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_data</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span>
            <span class="c1"># Include regular function arguments</span>
            <span class="k">elif</span> <span class="n">param</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Missing required parameter &#39;</span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2">&#39; for function &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">input_data</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_call_normal_node</span><span class="p">(</span>  <span class="c1"># noqa: PLR0912, PLR0915</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="s2">&quot;AgentState&quot;</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">callback_mgr</span><span class="p">:</span> <span class="n">CallbackManager</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterable</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="n">Message</span><span class="p">]:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; calling normal function&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">result</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="n">Message</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; is a regular function, executing with callbacks&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="c1"># This is a regular function - likely AI function</span>
        <span class="c1"># Create callback context for AI invocation</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">CallbackContext</span><span class="p">(</span>
            <span class="n">invocation_type</span><span class="o">=</span><span class="n">InvocationType</span><span class="o">.</span><span class="n">AI</span><span class="p">,</span>
            <span class="n">node_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">function_name</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">)),</span>
            <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># Execute before_invoke callbacks</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_input_data</span><span class="p">(</span>
            <span class="n">state</span><span class="p">,</span>
            <span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">last_message</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">context</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">event</span> <span class="o">=</span> <span class="n">EventModel</span><span class="o">.</span><span class="n">default</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()},</span>
            <span class="n">event</span><span class="o">=</span><span class="n">Event</span><span class="o">.</span><span class="n">NODE_EXECUTION</span><span class="p">,</span>
            <span class="n">content_type</span><span class="o">=</span><span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">STATE</span><span class="p">],</span>
            <span class="n">node_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;node&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;function_name&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">)),</span>
                <span class="s2">&quot;last_message&quot;</span><span class="p">:</span> <span class="n">last_message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">last_message</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; executing before_invoke callbacks&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="c1"># Execute before_invoke callbacks</span>
            <span class="n">input_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">callback_mgr</span><span class="o">.</span><span class="n">execute_before_invoke</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; executing function&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">PROGRESS</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;Function execution started&quot;</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

            <span class="c1"># Execute the actual function</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_sync_or_async</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
                <span class="o">**</span><span class="n">input_data</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; function execution completed&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; executing after_invoke callbacks&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="c1"># Execute after_invoke callbacks</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">callback_mgr</span><span class="o">.</span><span class="n">execute_after_invoke</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

            <span class="c1"># Now lets convert the response here only, upstream will be easy to handle</span>
            <span class="c1">##############################################################################</span>
            <span class="c1">################### Logics for streaming ##########################</span>
            <span class="c1">##############################################################################</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Check user sending command or not</span>
<span class="sd">            if command then we will check its streaming or not</span>
<span class="sd">            if streaming then we will yield from converter stream</span>
<span class="sd">            if not streaming then we will convert it and yield end event</span>
<span class="sd">            if its not command then we will check its streaming or not</span>
<span class="sd">            if streaming then we will yield from converter stream</span>
<span class="sd">            if not streaming then we will convert it and yield end event</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># first check its sync and not streaming</span>
            <span class="n">next_node</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">final_result</span> <span class="o">=</span> <span class="n">result</span>
            <span class="c1"># if type of command then we will update it</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Command</span><span class="p">):</span>
                <span class="c1"># now check the updated</span>
                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">:</span>
                    <span class="n">final_result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">update</span>

                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">state</span><span class="p">:</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">state</span>
                    <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">msg</span>

                <span class="n">next_node</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">goto</span>

            <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">check_non_streaming</span><span class="p">(</span><span class="n">final_result</span><span class="p">):</span>
                <span class="n">new_state</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">next_node</span> <span class="o">=</span> <span class="k">await</span> <span class="n">process_node_result</span><span class="p">(</span>
                    <span class="n">final_result</span><span class="p">,</span>
                    <span class="n">state</span><span class="p">,</span>
                    <span class="n">messages</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_state</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
                <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
                <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">]</span> <span class="k">if</span> <span class="n">messages</span> <span class="k">else</span> <span class="p">[]</span>
                <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;next_node&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_node</span>
                <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">m</span>

                <span class="k">yield</span> <span class="p">{</span>
                    <span class="s2">&quot;is_non_streaming&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">new_state</span><span class="p">,</span>
                    <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span>
                    <span class="s2">&quot;next_node&quot;</span><span class="p">:</span> <span class="n">next_node</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="k">return</span>  <span class="c1"># done</span>

            <span class="c1"># If the result is a ConverterCall with stream=True, use the converter</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ModelResponseConverter</span><span class="p">)</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">response</span><span class="p">:</span>
                <span class="n">stream_gen</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
                    <span class="n">config</span><span class="p">,</span>
                    <span class="n">node_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">meta</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;function_name&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">)),</span>
                    <span class="p">},</span>
                <span class="p">)</span>
                <span class="c1"># this will return event_model or message</span>
                <span class="k">async</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">stream_gen</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Message</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">delta</span><span class="p">:</span>
                        <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="n">item</span>
            <span class="c1"># Things are done, so publish event and yield final response</span>
            <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
            <span class="k">if</span> <span class="n">messages</span><span class="p">:</span>
                <span class="n">final_msg</span> <span class="o">=</span> <span class="n">messages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_msg</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
                <span class="c1"># Populate simple content and structured blocks when available</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">final_msg</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">final_msg</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">final_msg</span><span class="o">.</span><span class="n">content</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">final_msg</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="n">final_msg</span><span class="o">.</span><span class="n">content</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_blocks</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">STATE</span><span class="p">]</span>
            <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="c1"># if user use command and its streaming in that case we need to handle next node also</span>
            <span class="k">yield</span> <span class="p">{</span>
                <span class="s2">&quot;is_non_streaming&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span>
                <span class="s2">&quot;next_node&quot;</span><span class="p">:</span> <span class="n">next_node</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; execution failed, executing error callbacks: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span>
            <span class="p">)</span>
            <span class="c1"># Execute error callbacks</span>
            <span class="n">recovery_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">callback_mgr</span><span class="o">.</span><span class="n">execute_on_error</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recovery_result</span><span class="p">,</span> <span class="n">Message</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; recovered from error using callback result&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># Use recovery result instead of raising the error</span>
                <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">END</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;Function execution recovered from error&quot;</span>
                <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recovery_result</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">STATE</span><span class="p">]</span>
                <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

                <span class="k">yield</span> <span class="n">recovery_result</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Re-raise the original error</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; could not recover from error&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">ERROR</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Function execution failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">event</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContentType</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">STATE</span><span class="p">]</span>
                <span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">raise</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
        <span class="n">callback_mgr</span><span class="p">:</span> <span class="n">CallbackManager</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="n">Message</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the node function with streaming output and callback support.</span>

<span class="sd">        Handles both ToolNode and regular function nodes, yielding incremental results</span>
<span class="sd">        as they become available. Supports dependency injection, callback management,</span>
<span class="sd">        and event publishing for monitoring and debugging.</span>

<span class="sd">        Args:</span>
<span class="sd">            config: Configuration dictionary containing execution context and settings.</span>
<span class="sd">            state: Current AgentState providing workflow context and shared state.</span>
<span class="sd">            callback_mgr: Callback manager for pre/post execution hook handling.</span>

<span class="sd">        Yields:</span>
<span class="sd">            Dictionary objects or Message instances representing incremental outputs</span>
<span class="sd">            from the node function. The exact type and frequency of yields depends on</span>
<span class="sd">            the node function&#39;s streaming implementation.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NodeError: If node execution fails or encounters an error.</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            async for chunk in handler.stream(config, state):</span>
<span class="sd">                print(chunk)</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Executing node &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; execution with state context size=</span><span class="si">%d</span><span class="s2">, config keys=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">)</span> <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">context</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">config</span> <span class="k">else</span> <span class="p">[],</span>
        <span class="p">)</span>

        <span class="c1"># In this function publishing events not required</span>
        <span class="c1"># If its tool node, its already handled there, from start to end</span>
        <span class="c1"># In this class we need to handle normal function calls only</span>
        <span class="c1"># We will yield events from here only for normal function calls</span>
        <span class="c1"># ToolNode will yield events from its own stream method</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">ToolNode</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; is a ToolNode, executing tool calls&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="c1"># This is tool execution - handled separately in ToolNode</span>
                <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">context</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">last_message</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; processing tool calls from last message&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_tools</span><span class="p">(</span>
                        <span class="n">last_message</span><span class="p">,</span>
                        <span class="n">state</span><span class="p">,</span>
                        <span class="n">config</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">async</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">item</span>
                    <span class="c1"># Check if last message has tool calls to execute</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># No context, return available tools</span>
                    <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;No context available for tool execution&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">NodeError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_normal_node</span><span class="p">(</span>
                    <span class="n">state</span><span class="p">,</span>
                    <span class="n">config</span><span class="p">,</span>
                    <span class="n">callback_mgr</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">async</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">item</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; execution completed successfully&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># This is the final catch-all for node execution errors</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; execution failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">NodeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">





<h8 id="pyagenity.graph.utils.stream_node_handler.StreamNodeHandler-attributes">Attributes<a href="#pyagenity.graph.utils.stream_node_handler.StreamNodeHandler-attributes" class="headerlink" title="Permanent link">&para;</a></h8>

<div class="doc doc-object doc-attribute">



<h9 id="pyagenity.graph.utils.stream_node_handler.StreamNodeHandler.func" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">func</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.utils.stream_node_handler.StreamNodeHandler.func" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h9 id="pyagenity.graph.utils.stream_node_handler.StreamNodeHandler.name" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">name</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#pyagenity.graph.utils.stream_node_handler.StreamNodeHandler.name" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>


<h8 id="pyagenity.graph.utils.stream_node_handler.StreamNodeHandler-functions">Functions<a href="#pyagenity.graph.utils.stream_node_handler.StreamNodeHandler-functions" class="headerlink" title="Permanent link">&para;</a></h8>

<div class="doc doc-object doc-function">


<h9 id="pyagenity.graph.utils.stream_node_handler.StreamNodeHandler.__init__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">__init__</span>


<a href="#pyagenity.graph.utils.stream_node_handler.StreamNodeHandler.__init__" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Initialize a new StreamNodeHandler instance.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h10 id="pyagenity.graph.utils.stream_node_handler.StreamNodeHandler.__init__(name)" class="doc doc-heading doc-heading-parameter">                  <code>name</code>
<a href="#pyagenity.graph.utils.stream_node_handler.StreamNodeHandler.__init__(name)" class="headerlink" title="Permanent link">&para;</a></h10>            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique identifier for the node within the graph.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h10 id="pyagenity.graph.utils.stream_node_handler.StreamNodeHandler.__init__(func)" class="doc doc-heading doc-heading-parameter">                  <code>func</code>
<a href="#pyagenity.graph.utils.stream_node_handler.StreamNodeHandler.__init__(func)" class="headerlink" title="Permanent link">&para;</a></h10>            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="collections.abc.Callable">Callable</span>, <a class="autorefs autorefs-internal" title="            ToolNode (pyagenity.graph.tool_node.ToolNode)" href="../#pyagenity.graph.tool_node.ToolNode">ToolNode</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The function or ToolNode to execute. Determines streaming behavior.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/utils/stream_node_handler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">func</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="s2">&quot;ToolNode&quot;</span><span class="p">],</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize a new StreamNodeHandler instance.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: Unique identifier for the node within the graph.</span>
<span class="sd">        func: The function or ToolNode to execute. Determines streaming behavior.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h9 id="pyagenity.graph.utils.stream_node_handler.StreamNodeHandler.stream" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">stream</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.utils.stream_node_handler.StreamNodeHandler.stream" class="headerlink" title="Permanent link">&para;</a></h9>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">stream</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">callback_mgr</span><span class="o">=</span><span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">])</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Execute the node function with streaming output and callback support.</p>
<p>Handles both ToolNode and regular function nodes, yielding incremental results
as they become available. Supports dependency injection, callback management,
and event publishing for monitoring and debugging.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h10 id="pyagenity.graph.utils.stream_node_handler.StreamNodeHandler.stream(config)" class="doc doc-heading doc-heading-parameter">                  <code>config</code>
<a href="#pyagenity.graph.utils.stream_node_handler.StreamNodeHandler.stream(config)" class="headerlink" title="Permanent link">&para;</a></h10>            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration dictionary containing execution context and settings.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h10 id="pyagenity.graph.utils.stream_node_handler.StreamNodeHandler.stream(state)" class="doc doc-heading doc-heading-parameter">                  <code>state</code>
<a href="#pyagenity.graph.utils.stream_node_handler.StreamNodeHandler.stream(state)" class="headerlink" title="Permanent link">&para;</a></h10>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            AgentState (pyagenity.state.AgentState)" href="../#pyagenity.state.AgentState">AgentState</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Current AgentState providing workflow context and shared state.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h10 id="pyagenity.graph.utils.stream_node_handler.StreamNodeHandler.stream(callback_mgr)" class="doc doc-heading doc-heading-parameter">                  <code>callback_mgr</code>
<a href="#pyagenity.graph.utils.stream_node_handler.StreamNodeHandler.stream(callback_mgr)" class="headerlink" title="Permanent link">&para;</a></h10>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            CallbackManager (pyagenity.utils.CallbackManager)" href="../#pyagenity.utils.CallbackManager">CallbackManager</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Callback manager for pre/post execution hook handling.</p>
              </div>
            </td>
            <td>
                  <code><span title="injectq.Inject">Inject</span>[<a class="autorefs autorefs-internal" title="            CallbackManager (pyagenity.utils.CallbackManager)" href="../#pyagenity.utils.CallbackManager">CallbackManager</a>]</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Yields:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="collections.abc.AsyncGenerator">AsyncGenerator</span>[<span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | <a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.Message)" href="../#pyagenity.utils.Message">Message</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary objects or Message instances representing incremental outputs</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="collections.abc.AsyncGenerator">AsyncGenerator</span>[<span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | <a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.Message)" href="../#pyagenity.utils.Message">Message</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>from the node function. The exact type and frequency of yields depends on</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="collections.abc.AsyncGenerator">AsyncGenerator</span>[<span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | <a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.Message)" href="../#pyagenity.utils.Message">Message</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the node function's streaming implementation.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="            NodeError (pyagenity.exceptions.NodeError)" href="../#pyagenity.exceptions.NodeError">NodeError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If node execution fails or encounters an error.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">handler</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
</code></pre></div>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/utils/stream_node_handler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
    <span class="n">callback_mgr</span><span class="p">:</span> <span class="n">CallbackManager</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">CallbackManager</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="n">Message</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the node function with streaming output and callback support.</span>

<span class="sd">    Handles both ToolNode and regular function nodes, yielding incremental results</span>
<span class="sd">    as they become available. Supports dependency injection, callback management,</span>
<span class="sd">    and event publishing for monitoring and debugging.</span>

<span class="sd">    Args:</span>
<span class="sd">        config: Configuration dictionary containing execution context and settings.</span>
<span class="sd">        state: Current AgentState providing workflow context and shared state.</span>
<span class="sd">        callback_mgr: Callback manager for pre/post execution hook handling.</span>

<span class="sd">    Yields:</span>
<span class="sd">        Dictionary objects or Message instances representing incremental outputs</span>
<span class="sd">        from the node function. The exact type and frequency of yields depends on</span>
<span class="sd">        the node function&#39;s streaming implementation.</span>

<span class="sd">    Raises:</span>
<span class="sd">        NodeError: If node execution fails or encounters an error.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        async for chunk in handler.stream(config, state):</span>
<span class="sd">            print(chunk)</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Executing node &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; execution with state context size=</span><span class="si">%d</span><span class="s2">, config keys=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">)</span> <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">context</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nb">list</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">config</span> <span class="k">else</span> <span class="p">[],</span>
    <span class="p">)</span>

    <span class="c1"># In this function publishing events not required</span>
    <span class="c1"># If its tool node, its already handled there, from start to end</span>
    <span class="c1"># In this class we need to handle normal function calls only</span>
    <span class="c1"># We will yield events from here only for normal function calls</span>
    <span class="c1"># ToolNode will yield events from its own stream method</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">ToolNode</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; is a ToolNode, executing tool calls&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="c1"># This is tool execution - handled separately in ToolNode</span>
            <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">context</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">last_message</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; processing tool calls from last message&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_tools</span><span class="p">(</span>
                    <span class="n">last_message</span><span class="p">,</span>
                    <span class="n">state</span><span class="p">,</span>
                    <span class="n">config</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">async</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">item</span>
                <span class="c1"># Check if last message has tool calls to execute</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># No context, return available tools</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;No context available for tool execution&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">NodeError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_normal_node</span><span class="p">(</span>
                <span class="n">state</span><span class="p">,</span>
                <span class="n">config</span><span class="p">,</span>
                <span class="n">callback_mgr</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">async</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">item</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; execution completed successfully&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># This is the final catch-all for node execution errors</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; execution failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">NodeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>
<h6 id="pyagenity.graph.utils.stream_node_handler-functions">Functions<a href="#pyagenity.graph.utils.stream_node_handler-functions" class="headerlink" title="Permanent link">&para;</a></h6>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="pyagenity.graph.utils.stream_utils" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">stream_utils</span>


<a href="#pyagenity.graph.utils.stream_utils" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

        <p>Streaming utility functions for PyAgenity graph workflows.</p>
<p>This module provides helper functions for determining whether a result from a node
or tool execution should be treated as non-streaming (i.e., a complete result)
or processed incrementally as a stream. These utilities are used throughout the
graph execution engine to support both synchronous and streaming workflows.</p>












<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            check_non_streaming (pyagenity.graph.utils.stream_utils.check_non_streaming)" href="../#pyagenity.graph.utils.stream_utils.check_non_streaming">check_non_streaming</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Determine if a result should be treated as non-streaming.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>





  <div class="doc doc-children">







<h6 id="pyagenity.graph.utils.stream_utils-classes">Classes<a href="#pyagenity.graph.utils.stream_utils-classes" class="headerlink" title="Permanent link">&para;</a></h6>
<h6 id="pyagenity.graph.utils.stream_utils-functions">Functions<a href="#pyagenity.graph.utils.stream_utils-functions" class="headerlink" title="Permanent link">&para;</a></h6>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.utils.stream_utils.check_non_streaming" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">check_non_streaming</span>


<a href="#pyagenity.graph.utils.stream_utils.check_non_streaming" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">check_non_streaming</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Determine if a result should be treated as non-streaming.</p>
<p>Checks whether the given result is a complete, non-streaming output (such as a list,
dict, string, Message, or AgentState) or if it should be processed incrementally as a stream.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.utils.stream_utils.check_non_streaming(result)" class="doc doc-heading doc-heading-parameter">                  <code>result</code>
<a href="#pyagenity.graph.utils.stream_utils.check_non_streaming(result)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The result object returned from a node or tool execution. Can be any type.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if the result is non-streaming and should be processed as a complete output;</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td></td>            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>False if the result should be handled as a stream.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>check_non_streaming([Message.text_message("done")])
True
check_non_streaming(Message.text_message("done"))
True
check_non_streaming({"choices": [...]})
True
check_non_streaming("some text")
True</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/utils/stream_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_non_streaming</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Determine if a result should be treated as non-streaming.</span>

<span class="sd">    Checks whether the given result is a complete, non-streaming output (such as a list,</span>
<span class="sd">    dict, string, Message, or AgentState) or if it should be processed incrementally as a stream.</span>

<span class="sd">    Args:</span>
<span class="sd">        result: The result object returned from a node or tool execution. Can be any type.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if the result is non-streaming and should be processed as a complete output;</span>
<span class="sd">        False if the result should be handled as a stream.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; check_non_streaming([Message.text_message(&quot;done&quot;)])</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; check_non_streaming(Message.text_message(&quot;done&quot;))</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; check_non_streaming({&quot;choices&quot;: [...]})</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; check_non_streaming(&quot;some text&quot;)</span>
<span class="sd">        True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">dict</span> <span class="o">|</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Message</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">AgentState</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;choices&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Message</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="pyagenity.graph.utils.utils" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">utils</span>


<a href="#pyagenity.graph.utils.utils" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

        <p>Core utility functions for graph execution and state management.</p>
<p>This module provides essential utilities for PyAgenity graph execution, including
state management, message processing, response formatting, and execution flow control.
These functions handle the low-level operations that support graph workflow execution.</p>
<p>The utilities in this module are designed to work with PyAgenity's dependency injection
system and provide consistent interfaces for common operations across different
execution contexts.</p>
<p>Key functionality areas:
- State loading, creation, and synchronization
- Message processing and deduplication
- Response formatting based on granularity levels
- Node execution result processing
- Interrupt handling and execution flow control</p>












<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            call_realtime_sync


  
      async
   (pyagenity.graph.utils.utils.call_realtime_sync)" href="../#pyagenity.graph.utils.utils.call_realtime_sync">call_realtime_sync</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Call the realtime state sync hook if provided.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            check_and_handle_interrupt


  
      async
   (pyagenity.graph.utils.utils.check_and_handle_interrupt)" href="../#pyagenity.graph.utils.utils.check_and_handle_interrupt">check_and_handle_interrupt</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Check for interrupts and save state if needed. Returns True if interrupted.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            get_next_node (pyagenity.graph.utils.utils.get_next_node)" href="../#pyagenity.graph.utils.utils.get_next_node">get_next_node</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Get the next node to execute based on edges.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            load_or_create_state


  
      async
   (pyagenity.graph.utils.utils.load_or_create_state)" href="../#pyagenity.graph.utils.utils.load_or_create_state">load_or_create_state</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Load existing state from checkpointer or create new state.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            parse_response


  
      async
   (pyagenity.graph.utils.utils.parse_response)" href="../#pyagenity.graph.utils.utils.parse_response">parse_response</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Parse and format execution response based on specified granularity level.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            process_node_result


  
      async
   (pyagenity.graph.utils.utils.process_node_result)" href="../#pyagenity.graph.utils.utils.process_node_result">process_node_result</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Processes the result from a node execution, updating the agent state, message list,</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            reload_state


  
      async
   (pyagenity.graph.utils.utils.reload_state)" href="../#pyagenity.graph.utils.utils.reload_state">reload_state</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Load existing state from checkpointer or create new state.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            sync_data


  
      async
   (pyagenity.graph.utils.utils.sync_data)" href="../#pyagenity.graph.utils.utils.sync_data">sync_data</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Sync the current state and messages to the checkpointer.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>




<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            StateT


  
      module-attribute
   (pyagenity.graph.utils.utils.StateT)" href="../#pyagenity.graph.utils.utils.StateT">StateT</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            logger


  
      module-attribute
   (pyagenity.graph.utils.utils.logger)" href="../#pyagenity.graph.utils.utils.logger">logger</a></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>



  <div class="doc doc-children">





<h6 id="pyagenity.graph.utils.utils-attributes">Attributes<a href="#pyagenity.graph.utils.utils-attributes" class="headerlink" title="Permanent link">&para;</a></h6>

<div class="doc doc-object doc-attribute">



<h7 id="pyagenity.graph.utils.utils.StateT" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">StateT</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#pyagenity.graph.utils.utils.StateT" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">StateT</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;StateT&#39;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">AgentState</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="pyagenity.graph.utils.utils.logger" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">logger</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#pyagenity.graph.utils.utils.logger" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

    </div>

</div>

<h6 id="pyagenity.graph.utils.utils-classes">Classes<a href="#pyagenity.graph.utils.utils-classes" class="headerlink" title="Permanent link">&para;</a></h6>
<h6 id="pyagenity.graph.utils.utils-functions">Functions<a href="#pyagenity.graph.utils.utils-functions" class="headerlink" title="Permanent link">&para;</a></h6>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.utils.utils.call_realtime_sync" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">call_realtime_sync</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.utils.utils.call_realtime_sync" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">call_realtime_sync</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">checkpointer</span><span class="o">=</span><span class="n">Inject</span><span class="p">[</span><span class="n">BaseCheckpointer</span><span class="p">])</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Call the realtime state sync hook if provided.</p>


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/utils/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">call_realtime_sync</span><span class="p">(</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">checkpointer</span><span class="p">:</span> <span class="n">BaseCheckpointer</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">BaseCheckpointer</span><span class="p">],</span>  <span class="c1"># will be auto-injected</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Call the realtime state sync hook if provided.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">checkpointer</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Calling realtime state sync hook&quot;</span><span class="p">)</span>
        <span class="c1"># await call_sync_or_async(checkpointer.a, config, state)</span>
        <span class="k">await</span> <span class="n">checkpointer</span><span class="o">.</span><span class="n">aput_state_cache</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.utils.utils.check_and_handle_interrupt" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">check_and_handle_interrupt</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.utils.utils.check_and_handle_interrupt" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">check_and_handle_interrupt</span><span class="p">(</span><span class="n">interrupt_before</span><span class="p">,</span> <span class="n">interrupt_after</span><span class="p">,</span> <span class="n">current_node</span><span class="p">,</span> <span class="n">interrupt_type</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">_sync_data</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Check for interrupts and save state if needed. Returns True if interrupted.</p>


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/utils/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">check_and_handle_interrupt</span><span class="p">(</span>
    <span class="n">interrupt_before</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">interrupt_after</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">current_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">interrupt_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">_sync_data</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check for interrupts and save state if needed. Returns True if interrupted.&quot;&quot;&quot;</span>
    <span class="n">interrupt_nodes</span> <span class="o">=</span> <span class="n">interrupt_before</span> <span class="k">if</span> <span class="n">interrupt_type</span> <span class="o">==</span> <span class="s2">&quot;before&quot;</span> <span class="k">else</span> <span class="n">interrupt_after</span>

    <span class="k">if</span> <span class="n">current_node</span> <span class="ow">in</span> <span class="n">interrupt_nodes</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ExecutionStatus</span><span class="o">.</span><span class="n">INTERRUPTED_BEFORE</span>
            <span class="k">if</span> <span class="n">interrupt_type</span> <span class="o">==</span> <span class="s2">&quot;before&quot;</span>
            <span class="k">else</span> <span class="n">ExecutionStatus</span><span class="o">.</span><span class="n">INTERRUPTED_AFTER</span>
        <span class="p">)</span>
        <span class="n">state</span><span class="o">.</span><span class="n">set_interrupt</span><span class="p">(</span>
            <span class="n">current_node</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;interrupt_</span><span class="si">{</span><span class="n">interrupt_type</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">current_node</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">status</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Save state and interrupt</span>
        <span class="k">await</span> <span class="n">_sync_data</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node &#39;</span><span class="si">%s</span><span class="s2">&#39; interrupted&quot;</span><span class="p">,</span> <span class="n">current_node</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;No interrupts found for node &#39;</span><span class="si">%s</span><span class="s2">&#39;, continuing execution&quot;</span><span class="p">,</span>
        <span class="n">current_node</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.utils.utils.get_next_node" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">get_next_node</span>


<a href="#pyagenity.graph.utils.utils.get_next_node" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_next_node</span><span class="p">(</span><span class="n">current_node</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">edges</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Get the next node to execute based on edges.</p>


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/utils/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_next_node</span><span class="p">(</span>
    <span class="n">current_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
    <span class="n">edges</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the next node to execute based on edges.&quot;&quot;&quot;</span>
    <span class="c1"># Find outgoing edges from current node</span>
    <span class="n">outgoing_edges</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">edges</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">from_node</span> <span class="o">==</span> <span class="n">current_node</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">outgoing_edges</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No outgoing edges from node &#39;</span><span class="si">%s</span><span class="s2">&#39;, ending execution&quot;</span><span class="p">,</span> <span class="n">current_node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">END</span>

    <span class="c1"># Handle conditional edges</span>
    <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">outgoing_edges</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">edge</span><span class="o">.</span><span class="n">condition</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">condition_result</span> <span class="o">=</span> <span class="n">edge</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="s2">&quot;condition_result&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">edge</span><span class="o">.</span><span class="n">condition_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Mapped conditional edge</span>
                    <span class="k">if</span> <span class="n">condition_result</span> <span class="o">==</span> <span class="n">edge</span><span class="o">.</span><span class="n">condition_result</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">edge</span><span class="o">.</span><span class="n">to_node</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">condition_result</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">condition_result</span>
                <span class="k">elif</span> <span class="n">condition_result</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">edge</span><span class="o">.</span><span class="n">to_node</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error evaluating condition for edge: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">edge</span><span class="p">)</span>
                <span class="k">continue</span>

    <span class="c1"># Return first static edge if no conditions matched</span>
    <span class="n">static_edges</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">outgoing_edges</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">condition</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">static_edges</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">static_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_node</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No valid edges found from node &#39;</span><span class="si">%s</span><span class="s2">&#39;, ending execution&quot;</span><span class="p">,</span> <span class="n">current_node</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">END</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.utils.utils.load_or_create_state" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">load_or_create_state</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.utils.utils.load_or_create_state" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">load_or_create_state</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">old_state</span><span class="p">,</span> <span class="n">checkpointer</span><span class="o">=</span><span class="n">Inject</span><span class="p">[</span><span class="n">BaseCheckpointer</span><span class="p">])</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Load existing state from checkpointer or create new state.</p>
<p>Attempts to fetch a realtime-synced state first, then falls back to
the persistent checkpointer. If no existing state is found, creates
a new state from the <code>StateGraph</code>'s prototype state and merges any
incoming messages. Supports partial state update via 'state' in input_data.</p>


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/utils/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">load_or_create_state</span><span class="p">[</span><span class="n">StateT</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">](</span>  <span class="c1"># noqa: PLR0912, PLR0915</span>
    <span class="n">input_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">old_state</span><span class="p">:</span> <span class="n">StateT</span><span class="p">,</span>
    <span class="n">checkpointer</span><span class="p">:</span> <span class="n">BaseCheckpointer</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">BaseCheckpointer</span><span class="p">],</span>  <span class="c1"># will be auto-injected</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StateT</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load existing state from checkpointer or create new state.</span>

<span class="sd">    Attempts to fetch a realtime-synced state first, then falls back to</span>
<span class="sd">    the persistent checkpointer. If no existing state is found, creates</span>
<span class="sd">    a new state from the `StateGraph`&#39;s prototype state and merges any</span>
<span class="sd">    incoming messages. Supports partial state update via &#39;state&#39; in input_data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading or creating state with thread_id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;thread_id&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">))</span>

    <span class="c1"># Try to load existing state if checkpointer is available</span>
    <span class="k">if</span> <span class="n">checkpointer</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Attempting to load existing state from checkpointer&quot;</span><span class="p">)</span>
        <span class="c1"># first check realtime-synced state</span>
        <span class="n">existing_state</span><span class="p">:</span> <span class="n">StateT</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="k">await</span> <span class="n">checkpointer</span><span class="o">.</span><span class="n">aget_state_cache</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">existing_state</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No synced state found, trying persistent checkpointer&quot;</span><span class="p">)</span>
            <span class="c1"># If no synced state, try to get from persistent checkpointer</span>
            <span class="n">existing_state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">checkpointer</span><span class="o">.</span><span class="n">aget_state</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">existing_state</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Loaded existing state with </span><span class="si">%d</span><span class="s2"> context messages, current_node=</span><span class="si">%s</span><span class="s2">, step=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">existing_state</span><span class="o">.</span><span class="n">context</span><span class="p">)</span> <span class="k">if</span> <span class="n">existing_state</span><span class="o">.</span><span class="n">context</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">existing_state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span><span class="p">,</span>
                <span class="n">existing_state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">step</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Normalize legacy node names (backward compatibility)</span>
            <span class="c1"># Some older runs may have persisted &#39;start&#39;/&#39;end&#39; instead of &#39;__start__&#39;/&#39;__end__&#39;</span>
            <span class="k">if</span> <span class="n">existing_state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span> <span class="o">==</span> <span class="s2">&quot;start&quot;</span><span class="p">:</span>
                <span class="n">existing_state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span> <span class="o">=</span> <span class="n">START</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Normalized legacy current_node &#39;start&#39; to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">START</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">existing_state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span> <span class="o">==</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span>
                <span class="n">existing_state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span> <span class="o">=</span> <span class="n">END</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Normalized legacy current_node &#39;end&#39; to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">END</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">existing_state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span> <span class="o">==</span> <span class="s2">&quot;__start__&quot;</span><span class="p">:</span>
                <span class="n">existing_state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span> <span class="o">=</span> <span class="n">START</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Normalized legacy current_node &#39;__start__&#39; to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">START</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">existing_state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span> <span class="o">==</span> <span class="s2">&quot;__end__&quot;</span><span class="p">:</span>
                <span class="n">existing_state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span> <span class="o">=</span> <span class="n">END</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Normalized legacy current_node &#39;__end__&#39; to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">END</span><span class="p">)</span>
            <span class="c1"># Merge new messages with existing context</span>
            <span class="n">new_messages</span> <span class="o">=</span> <span class="n">input_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">new_messages</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Merging </span><span class="si">%d</span><span class="s2"> new messages with existing context&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_messages</span><span class="p">))</span>
                <span class="n">existing_state</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">add_messages</span><span class="p">(</span><span class="n">existing_state</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">new_messages</span><span class="p">)</span>
            <span class="c1"># Merge partial state fields if provided</span>
            <span class="n">partial_state</span> <span class="o">=</span> <span class="n">input_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="n">partial_state</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">partial_state</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Merging partial state with </span><span class="si">%d</span><span class="s2"> fields&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">partial_state</span><span class="p">))</span>
                <span class="n">_update_state_fields</span><span class="p">(</span><span class="n">existing_state</span><span class="p">,</span> <span class="n">partial_state</span><span class="p">)</span>
            <span class="c1"># Update current node if available</span>
            <span class="k">if</span> <span class="s2">&quot;current_node&quot;</span> <span class="ow">in</span> <span class="n">partial_state</span> <span class="ow">and</span> <span class="n">partial_state</span><span class="p">[</span><span class="s2">&quot;current_node&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">existing_state</span><span class="o">.</span><span class="n">set_current_node</span><span class="p">(</span><span class="n">partial_state</span><span class="p">[</span><span class="s2">&quot;current_node&quot;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">existing_state</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No checkpointer available, will create new state&quot;</span><span class="p">)</span>

    <span class="c1"># Create new state by deep copying the graph&#39;s prototype state</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating new state from graph prototype&quot;</span><span class="p">)</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">old_state</span><span class="p">)</span>

    <span class="c1"># Ensure core AgentState fields are properly initialized</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;context&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">state</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Initialized empty context list&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;context_summary&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">state</span><span class="o">.</span><span class="n">context_summary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">context_summary</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Initialized context_summary as None&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;execution_meta&quot;</span><span class="p">):</span>
        <span class="c1"># Create a fresh execution metadata</span>
        <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span> <span class="o">=</span> <span class="n">ExecMeta</span><span class="p">(</span><span class="n">current_node</span><span class="o">=</span><span class="n">START</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Created fresh execution metadata starting at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">START</span><span class="p">)</span>

    <span class="c1"># Set thread_id in execution metadata</span>
    <span class="n">thread_id</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;thread_id&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">)</span>
    <span class="n">state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">thread_id</span> <span class="o">=</span> <span class="n">thread_id</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Set thread_id to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">thread_id</span><span class="p">)</span>

    <span class="c1"># Merge new messages with context</span>
    <span class="n">new_messages</span> <span class="o">=</span> <span class="n">input_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="n">new_messages</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding </span><span class="si">%d</span><span class="s2"> new messages to fresh state&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_messages</span><span class="p">))</span>
        <span class="n">state</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">add_messages</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">new_messages</span><span class="p">)</span>
    <span class="c1"># Merge partial state fields if provided</span>
    <span class="n">partial_state</span> <span class="o">=</span> <span class="n">input_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">if</span> <span class="n">partial_state</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">partial_state</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Merging partial state with </span><span class="si">%d</span><span class="s2"> fields&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">partial_state</span><span class="p">))</span>
        <span class="n">_update_state_fields</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">partial_state</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Created new state with </span><span class="si">%d</span><span class="s2"> context messages&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">)</span> <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">context</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;current_node&quot;</span> <span class="ow">in</span> <span class="n">partial_state</span> <span class="ow">and</span> <span class="n">partial_state</span><span class="p">[</span><span class="s2">&quot;current_node&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Normalize legacy values if provided in partial state</span>
        <span class="n">next_node</span> <span class="o">=</span> <span class="n">partial_state</span><span class="p">[</span><span class="s2">&quot;current_node&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">next_node</span> <span class="o">==</span> <span class="s2">&quot;__start__&quot;</span><span class="p">:</span>
            <span class="n">next_node</span> <span class="o">=</span> <span class="n">START</span>
        <span class="k">elif</span> <span class="n">next_node</span> <span class="o">==</span> <span class="s2">&quot;__end__&quot;</span><span class="p">:</span>
            <span class="n">next_node</span> <span class="o">=</span> <span class="n">END</span>
        <span class="n">state</span><span class="o">.</span><span class="n">set_current_node</span><span class="p">(</span><span class="n">next_node</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">state</span>  <span class="c1"># type: ignore[return-value]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.utils.utils.parse_response" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">parse_response</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.utils.utils.parse_response" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">parse_response</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">response_granularity</span><span class="o">=</span><span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Parse and format execution response based on specified granularity level.</p>
<p>Formats the final response from graph execution according to the requested
granularity level, allowing clients to receive different levels of detail
depending on their needs.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.utils.utils.parse_response(state)" class="doc doc-heading doc-heading-parameter">                  <code>state</code>
<a href="#pyagenity.graph.utils.utils.parse_response(state)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            AgentState (pyagenity.state.AgentState)" href="../#pyagenity.state.AgentState">AgentState</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The final agent state after graph execution.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.utils.utils.parse_response(messages)" class="doc doc-heading doc-heading-parameter">                  <code>messages</code>
<a href="#pyagenity.graph.utils.utils.parse_response(messages)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.Message)" href="../#pyagenity.utils.Message">Message</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of messages generated during execution.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.utils.utils.parse_response(response_granularity)" class="doc doc-heading doc-heading-parameter">                  <code>response_granularity</code>
<a href="#pyagenity.graph.utils.utils.parse_response(response_granularity)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            ResponseGranularity (pyagenity.utils.ResponseGranularity)" href="../#pyagenity.utils.ResponseGranularity">ResponseGranularity</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Level of detail to include in the response:
- FULL: Returns complete state object and all messages
- PARTIAL: Returns context, summary, and messages
- LOW: Returns only the messages (default)</p>
              </div>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            LOW


  
      class-attribute
      instance-attribute
   (pyagenity.utils.ResponseGranularity.LOW)" href="../#pyagenity.utils.ResponseGranularity.LOW">LOW</a></code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing the formatted response with keys depending on</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>granularity level. Always includes 'messages' key with execution results.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="c1"># LOW granularity (default)</span>
<span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">parse_response</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">messages</span><span class="p">)</span>
<span class="c1"># Returns: {&quot;messages&quot;: [Message(...), ...]}</span>

<span class="c1"># FULL granularity</span>
<span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">parse_response</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">FULL</span><span class="p">)</span>
<span class="c1"># Returns: {&quot;state&quot;: AgentState(...), &quot;messages&quot;: [Message(...), ...]}</span>
</code></pre></div>
</details>

            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/utils/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">parse_response</span><span class="p">(</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
    <span class="n">messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Message</span><span class="p">],</span>
    <span class="n">response_granularity</span><span class="p">:</span> <span class="n">ResponseGranularity</span> <span class="o">=</span> <span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse and format execution response based on specified granularity level.</span>

<span class="sd">    Formats the final response from graph execution according to the requested</span>
<span class="sd">    granularity level, allowing clients to receive different levels of detail</span>
<span class="sd">    depending on their needs.</span>

<span class="sd">    Args:</span>
<span class="sd">        state: The final agent state after graph execution.</span>
<span class="sd">        messages: List of messages generated during execution.</span>
<span class="sd">        response_granularity: Level of detail to include in the response:</span>
<span class="sd">            - FULL: Returns complete state object and all messages</span>
<span class="sd">            - PARTIAL: Returns context, summary, and messages</span>
<span class="sd">            - LOW: Returns only the messages (default)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary containing the formatted response with keys depending on</span>
<span class="sd">        granularity level. Always includes &#39;messages&#39; key with execution results.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        # LOW granularity (default)</span>
<span class="sd">        response = await parse_response(state, messages)</span>
<span class="sd">        # Returns: {&quot;messages&quot;: [Message(...), ...]}</span>

<span class="sd">        # FULL granularity</span>
<span class="sd">        response = await parse_response(state, messages, ResponseGranularity.FULL)</span>
<span class="sd">        # Returns: {&quot;state&quot;: AgentState(...), &quot;messages&quot;: [Message(...), ...]}</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">match</span> <span class="n">response_granularity</span><span class="p">:</span>
        <span class="k">case</span> <span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">FULL</span><span class="p">:</span>
            <span class="c1"># Return full state and messages</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">,</span> <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">messages</span><span class="p">}</span>
        <span class="k">case</span> <span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">PARTIAL</span><span class="p">:</span>
            <span class="c1"># Return state and summary of messages</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">context_summary</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">case</span> <span class="n">ResponseGranularity</span><span class="o">.</span><span class="n">LOW</span><span class="p">:</span>
            <span class="c1"># Return all messages from state context</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">messages</span><span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">messages</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.utils.utils.process_node_result" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">process_node_result</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.utils.utils.process_node_result" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">process_node_result</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">messages</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Processes the result from a node execution, updating the agent state, message list,
and determining the next node.</p>
<p>Supports:
- Handling results of type Command, AgentState, Message, list, str, dict,
        or other types.
    - Deduplicating messages by message_id.
    - Updating the agent state and its context with new messages.
    - Extracting navigation information (next node) from Command results.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.utils.utils.process_node_result(result)" class="doc doc-heading doc-heading-parameter">                  <code>result</code>
<a href="#pyagenity.graph.utils.utils.process_node_result(result)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The output from a node execution. Can be a Command, AgentState, Message,
list, str, dict, ModelResponse, or other types.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.utils.utils.process_node_result(state)" class="doc doc-heading doc-heading-parameter">                  <code>state</code>
<a href="#pyagenity.graph.utils.utils.process_node_result(state)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="pyagenity.graph.utils.utils.process_node_result[StateT]">StateT</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current agent state.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
<h8 id="pyagenity.graph.utils.utils.process_node_result(messages)" class="doc doc-heading doc-heading-parameter">                  <code>messages</code>
<a href="#pyagenity.graph.utils.utils.process_node_result(messages)" class="headerlink" title="Permanent link">&para;</a></h8>            </td>
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.Message)" href="../#pyagenity.utils.Message">Message</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The list of messages accumulated so far.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<span title="pyagenity.graph.utils.utils.process_node_result[StateT]">StateT</span>, <span title="list">list</span>[<a class="autorefs autorefs-internal" title="            Message (pyagenity.utils.Message)" href="../#pyagenity.utils.Message">Message</a>], <span title="str">str</span> | None]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tuple[StateT, list[Message], str | None]:
- The updated agent state.
- The updated list of messages (with new, unique messages added).
- The identifier of the next node to execute, if specified; otherwise, None.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/utils/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_node_result</span><span class="p">[</span><span class="n">StateT</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">](</span>  <span class="c1"># noqa: PLR0915</span>
    <span class="n">result</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">StateT</span><span class="p">,</span>
    <span class="n">messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Message</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">StateT</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">Message</span><span class="p">],</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Processes the result from a node execution, updating the agent state, message list,</span>
<span class="sd">    and determining the next node.</span>

<span class="sd">    Supports:</span>
<span class="sd">    - Handling results of type Command, AgentState, Message, list, str, dict,</span>
<span class="sd">            or other types.</span>
<span class="sd">        - Deduplicating messages by message_id.</span>
<span class="sd">        - Updating the agent state and its context with new messages.</span>
<span class="sd">        - Extracting navigation information (next node) from Command results.</span>

<span class="sd">    Args:</span>
<span class="sd">        result (Any): The output from a node execution. Can be a Command, AgentState, Message,</span>
<span class="sd">            list, str, dict, ModelResponse, or other types.</span>
<span class="sd">        state (StateT): The current agent state.</span>
<span class="sd">        messages (list[Message]): The list of messages accumulated so far.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[StateT, list[Message], str | None]:</span>
<span class="sd">            - The updated agent state.</span>
<span class="sd">            - The updated list of messages (with new, unique messages added).</span>
<span class="sd">            - The identifier of the next node to execute, if specified; otherwise, None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">next_node</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">existing_ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">msg</span><span class="o">.</span><span class="n">message_id</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">}</span>
    <span class="n">new_messages</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_unique_message</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add message only if it doesn&#39;t already exist.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">message_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_ids</span><span class="p">:</span>
            <span class="n">new_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">existing_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_and_add_message</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Message</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create message from content and add if unique.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">Message</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">content</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">ModelResponseConverter</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="n">content</span><span class="o">.</span><span class="n">invoke</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="n">text_message</span><span class="p">(</span>
                <span class="n">content</span><span class="p">,</span>
                <span class="n">role</span><span class="o">=</span><span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            Unsupported content type for message: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="si">}</span><span class="s2">.</span>
<span class="s2">            Supported types are: AgentState, Message, ModelResponseConverter, Command, str,</span>
<span class="s2">            dict (OpenAI style/Native Message).</span>
<span class="s2">            &quot;&quot;&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

        <span class="n">add_unique_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">msg</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_state_message</span><span class="p">(</span><span class="n">old_state</span><span class="p">:</span> <span class="n">StateT</span><span class="p">,</span> <span class="n">new_state</span><span class="p">:</span> <span class="n">StateT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle state messages by updating the context.&quot;&quot;&quot;</span>
        <span class="n">old_messages</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">old_state</span><span class="o">.</span><span class="n">context</span><span class="p">:</span>
            <span class="n">old_messages</span> <span class="o">=</span> <span class="p">{</span><span class="n">msg</span><span class="o">.</span><span class="n">message_id</span><span class="p">:</span> <span class="n">msg</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">old_state</span><span class="o">.</span><span class="n">context</span><span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">new_state</span><span class="o">.</span><span class="n">context</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># now save all the new messages</span>
        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">new_state</span><span class="o">.</span><span class="n">context</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">message_id</span> <span class="ow">in</span> <span class="n">old_messages</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># otherwise save it</span>
            <span class="n">add_unique_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Process different result types</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Command</span><span class="p">):</span>
        <span class="c1"># Handle state updates</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">,</span> <span class="n">AgentState</span><span class="p">):</span>
                <span class="n">handle_state_message</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">)</span>  <span class="c1"># type: ignore[assignment]</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">update</span>  <span class="c1"># type: ignore[assignment]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">create_and_add_message</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">create_and_add_message</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">)</span>

        <span class="c1"># Handle navigation</span>
        <span class="n">next_node</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">goto</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">AgentState</span><span class="p">):</span>
        <span class="n">handle_state_message</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>  <span class="c1"># type: ignore[assignment]</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">result</span>  <span class="c1"># type: ignore[assignment]</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Message</span><span class="p">):</span>
        <span class="n">add_unique_message</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="c1"># Handle list of items (convert each to message)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">create_and_add_message</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Handle single items (str, dict, model_dump-capable, or other)</span>
        <span class="k">await</span> <span class="n">create_and_add_message</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="c1"># Add new messages to the main list and state context</span>
    <span class="k">if</span> <span class="n">new_messages</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_messages</span><span class="p">)</span>
        <span class="n">state</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">add_messages</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">new_messages</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">next_node</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.utils.utils.reload_state" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">reload_state</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.utils.utils.reload_state" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">reload_state</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">old_state</span><span class="p">,</span> <span class="n">checkpointer</span><span class="o">=</span><span class="n">Inject</span><span class="p">[</span><span class="n">BaseCheckpointer</span><span class="p">])</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Load existing state from checkpointer or create new state.</p>
<p>Attempts to fetch a realtime-synced state first, then falls back to
the persistent checkpointer. If no existing state is found, creates
a new state from the <code>StateGraph</code>'s prototype state and merges any
incoming messages. Supports partial state update via 'state' in input_data.</p>


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/utils/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">reload_state</span><span class="p">[</span><span class="n">StateT</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">](</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">old_state</span><span class="p">:</span> <span class="n">StateT</span><span class="p">,</span>
    <span class="n">checkpointer</span><span class="p">:</span> <span class="n">BaseCheckpointer</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">BaseCheckpointer</span><span class="p">],</span>  <span class="c1"># will be auto-injected</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StateT</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load existing state from checkpointer or create new state.</span>

<span class="sd">    Attempts to fetch a realtime-synced state first, then falls back to</span>
<span class="sd">    the persistent checkpointer. If no existing state is found, creates</span>
<span class="sd">    a new state from the `StateGraph`&#39;s prototype state and merges any</span>
<span class="sd">    incoming messages. Supports partial state update via &#39;state&#39; in input_data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading or creating state with thread_id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;thread_id&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">checkpointer</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">old_state</span>

    <span class="c1"># first check realtime-synced state</span>
    <span class="n">existing_state</span><span class="p">:</span> <span class="n">AgentState</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="k">await</span> <span class="n">checkpointer</span><span class="o">.</span><span class="n">aget_state_cache</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">existing_state</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No synced state found, trying persistent checkpointer&quot;</span><span class="p">)</span>
        <span class="c1"># If no synced state, try to get from persistent checkpointer</span>
        <span class="n">existing_state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">checkpointer</span><span class="o">.</span><span class="n">aget_state</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">existing_state</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No existing state found to reload, returning old state&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">old_state</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Loaded existing state with </span><span class="si">%d</span><span class="s2"> context messages, current_node=</span><span class="si">%s</span><span class="s2">, step=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">existing_state</span><span class="o">.</span><span class="n">context</span><span class="p">)</span> <span class="k">if</span> <span class="n">existing_state</span><span class="o">.</span><span class="n">context</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">existing_state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span><span class="p">,</span>
        <span class="n">existing_state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">step</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Normalize legacy node names (backward compatibility)</span>
    <span class="c1"># Some older runs may have persisted &#39;start&#39;/&#39;end&#39; instead of &#39;__start__&#39;/&#39;__end__&#39;</span>
    <span class="k">if</span> <span class="n">existing_state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span> <span class="o">==</span> <span class="s2">&quot;start&quot;</span><span class="p">:</span>
        <span class="n">existing_state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span> <span class="o">=</span> <span class="n">START</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Normalized legacy current_node &#39;start&#39; to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">START</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">existing_state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span> <span class="o">==</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span>
        <span class="n">existing_state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span> <span class="o">=</span> <span class="n">END</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Normalized legacy current_node &#39;end&#39; to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">END</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">existing_state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span> <span class="o">==</span> <span class="s2">&quot;__start__&quot;</span><span class="p">:</span>
        <span class="n">existing_state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span> <span class="o">=</span> <span class="n">START</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Normalized legacy current_node &#39;__start__&#39; to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">START</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">existing_state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span> <span class="o">==</span> <span class="s2">&quot;__end__&quot;</span><span class="p">:</span>
        <span class="n">existing_state</span><span class="o">.</span><span class="n">execution_meta</span><span class="o">.</span><span class="n">current_node</span> <span class="o">=</span> <span class="n">END</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Normalized legacy current_node &#39;__end__&#39; to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">END</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">existing_state</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="pyagenity.graph.utils.utils.sync_data" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">sync_data</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#pyagenity.graph.utils.utils.sync_data" class="headerlink" title="Permanent link">&para;</a></h7>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">sync_data</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">trim</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">checkpointer</span><span class="o">=</span><span class="n">Inject</span><span class="p">[</span><span class="n">BaseCheckpointer</span><span class="p">],</span> <span class="n">context_manager</span><span class="o">=</span><span class="n">Inject</span><span class="p">[</span><span class="n">BaseContextManager</span><span class="p">])</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Sync the current state and messages to the checkpointer.</p>


            <details class="quote">
              <summary>Source code in <code>pyagenity/graph/utils/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">sync_data</span><span class="p">(</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Message</span><span class="p">],</span>
    <span class="n">trim</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">checkpointer</span><span class="p">:</span> <span class="n">BaseCheckpointer</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">BaseCheckpointer</span><span class="p">],</span>  <span class="c1"># will be auto-injected</span>
    <span class="n">context_manager</span><span class="p">:</span> <span class="n">BaseContextManager</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">[</span><span class="n">BaseContextManager</span><span class="p">],</span>  <span class="c1"># will be auto-injected</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sync the current state and messages to the checkpointer.&quot;&quot;&quot;</span>
    <span class="n">is_context_trimmed</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">new_state</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="c1"># if context manager is available then utilize it</span>
    <span class="k">if</span> <span class="n">context_manager</span> <span class="ow">and</span> <span class="n">trim</span><span class="p">:</span>
        <span class="n">new_state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">context_manager</span><span class="o">.</span><span class="n">atrim_context</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="n">is_context_trimmed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># first sync with realtime then main db</span>
    <span class="k">await</span> <span class="n">call_realtime_sync</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">checkpointer</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Persisting state and </span><span class="si">%d</span><span class="s2"> messages to checkpointer&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">checkpointer</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">checkpointer</span><span class="o">.</span><span class="n">aput_state</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">new_state</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">messages</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">checkpointer</span><span class="o">.</span><span class="n">aput_messages</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">messages</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">is_context_trimmed</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>


  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.pagination", "navigation.goto_top", "navigation.path", "navigation.tabs", "navigation.top", "search-suggest", "search.highlight", "search.share", "content.code.copy"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>